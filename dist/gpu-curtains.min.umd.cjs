(function(m,R){typeof exports=="object"&&typeof module<"u"?R(exports):typeof define=="function"&&define.amd?define(["exports"],R):(m=typeof globalThis<"u"?globalThis:m||self,R(m.GPUCurtains={}))})(this,function(m){"use strict";var et=(m,R,G)=>{if(!R.has(m))throw TypeError("Cannot "+G)};var M=(m,R,G)=>(et(m,R,"read from private field"),G?G.call(m):R.get(m)),D=(m,R,G)=>{if(R.has(m))throw TypeError("Cannot add the same private member more than once");R instanceof WeakSet?R.add(m):R.set(m,G)},_=(m,R,G,ee)=>(et(m,R,"write to private field"),ee?ee.call(m,G):R.set(m,G),G);var St=(m,R,G,ee)=>({set _(me){_(m,R,me,G)},get _(){return M(m,R,ee)}}),Gt=(m,R,G)=>(et(m,R,"access private method"),G);var Z,Q,ce,pe,ye,ge,xe,be,ne,Se,zt,oe,ae,he,fe;const R=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,d=>{const e=Math.random()*16|0;return(d==="x"?e:e&3|8).toString(16).toUpperCase()}),G=d=>d.replace(/(?:^\w|[A-Z]|\b\w)/g,(e,t)=>t===0?e.toLowerCase():e.toUpperCase()).replace(/\s+/g,""),ee=d=>{const e=G(d);return e.charAt(0).toUpperCase()+e.slice(1)};let me=0;const V=d=>{me>100||(console.warn(me===100?"GPUCurtains: too many warnings thrown, stop logging.":d),me++)},I=d=>{throw new Error(d)},Ge=(d,e="GPURenderer",t)=>{const s=t?`Unable to create ${t} because the ${e} is not defined: ${d}`:`The ${e} is not defined: ${d}`;I(s)},U=(d,e)=>{const t=d&&(d.type==="GPURenderer"||d.type==="GPUCameraRenderer"||d.type==="GPUCurtainsRenderer");return t||Ge(d,"GPURenderer",e),t},ze=(d,e)=>{const t=d&&(d.type==="GPUCameraRenderer"||d.type==="GPUCurtainsRenderer");return t||Ge(d,"GPUCameraRenderer",e),t},Oe=(d,e)=>{const t=d&&d.type==="GPUCurtainsRenderer";return t||Ge(d,"GPUCurtainsRenderer",e),t},Ot=(()=>{let d,e;const t={};return function(r,i){e||(e=r.createShaderModule({label:"textured quad shaders for mip level generation",code:`
            struct VSOutput {
              @builtin(position) position: vec4f,
              @location(0) texcoord: vec2f,
            };

            @vertex fn vs(
              @builtin(vertex_index) vertexIndex : u32
            ) -> VSOutput {
              var pos = array<vec2f, 6>(

                vec2f( 0.0,  0.0),  // center
                vec2f( 1.0,  0.0),  // right, center
                vec2f( 0.0,  1.0),  // center, top

                // 2st triangle
                vec2f( 0.0,  1.0),  // center, top
                vec2f( 1.0,  0.0),  // right, center
                vec2f( 1.0,  1.0),  // right, top
              );

              var vsOutput: VSOutput;
              let xy = pos[vertexIndex];
              vsOutput.position = vec4f(xy * 2.0 - 1.0, 0.0, 1.0);
              vsOutput.texcoord = vec2f(xy.x, 1.0 - xy.y);
              return vsOutput;
            }

            @group(0) @binding(0) var ourSampler: sampler;
            @group(0) @binding(1) var ourTexture: texture_2d<f32>;

            @fragment fn fs(fsInput: VSOutput) -> @location(0) vec4f {
              return textureSample(ourTexture, ourSampler, fsInput.texcoord);
            }
          `}),d=r.createSampler({minFilter:"linear"})),t[i.format]||(t[i.format]=r.createRenderPipeline({label:"mip level generator pipeline",layout:"auto",vertex:{module:e,entryPoint:"vs"},fragment:{module:e,entryPoint:"fs",targets:[{format:i.format}]}}));const n=t[i.format],o=r.createCommandEncoder({label:"mip gen encoder"});let a=i.width,h=i.height,u=0;for(;a>1||h>1;){a=Math.max(1,a/2|0),h=Math.max(1,h/2|0);const l=r.createBindGroup({layout:n.getBindGroupLayout(0),entries:[{binding:0,resource:d},{binding:1,resource:i.createView({baseMipLevel:u,mipLevelCount:1})}]});++u;const p={label:"our basic canvas renderPass",colorAttachments:[{view:i.createView({baseMipLevel:u,mipLevelCount:1}),loadOp:"clear",storeOp:"store"}]},y=o.beginRenderPass(p);y.setPipeline(n),y.setBindGroup(0,l),y.draw(6),y.end()}const c=o.finish();r.queue.submit([c])}})();class we{constructor({label:e="Uniform",name:t="uniform",bindingType:s="uniform",visibility:r}){this.label=e,this.name=G(t),this.bindingType=s,this.visibility=r?(()=>{switch(r){case"vertex":return GPUShaderStage.VERTEX;case"fragment":return GPUShaderStage.FRAGMENT;case"compute":return GPUShaderStage.COMPUTE;default:return GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE}})():GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,this.options={label:e,name:t,bindingType:s,visibility:r},this.shouldResetBindGroup=!1,this.shouldResetBindGroupLayout=!1}}const tt=d=>({i32:{numElements:1,align:4,size:4,type:"i32",View:Int32Array},u32:{numElements:1,align:4,size:4,type:"u32",View:Uint32Array},f32:{numElements:1,align:4,size:4,type:"f32",View:Float32Array},f16:{numElements:1,align:2,size:2,type:"u16",View:Uint16Array},vec2f:{numElements:2,align:8,size:8,type:"f32",View:Float32Array},vec2i:{numElements:2,align:8,size:8,type:"i32",View:Int32Array},vec2u:{numElements:2,align:8,size:8,type:"u32",View:Uint32Array},vec2h:{numElements:2,align:4,size:4,type:"u16",View:Uint16Array},vec3i:{numElements:3,align:16,size:12,type:"i32",View:Int32Array},vec3u:{numElements:3,align:16,size:12,type:"u32",View:Uint32Array},vec3f:{numElements:3,align:16,size:12,type:"f32",View:Float32Array},vec3h:{numElements:3,align:8,size:6,type:"u16",View:Uint16Array},vec4i:{numElements:4,align:16,size:16,type:"i32",View:Int32Array},vec4u:{numElements:4,align:16,size:16,type:"u32",View:Uint32Array},vec4f:{numElements:4,align:16,size:16,type:"f32",View:Float32Array},vec4h:{numElements:4,align:8,size:8,type:"u16",View:Uint16Array},mat2x2f:{numElements:4,align:8,size:16,type:"f32",View:Float32Array},mat2x2h:{numElements:4,align:4,size:8,type:"u16",View:Uint16Array},mat3x2f:{numElements:6,align:8,size:24,type:"f32",View:Float32Array},mat3x2h:{numElements:6,align:4,size:12,type:"u16",View:Uint16Array},mat4x2f:{numElements:8,align:8,size:32,type:"f32",View:Float32Array},mat4x2h:{numElements:8,align:4,size:16,type:"u16",View:Uint16Array},mat2x3f:{numElements:8,align:16,size:32,pad:[3,1],type:"f32",View:Float32Array},mat2x3h:{numElements:8,align:8,size:16,pad:[3,1],type:"u16",View:Uint16Array},mat3x3f:{numElements:12,align:16,size:48,pad:[3,1],type:"f32",View:Float32Array},mat3x3h:{numElements:12,align:8,size:24,pad:[3,1],type:"u16",View:Uint16Array},mat4x3f:{numElements:16,align:16,size:64,pad:[3,1],type:"f32",View:Float32Array},mat4x3h:{numElements:16,align:8,size:32,pad:[3,1],type:"u16",View:Uint16Array},mat2x4f:{numElements:8,align:16,size:32,type:"f32",View:Float32Array},mat2x4h:{numElements:8,align:8,size:16,type:"u16",View:Uint16Array},mat3x4f:{numElements:12,align:16,size:48,pad:[3,1],type:"f32",View:Float32Array},mat3x4h:{numElements:12,align:8,size:24,pad:[3,1],type:"u16",View:Uint16Array},mat4x4f:{numElements:16,align:16,size:64,type:"f32",View:Float32Array},mat4x4h:{numElements:16,align:8,size:32,type:"u16",View:Uint16Array}})[d],Pe=d=>(()=>{switch(d.bindingType){case"storage":return`var<${d.bindingType}, ${d.options.access}>`;case"uniform":default:return"var<uniform>"}})(),Ut=d=>d.bindingType==="externalTexture"?`var ${d.name}: texture_external;`:d.bindingType==="storageTexture"?`var ${d.name}: texture_storage_${d.options.viewDimension}<${d.options.format}, ${d.options.access}>;`:d.bindingType==="depthTexture"?`var ${d.name}: texture_depth${d.options.multisampled?"_multisampled":""}_${d.options.viewDimension};`:`var ${d.name}: texture${d.options.multisampled?"_multisampled":""}_${d.options.viewDimension}<f32>;`,At=d=>d.bindingType==="storage"&&d.options.access==="read_write"?"storage":d.bindingType==="storage"?"read-only-storage":"uniform",Ft=d=>(()=>{switch(d.bindingType){case"externalTexture":return{externalTexture:{}};case"storageTexture":return{storageTexture:{format:d.options.format,viewDimension:d.options.viewDimension}};case"texture":return{texture:{multisampled:d.options.multisampled,viewDimension:d.options.viewDimension}};case"depthTexture":return{texture:{multisampled:d.options.multisampled,format:d.options.format,viewDimension:d.options.viewDimension,sampleType:"depth"}};default:return null}})();class A{constructor(e=0,t=e){this.type="Vec2",this._x=e,this._y=t}get x(){return this._x}set x(e){const t=e!==this._x;this._x=e,t&&this._onChangeCallback&&this._onChangeCallback()}get y(){return this._y}set y(e){const t=e!==this._y;this._y=e,t&&this._onChangeCallback&&this._onChangeCallback()}onChange(e){return e&&(this._onChangeCallback=e),this}set(e=0,t=e){return this.x=e,this.y=t,this}add(e=new A){return this.x+=e.x,this.y+=e.y,this}addScalar(e=0){return this.x+=e,this.y+=e,this}sub(e=new A){return this.x-=e.x,this.y-=e.y,this}subScalar(e=0){return this.x-=e,this.y-=e,this}multiply(e=new A(1)){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e=1){return this.x*=e,this.y*=e,this}copy(e=new A){return this.x=e.x,this.y=e.y,this}clone(){return new A(this.x,this.y)}max(e=new A){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}min(e=new A){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}clamp(e=new A,t=new A){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this}equals(e=new A){return this.x===e.x&&this.y===e.y}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.lengthSq())}normalize(){let e=this.x*this.x+this.y*this.y;return e>0&&(e=1/Math.sqrt(e)),this.x*=e,this.y*=e,this}dot(e=new A){return this.x*e.x+this.y*e.y}lerp(e=new A,t=1){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}}class Y{constructor(e=new Float32Array([0,0,0,1]),t="XYZ"){this.type="Quat",this.elements=e,this.axisOrder=t}setFromArray(e=new Float32Array([0,0,0,1])){return this.elements[0]=e[0],this.elements[1]=e[1],this.elements[2]=e[2],this.elements[3]=e[3],this}setAxisOrder(e="XYZ"){switch(e=e.toUpperCase(),e){case"XYZ":case"YXZ":case"ZXY":case"ZYX":case"YZX":case"XZY":this.axisOrder=e;break;default:this.axisOrder="XYZ"}return this}copy(e=new Y){return this.elements=e.elements,this.axisOrder=e.axisOrder,this}clone(){return new Y().copy(this)}equals(e=new Y){return this.elements[0]===e.elements[0]&&this.elements[1]===e.elements[1]&&this.elements[2]===e.elements[2]&&this.elements[3]===e.elements[3]&&this.axisOrder===e.axisOrder}setFromVec3(e=new f){const t=e.x*.5,s=e.y*.5,r=e.z*.5,i=Math.cos(t),n=Math.cos(s),o=Math.cos(r),a=Math.sin(t),h=Math.sin(s),u=Math.sin(r);return this.axisOrder==="XYZ"?(this.elements[0]=a*n*o+i*h*u,this.elements[1]=i*h*o-a*n*u,this.elements[2]=i*n*u+a*h*o,this.elements[3]=i*n*o-a*h*u):this.axisOrder==="YXZ"?(this.elements[0]=a*n*o+i*h*u,this.elements[1]=i*h*o-a*n*u,this.elements[2]=i*n*u-a*h*o,this.elements[3]=i*n*o+a*h*u):this.axisOrder==="ZXY"?(this.elements[0]=a*n*o-i*h*u,this.elements[1]=i*h*o+a*n*u,this.elements[2]=i*n*u+a*h*o,this.elements[3]=i*n*o-a*h*u):this.axisOrder==="ZYX"?(this.elements[0]=a*n*o-i*h*u,this.elements[1]=i*h*o+a*n*u,this.elements[2]=i*n*u-a*h*o,this.elements[3]=i*n*o+a*h*u):this.axisOrder==="YZX"?(this.elements[0]=a*n*o+i*h*u,this.elements[1]=i*h*o+a*n*u,this.elements[2]=i*n*u-a*h*o,this.elements[3]=i*n*o-a*h*u):this.axisOrder==="XZY"&&(this.elements[0]=a*n*o-i*h*u,this.elements[1]=i*h*o-a*n*u,this.elements[2]=i*n*u+a*h*o,this.elements[3]=i*n*o+a*h*u),this}setFromAxisAngle(e=new f,t=0){const s=t/2,r=Math.sin(s);return this.elements[0]=e.x*r,this.elements[1]=e.y*r,this.elements[2]=e.z*r,this.elements[3]=Math.cos(s),this}setFromRotationMatrix(e){const t=e.elements,s=t[0],r=t[4],i=t[8],n=t[1],o=t[5],a=t[9],h=t[2],u=t[6],c=t[10],l=s+o+c;if(l>0){const p=.5/Math.sqrt(l+1);this.elements[3]=.25/p,this.elements[0]=(u-a)*p,this.elements[1]=(i-h)*p,this.elements[2]=(n-r)*p}else if(s>o&&s>c){const p=2*Math.sqrt(1+s-o-c);this.elements[3]=(u-a)/p,this.elements[0]=.25*p,this.elements[1]=(r+n)/p,this.elements[2]=(i+h)/p}else if(o>c){const p=2*Math.sqrt(1+o-s-c);this.elements[3]=(i-h)/p,this.elements[0]=(r+n)/p,this.elements[1]=.25*p,this.elements[2]=(a+u)/p}else{const p=2*Math.sqrt(1+c-s-o);this.elements[3]=(n-r)/p,this.elements[0]=(i+h)/p,this.elements[1]=(a+u)/p,this.elements[2]=.25*p}return this}}class z{constructor(e=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])){this.type="Mat4",this.elements=e}set(e,t,s,r,i,n,o,a,h,u,c,l,p,y,b,x){const g=this.elements;return g[0]=e,g[1]=t,g[2]=s,g[3]=r,g[4]=i,g[5]=n,g[6]=o,g[7]=a,g[8]=h,g[9]=u,g[10]=c,g[11]=l,g[12]=p,g[13]=y,g[14]=b,g[15]=x,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}setFromArray(e=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])){for(let t=0;t<this.elements.length;t++)this.elements[t]=e[t];return this}copy(e=new z){const t=e.elements;return this.elements[0]=t[0],this.elements[1]=t[1],this.elements[2]=t[2],this.elements[3]=t[3],this.elements[4]=t[4],this.elements[5]=t[5],this.elements[6]=t[6],this.elements[7]=t[7],this.elements[8]=t[8],this.elements[9]=t[9],this.elements[10]=t[10],this.elements[11]=t[11],this.elements[12]=t[12],this.elements[13]=t[13],this.elements[14]=t[14],this.elements[15]=t[15],this}clone(){return new z().copy(this)}multiply(e=new z){return this.multiplyMatrices(this,e)}premultiply(e=new z){return this.multiplyMatrices(e,this)}multiplyMatrices(e=new z,t=new z){const s=e.elements,r=t.elements,i=this.elements,n=s[0],o=s[4],a=s[8],h=s[12],u=s[1],c=s[5],l=s[9],p=s[13],y=s[2],b=s[6],x=s[10],g=s[14],T=s[3],C=s[7],P=s[11],v=s[15],B=r[0],w=r[4],S=r[8],E=r[12],k=r[1],X=r[5],q=r[9],J=r[13],H=r[2],O=r[6],F=r[10],L=r[14],j=r[3],N=r[7],K=r[11],ue=r[15];return i[0]=n*B+o*k+a*H+h*j,i[4]=n*w+o*X+a*O+h*N,i[8]=n*S+o*q+a*F+h*K,i[12]=n*E+o*J+a*L+h*ue,i[1]=u*B+c*k+l*H+p*j,i[5]=u*w+c*X+l*O+p*N,i[9]=u*S+c*q+l*F+p*K,i[13]=u*E+c*J+l*L+p*ue,i[2]=y*B+b*k+x*H+g*j,i[6]=y*w+b*X+x*O+g*N,i[10]=y*S+b*q+x*F+g*K,i[14]=y*E+b*J+x*L+g*ue,i[3]=T*B+C*k+P*H+v*j,i[7]=T*w+C*X+P*O+v*N,i[11]=T*S+C*q+P*F+v*K,i[15]=T*E+C*J+P*L+v*ue,this}premultiplyTranslate(e=new f){const n=e.x,o=e.y,a=e.z,h=this.elements,u=this.elements,c=h[0],l=h[4],p=h[8],y=h[12],b=h[1],x=h[5],g=h[9],T=h[13],C=h[2],P=h[6],v=h[10],B=h[14],w=h[3],S=h[7],E=h[11],k=h[15];return u[0]=1*c+n*w,u[4]=1*l+n*S,u[8]=1*p+n*E,u[12]=1*y+n*k,u[1]=1*b+o*w,u[5]=1*x+o*S,u[9]=1*g+o*E,u[13]=1*T+o*k,u[2]=1*C+a*w,u[6]=1*P+a*S,u[10]=1*v+a*E,u[14]=1*B+a*k,u[3]=1*w,u[7]=1*S,u[11]=1*E,u[15]=1*k,this}premultiplyScale(e=new f){const t=this.elements,s=this.elements,r=e.x,i=e.y,n=e.z,o=1,a=t[0],h=t[4],u=t[8],c=t[12],l=t[1],p=t[5],y=t[9],b=t[13],x=t[2],g=t[6],T=t[10],C=t[14],P=t[3],v=t[7],B=t[11],w=t[15];return s[0]=r*a,s[4]=r*h,s[8]=r*u,s[12]=r*c,s[1]=i*l,s[5]=i*p,s[9]=i*y,s[13]=i*b,s[2]=n*x,s[6]=n*g,s[10]=n*T,s[14]=n*C,s[3]=o*P,s[7]=o*v,s[11]=o*B,s[15]=o*w,this}invert(){const e=this.elements,t=e[0],s=e[1],r=e[2],i=e[3],n=e[4],o=e[5],a=e[6],h=e[7],u=e[8],c=e[9],l=e[10],p=e[11],y=e[12],b=e[13],x=e[14],g=e[15],T=c*x*h-b*l*h+b*a*p-o*x*p-c*a*g+o*l*g,C=y*l*h-u*x*h-y*a*p+n*x*p+u*a*g-n*l*g,P=u*b*h-y*c*h+y*o*p-n*b*p-u*o*g+n*c*g,v=y*c*a-u*b*a-y*o*l+n*b*l+u*o*x-n*c*x,B=t*T+s*C+r*P+i*v;if(B===0)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const w=1/B;return e[0]=T*w,e[1]=(b*l*i-c*x*i-b*r*p+s*x*p+c*r*g-s*l*g)*w,e[2]=(o*x*i-b*a*i+b*r*h-s*x*h-o*r*g+s*a*g)*w,e[3]=(c*a*i-o*l*i-c*r*h+s*l*h+o*r*p-s*a*p)*w,e[4]=C*w,e[5]=(u*x*i-y*l*i+y*r*p-t*x*p-u*r*g+t*l*g)*w,e[6]=(y*a*i-n*x*i-y*r*h+t*x*h+n*r*g-t*a*g)*w,e[7]=(n*l*i-u*a*i+u*r*h-t*l*h-n*r*p+t*a*p)*w,e[8]=P*w,e[9]=(y*c*i-u*b*i-y*s*p+t*b*p+u*s*g-t*c*g)*w,e[10]=(n*b*i-y*o*i+y*s*h-t*b*h-n*s*g+t*o*g)*w,e[11]=(u*o*i-n*c*i-u*s*h+t*c*h+n*s*p-t*o*p)*w,e[12]=v*w,e[13]=(u*b*r-y*c*r+y*s*l-t*b*l-u*s*x+t*c*x)*w,e[14]=(y*o*r-n*b*r-y*s*a+t*b*a+n*s*x-t*o*x)*w,e[15]=(n*c*r-u*o*r+u*s*a-t*c*a-n*s*l+t*o*l)*w,this}getInverse(){return this.clone().invert()}translate(e=new f){const t=this.elements;return t[12]=t[0]*e.x+t[4]*e.y+t[8]*e.z+t[12],t[13]=t[1]*e.x+t[5]*e.y+t[9]*e.z+t[13],t[14]=t[2]*e.x+t[6]*e.y+t[10]*e.z+t[14],t[15]=t[3]*e.x+t[7]*e.y+t[11]*e.z+t[15],this}scale(e=new f){const t=this.elements;return t[0]*=e.x,t[1]*=e.x,t[2]*=e.x,t[3]*=e.x,t[4]*=e.y,t[5]*=e.y,t[6]*=e.y,t[7]*=e.y,t[8]*=e.z,t[9]*=e.z,t[10]*=e.z,t[11]*=e.z,this}rotateFromQuaternion(e=new Y){const t=this.elements,s=e.elements[0],r=e.elements[1],i=e.elements[2],n=e.elements[3],o=s+s,a=r+r,h=i+i,u=s*o,c=s*a,l=s*h,p=r*a,y=r*h,b=i*h,x=n*o,g=n*a,T=n*h;return t[0]=1-(p+b),t[4]=c-T,t[8]=l+g,t[1]=c+T,t[5]=1-(u+b),t[9]=y-x,t[2]=l-g,t[6]=y+x,t[10]=1-(u+p),this}lookAt(e=new f,t=new f,s=new f(0,1,0)){const r=this.elements,i=e.clone().sub(t);i.lengthSq()===0&&(i.z=1),i.normalize();const n=new f().crossVectors(s,i);n.lengthSq()===0&&(Math.abs(s.z)===1?i.x+=1e-4:i.z+=1e-4,i.normalize(),n.crossVectors(s,i)),n.normalize();const o=new f().crossVectors(i,n);return r[0]=n.x,r[4]=o.x,r[8]=i.x,r[1]=n.y,r[5]=o.y,r[9]=i.y,r[2]=n.z,r[6]=o.z,r[10]=i.z,this}compose(e=new f,t=new Y,s=new f(1)){const r=this.elements,i=t.elements[0],n=t.elements[1],o=t.elements[2],a=t.elements[3],h=i+i,u=n+n,c=o+o,l=i*h,p=i*u,y=i*c,b=n*u,x=n*c,g=o*c,T=a*h,C=a*u,P=a*c,v=s.x,B=s.y,w=s.z;return r[0]=(1-(b+g))*v,r[1]=(p+P)*v,r[2]=(y-C)*v,r[3]=0,r[4]=(p-P)*B,r[5]=(1-(l+g))*B,r[6]=(x+T)*B,r[7]=0,r[8]=(y+C)*w,r[9]=(x-T)*w,r[10]=(1-(l+b))*w,r[11]=0,r[12]=e.x,r[13]=e.y,r[14]=e.z,r[15]=1,this}composeFromOrigin(e=new f,t=new Y,s=new f(1),r=new f){const i=this.elements,n=t.elements[0],o=t.elements[1],a=t.elements[2],h=t.elements[3],u=n+n,c=o+o,l=a+a,p=n*u,y=n*c,b=n*l,x=o*c,g=o*l,T=a*l,C=h*u,P=h*c,v=h*l,B=s.x,w=s.y,S=s.z,E=r.x,k=r.y,X=r.z,q=(1-(x+T))*B,J=(y+v)*B,H=(b-P)*B,O=(y-v)*w,F=(1-(p+T))*w,L=(g+C)*w,j=(b+P)*S,N=(g-C)*S,K=(1-(p+x))*S;return i[0]=q,i[1]=J,i[2]=H,i[3]=0,i[4]=O,i[5]=F,i[6]=L,i[7]=0,i[8]=j,i[9]=N,i[10]=K,i[11]=0,i[12]=e.x+E-(q*E+O*k+j*X),i[13]=e.y+k-(J*E+F*k+N*X),i[14]=e.z+X-(H*E+L*k+K*X),i[15]=1,this}getTranslation(e=new f){return e.set(this.elements[12],this.elements[13],this.elements[14])}}class f{constructor(e=0,t=e,s=e){this.type="Vec3",this._x=e,this._y=t,this._z=s}get x(){return this._x}set x(e){const t=e!==this._x;this._x=e,t&&this._onChangeCallback&&this._onChangeCallback()}get y(){return this._y}set y(e){const t=e!==this._y;this._y=e,t&&this._onChangeCallback&&this._onChangeCallback()}get z(){return this._z}set z(e){const t=e!==this._z;this._z=e,t&&this._onChangeCallback&&this._onChangeCallback()}onChange(e){return e&&(this._onChangeCallback=e),this}set(e=0,t=e,s=e){return this.x=e,this.y=t,this.z=s,this}add(e=new f){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e=0){return this.x+=e,this.y+=e,this.z+=e,this}sub(e=new f){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e=0){return this.x-=e,this.y-=e,this.z-=e,this}multiply(e=new f(1)){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e=1){return this.x*=e,this.y*=e,this.z*=e,this}copy(e=new f){return this.x=e.x,this.y=e.y,this.z=e.z,this}clone(){return new f(this.x,this.y,this.z)}max(e=new f){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}min(e=new f){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}clamp(e=new f,t=new f){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this}equals(e=new f){return this.x===e.x&&this.y===e.y&&this.z===e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.lengthSq())}normalize(){let e=this.lengthSq();return e>0&&(e=1/Math.sqrt(e)),this.x*=e,this.y*=e,this.z*=e,this}dot(e=new f){return this.x*e.x+this.y*e.y+this.z*e.z}cross(e=new f){return this.crossVectors(this,e)}crossVectors(e=new f,t=new f){const s=e.x,r=e.y,i=e.z,n=t.x,o=t.y,a=t.z;return this.x=r*a-i*o,this.y=i*n-s*a,this.z=s*o-r*n,this}lerp(e=new f,t=1){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}applyMat4(e=new z){const t=this._x,s=this._y,r=this._z,i=e.elements;let n=i[3]*t+i[7]*s+i[11]*r+i[15];return n=n||1,this.x=(i[0]*t+i[4]*s+i[8]*r+i[12])/n,this.y=(i[1]*t+i[5]*s+i[9]*r+i[13])/n,this.z=(i[2]*t+i[6]*s+i[10]*r+i[14])/n,this}applyQuat(e=new Y){const t=this.x,s=this.y,r=this.z,i=e.elements[0],n=e.elements[1],o=e.elements[2],a=e.elements[3],h=a*t+n*r-o*s,u=a*s+o*t-i*r,c=a*r+i*s-n*t,l=-i*t-n*s-o*r;return this.x=h*a+l*-i+u*-o-c*-n,this.y=u*a+l*-n+c*-i-h*-o,this.z=c*a+l*-o+h*-n-u*-i,this}applyAxisAngle(e=new f,t=0,s=new Y){return this.applyQuat(s.setFromAxisAngle(e,t))}project(e){return this.applyMat4(e.viewMatrix).applyMat4(e.projectionMatrix),this}unproject(e){return this.applyMat4(e.projectionMatrix.getInverse()).applyMat4(e.modelMatrix),this}}const _t=4,Me=4,$=_t*Me;class Ue{constructor({name:e,key:t,type:s="f32"}){this.name=e,this.key=t,this.type=s,this.bufferLayout=tt(this.type.replace("array","").replace("<","").replace(">","")),this.alignment={start:{row:0,byte:0},end:{row:0,byte:0}}}get rowCount(){return this.alignment.end.row-this.alignment.start.row+1}get byteCount(){return Math.abs(this.endOffset-this.startOffset)+1}get paddedByteCount(){return(this.alignment.end.row+1)*$}get startOffset(){return this.getByteCountAtPosition(this.alignment.start)}get startOffsetToIndex(){return this.startOffset/Me}get endOffset(){return this.getByteCountAtPosition(this.alignment.end)}get endOffsetToIndex(){return Math.floor(this.endOffset/Me)}getPositionAtOffset(e=0){return{row:Math.floor(e/$),byte:e%$}}getByteCountAtPosition(e={row:0,byte:0}){return e.row*$+e.byte}applyOverflowToPosition(e={row:0,byte:0}){if(e.byte>$-1){const t=e.byte%$;e.row+=Math.floor(e.byte/$),e.byte=t}return e}getByteCountBetweenPositions(e={row:0,byte:0},t={row:0,byte:0}){return Math.abs(this.getByteCountAtPosition(t)-this.getByteCountAtPosition(e))}getElementAlignment(e={row:0,byte:0}){const t={start:e,end:e},{size:s,align:r}=this.bufferLayout;return e.byte%r!==0&&(e.byte+=e.byte%r),s<=$&&e.byte+s>$&&(e.row+=1,e.byte=0),t.end={row:e.row+Math.ceil(s/$)-1,byte:e.byte+(s%$===0?$-1:s%$-1)},t.end=this.applyOverflowToPosition(t.end),t}setAlignmentFromPosition(e={row:0,byte:0}){this.alignment=this.getElementAlignment(e)}setAlignment(e=0){this.setAlignmentFromPosition(this.getPositionAtOffset(e))}setView(e,t){this.view=new this.bufferLayout.View(e,this.startOffset,this.byteCount/this.bufferLayout.View.BYTES_PER_ELEMENT)}update(e){this.type==="f32"||this.type==="u32"||this.type==="i32"?this.view[0]=e:this.type==="vec2f"?(this.view[0]=e.x??e[0]??0,this.view[1]=e.y??e[1]??0):this.type==="vec3f"?(this.view[0]=e.x??e[0]??0,this.view[1]=e.y??e[1]??0,this.view[2]=e.z??e[2]??0):e.elements?this.view.set(e.elements):(ArrayBuffer.isView(e)||Array.isArray(e))&&this.view.set(e)}extractDataFromBufferResult(e){return e.slice(this.startOffsetToIndex,this.endOffsetToIndex)}}class st extends Ue{constructor({name:e,key:t,type:s="f32",arrayLength:r=1}){super({name:e,key:t,type:s}),this.arrayLength=r,this.numElements=this.arrayLength/this.bufferLayout.numElements}get arrayStrideToIndex(){return this.arrayStride/Me}setAlignment(e=0){super.setAlignment(e);const t=this.getElementAlignment(this.getPositionAtOffset(this.endOffset+1));this.arrayStride=this.getByteCountBetweenPositions(this.alignment.end,t.end),this.alignment.end=this.getPositionAtOffset(this.endOffset+this.arrayStride*(this.numElements-1))}update(e){if(ArrayBuffer.isView(e)||Array.isArray(e)){let t=0;const s=this.byteCount/this.bufferLayout.View.BYTES_PER_ELEMENT,r=Math.ceil(s/this.numElements);for(let i=0;i<this.numElements;i++)for(let n=0;n<this.bufferLayout.numElements;n++)this.view[n+i*r]=e[t],t++}else V(`BufferArrayElement: value passed to ${this.name} is not an array: ${e}`)}}class Ae extends st{constructor({name:e,key:t,type:s="f32",arrayLength:r=1}){super({name:e,key:t,type:s,arrayLength:r}),this.arrayStride=1,this.arrayLength=r,this.numElements=this.arrayLength/this.bufferLayout.numElements}get byteCount(){return this.bufferLayout.size*this.numElements}setAlignment(e=0,t=0){this.alignment=this.getElementAlignment(this.getPositionAtOffset(e)),this.arrayStride=t,this.alignment.end=this.getPositionAtOffset(this.endOffset+t*(this.numElements-1))}setView(e,t){this.view=new this.bufferLayout.View(this.bufferLayout.numElements*this.numElements),this.viewSetFunction=(s=>{switch(this.bufferLayout.View){case Int32Array:return s.setInt32.bind(s);case Uint16Array:return s.setUint16.bind(s);case Uint32Array:return s.setUint32.bind(s);case Float32Array:default:return s.setFloat32.bind(s)}})(t)}update(e){super.update(e);for(let t=0;t<this.numElements;t++){const s=this.view.subarray(t*this.bufferLayout.numElements,t*this.bufferLayout.numElements+this.bufferLayout.numElements),r=this.startOffset+t*this.arrayStride;s.forEach((i,n)=>{this.viewSetFunction(r+n*this.bufferLayout.View.BYTES_PER_ELEMENT,i,!0)})}}extractDataFromBufferResult(e){const t=new Float32Array(this.arrayLength);for(let s=0;s<this.numElements;s++){const r=this.startOffsetToIndex+s*this.arrayStrideToIndex;for(let i=0;i<this.bufferLayout.numElements;i++)t[s*this.bufferLayout.numElements+i]=e[r+i]}return t}}class de extends we{constructor({label:e="Uniform",name:t="uniform",bindingType:s,visibility:r,useStruct:i=!0,access:n="read",struct:o={}}){s=s??"uniform",super({label:e,name:t,bindingType:s,visibility:r}),this.options={...this.options,useStruct:i,access:n,struct:o},this.arrayBufferSize=0,this.shouldUpdate=!1,this.useStruct=i,this.bufferElements=[],this.inputs={},this.buffer=null,this.setBindings(o),this.setBufferAttributes(),this.setWGSLFragment()}get resourceLayout(){return{buffer:{type:At(this)}}}get resource(){return{buffer:this.buffer}}setBindings(e){Object.keys(e).forEach(t=>{const s={};for(const r in e[t])r!=="value"&&(s[r]=e[t][r]);Object.defineProperty(s,"value",{get(){return s._value},set(r){s._value=r,s.shouldUpdate=!0}}),s.value=e[t].value,(s.value instanceof A||s.value instanceof f)&&s.value.onChange(()=>s.shouldUpdate=!0),this.inputs[t]=s})}setBufferAttributes(){const e=Object.keys(this.inputs).filter(s=>this.inputs[s].type.indexOf("array")!==-1);let t=Object.keys(this.inputs).sort((s,r)=>{const i=Math.min(0,this.inputs[s].type.indexOf("array")),n=Math.min(0,this.inputs[r].type.indexOf("array"));return i-n});if(e.length>1&&(t=t.filter(s=>!e.includes(s))),t.forEach(s=>{const r=this.inputs[s],i={name:G(r.name??s),key:s,type:r.type},n=r.type.indexOf("array")!==-1&&(Array.isArray(r.value)||ArrayBuffer.isView(r.value));this.bufferElements.push(n?new st({...i,arrayLength:r.value.length}):new Ue(i))}),this.bufferElements.forEach((s,r)=>{const i=r===0?0:this.bufferElements[r-1].endOffset+1;s.setAlignment(i)}),e.length>1)if(e.map(i=>{const n=this.inputs[i],o=tt(n.type.replace("array","").replace("<","").replace(">",""));return n.value.length/o.numElements}).every((i,n,o)=>i===o[0])){const i=e.map(a=>{const h=this.inputs[a];return new Ae({name:G(h.name??a),key:a,type:h.type,arrayLength:h.value.length})}),n=e.map(a=>{const h=this.inputs[a];return new Ue({name:G(h.name??a),key:a,type:h.type.replace("array","").replace("<","").replace(">","")})});n.forEach((a,h)=>{h===0?this.bufferElements.length?a.setAlignmentFromPosition({row:this.bufferElements[this.bufferElements.length-1].alignment.end.row+1,byte:0}):a.setAlignment(0):a.setAlignment(n[h-1].endOffset+1)});const o=n[n.length-1].endOffset+1-n[0].startOffset;i.forEach((a,h)=>{a.setAlignment(n[h].startOffset,o)}),this.bufferElements=[...this.bufferElements,...i]}else V(`BufferBinding: "${this.label}" contains multiple array inputs that should use an interleaved array, but their sizes do not match. These inputs cannot be added to the BufferBinding: "${e.join(", ")}"`);this.arrayBufferSize=this.bufferElements.length?this.bufferElements[this.bufferElements.length-1].paddedByteCount:0,this.arrayBuffer=new ArrayBuffer(this.arrayBufferSize),this.arrayView=new DataView(this.arrayBuffer,0,this.arrayBuffer.byteLength),this.bufferElements.forEach(s=>{s.setView(this.arrayBuffer,this.arrayView)}),this.shouldUpdate=this.arrayBufferSize>0}setWGSLFragment(){const e=ee(this.label);if(this.useStruct){const t=this.bufferElements.filter(r=>!(r instanceof Ae)),s=this.bufferElements.filter(r=>r instanceof Ae);if(s.length){const r=this.bindingType==="uniform"?`, ${s[0].numElements}`:"";if(t.length){this.wgslStructFragment=`struct ${e}Element {
	${s.map(o=>o.name+": "+o.type.replace("array","").replace("<","").replace(">","")).join(`,
	`)}
};

`;const i=`${this.name}Element: array<${e}Element${r}>,`;this.wgslStructFragment+=`struct ${e} {
	${t.map(o=>o.name+": "+o.type).join(`,
	`)}
	${i}
};`;const n=Pe(this);this.wgslGroupFragment=[`${n} ${this.name}: ${e};`]}else{this.wgslStructFragment=`struct ${e} {
	${this.bufferElements.map(n=>n.name+": "+n.type.replace("array","").replace("<","").replace(">","")).join(`,
	`)}
};`;const i=Pe(this);this.wgslGroupFragment=[`${i} ${this.name}: array<${e}${r}>;`]}}else{this.wgslStructFragment=`struct ${e} {
	${this.bufferElements.map(i=>{const n=this.bindingType==="uniform"&&"numElements"in i?`array<${i.type.replace("array","").replace("<","").replace(">","")}, ${i.numElements}>`:i.type;return i.name+": "+n}).join(`,
	`)}
};`;const r=Pe(this);this.wgslGroupFragment=[`${r} ${this.name}: ${e};`]}}else this.wgslStructFragment="",this.wgslGroupFragment=this.bufferElements.map(t=>`${Pe(this)} ${t.name}: ${t.type};`)}shouldUpdateBinding(e=""){const t=Object.keys(this.inputs).find(s=>this.inputs[s].name===e);t&&(this.inputs[t].shouldUpdate=!0)}update(){Object.keys(this.inputs).forEach(e=>{const t=this.inputs[e],s=this.bufferElements.find(r=>r.key===e);t.shouldUpdate&&s&&(t.onBeforeUpdate&&t.onBeforeUpdate(),s.update(t.value),this.shouldUpdate=!0,t.shouldUpdate=!1)})}extractBufferElementDataFromBufferResult({result:e,bufferElementName:t}){const s=this.bufferElements.find(r=>r.name===t);return s?s.extractDataFromBufferResult(e):e}}class Fe extends de{constructor({label:e="Work",name:t="work",bindingType:s,useStruct:r=!0,struct:i={},visibility:n,access:o="read_write",shouldCopyResult:a=!1}){s="storage",n="compute",super({label:e,name:t,bindingType:s,useStruct:r,struct:i,visibility:n,access:o}),this.options={...this.options,shouldCopyResult:a},this.shouldCopyResult=a,this.resultBuffer=null}}class ve{constructor(e,{label:t="BindGroup",index:s=0,bindings:r=[],uniforms:i,storages:n}={}){this.type="BindGroup",e=e&&e.renderer||e,U(e,this.type),this.renderer=e,this.options={label:t,index:s,bindings:r,...i&&{uniforms:i},...n&&{storages:n}},this.index=s,this.uuid=R(),this.bindings=[],r.length&&this.addBindings(r),(this.options.uniforms||this.options.storages)&&this.setInputBindings(),this.resetEntries(),this.bindGroupLayout=null,this.bindGroup=null,this.needsPipelineFlush=!1,this.renderer.addBindGroup(this)}setIndex(e){this.index=e}addBindings(e=[]){this.bindings=[...this.bindings,...e]}addBinding(e){this.bindings.push(e)}createInputBindings(e="uniform",t={}){return[...Object.keys(t).map(s=>{const r=t[s],i={label:ee(r.label||s),name:s,bindingType:e,useStruct:!0,visibility:r.access==="read_write"?"compute":r.visibility,access:r.access??"read",struct:r.struct,...r.shouldCopyResult!==void 0&&{shouldCopyResult:r.shouldCopyResult}},n=i.access==="read_write"?Fe:de;return r.useStruct!==!1?new n(i):Object.keys(r.struct).map(o=>(i.label=ee(r.label?r.label+o:s+o),i.name=s+o,i.useStruct=!1,i.struct={[o]:r.struct[o]},new n(i)))})].flat()}setInputBindings(){this.addBindings([...this.createInputBindings("uniform",this.options.uniforms),...this.createInputBindings("storage",this.options.storages)])}get shouldCreateBindGroup(){return!this.bindGroup&&!!this.bindings.length}resetEntries(){this.entries={bindGroupLayout:[],bindGroup:[]}}createBindGroup(){this.fillEntries(),this.setBindGroupLayout(),this.setBindGroup()}resetBindGroup(){this.entries.bindGroup=[],this.bindings.forEach(e=>{this.entries.bindGroup.push({binding:this.entries.bindGroup.length,resource:e.resource})}),this.setBindGroup()}resetBindGroupLayout(){this.entries.bindGroupLayout=[],this.bindings.forEach(e=>{this.entries.bindGroupLayout.push({binding:this.entries.bindGroupLayout.length,...e.resourceLayout,visibility:e.visibility})}),this.setBindGroupLayout()}loseContext(){this.resetEntries(),this.bufferBindings.forEach(e=>{e.buffer=null,"resultBuffer"in e&&(e.resultBuffer=null)}),this.bindGroup=null,this.bindGroupLayout=null,this.needsPipelineFlush=!0}get bufferBindings(){return this.bindings.filter(e=>e instanceof de||e instanceof Fe)}createBindingBuffer(e){e.buffer=this.renderer.createBuffer({label:this.options.label+": "+e.bindingType+" buffer from: "+e.label,size:e.arrayBuffer.byteLength,usage:e.bindingType==="uniform"?GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC|GPUBufferUsage.VERTEX:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC|GPUBufferUsage.VERTEX}),"resultBuffer"in e&&(e.resultBuffer=this.renderer.createBuffer({label:this.options.label+": Result buffer from: "+e.label,size:e.arrayBuffer.byteLength,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}))}fillEntries(){this.bindings.forEach(e=>{e.visibility||(e.visibility=GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE),"buffer"in e&&!e.buffer&&this.createBindingBuffer(e),this.entries.bindGroupLayout.push({binding:this.entries.bindGroupLayout.length,...e.resourceLayout,visibility:e.visibility}),this.entries.bindGroup.push({binding:this.entries.bindGroup.length,resource:e.resource})})}getBindingByName(e=""){return this.bindings.find(t=>t.name===e)}setBindGroupLayout(){this.bindGroupLayout=this.renderer.createBindGroupLayout({label:this.options.label+" layout",entries:this.entries.bindGroupLayout})}setBindGroup(){this.bindGroup=this.renderer.createBindGroup({label:this.options.label,layout:this.bindGroupLayout,entries:this.entries.bindGroup})}updateBufferBindings(){this.bufferBindings.forEach((e,t)=>{e.update(),e.shouldUpdate&&(!e.useStruct&&e.bufferElements.length>1?this.renderer.queueWriteBuffer(e.buffer,0,e.bufferElements[t].view):this.renderer.queueWriteBuffer(e.buffer,0,e.arrayBuffer)),e.shouldUpdate=!1})}update(){this.updateBufferBindings();const e=this.bindings.some(s=>s.shouldResetBindGroup),t=this.bindings.some(s=>s.shouldResetBindGroupLayout);(e||t)&&this.renderer.onAfterCommandEncoderSubmission.add(()=>{this.bindings.forEach(s=>{s.shouldResetBindGroup=!1,s.shouldResetBindGroupLayout=!1})},{once:!0}),t&&(this.resetBindGroupLayout(),this.needsPipelineFlush=!0),e&&this.resetBindGroup()}clone({bindings:e=[],keepLayout:t=!1}={}){const s={...this.options};s.label+=" (copy)";const r=new this.constructor(this.renderer,{label:s.label});return r.setIndex(this.index),r.options=s,(e.length?e:this.bindings).forEach((n,o)=>{r.addBinding(n),"buffer"in n&&!n.buffer&&r.createBindingBuffer(n),t||r.entries.bindGroupLayout.push({binding:r.entries.bindGroupLayout.length,...n.resourceLayout,visibility:n.visibility}),r.entries.bindGroup.push({binding:r.entries.bindGroup.length,resource:n.resource})}),t&&(r.entries.bindGroupLayout=[...this.entries.bindGroupLayout]),r.setBindGroupLayout(),r.setBindGroup(),r}destroy(){this.renderer.removeBindGroup(this),this.bufferBindings.forEach(e=>{var t,s;"buffer"in e&&(this.renderer.removeBuffer(e.buffer),(t=e.buffer)==null||t.destroy(),e.buffer=null),"resultBuffer"in e&&(this.renderer.removeBuffer(e.resultBuffer),(s=e.resultBuffer)==null||s.destroy(),e.resultBuffer=null)}),this.bindings=[],this.bindGroupLayout=null,this.bindGroup=null,this.resetEntries()}}class _e extends we{constructor({label:e="Texture",name:t="texture",bindingType:s,visibility:r,texture:i,format:n="rgba8unorm",access:o="write",viewDimension:a="2d",multisampled:h=!1}){s=s??"texture",s==="storageTexture"&&(r="compute"),super({label:e,name:t,bindingType:s,visibility:r}),this.options={...this.options,texture:i,format:n,access:o,viewDimension:a,multisampled:h},this.resource=i,this.setWGSLFragment()}get resourceLayout(){return Ft(this)}get resource(){return this.texture instanceof GPUTexture?this.texture.createView({label:this.options.label+" view"}):this.texture instanceof GPUExternalTexture?this.texture:null}set resource(e){(e||this.texture)&&(this.shouldResetBindGroup=!0),this.texture=e}setBindingType(e){e!==this.bindingType&&(e&&(this.shouldResetBindGroupLayout=!0),this.bindingType=e,this.setWGSLFragment())}setWGSLFragment(){this.wgslGroupFragment=[`${Ut(this)}`]}}let kt=0;class Re{constructor(){this.parent=null,this.children=[],Object.defineProperty(this,"object3DIndex",{value:kt++}),this.setMatrices(),this.setTransforms()}get parent(){return this._parent}set parent(e){var t;this.parent&&(this.parent.children=this.parent.children.filter(s=>s.object3DIndex!==this.object3DIndex)),this._parent=e,(t=this._parent)==null||t.children.push(this)}setTransforms(){this.transforms={origin:{model:new f},quaternion:new Y,rotation:new f,position:{world:new f},scale:new f(1)},this.rotation.onChange(()=>this.applyRotation()),this.position.onChange(()=>this.applyPosition()),this.scale.onChange(()=>this.applyScale()),this.transformOrigin.onChange(()=>this.applyTransformOrigin())}get rotation(){return this.transforms.rotation}set rotation(e){this.transforms.rotation=e,this.applyRotation()}get quaternion(){return this.transforms.quaternion}set quaternion(e){this.transforms.quaternion=e}get position(){return this.transforms.position.world}set position(e){this.transforms.position.world=e}get scale(){return this.transforms.scale}set scale(e){this.transforms.scale=e,this.applyScale()}get transformOrigin(){return this.transforms.origin.model}set transformOrigin(e){this.transforms.origin.model=e}applyRotation(){this.quaternion.setFromVec3(this.rotation),this.shouldUpdateModelMatrix()}applyPosition(){this.shouldUpdateModelMatrix()}applyScale(){this.shouldUpdateModelMatrix()}applyTransformOrigin(){this.shouldUpdateModelMatrix()}setMatrices(){this.matrices={model:{matrix:new z,shouldUpdate:!1,onUpdate:()=>this.updateModelMatrix()},world:{matrix:new z,shouldUpdate:!1,onUpdate:()=>this.updateWorldMatrix()}}}get modelMatrix(){return this.matrices.model.matrix}set modelMatrix(e){this.matrices.model.matrix=e,this.shouldUpdateModelMatrix()}shouldUpdateModelMatrix(){this.matrices.model.shouldUpdate=!0,this.shouldUpdateWorldMatrix()}get worldMatrix(){return this.matrices.world.matrix}set worldMatrix(e){this.matrices.world.matrix=e,this.shouldUpdateWorldMatrix()}shouldUpdateWorldMatrix(){this.matrices.world.shouldUpdate=!0}lookAt(e=new f){const t=new z().lookAt(e,this.position);this.quaternion.setFromRotationMatrix(t),this.shouldUpdateModelMatrix()}updateModelMatrix(){this.modelMatrix=this.modelMatrix.composeFromOrigin(this.position,this.quaternion,this.scale,this.transformOrigin),this.shouldUpdateWorldMatrix()}updateWorldMatrix(){this.parent?this.worldMatrix.multiplyMatrices(this.parent.worldMatrix,this.modelMatrix):this.worldMatrix.copy(this.modelMatrix),this.children.forEach(e=>{e.shouldUpdateWorldMatrix()})}onAfterMatrixStackUpdate(){}updateMatrixStack(){if(this.parent&&this.parent.constructor.name==="Object3D"&&this.parent.updateMatrixStack(),!!Object.keys(this.matrices).find(t=>this.matrices[t].shouldUpdate)){for(const t in this.matrices)this.matrices[t].shouldUpdate&&(this.matrices[t].onUpdate(),this.matrices[t].shouldUpdate=!1);this.onAfterMatrixStackUpdate()}}}const it={name:"texture",generateMips:!1,flipY:!1,format:"rgba8unorm",premultipliedAlpha:!0,placeholderColor:[0,0,0,255],useExternalTextures:!0,fromTexture:null,viewDimension:"2d",cache:!0};class se extends Re{constructor(t,s=it){super();D(this,Z,void 0);D(this,Q,void 0);D(this,ce,void 0);D(this,pe,void 0);_(this,Z,new f(1)),_(this,Q,new f(1)),_(this,ce,new f(1)),_(this,pe,new z),this._onSourceLoadedCallback=()=>{},this._onSourceUploadedCallback=()=>{},this.type="Texture",t=t&&t.renderer||t,U(t,s.label?s.label+" "+this.type:this.type),this.renderer=t,this.uuid=R();const r={...it,source:s.fromTexture?s.fromTexture.options.source:null,sourceType:s.fromTexture?s.fromTexture.options.sourceType:null};this.options={...r,...s},this.options.label=this.options.label??this.options.name,this.texture=null,this.externalTexture=null,this.source=null,this.size={width:1,height:1,depth:1},this.textureMatrix=new de({label:this.options.label+": model matrix",name:this.options.name+"Matrix",useStruct:!1,struct:{matrix:{name:this.options.name+"Matrix",type:"mat4x4f",value:this.modelMatrix}}}),this.setBindings(),this._parentMesh=null,this.sourceLoaded=!1,this.sourceUploaded=!1,this.shouldUpdate=!1,this.renderer.addTexture(this),this.createTexture()}setBindings(){this.bindings=[new _e({label:this.options.label+": texture",name:this.options.name,texture:this.options.sourceType==="externalVideo"?this.externalTexture:this.texture,bindingType:this.options.sourceType==="externalVideo"?"externalTexture":"texture",viewDimension:this.options.viewDimension}),this.textureMatrix]}get textureBinding(){return this.bindings[0]}get parentMesh(){return this._parentMesh}set parentMesh(t){this._parentMesh=t,this.resize()}get sourceLoaded(){return this._sourceLoaded}set sourceLoaded(t){t&&!this.sourceLoaded&&this._onSourceLoadedCallback&&this._onSourceLoadedCallback(),this._sourceLoaded=t}get sourceUploaded(){return this._sourceUploaded}set sourceUploaded(t){t&&!this.sourceUploaded&&this._onSourceUploadedCallback&&this._onSourceUploadedCallback(),this._sourceUploaded=t}setTransforms(){super.setTransforms(),this.transforms.quaternion.setAxisOrder("ZXY"),this.transforms.origin.model.set(.5,.5,0)}updateModelMatrix(){if(!this.parentMesh)return;const t=this.parentMesh.scale?this.parentMesh.scale:new f(1,1,1),s=this.parentMesh.boundingRect?this.parentMesh.boundingRect.width*t.x:this.size.width,r=this.parentMesh.boundingRect?this.parentMesh.boundingRect.height*t.y:this.size.height,i=s/r,n=this.size.width/this.size.height;s>r?(M(this,Z).set(i,1,1),M(this,Q).set(1/n,1,1)):(M(this,Z).set(1,1/i,1),M(this,Q).set(1,n,1));const o=i>n!=s>r?1:s>r?M(this,Z).x*M(this,Q).x:M(this,Q).y*M(this,Z).y;M(this,ce).set(1/(o*this.scale.x),1/(o*this.scale.y),1),M(this,pe).rotateFromQuaternion(this.quaternion),this.modelMatrix.identity().premultiplyTranslate(this.transformOrigin.clone().multiplyScalar(-1)).premultiplyScale(M(this,ce)).premultiplyScale(M(this,Z)).premultiply(M(this,pe)).premultiplyScale(M(this,Q)).premultiplyTranslate(this.transformOrigin).translate(this.position)}onAfterMatrixStackUpdate(){this.textureMatrix.shouldUpdateBinding(this.options.name+"Matrix")}resize(){this.source&&this.source instanceof HTMLCanvasElement&&(this.source.width!==this.size.width||this.source.height!==this.size.height)&&(this.setSourceSize(),this.createTexture()),this.shouldUpdateModelMatrix()}getNumMipLevels(...t){const s=Math.max(...t);return 1+Math.log2(s)|0}uploadTexture(){this.renderer.uploadTexture(this),this.shouldUpdate=!1}uploadVideoTexture(){this.externalTexture=this.renderer.importExternalTexture(this.source),this.textureBinding.resource=this.externalTexture,this.textureBinding.setBindingType("externalTexture"),this.shouldUpdate=!1,this.sourceUploaded=!0}copy(t){if(this.options.sourceType==="externalVideo"&&t.options.sourceType!=="externalVideo"){V(`${this.options.label}: cannot copy a GPUTexture to a GPUExternalTexture`);return}else if(this.options.sourceType!=="externalVideo"&&t.options.sourceType==="externalVideo"){V(`${this.options.label}: cannot copy a GPUExternalTexture to a GPUTexture`);return}this.options.fromTexture=t,this.options.sourceType=t.options.sourceType,this.options.generateMips=t.options.generateMips,this.options.flipY=t.options.flipY,this.options.format=t.options.format,this.options.premultipliedAlpha=t.options.premultipliedAlpha,this.options.placeholderColor=t.options.placeholderColor,this.options.useExternalTextures=t.options.useExternalTextures,this.sourceLoaded=t.sourceLoaded,this.sourceUploaded=t.sourceUploaded,t.texture&&(t.sourceLoaded&&(this.size=t.size,this.source=t.source,this.resize()),t.sourceUploaded?(this.texture=t.texture,this.textureBinding.resource=this.texture):this.createTexture())}createTexture(){var s;const t={label:this.options.label,format:this.options.format,size:[this.size.width,this.size.height,this.size.depth],dimensions:this.options.viewDimension==="1d"?"1d":this.options.viewDimension==="3d"?"3d":"2d",usage:this.source?GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST};this.options.sourceType!=="externalVideo"&&(t.mipLevelCount=this.options.generateMips?this.getNumMipLevels(this.size.width,this.size.height):1,(s=this.texture)==null||s.destroy(),this.texture=this.renderer.createTexture(t),this.textureBinding.resource=this.texture),this.shouldUpdate=!0}setSourceSize(){this.size={width:this.source.naturalWidth||this.source.width||this.source.videoWidth,height:this.source.naturalHeight||this.source.height||this.source.videoHeight,depth:1}}async loadImageBitmap(t){const r=await(await fetch(t)).blob();return await createImageBitmap(r,{colorSpaceConversion:"none"})}async loadImage(t){const s=typeof t=="string"?t:t.getAttribute("src");this.options.source=s,this.options.sourceType="image";const r=this.renderer.textures.find(i=>i.options.source===s);if(r&&r.texture&&r.sourceUploaded){this.copy(r);return}this.sourceLoaded=!1,this.sourceUploaded=!1,this.source=await this.loadImageBitmap(this.options.source),this.setSourceSize(),this.resize(),this.sourceLoaded=!0,this.createTexture()}onVideoFrameCallback(){this.videoFrameCallbackId&&(this.shouldUpdate=!0,this.source.requestVideoFrameCallback(this.onVideoFrameCallback.bind(this)))}onVideoLoaded(t){var s;this.sourceLoaded||(this.source=t,this.setSourceSize(),this.resize(),this.options.useExternalTextures?(this.options.sourceType="externalVideo",(s=this.texture)==null||s.destroy()):(this.options.sourceType="video",this.createTexture()),"requestVideoFrameCallback"in HTMLVideoElement.prototype&&(this.videoFrameCallbackId=this.source.requestVideoFrameCallback(this.onVideoFrameCallback.bind(this))),this.sourceLoaded=!0)}get isVideoSource(){return this.source&&(this.options.sourceType==="video"||this.options.sourceType==="externalVideo")}loadVideo(t){let s;typeof t=="string"?(s=document.createElement("video"),s.src=t):s=t,s.preload="auto",s.muted=!0,s.loop=!0,s.crossOrigin="anonymous",s.setAttribute("playsinline",""),this.options.source=s.src,this.sourceLoaded=!1,this.sourceUploaded=!1,s.readyState>=s.HAVE_ENOUGH_DATA?this.onVideoLoaded(s):s.addEventListener("canplaythrough",this.onVideoLoaded.bind(this,s),{once:!0}),isNaN(s.duration)&&s.load()}loadCanvas(t){this.options.source=t,this.options.sourceType="canvas",this.sourceLoaded=!1,this.sourceUploaded=!1,this.source=t,this.setSourceSize(),this.resize(),this.sourceLoaded=!0,this.createTexture()}onSourceLoaded(t){return t&&(this._onSourceLoadedCallback=t),this}onSourceUploaded(t){return t&&(this._onSourceUploadedCallback=t),this}render(){this.updateMatrixStack(),this.textureMatrix.update(),this.options.sourceType==="externalVideo"&&(this.shouldUpdate=!0),this.isVideoSource&&!this.videoFrameCallbackId&&this.source.readyState>=this.source.HAVE_CURRENT_DATA&&!this.source.paused&&(this.shouldUpdate=!0),this.shouldUpdate&&this.options.sourceType&&this.options.sourceType!=="externalVideo"&&this.uploadTexture()}destroy(){var t;this.videoFrameCallbackId&&this.source.cancelVideoFrameCallback(this.videoFrameCallbackId),this.isVideoSource&&this.source.removeEventListener("canplaythrough",this.onVideoLoaded.bind(this,this.source),{once:!0}),this.renderer.removeTexture(this),(t=this.texture)==null||t.destroy(),this.texture=null}}Z=new WeakMap,Q=new WeakMap,ce=new WeakMap,pe=new WeakMap;class ke extends ve{constructor(e,{label:t,index:s=0,bindings:r=[],uniforms:i,storages:n,textures:o=[],samplers:a=[]}={}){const h="TextureBindGroup";e=e&&e.renderer||e,U(e,h),super(e,{label:t,index:s,bindings:r,uniforms:i,storages:n}),this.options={...this.options,textures:[],samplers:[]},o.length&&o.forEach(u=>this.addTexture(u)),a.length&&a.forEach(u=>this.addSampler(u)),this.type=h}addTexture(e){this.textures.push(e),this.addBindings([...e.bindings])}get textures(){return this.options.textures}addSampler(e){this.samplers.push(e),this.addBindings([e.binding])}get samplers(){return this.options.samplers}get shouldCreateBindGroup(){return!this.bindGroup&&!!this.bindings.length&&!this.textures.find(e=>!(e.texture||e.externalTexture))&&!this.samplers.find(e=>!e.sampler)}updateTextures(){this.textures.forEach((e,t)=>{e instanceof se&&(e.options.fromTexture&&e.options.fromTexture.sourceUploaded&&!e.sourceUploaded&&e.copy(e.options.fromTexture),e.shouldUpdate&&e.options.sourceType&&e.options.sourceType==="externalVideo"&&e.uploadVideoTexture())})}update(){this.updateTextures(),super.update()}destroy(){super.destroy(),this.options.textures=[],this.options.samplers=[]}}class rt extends we{constructor({label:e="Sampler",name:t="sampler",bindingType:s,visibility:r,sampler:i,type:n="filtering"}){s=s??"sampler",super({label:e,name:t,bindingType:s,visibility:r}),this.options={...this.options,sampler:i,type:n},this.resource=i,this.setWGSLFragment()}get resourceLayout(){return{sampler:{type:this.options.type}}}get resource(){return this.sampler}set resource(e){e&&this.sampler&&(this.shouldResetBindGroup=!0),this.sampler=e}setWGSLFragment(){this.wgslGroupFragment=[`var ${this.name}: ${this.bindingType};`]}}class nt extends Re{constructor({fov:t=50,near:s=.01,far:r=150,width:i=1,height:n=1,pixelRatio:o=1,onMatricesChanged:a=()=>{}}={}){super();D(this,ye,void 0);D(this,ge,void 0);D(this,xe,void 0);D(this,be,void 0);this.position.set(0,0,10),this.onMatricesChanged=a,this.size={width:1,height:1},this.setPerspective({fov:t,near:s,far:r,width:i,height:n,pixelRatio:o})}setMatrices(){super.setMatrices(),this.matrices={...this.matrices,view:{matrix:new z,shouldUpdate:!1,onUpdate:()=>{this.viewMatrix.copy(this.modelMatrix).invert()}},projection:{matrix:new z,shouldUpdate:!1,onUpdate:()=>this.updateProjectionMatrix()}}}get viewMatrix(){return this.matrices.view.matrix}set viewMatrix(t){this.matrices.view.matrix=t,this.matrices.view.shouldUpdate=!0}get projectionMatrix(){return this.matrices.projection.matrix}set projectionMatrix(t){this.matrices.projection.matrix=t,this.shouldUpdateProjectionMatrix()}shouldUpdateProjectionMatrix(){this.matrices.projection.shouldUpdate=!0}updateModelMatrix(){super.updateModelMatrix(),this.setScreenRatios(),this.matrices.view.shouldUpdate=!0}get fov(){return M(this,ye)}set fov(t){t=Math.max(1,Math.min(t??this.fov,179)),t!==this.fov&&(_(this,ye,t),this.shouldUpdateProjectionMatrix()),this.setScreenRatios(),this.setCSSPerspective()}get near(){return M(this,ge)}set near(t){t=Math.max(t??this.near,.01),t!==this.near&&(_(this,ge,t),this.shouldUpdateProjectionMatrix())}get far(){return M(this,xe)}set far(t){t=Math.max(t??this.far,this.near+1),t!==this.far&&(_(this,xe,t),this.shouldUpdateProjectionMatrix())}get pixelRatio(){return M(this,be)}set pixelRatio(t){_(this,be,t??this.pixelRatio),this.setCSSPerspective()}setSize({width:t,height:s}){(t!==this.size.width||s!==this.size.height)&&this.shouldUpdateProjectionMatrix(),this.size.width=t,this.size.height=s,this.setScreenRatios(),this.setCSSPerspective()}setPerspective({fov:t=this.fov,near:s=this.near,far:r=this.far,width:i=this.size.width,height:n=this.size.height,pixelRatio:o=this.pixelRatio}={}){this.setSize({width:i,height:n}),this.pixelRatio=o,this.fov=t,this.near=s,this.far=r}onAfterMatrixStackUpdate(){this.onMatricesChanged()}setCSSPerspective(){this.CSSPerspective=Math.pow(Math.pow(this.size.width/(2*this.pixelRatio),2)+Math.pow(this.size.height/(2*this.pixelRatio),2),.5)/Math.tan(this.fov*.5*Math.PI/180)}setScreenRatios(t=0){const s=this.position.z;t<s?t-=s:t+=s;const r=this.fov*Math.PI/180,i=2*Math.tan(r/2)*Math.abs(t);this.screenRatio={width:i*this.size.width/this.size.height,height:i}}lookAt(t=new f){const s=new z().lookAt(this.position,t);this.quaternion.setFromRotationMatrix(s),this.shouldUpdateModelMatrix()}updateProjectionMatrix(){const t=this.size.width/this.size.height,s=this.near*Math.tan(Math.PI/180*.5*this.fov),r=2*s,i=t*r,n=-.5*i,o=n+i,a=s-r,h=2*this.near/(o-n),u=2*this.near/(s-a),c=(o+n)/(o-n),l=(s+a)/(s-a),p=-(this.far+this.near)/(this.far-this.near),y=-2*this.far*this.near/(this.far-this.near);this.projectionMatrix.set(h,0,0,0,0,u,0,0,c,l,p,-1,0,0,y,0)}}ye=new WeakMap,ge=new WeakMap,xe=new WeakMap,be=new WeakMap;class ot{constructor(e,{label:t="Sampler",name:s,addressModeU:r="repeat",addressModeV:i="repeat",magFilter:n="linear",minFilter:o="linear",mipmapFilter:a="linear",maxAnisotropy:h=1,type:u="filtering"}={}){this.type="Sampler",this.uuid=R(),e=e&&e.renderer||e,U(e,t?t+" "+this.type:this.type),this.renderer=e,this.label=t,!s&&!this.renderer.production&&(s="sampler"+this.renderer.samplers.length,V(`Sampler: you are trying to create a sampler without the mandatory name parameter. A default name will be used instead: ${s}`)),this.name=s,this.options={addressModeU:r,addressModeV:i,magFilter:n,minFilter:o,mipmapFilter:a,maxAnisotropy:h,type:u},this.createSampler(),this.createBinding()}createSampler(){this.sampler=this.renderer.createSampler(this)}createBinding(){this.binding=new rt({label:this.label,name:this.name,bindingType:"sampler",sampler:this.sampler,type:this.options.type})}}const at={label:"RenderTexture",name:"renderTexture",usage:"texture",access:"write",fromTexture:null,viewDimension:"2d",sampleCount:1};class te{constructor(e,t=at){e=e&&e.renderer||e,U(e,t.label?t.label+" RenderTexture":"RenderTexture"),this.type="RenderTexture",this.renderer=e,this.uuid=R(),this.options={...at,...t},this.options.format||(this.options.format=this.renderer.options.preferredFormat),this.size=this.options.size??{width:Math.floor(this.renderer.pixelRatioBoundingRect.width),height:Math.floor(this.renderer.pixelRatioBoundingRect.height),depth:1},this.setBindings(),this.renderer.addRenderTexture(this),this.createTexture()}copy(e){this.options.fromTexture=e,this.createTexture()}copyGPUTexture(e){this.size={width:e.width,height:e.height,depth:e.depthOrArrayLayers},this.texture=e,this.textureBinding.resource=this.texture}createTexture(){var e;if(this.options.fromTexture){this.copyGPUTexture(this.options.fromTexture.texture);return}(e=this.texture)==null||e.destroy(),this.texture=this.renderer.createTexture({label:this.options.label,format:this.options.format,size:[this.size.width,this.size.height,this.size.depth],dimensions:this.options.viewDimension==="1d"?"1d":this.options.viewDimension==="3d"?"3d":"2d",sampleCount:this.options.sampleCount,usage:this.options.usage!=="storageTexture"?GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT:GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST}),this.textureBinding.resource=this.texture}setBindings(){this.bindings=[new _e({label:this.options.label+": "+this.options.name+" render texture",name:this.options.name,texture:this.texture,bindingType:this.options.usage,format:this.options.format,viewDimension:this.options.viewDimension,multisampled:this.options.sampleCount>1})]}get textureBinding(){return this.bindings[0]}forceResize(e){this.size=e,this.createTexture()}resize(e=null){e||(e={width:Math.floor(this.renderer.pixelRatioBoundingRect.width),height:Math.floor(this.renderer.pixelRatioBoundingRect.height),depth:1}),!(e.width===this.size.width&&e.height===this.size.height&&e.depth===this.size.depth)&&this.forceResize(e)}destroy(){var e;this.renderer.removeRenderTexture(this),this.options.fromTexture||(e=this.texture)==null||e.destroy(),this.texture=null}}class Le{constructor(e,t){this.type="Material",e=e&&e.renderer||e,U(e,this.type),this.renderer=e,this.uuid=R();const{shaders:s,label:r,useAsyncPipeline:i,uniforms:n,storages:o,bindGroups:a,samplers:h,textures:u,renderTextures:c}=t;this.options={shaders:s,label:r,...i!==void 0&&{useAsyncPipeline:i},...n!==void 0&&{uniforms:n},...o!==void 0&&{storages:o},...a!==void 0&&{bindGroups:a},...h!==void 0&&{samplers:h},...u!==void 0&&{textures:u},...c!==void 0&&{renderTextures:c}},this.bindGroups=[],this.texturesBindGroups=[],this.clonedBindGroups=[],this.setBindGroups(),this.setTextures(),this.setSamplers()}compileMaterial(){const e=this.texturesBindGroup.bindings.length?1:0;this.bindGroups.length>=this.inputsBindGroups.length+e||this.createBindGroups()}get ready(){return!!(this.renderer.ready&&this.pipelineEntry&&this.pipelineEntry.pipeline&&this.pipelineEntry.ready)}loseContext(){this.textures.forEach(e=>{e.texture=null,e.sourceUploaded=!1}),this.renderTextures.forEach(e=>{e.texture=null}),[...this.bindGroups,...this.clonedBindGroups,...this.inputsBindGroups].forEach(e=>e.loseContext()),this.pipelineEntry.pipeline=null}restoreContext(){this.samplers.forEach(e=>{e.createSampler(),e.binding.resource=e.sampler}),this.textures.forEach(e=>{e.createTexture(),e.resize()}),this.renderTextures.forEach(e=>{e.resize(e.size)}),[...this.bindGroups,...this.clonedBindGroups,...this.inputsBindGroups].forEach(e=>{e.shouldCreateBindGroup&&e.createBindGroup(),e.bufferBindings.forEach(t=>t.shouldUpdate=!0)})}getShaderCode(e="full"){return this.pipelineEntry?(e=(()=>{switch(e){case"vertex":case"fragment":case"compute":case"full":return e;default:return"full"}})(),this.pipelineEntry.shaders[e].code):""}getAddedShaderCode(e="vertex"){return this.pipelineEntry?(e=(()=>{switch(e){case"vertex":case"fragment":case"compute":return e;default:return"vertex"}})(),this.pipelineEntry.shaders[e].head):""}setBindGroups(){var e;if(this.uniforms={},this.storages={},this.inputsBindGroups=[],this.inputsBindings=[],this.options.uniforms||this.options.storages){const t=new ve(this.renderer,{label:this.options.label+": Bindings bind group",uniforms:this.options.uniforms,storages:this.options.storages});this.processBindGroupBindings(t),this.inputsBindGroups.push(t)}(e=this.options.bindGroups)==null||e.forEach(t=>{this.processBindGroupBindings(t),this.inputsBindGroups.push(t)})}get texturesBindGroup(){return this.texturesBindGroups[0]}processBindGroupBindings(e){e.bindings.forEach(t=>{t.bindingType==="uniform"&&(this.uniforms={...this.uniforms,[t.name]:t.inputs}),t.bindingType==="storage"&&(this.storages={...this.storages,[t.name]:t.inputs}),this.inputsBindings.push(t)})}createBindGroups(){var e;this.texturesBindGroup.shouldCreateBindGroup&&(this.texturesBindGroup.setIndex(this.bindGroups.length),this.texturesBindGroup.createBindGroup(),this.bindGroups.push(this.texturesBindGroup)),this.inputsBindGroups.forEach(t=>{t.shouldCreateBindGroup&&(t.setIndex(this.bindGroups.length),t.createBindGroup(),this.bindGroups.push(t))}),(e=this.options.bindGroups)==null||e.forEach(t=>{!t.shouldCreateBindGroup&&!this.bindGroups.find(s=>s.uuid===t.uuid)&&(t.setIndex(this.bindGroups.length),this.bindGroups.push(t)),t instanceof ke&&!this.texturesBindGroups.find(s=>s.uuid===t.uuid)&&(this.texturesBindGroups.push(t),t.textures.forEach(s=>{s instanceof se&&!this.textures.find(r=>r.uuid===s.uuid)?this.textures.push(s):s instanceof te&&!this.renderTextures.find(r=>r.uuid===s.uuid)&&this.renderTextures.push(s)}))})}cloneBindGroup({bindGroup:e,bindings:t=[],keepLayout:s=!0}){if(!e)return null;const r=e.clone({bindings:t,keepLayout:s});return this.clonedBindGroups.push(r),r}getBindGroupByBindingName(e=""){return(this.ready?this.bindGroups:this.inputsBindGroups).find(t=>t.bindings.find(s=>s.name===e))}destroyBindGroup(e){const t=this.renderer.getObjectsByBindGroup(e);(!t||!t.find(r=>r.material.uuid!==this.uuid))&&e.destroy()}destroyBindGroups(){this.bindGroups.forEach(e=>this.destroyBindGroup(e)),this.clonedBindGroups.forEach(e=>this.destroyBindGroup(e)),this.texturesBindGroups.forEach(e=>this.destroyBindGroup(e)),this.texturesBindGroups=[],this.inputsBindGroups=[],this.bindGroups=[],this.clonedBindGroups=[]}updateBindGroups(){this.bindGroups.forEach(e=>{e.update(),e.needsPipelineFlush&&this.pipelineEntry.ready&&(this.pipelineEntry.flushPipelineEntry(this.bindGroups),e.needsPipelineFlush=!1)})}getBindingByName(e=""){return this.inputsBindings.find(t=>t.name===e)}getBufferBindingByName(e=""){return this.inputsBindings.find(t=>t.name===e&&"buffer"in t)}shouldUpdateInputsBindings(e,t){if(!e)return;const s=this.getBindingByName(e);s&&(t?s.shouldUpdateBinding(t):Object.keys(s.inputs).forEach(r=>s.shouldUpdateBinding(r)))}setTextures(){var e,t;this.textures=[],this.renderTextures=[],this.texturesBindGroups.push(new ke(this.renderer,{label:this.options.label+": Textures bind group"})),(e=this.options.textures)==null||e.forEach(s=>{this.addTexture(s)}),(t=this.options.renderTextures)==null||t.forEach(s=>{this.addTexture(s)})}addTexture(e){e instanceof se?this.textures.push(e):e instanceof te&&this.renderTextures.push(e),(this.options.shaders.vertex&&this.options.shaders.vertex.code.indexOf(e.options.name)!==-1||this.options.shaders.fragment&&this.options.shaders.fragment.code.indexOf(e.options.name)!==-1||this.options.shaders.compute&&this.options.shaders.compute.code.indexOf(e.options.name)!==-1)&&this.texturesBindGroup.addTexture(e)}destroyTexture(e){if(e.options.cache)return;const t=this.renderer.getObjectsByTexture(e);(!t||!t.some(r=>r.material.uuid!==this.uuid))&&e.destroy()}destroyTextures(){var e,t;(e=this.textures)==null||e.forEach(s=>this.destroyTexture(s)),(t=this.renderTextures)==null||t.forEach(s=>this.destroyTexture(s)),this.textures=[],this.renderTextures=[]}setSamplers(){var t;if(this.samplers=[],(t=this.options.samplers)==null||t.forEach(s=>{this.addSampler(s)}),!this.samplers.find(s=>s.name==="defaultSampler")){const s=new ot(this.renderer,{name:"defaultSampler"});this.addSampler(s)}}addSampler(e){this.samplers.push(e),(this.options.shaders.vertex&&this.options.shaders.vertex.code.indexOf(e.name)!==-1||this.options.shaders.fragment&&this.options.shaders.fragment.code.indexOf(e.name)!==-1||this.options.shaders.compute&&this.options.shaders.compute.code.indexOf(e.name)!==-1)&&this.texturesBindGroup.addSampler(e)}async getBufferResult(e){await e.mapAsync(GPUMapMode.READ);const t=new Float32Array(e.getMappedRange().slice(0));return e.unmap(),t}async getBufferBindingResultByBindingName(e=""){const t=this.getBufferBindingByName(e);if(t&&"buffer"in t){const s=this.renderer.copyBufferToBuffer({srcBuffer:t.buffer});return await this.getBufferResult(s)}else return new Float32Array(0)}async getBufferElementResultByNames({bindingName:e,bufferElementName:t}){const s=await this.getBufferBindingResultByBindingName(e);if(!t||s.length)return s;{const r=this.getBufferBindingByName(e);return r?r.extractBufferElementDataFromBufferResult({result:s,bufferElementName:t}):s}}onBeforeRender(){this.compileMaterial(),this.textures.forEach(e=>{e.render()}),this.updateBindGroups()}setPipeline(e){this.renderer.pipelineManager.setCurrentPipeline(e,this.pipelineEntry)}render(e){this.ready&&(this.setPipeline(e),this.bindGroups.forEach(t=>{e.setBindGroup(t.index,t.bindGroup)}))}destroy(){this.destroyBindGroups(),this.destroyTextures()}}class ht extends Le{constructor(e,t){e=e&&e.renderer||e;const s="ComputeMaterial";U(e,s),super(e,t),this.type=s,this.renderer=e;let{shaders:r,dispatchSize:i}=t;(!r||!r.compute)&&(r={compute:{code:"",entryPoint:"main"}}),r.compute.code||(r.compute.code="@compute @workgroup_size(1) fn main(){}"),r.compute.entryPoint||(r.compute.entryPoint="main"),this.options={...this.options,shaders:r,...t.dispatchSize!==void 0&&{dispatchSize:t.dispatchSize}},i||(i=1),Array.isArray(i)?(i[0]=Math.ceil(i[0]??1),i[1]=Math.ceil(i[1]??1),i[2]=Math.ceil(i[2]??1)):isNaN(i)||(i=[Math.ceil(i),1,1]),this.dispatchSize=i,this.pipelineEntry=this.renderer.pipelineManager.createComputePipeline({renderer:this.renderer,label:this.options.label+" compute pipeline",shaders:this.options.shaders,useAsync:this.options.useAsyncPipeline})}setPipelineEntryProperties(){this.pipelineEntry.setPipelineEntryProperties({bindGroups:this.bindGroups})}async compilePipelineEntry(){await this.pipelineEntry.compilePipelineEntry()}async compileMaterial(){super.compileMaterial(),this.pipelineEntry&&this.pipelineEntry.canCompile&&(this.setPipelineEntryProperties(),await this.compilePipelineEntry())}getShaderCode(e="compute"){return super.getShaderCode(e)}getAddedShaderCode(e="compute"){return super.getAddedShaderCode(e)}useCustomRender(e){e&&(this._useCustomRenderCallback=e)}render(e){this.ready&&(this.setPipeline(e),this._useCustomRenderCallback!==void 0?this._useCustomRenderCallback(e):(this.bindGroups.forEach(t=>{e.setBindGroup(t.index,t.bindGroup)}),e.dispatchWorkgroups(this.dispatchSize[0],this.dispatchSize[1],this.dispatchSize[2])))}copyBufferToResult(e){this.bindGroups.forEach(t=>{t.bufferBindings.forEach(s=>{s.shouldCopyResult&&s.resultBuffer.mapState==="unmapped"&&e.copyBufferToBuffer(s.buffer,0,s.resultBuffer,0,s.resultBuffer.size)})})}async getComputeResult({bindingName:e="",bufferElementName:t=""}){const s=this.getBufferBindingByName(e);if(s&&"resultBuffer"in s&&s.resultBuffer.mapState==="unmapped"){const r=await this.getBufferResult(s.resultBuffer);return t?s.extractBufferElementDataFromBufferResult({result:r,bufferElementName:t}):r}else return new Float32Array(0)}}let Lt=0;class ut{constructor(e,t={}){D(this,ne,void 0);var g;_(this,ne,!0),this._onReadyCallback=()=>{},this._onBeforeRenderCallback=()=>{},this._onRenderCallback=()=>{},this._onAfterRenderCallback=()=>{},this._onAfterResizeCallback=()=>{};const s="ComputePass";e=e&&e.renderer||e,U(e,t.label?`${t.label} ${s}`:s),t.label=t.label??"ComputePass "+((g=e.computePasses)==null?void 0:g.length),this.renderer=e,this.type=s,this.uuid=R(),Object.defineProperty(this,"index",{value:Lt++});const{label:r,shaders:i,renderOrder:n,uniforms:o,storages:a,bindGroups:h,samplers:u,textures:c,renderTextures:l,autoRender:p,useAsyncPipeline:y,texturesOptions:b,dispatchSize:x}=t;this.options={label:r,shaders:i,...p!==void 0&&{autoRender:p},...n!==void 0&&{renderOrder:n},...y!==void 0&&{useAsyncPipeline:y},...x!==void 0&&{dispatchSize:x},texturesOptions:b},this.renderOrder=n??0,p!==void 0&&_(this,ne,p),this.userData={},this.ready=!1,this.setComputeMaterial({label:this.options.label,shaders:this.options.shaders,uniforms:o,storages:a,bindGroups:h,samplers:u,textures:c,renderTextures:l,useAsyncPipeline:y,dispatchSize:x}),this.addToScene()}get ready(){return this._ready}set ready(e){e&&this._onReadyCallback&&this._onReadyCallback(),this._ready=e}addToScene(){this.renderer.computePasses.push(this),M(this,ne)&&this.renderer.scene.addComputePass(this)}removeFromScene(){M(this,ne)&&this.renderer.scene.removeComputePass(this),this.renderer.computePasses=this.renderer.computePasses.filter(e=>e.uuid!==this.uuid)}setComputeMaterial(e){this.material=new ht(this.renderer,e)}loseContext(){this.material.loseContext()}restoreContext(){this.material.restoreContext()}get textures(){var e;return((e=this.material)==null?void 0:e.textures)||[]}get renderTextures(){var e;return((e=this.material)==null?void 0:e.renderTextures)||[]}createTexture(e){e.name||(e.name="texture"+this.textures.length),e.label||(e.label=this.options.label+" "+e.name);const t=new se(this.renderer,{...e,...this.options.texturesOptions});return this.addTexture(t),t}addTexture(e){this.material.addTexture(e)}createRenderTexture(e){e.name||(e.name="renderTexture"+this.renderTextures.length);const t=new te(this.renderer,e);return this.addRenderTexture(t),t}addRenderTexture(e){this.material.addTexture(e)}get uniforms(){var e;return(e=this.material)==null?void 0:e.uniforms}get storages(){var e;return(e=this.material)==null?void 0:e.storages}resize(){this._onAfterResizeCallback&&this._onAfterResizeCallback()}onReady(e){return e&&(this._onReadyCallback=e),this}onBeforeRender(e){return e&&(this._onBeforeRenderCallback=e),this}onRender(e){return e&&(this._onRenderCallback=e),this}onAfterRender(e){return e&&(this._onAfterRenderCallback=e),this}useCustomRender(e){return this.material.useCustomRender(e),this}onAfterResize(e){return e&&(this._onAfterResizeCallback=e),this}onBeforeRenderPass(){this.renderer.ready&&(this.material&&this.material.ready&&!this.ready&&(this.ready=!0),this._onBeforeRenderCallback&&this._onBeforeRenderCallback(),this.material.onBeforeRender())}onRenderPass(e){this.material.ready&&(this._onRenderCallback&&this._onRenderCallback(),this.material.render(e))}onAfterRenderPass(){this._onAfterRenderCallback&&this._onAfterRenderCallback()}render(e){this.onBeforeRenderPass(),this.renderer.ready&&(this.onRenderPass(e),this.onAfterRenderPass())}copyBufferToResult(e){var t;(t=this.material)==null||t.copyBufferToResult(e)}async getComputeResult({bindingName:e,bufferElementName:t}){var s;return await((s=this.material)==null?void 0:s.getComputeResult({bindingName:e,bufferElementName:t}))}remove(){this.removeFromScene(),this.destroy()}destroy(){var e;(e=this.material)==null||e.destroy()}}ne=new WeakMap;const W=[new f,new f,new f,new f,new f,new f,new f,new f];class le{constructor(e=new f(1/0),t=new f(-1/0)){this.min=e,this.max=t}set(e=new f(1/0),t=new f(-1/0)){return this.min.copy(e),this.max.copy(t),this}clone(){return new le().set(this.min,this.max)}getCenter(){return this.max.clone().add(this.min).multiplyScalar(.5)}getSize(){return this.max.clone().sub(this.min)}applyMat4(e=new z){const t=[];this.min.z===this.max.z?(t[0]=W[0].set(this.min.x,this.min.y,this.min.z).applyMat4(e),t[1]=W[2].set(this.min.x,this.max.y,this.min.z).applyMat4(e),t[2]=W[4].set(this.max.x,this.min.y,this.min.z).applyMat4(e),t[3]=W[6].set(this.max.x,this.max.y,this.min.z).applyMat4(e)):(t[0]=W[0].set(this.min.x,this.min.y,this.min.z).applyMat4(e),t[1]=W[1].set(this.min.x,this.min.y,this.max.z).applyMat4(e),t[2]=W[2].set(this.min.x,this.max.y,this.min.z).applyMat4(e),t[3]=W[3].set(this.min.x,this.max.y,this.max.z).applyMat4(e),t[4]=W[4].set(this.max.x,this.min.y,this.min.z).applyMat4(e),t[5]=W[5].set(this.max.x,this.min.y,this.max.z).applyMat4(e),t[6]=W[6].set(this.max.x,this.max.y,this.min.z).applyMat4(e),t[7]=W[7].set(this.max.x,this.max.y,this.max.z).applyMat4(e));const s=new le;for(let r=0,i=t.length;r<i;r++)s.min.min(t[r]),s.max.max(t[r]);return s}}const dt={top:0,right:0,bottom:0,left:0};class lt{constructor({boundingBox:e=new le,modelViewProjectionMatrix:t=new z,containerBoundingRect:s={top:0,right:0,bottom:0,left:0,width:0,height:0,x:0,y:0},DOMFrustumMargins:r=dt,onReEnterView:i=()=>{},onLeaveView:n=()=>{}}){this.boundingBox=e,this.modelViewProjectionMatrix=t,this.containerBoundingRect=s,this.DOMFrustumMargins={...dt,...r},this.projectedBoundingRect={top:0,right:0,bottom:0,left:0,width:0,height:0,x:0,y:0},this.onReEnterView=i,this.onLeaveView=n,this.isIntersecting=!1,this.shouldUpdate=!1}setContainerBoundingRect(e){this.containerBoundingRect=e}get DOMFrustumBoundingRect(){return{top:this.projectedBoundingRect.top-this.DOMFrustumMargins.top,right:this.projectedBoundingRect.right+this.DOMFrustumMargins.right,bottom:this.projectedBoundingRect.bottom+this.DOMFrustumMargins.bottom,left:this.projectedBoundingRect.left-this.DOMFrustumMargins.left}}computeProjectedToDocumentCoords(){const e=this.boundingBox.applyMat4(this.modelViewProjectionMatrix);e.min.x=(e.min.x+1)*.5,e.max.x=(e.max.x+1)*.5,e.min.y=1-(e.min.y+1)*.5,e.max.y=1-(e.max.y+1)*.5;const{width:t,height:s,top:r,left:i}=this.containerBoundingRect;this.projectedBoundingRect={left:e.min.x*t+i,x:e.min.x*t+i,top:e.max.y*s+r,y:e.max.y*s+r,right:e.max.x*t+i,bottom:e.min.y*s+r,width:e.max.x*t+i-(e.min.x*t+i),height:e.min.y*s+r-(e.max.y*s+r)},this.intersectsContainer()}intersectsContainer(){Math.round(this.DOMFrustumBoundingRect.right)<=this.containerBoundingRect.left||Math.round(this.DOMFrustumBoundingRect.left)>=this.containerBoundingRect.left+this.containerBoundingRect.width||Math.round(this.DOMFrustumBoundingRect.bottom)<=this.containerBoundingRect.top||Math.round(this.DOMFrustumBoundingRect.top)>=this.containerBoundingRect.top+this.containerBoundingRect.height?(this.isIntersecting&&this.onLeaveView(),this.isIntersecting=!1):(this.isIntersecting||this.onReEnterView(),this.isIntersecting=!0)}}class De{constructor({verticesOrder:e="ccw",topology:t="triangle-list",instancesCount:s=1,vertexBuffers:r=[]}={}){D(this,Se);this.verticesCount=0,this.verticesOrder=e,this.topology=t,this.instancesCount=s,this.boundingBox=new le,this.type="Geometry",this.vertexBuffers=[],this.addVertexBuffer({name:"attributes"}),this.options={verticesOrder:e,instancesCount:s,vertexBuffers:r,topology:t},r.forEach(i=>{this.addVertexBuffer({stepMode:i.stepMode??"vertex",name:i.name,attributes:i.attributes})})}get shouldCompute(){return this.vertexBuffers.length&&!this.vertexBuffers[0].array}get ready(){return!this.shouldCompute&&!this.vertexBuffers.find(e=>!e.buffer)}addVertexBuffer({stepMode:e="vertex",name:t,attributes:s=[]}={}){const r={name:t??"attributes"+this.vertexBuffers.length,stepMode:e,arrayStride:0,bufferLength:0,attributes:[],buffer:null};return s==null||s.forEach(i=>{this.setAttribute({vertexBuffer:r,...i})}),this.vertexBuffers.push(r),r}getVertexBufferByName(e=""){return this.vertexBuffers.find(t=>t.name===e)}setAttribute({vertexBuffer:e=this.vertexBuffers[0],name:t,type:s="vec3f",bufferFormat:r="float32x3",size:i=3,array:n=new Float32Array(this.verticesCount*i),verticesStride:o=1}){const a=e.attributes,h=a.length;t||(t="geometryAttribute"+h),t==="position"&&(s!=="vec3f"||r!=="float32x3"||i!==3)&&(V(`Geometry 'position' attribute must have this exact properties set:
	type: 'vec3f',
	bufferFormat: 'float32x3',
	size: 3`),s="vec3f",r="float32x3",i=3);const u=n.length/i;t==="position"&&(this.verticesCount=u),e.stepMode==="vertex"&&this.verticesCount&&this.verticesCount!==u*o?I(`Geometry vertex attribute error. Attribute array of size ${i} must be of length: ${this.verticesCount*i}, current given: ${n.length}. (${this.verticesCount} vertices).`):e.stepMode==="instance"&&u!==this.instancesCount&&I(`Geometry instance attribute error. Attribute array of size ${i} must be of length: ${this.instancesCount*i}, current given: ${n.length}. (${this.instancesCount} instances).`);const c={name:t,type:s,bufferFormat:r,size:i,bufferLength:n.length,offset:h?a.reduce((l,p)=>l+p.bufferLength,0):0,bufferOffset:h?a[h-1].bufferOffset+a[h-1].size*4:0,array:n,verticesStride:o};e.bufferLength+=c.bufferLength*o,e.arrayStride+=c.size,e.attributes.push(c)}getAttributeByName(e){let t;return this.vertexBuffers.forEach(s=>{t=s.attributes.find(r=>r.name===e)}),t}computeGeometry(){this.shouldCompute&&(this.vertexBuffers.forEach((e,t)=>{if(t===0){const i=e.attributes.find(n=>n.name==="position");i||I("Geometry must have a 'position' attribute"),(i.type!=="vec3f"||i.bufferFormat!=="float32x3"||i.size!==3)&&(V(`Geometry 'position' attribute must have this exact properties set:
	type: 'vec3f',
	bufferFormat: 'float32x3',
	size: 3`),i.type="vec3f",i.bufferFormat="float32x3",i.size=3)}e.array=new Float32Array(e.bufferLength);let s=0,r=0;for(let i=0;i<e.bufferLength;i+=e.arrayStride){for(let n=0;n<e.attributes.length;n++){const{name:o,size:a,array:h,verticesStride:u}=e.attributes[n];for(let c=0;c<a;c++){const l=h[Math.floor(r/u)*a+c];e.array[s]=l,o==="position"&&(c%3===0?(this.boundingBox.min.x>l&&(this.boundingBox.min.x=l),this.boundingBox.max.x<l&&(this.boundingBox.max.x=l)):c%3===1?(this.boundingBox.min.y>l&&(this.boundingBox.min.y=l),this.boundingBox.max.y<l&&(this.boundingBox.max.y=l)):c%3===2&&(this.boundingBox.min.z>l&&(this.boundingBox.min.z=l),this.boundingBox.max.z<l&&(this.boundingBox.max.z=l))),s++}}r++}}),Gt(this,Se,zt).call(this))}setGeometryBuffers(e){this.vertexBuffers.forEach((t,s)=>{e.setVertexBuffer(s,t.buffer)})}drawGeometry(e){e.draw(this.verticesCount,this.instancesCount)}render(e){this.ready&&(this.setGeometryBuffers(e),this.drawGeometry(e))}destroy(){this.vertexBuffers.forEach(e=>{var t;(t=e.buffer)==null||t.destroy(),e.buffer=null})}}Se=new WeakSet,zt=function(){let e=-1;this.wgslStructFragment=`struct Attributes {
	@builtin(vertex_index) vertexIndex : u32,
	@builtin(instance_index) instanceIndex : u32,${this.vertexBuffers.map(t=>t.attributes.map(s=>(e++,`
	@location(${e}) ${s.name}: ${s.type}`))).join(",")}
};`};class Be extends De{constructor({verticesOrder:e="ccw",topology:t="triangle-list",instancesCount:s=1,vertexBuffers:r=[]}={}){super({verticesOrder:e,topology:t,instancesCount:s,vertexBuffers:r}),this.type="IndexedGeometry"}get ready(){return!this.shouldCompute&&!this.vertexBuffers.find(e=>!e.buffer)&&this.indexBuffer&&!!this.indexBuffer.buffer}get useUint16IndexArray(){return this.verticesCount<256*256}setIndexBuffer({bufferFormat:e="uint32",array:t=new Uint32Array(0)}){this.indexBuffer={array:t,bufferFormat:e,bufferLength:t.length,buffer:null}}setGeometryBuffers(e){super.setGeometryBuffers(e),e.setIndexBuffer(this.indexBuffer.buffer,this.indexBuffer.bufferFormat)}drawGeometry(e){e.drawIndexed(this.indexBuffer.bufferLength,this.instancesCount)}destroy(){var e,t;super.destroy(),(t=(e=this.indexBuffer)==null?void 0:e.buffer)==null||t.destroy(),this.indexBuffer.buffer=null}}class Ve extends Be{constructor({widthSegments:e=1,heightSegments:t=1,instancesCount:s=1,vertexBuffers:r=[],topology:i}={}){super({verticesOrder:"cw",topology:i,instancesCount:s,vertexBuffers:r}),this.type="PlaneGeometry",e=Math.floor(e),t=Math.floor(t),this.definition={id:e*t+e,width:e,height:t,count:e*t};const n=(this.definition.width+1)*(this.definition.height+1),o=this.getIndexedVerticesAndUVs(n);Object.keys(o).forEach(a=>{this.setAttribute(o[a])}),this.setIndexArray()}setIndexArray(){const e=this.useUint16IndexArray?new Uint16Array(this.definition.count*6):new Uint32Array(this.definition.count*6);let t=0;for(let s=0;s<this.definition.height;s++)for(let r=0;r<this.definition.width;r++)e[t++]=r+s*(this.definition.width+1),e[t++]=this.definition.width+r+1+s*(this.definition.width+1),e[t++]=r+1+s*(this.definition.width+1),e[t++]=r+1+s*(this.definition.width+1),e[t++]=this.definition.width+r+1+s*(this.definition.width+1),e[t++]=this.definition.width+r+2+s*(this.definition.width+1);this.setIndexBuffer({array:e,bufferFormat:this.useUint16IndexArray?"uint16":"uint32"})}getIndexedVerticesAndUVs(e){const t={name:"uv",type:"vec2f",bufferFormat:"float32x2",size:2,array:new Float32Array(e*2)},s={name:"position",type:"vec3f",bufferFormat:"float32x3",size:3,array:new Float32Array(e*3)},r={name:"normal",type:"vec3f",bufferFormat:"float32x3",size:3,array:new Float32Array(e*3)};let i=0,n=0,o=0;for(let a=0;a<=this.definition.height;a++)for(let h=0;h<=this.definition.width;h++)t.array[o++]=h/this.definition.width,t.array[o++]=1-a/this.definition.height,s.array[i++]=h*2/this.definition.width-1,s.array[i++]=a*2/this.definition.height-1,s.array[i++]=0,r.array[n++]=0,r.array[n++]=0,r.array[n++]=1;return{position:s,uv:t,normal:r}}}class ct extends Le{constructor(e,t){e=e&&e.renderer||e;const s="RenderMaterial";U(e,s),super(e,t),this.type=s,this.renderer=e;const{shaders:r,label:i,useAsyncPipeline:n,uniforms:o,storages:a,bindGroups:h,...u}=t;r.vertex.entryPoint||(r.vertex.entryPoint="main"),r.fragment.entryPoint||(r.fragment.entryPoint="main"),this.options={...this.options,shaders:r,rendering:u},this.pipelineEntry=this.renderer.pipelineManager.createRenderPipeline({renderer:this.renderer,label:this.options.label+" render pipeline",shaders:this.options.shaders,useAsync:this.options.useAsyncPipeline,...this.options.rendering}),this.attributes=null}setPipelineEntryProperties(){this.pipelineEntry.setPipelineEntryProperties({attributes:this.attributes,bindGroups:this.bindGroups})}async compilePipelineEntry(){await this.pipelineEntry.compilePipelineEntry()}async compileMaterial(){super.compileMaterial(),this.attributes&&this.pipelineEntry&&this.pipelineEntry.canCompile&&(this.setPipelineEntryProperties(),await this.compilePipelineEntry())}setRenderingOptions(e={}){const t=Object.keys(e).filter(s=>e[s]!==this.options.rendering[s]);this.options.rendering={...this.options.rendering,...e},this.pipelineEntry&&(this.pipelineEntry.options={...this.pipelineEntry.options,...this.options.rendering},this.pipelineEntry.ready&&t.length&&(V(`${this.options.label}: the change of rendering options is causing this RenderMaterial pipeline to be flushed and recompiled. This should be avoided. Rendering options that caused this: { ${t.map(s=>`"${s}": ${e[s]}`).join(", ")} }`),this.pipelineEntry.flushPipelineEntry(this.bindGroups)))}setAttributesFromGeometry(e){this.attributes={wgslStructFragment:e.wgslStructFragment,vertexBuffers:e.vertexBuffers}}createBindGroups(){const e=this.options.rendering.useProjection?1:0;this.texturesBindGroup.shouldCreateBindGroup&&(this.texturesBindGroup.setIndex(this.bindGroups.length+e),this.texturesBindGroup.createBindGroup(),this.bindGroups.push(this.texturesBindGroup)),this.inputsBindGroups.forEach(t=>{t.shouldCreateBindGroup&&(t.setIndex(this.bindGroups.length+e),t.createBindGroup(),this.bindGroups.push(t))})}}const pt=`
struct VertexOutput {
  @builtin(position) position: vec4f,
  @location(0) uv: vec2f,
};

@vertex fn main(
  attributes: Attributes,
) -> VertexOutput {
  var vsOutput: VertexOutput;

  vsOutput.position = vec4f(attributes.position, 1.0);
  vsOutput.uv = attributes.uv;
  
  return vsOutput;
}`,ft=`
@fragment fn main() -> @location(0) vec4f {
  return vec4(0.0, 0.0, 0.0, 1.0);
}`;let Dt=0;const mt={geometry:new De,shaders:{},autoRender:!0,useProjection:!1,cullMode:"back",depth:!0,depthWriteEnabled:!0,depthCompare:"less",transparent:!1,visible:!0,renderOrder:0,texturesOptions:{}};function yt(d){var e,t;return t=class extends d{constructor(...i){super(i[0],i[1],{...mt,...i[2]});D(this,e,void 0);_(this,e,!0),this._onReadyCallback=()=>{},this._onBeforeRenderCallback=()=>{},this._onRenderCallback=()=>{},this._onAfterRenderCallback=()=>{},this._onAfterResizeCallback=()=>{};let n=i[0];const o={...mt,...i[2]};this.type="MeshBase",this.uuid=R(),Object.defineProperty(this,"index",{value:Dt++}),n=n&&n.renderer||n,U(n,o.label?o.label+" "+this.type:this.type),this.renderer=n;const{label:a,shaders:h,geometry:u,visible:c,renderOrder:l,renderTarget:p,texturesOptions:y,autoRender:b,...x}=o;x.sampleCount=x.sampleCount??(this.renderer&&this.renderer.renderPass)?this.renderer.renderPass.options.sampleCount:1,this.options={...this.options??{},label:a??"Mesh "+this.renderer.meshes.length,shaders:h,texturesOptions:y,...p!==void 0&&{renderTarget:p},...b!==void 0&&{autoRender:b},...x.useAsyncPipeline!==void 0&&{useAsyncPipeline:x.useAsyncPipeline}},this.renderTarget=p??null,this.geometry=u,b!==void 0&&_(this,e,b),this.visible=c,this.renderOrder=l,this.ready=!1,this.userData={},this.computeGeometry(),this.setMaterial({label:this.options.label,shaders:this.options.shaders,...x,verticesOrder:u.verticesOrder,topology:u.topology}),this.addToScene()}get autoRender(){return M(this,e)}get ready(){return this._ready}set ready(i){i&&this._onReadyCallback&&this._onReadyCallback(),this._ready=i}addToScene(){var i;this.renderer.meshes.push(this),(i=this.material)==null||i.setRenderingOptions({sampleCount:this.renderTarget?this.renderTarget.renderPass.options.sampleCount:this.renderer.renderPass.options.sampleCount}),M(this,e)&&this.renderer.scene.addMesh(this)}removeFromScene(){M(this,e)&&this.renderer.scene.removeMesh(this),this.renderer.meshes=this.renderer.meshes.filter(i=>i.uuid!==this.uuid)}setRenderer(i){if(i=i&&i.renderer||i,!i||!(i.type==="GPURenderer"||i.type==="GPUCameraRenderer"||i.type==="GPUCurtainsRenderer")){V(`${this.options.label}: Cannot set ${i} as a renderer because it is not of a valid Renderer type.`);return}const n=this.renderer;this.removeFromScene(),this.renderer=i,this.addToScene(),n.meshes.length||n.onBeforeRenderScene.add(o=>{n.forceClear(o)},{once:!0})}setRenderTarget(i){if(i&&i.type!=="RenderTarget"){V(`${this.options.label??this.type}: renderTarget is not a RenderTarget: ${i}`);return}this.removeFromScene(),this.renderTarget=i,this.addToScene()}loseContext(){this.geometry.vertexBuffers.forEach(i=>{i.buffer=null}),"indexBuffer"in this.geometry&&(this.geometry.indexBuffer.buffer=null),this.material.loseContext()}restoreContext(){this.material.restoreContext()}setShaders(){let{shaders:i}=this.options;i?((!i.vertex||!i.vertex.code)&&(i.vertex={code:pt,entryPoint:"main"}),(!i.fragment||!i.fragment.code)&&(i.fragment={code:ft,entryPoint:"main"})):i={vertex:{code:pt,entryPoint:"main"},fragment:{code:ft,entryPoint:"main"}}}computeGeometry(){this.geometry.shouldCompute&&this.geometry.computeGeometry()}createGeometryBuffers(){this.geometry.ready||(this.geometry.vertexBuffers.forEach(i=>{i.buffer||(i.buffer=this.renderer.createBuffer({label:this.options.label+" geometry: "+i.name+" buffer",size:i.array.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),this.renderer.queueWriteBuffer(i.buffer,0,i.array))}),"indexBuffer"in this.geometry&&this.geometry.indexBuffer&&!this.geometry.indexBuffer.buffer&&(this.geometry.indexBuffer.buffer=this.renderer.createBuffer({label:this.options.label+" geometry: index buffer",size:this.geometry.indexBuffer.array.byteLength,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST}),this.renderer.queueWriteBuffer(this.geometry.indexBuffer.buffer,0,this.geometry.indexBuffer.array)))}setGeometry(){this.geometry&&this.renderer.ready&&(this.createGeometryBuffers(),this.setMaterialGeometryAttributes())}setMaterial(i){var n;this.transparent=i.transparent,this.setShaders(),this.material=new ct(this.renderer,i),(n=this.material.options.textures)==null||n.filter(o=>o instanceof se).forEach(o=>this.onTextureAdded(o))}setMaterialGeometryAttributes(){this.material&&!this.material.attributes&&this.material.setAttributesFromGeometry(this.geometry)}get textures(){var i;return((i=this.material)==null?void 0:i.textures)||[]}get renderTextures(){var i;return((i=this.material)==null?void 0:i.renderTextures)||[]}createTexture(i){i.name||(i.name="texture"+this.textures.length),i.label||(i.label=this.options.label+" "+i.name);const n=new se(this.renderer,{...i,...this.options.texturesOptions});return this.addTexture(n),n}addTexture(i){this.material.addTexture(i),this.onTextureAdded(i)}onTextureAdded(i){i.parentMesh=this}createRenderTexture(i){i.name||(i.name="renderTexture"+this.renderTextures.length);const n=new te(this.renderer,i);return this.addRenderTexture(n),n}addRenderTexture(i){this.material.addTexture(i)}get uniforms(){var i;return(i=this.material)==null?void 0:i.uniforms}get storages(){var i;return(i=this.material)==null?void 0:i.storages}resizeRenderTextures(){var i;(i=this.renderTextures)==null||i.filter(n=>n.options.usage!=="storageTexture").forEach(n=>n.resize())}resize(i){var n;this.resizeRenderTextures(),super.resize&&super.resize(i),(n=this.textures)==null||n.forEach(o=>{o.resize()}),this._onAfterResizeCallback&&this._onAfterResizeCallback()}onReady(i){return i&&(this._onReadyCallback=i),this}onBeforeRender(i){return i&&(this._onBeforeRenderCallback=i),this}onRender(i){return i&&(this._onRenderCallback=i),this}onAfterRender(i){return i&&(this._onAfterRenderCallback=i),this}onAfterResize(i){return i&&(this._onAfterResizeCallback=i),this}onBeforeRenderPass(){this.renderer.ready&&(this.material&&this.material.ready&&this.geometry&&this.geometry.ready&&!this.ready&&(this.ready=!0),this.setGeometry(),this._onBeforeRenderCallback&&this._onBeforeRenderCallback(),this.material.onBeforeRender())}onRenderPass(i){this.material.ready&&(this._onRenderCallback&&this._onRenderCallback(),this.material.render(i),this.geometry.render(i))}onAfterRenderPass(){this._onAfterRenderCallback&&this._onAfterRenderCallback()}render(i){this.onBeforeRenderPass(),!(!this.renderer.ready||!this.visible)&&(super.render&&super.render(),this.onRenderPass(i),this.onAfterRenderPass())}remove(){this.removeFromScene(),this.destroy(),this.renderer.meshes.length||this.renderer.onBeforeRenderScene.add(i=>{this.renderer.forceClear(i)},{once:!0})}destroy(){var i,n;super.destroy&&super.destroy(),(i=this.material)==null||i.destroy(),this.geometry.vertexBuffers.forEach(o=>{this.renderer.removeBuffer(o.buffer,this.options.label+" geometry: "+o.name+" buffer")}),"indexBuffer"in this.geometry&&this.renderer.removeBuffer(this.geometry.indexBuffer.buffer),(n=this.geometry)==null||n.destroy()}},e=new WeakMap,t}class Vt{constructor(){this.planeGeometries=[]}getPlaneGeometry(e){return this.planeGeometries.find(t=>t.definition.id===e.definition.id)}getPlaneGeometryByID(e){return this.planeGeometries.find(t=>t.definition.id===e)}addPlaneGeometry(e){this.planeGeometries.push(e)}destroy(){this.planeGeometries=[]}}const Te=new Vt;class je extends yt(class{}){constructor(e,t={}){e=e&&e.renderer||e,U(e,t.label?t.label+" FullscreenQuadMesh":"FullscreenQuadMesh");let s=Te.getPlaneGeometryByID(2);s||(s=new Ve({widthSegments:1,heightSegments:1}),Te.addPlaneGeometry(s)),super(e,null,{geometry:s,...t}),this.size={document:{width:this.renderer.boundingRect.width,height:this.renderer.boundingRect.height,top:this.renderer.boundingRect.top,left:this.renderer.boundingRect.left}},this.type="FullscreenQuadMesh"}resize(e=null){this.size.document=e??this.renderer.boundingRect,super.resize(e)}mouseToPlaneCoords(e=new A){return new A((e.x-this.size.document.left)/this.size.document.width*2-1,1-(e.y-this.size.document.top)/this.size.document.height*2)}}class Ie extends Re{constructor(e){super(),e=e&&e.renderer||e,ze(e,"ProjectedObject3D"),this.camera=e.camera}applyPosition(){super.applyPosition(),this.shouldUpdateProjectionMatrixStack()}applyRotation(){super.applyRotation(),this.shouldUpdateProjectionMatrixStack()}applyScale(){super.applyScale(),this.shouldUpdateProjectionMatrixStack()}applyTransformOrigin(){super.applyTransformOrigin(),this.shouldUpdateProjectionMatrixStack()}setMatrices(){super.setMatrices(),this.matrices={...this.matrices,modelView:{matrix:new z,shouldUpdate:!1,onUpdate:()=>{this.modelViewMatrix.multiplyMatrices(this.viewMatrix,this.worldMatrix)}},modelViewProjection:{matrix:new z,shouldUpdate:!1,onUpdate:()=>{this.modelViewProjectionMatrix.multiplyMatrices(this.projectionMatrix,this.modelViewMatrix)}}}}get modelViewMatrix(){return this.matrices.modelView.matrix}set modelViewMatrix(e){this.matrices.modelView.matrix=e,this.matrices.modelView.shouldUpdate=!0}get viewMatrix(){return this.camera.viewMatrix}get projectionMatrix(){return this.camera.projectionMatrix}get modelViewProjectionMatrix(){return this.matrices.modelViewProjection.matrix}set modelViewProjectionMatrix(e){this.matrices.modelViewProjection.matrix=e,this.matrices.modelViewProjection.shouldUpdate=!0}shouldUpdateProjectionMatrixStack(){this.matrices.modelView.shouldUpdate=!0,this.matrices.modelViewProjection.shouldUpdate=!0}shouldUpdateWorldMatrix(){super.shouldUpdateWorldMatrix(),this.shouldUpdateProjectionMatrixStack()}shouldUpdateMatrixStack(){this.shouldUpdateModelMatrix(),this.shouldUpdateProjectionMatrixStack()}}const gt=`
struct VertexOutput {
  @builtin(position) position: vec4f,
  @location(0) uv: vec2f,
  @location(1) normal: vec3f,
};

@vertex fn main(
  attributes: Attributes,
) -> VertexOutput {
  var vsOutput: VertexOutput;

  vsOutput.position = getOutputPosition(attributes.position);
  vsOutput.uv = attributes.uv;
  vsOutput.normal = attributes.normal;
  
  return vsOutput;
}`,xt=`
struct VSOutput {
  @builtin(position) position: vec4f,
  @location(0) uv: vec2f,
  @location(1) normal: vec3f,
};

@fragment fn main(fsInput: VSOutput) -> @location(0) vec4f {
  // normals
  return vec4(normalize(fsInput.normal) * 0.5 + 0.5, 1.0);
}`,bt={frustumCulled:!0,DOMFrustumMargins:{top:0,right:0,bottom:0,left:0}};function wt(d){return class extends yt(d){constructor(...t){super(t[0],t[1],{...bt,...t[2],useProjection:!0}),this._onReEnterViewCallback=()=>{},this._onLeaveViewCallback=()=>{};let s=t[0];const r={...bt,...t[2],useProjection:!0};this.type="MeshTransformed",s=s&&s.renderer||s,ze(s,r.label?r.label+" "+this.type:this.type),this.renderer=s;const{geometry:i,frustumCulled:n,DOMFrustumMargins:o}=r;this.options={...this.options??{},frustumCulled:n,DOMFrustumMargins:o},this.setDOMFrustum(),this.geometry=i,this.shouldUpdateMatrixStack()}setShaders(){let{shaders:t}=this.options;t?((!t.vertex||!t.vertex.code)&&(t.vertex={code:gt,entryPoint:"main"}),(!t.fragment||!t.fragment.code)&&(t.fragment={code:xt,entryPoint:"main"})):t={vertex:{code:gt,entryPoint:"main"},fragment:{code:xt,entryPoint:"main"}}}setDOMFrustum(){this.domFrustum=new lt({boundingBox:this.geometry.boundingBox,modelViewProjectionMatrix:this.modelViewProjectionMatrix,containerBoundingRect:this.renderer.boundingRect,DOMFrustumMargins:this.options.DOMFrustumMargins,onReEnterView:()=>{this._onReEnterViewCallback&&this._onReEnterViewCallback()},onLeaveView:()=>{this._onLeaveViewCallback&&this._onLeaveViewCallback()}}),this.DOMFrustumMargins=this.domFrustum.DOMFrustumMargins,this.frustumCulled=this.options.frustumCulled,this.domFrustum.shouldUpdate=this.frustumCulled}setMaterial(t){const s={label:"Matrices",struct:{model:{name:"model",type:"mat4x4f",value:this.modelMatrix},world:{name:"world",type:"mat4x4f",value:this.worldMatrix},modelView:{name:"modelView",type:"mat4x4f",value:this.modelViewMatrix},modelViewProjection:{name:"modelViewProjection",type:"mat4x4f",value:this.modelViewProjectionMatrix}}};t.uniforms||(t.uniforms={}),t.uniforms.matrices=s,super.setMaterial(t)}resize(t){this.domFrustum&&this.domFrustum.setContainerBoundingRect(this.renderer.boundingRect),super.resize(t)}applyScale(){super.applyScale(),this.textures.forEach(t=>t.resize())}get projectedBoundingRect(){var t;return(t=this.domFrustum)==null?void 0:t.projectedBoundingRect}onAfterMatrixStackUpdate(){this.material&&this.material.shouldUpdateInputsBindings("matrices"),this.domFrustum&&(this.domFrustum.shouldUpdate=!0)}onReEnterView(t){return t&&(this._onReEnterViewCallback=t),this}onLeaveView(t){return t&&(this._onLeaveViewCallback=t),this}onBeforeRenderPass(){this.updateMatrixStack(),this.domFrustum&&this.domFrustum.shouldUpdate&&this.frustumCulled&&(this.domFrustum.computeProjectedToDocumentCoords(),this.domFrustum.shouldUpdate=!1),super.onBeforeRenderPass()}onRenderPass(t){this.material.ready&&(this._onRenderCallback&&this._onRenderCallback(),(this.domFrustum&&this.domFrustum.isIntersecting||!this.frustumCulled)&&(this.material.render(t),this.geometry.render(t)))}}}class jt extends wt(Ie){constructor(e,t){e=e&&e.renderer||e,ze(e,t.label?t.label+" Mesh":"Mesh"),super(e,null,t),this.type="Mesh"}}let It=0;class $e{constructor(e){this.type="PipelineEntry";let{renderer:t}=e;const{label:s,shaders:r,useAsync:i}=e;t=t&&t.renderer||t,U(t,s?s+" "+this.type:this.type),this.renderer=t,Object.defineProperty(this,"index",{value:It++}),this.layout=null,this.pipeline=null,this.status={compiling:!1,compiled:!1,error:null},this.options={label:s,shaders:r,useAsync:i!==void 0?i:!0}}get ready(){return!this.status.compiling&&this.status.compiled&&!this.status.error}get canCompile(){return!this.status.compiling&&!this.status.compiled&&!this.status.error}setPipelineEntryBindGroups(e){this.bindGroups=e}createShaderModule({code:e="",type:t="vertex"}){const s=this.renderer.createShaderModule({label:this.options.label+": "+t+"Shader module",code:e});return"getCompilationInfo"in s&&!this.renderer.production&&s.getCompilationInfo().then(r=>{for(const i of r.messages){let n="";switch(i.lineNum&&(n+=`Line ${i.lineNum}:${i.linePos} - ${e.substring(i.offset,i.offset+i.length)}
`),n+=i.message,i.type){case"error":console.error(`${this.options.label} compilation error:
${n}`);break;case"warning":console.warn(`${this.options.label} compilation warning:
${n}`);break;case"info":console.log(`${this.options.label} compilation information:
${n}`);break}}}),s}createShaders(){}createPipelineLayout(){this.layout=this.renderer.createPipelineLayout({label:this.options.label+" layout",bindGroupLayouts:this.bindGroups.map(e=>e.bindGroupLayout)})}createPipelineDescriptor(){}flushPipelineEntry(e=[]){this.status.compiling=!1,this.status.compiled=!1,this.status.error=null,this.setPipelineEntryBindGroups(e),this.compilePipelineEntry()}compilePipelineEntry(){this.status.compiling=!0,this.createShaders(),this.createPipelineLayout(),this.createPipelineDescriptor()}}const $t=`
fn getOutputPosition(position: vec3f) -> vec4f {
  return matrices.modelViewProjection * vec4f(position, 1.0);
}`,Pt=`
fn getUVCover(uv: vec2f, textureMatrix: mat4x4f) -> vec2f {
  return (textureMatrix * vec4f(uv, 0.0, 1.0)).xy;
}`,ie={vertex:{get_uv_cover:Pt},fragment:{get_uv_cover:Pt,get_vertex_to_uv_coords:`
fn getVertex2DToUVCoords(vertex: vec2f) -> vec2f {
  return vec2(
    vertex.x * 0.5 + 0.5,
    0.5 - vertex.y * 0.5
  );
}

fn getVertex3DToUVCoords(vertex: vec3f) -> vec2f {
  return vec2(
    vertex.x * 0.5 + 0.5,
    0.5 - vertex.y * 0.5
  );
}
`}},re={vertex:{get_output_position:$t},fragment:{}};class qe extends $e{constructor(e){let{renderer:t}=e;const{label:s,...r}=e;t=t&&t.renderer||t;const i="RenderPipelineEntry";U(t,s?s+" "+i:i),super(e),this.type=i,this.shaders={vertex:{head:"",code:"",module:null},fragment:{head:"",code:"",module:null},full:{head:"",code:"",module:null}},this.descriptor=null,this.options={...this.options,...r}}setPipelineEntryBindGroups(e){this.bindGroups="cameraBindGroup"in this.renderer&&this.options.useProjection?[this.renderer.cameraBindGroup,...e]:e}setPipelineEntryProperties(e){const{attributes:t,bindGroups:s}=e;this.attributes=t,this.setPipelineEntryBindGroups(s)}patchShaders(){this.shaders.vertex.head="",this.shaders.vertex.code="",this.shaders.fragment.head="",this.shaders.fragment.code="",this.shaders.full.head="",this.shaders.full.code="";for(const t in ie.vertex)this.shaders.vertex.head=`${ie.vertex[t]}
${this.shaders.vertex.head}`,this.shaders.full.head=`${ie.vertex[t]}
${this.shaders.full.head}`;for(const t in ie.fragment)this.shaders.fragment.head=`${ie.fragment[t]}
${this.shaders.fragment.head}`,this.shaders.full.head.indexOf(ie.fragment[t])===-1&&(this.shaders.full.head=`${ie.fragment[t]}
${this.shaders.full.head}`);if(this.options.useProjection){for(const t in re.vertex)this.shaders.vertex.head=`${re.vertex[t]}
${this.shaders.vertex.head}`,this.shaders.full.head=`${re.vertex[t]}
${this.shaders.full.head}`;for(const t in re.fragment)this.shaders.fragment.head=`${re.fragment[t]}
${this.shaders.fragment.head}`,this.shaders.full.head.indexOf(re.fragment[t])===-1&&(this.shaders.full.head=`${re.fragment[t]}
${this.shaders.full.head}`)}const e=[];this.bindGroups.forEach(t=>{let s=0;t.bindings.forEach((r,i)=>{r.wgslGroupFragment.forEach((n,o)=>{e.push({groupIndex:t.index,visibility:r.visibility,bindIndex:s,wgslStructFragment:r.wgslStructFragment,wgslGroupFragment:n,newLine:i===t.bindings.length-1&&o===r.wgslGroupFragment.length-1}),s++})})}),e.forEach(t=>{(t.visibility===GPUShaderStage.VERTEX||t.visibility===(GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE))&&(t.wgslStructFragment&&this.shaders.vertex.head.indexOf(t.wgslStructFragment)===-1&&(this.shaders.vertex.head=`
${t.wgslStructFragment}
${this.shaders.vertex.head}`),this.shaders.vertex.head.indexOf(t.wgslGroupFragment)===-1&&(this.shaders.vertex.head=`${this.shaders.vertex.head}
@group(${t.groupIndex}) @binding(${t.bindIndex}) ${t.wgslGroupFragment}`,t.newLine&&(this.shaders.vertex.head+=`
`))),(t.visibility===GPUShaderStage.FRAGMENT||t.visibility===(GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE))&&(t.wgslStructFragment&&this.shaders.fragment.head.indexOf(t.wgslStructFragment)===-1&&(this.shaders.fragment.head=`
${t.wgslStructFragment}
${this.shaders.fragment.head}`),this.shaders.fragment.head.indexOf(t.wgslGroupFragment)===-1&&(this.shaders.fragment.head=`${this.shaders.fragment.head}
@group(${t.groupIndex}) @binding(${t.bindIndex}) ${t.wgslGroupFragment}`,t.newLine&&(this.shaders.fragment.head+=`
`))),t.wgslStructFragment&&this.shaders.full.head.indexOf(t.wgslStructFragment)===-1&&(this.shaders.full.head=`
${t.wgslStructFragment}
${this.shaders.full.head}`),this.shaders.full.head.indexOf(t.wgslGroupFragment)===-1&&(this.shaders.full.head=`${this.shaders.full.head}
@group(${t.groupIndex}) @binding(${t.bindIndex}) ${t.wgslGroupFragment}`,t.newLine&&(this.shaders.full.head+=`
`))}),this.shaders.vertex.head=`${this.attributes.wgslStructFragment}
${this.shaders.vertex.head}`,this.shaders.full.head=`${this.attributes.wgslStructFragment}
${this.shaders.full.head}`,this.shaders.vertex.code=this.shaders.vertex.head+this.options.shaders.vertex.code,this.shaders.fragment.code=this.shaders.fragment.head+this.options.shaders.fragment.code,this.options.shaders.vertex.entryPoint!==this.options.shaders.fragment.entryPoint&&this.options.shaders.vertex.code.localeCompare(this.options.shaders.fragment.code)===0?this.shaders.full.code=this.shaders.full.head+this.options.shaders.vertex.code:this.shaders.full.code=this.shaders.full.head+this.options.shaders.vertex.code+this.options.shaders.fragment.code}createShaders(){this.patchShaders();const e=this.options.shaders.vertex.entryPoint!==this.options.shaders.fragment.entryPoint&&this.options.shaders.vertex.code.localeCompare(this.options.shaders.fragment.code)===0;this.shaders.vertex.module=this.createShaderModule({code:this.shaders[e?"full":"vertex"].code,type:"vertex"}),this.shaders.fragment.module=this.createShaderModule({code:this.shaders[e?"full":"fragment"].code,type:"fragment"})}createPipelineDescriptor(){if(!this.shaders.vertex.module||!this.shaders.fragment.module)return;let e=-1;const t=this.options.blend??(this.options.transparent&&{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha"}});this.descriptor={label:this.options.label,layout:this.layout,vertex:{module:this.shaders.vertex.module,entryPoint:this.options.shaders.vertex.entryPoint,buffers:this.attributes.vertexBuffers.map(s=>({stepMode:s.stepMode,arrayStride:s.arrayStride*4,attributes:s.attributes.map(r=>(e++,{shaderLocation:e,offset:r.bufferOffset,format:r.bufferFormat}))}))},fragment:{module:this.shaders.fragment.module,entryPoint:this.options.shaders.fragment.entryPoint,targets:[{format:this.options.targetFormat??this.renderer.options.preferredFormat,...t&&{blend:t}}]},primitive:{topology:this.options.topology,frontFace:this.options.verticesOrder,cullMode:this.options.cullMode},...this.options.depth&&{depthStencil:{depthWriteEnabled:this.options.depthWriteEnabled,depthCompare:this.options.depthCompare,format:"depth24plus"}},...this.options.sampleCount>1&&{multisample:{count:this.options.sampleCount}}}}createRenderPipeline(){if(!(!this.shaders.vertex.module||!this.shaders.fragment.module))try{this.pipeline=this.renderer.createRenderPipeline(this.descriptor)}catch(e){this.status.error=e,I(e)}}async createRenderPipelineAsync(){if(!(!this.shaders.vertex.module||!this.shaders.fragment.module))try{this.pipeline=await this.renderer.createRenderPipelineAsync(this.descriptor),this.status.compiled=!0,this.status.compiling=!1,this.status.error=null}catch(e){this.status.error=e,I(e)}}async compilePipelineEntry(){super.compilePipelineEntry(),this.options.useAsync?await this.createRenderPipelineAsync():(this.createRenderPipeline(),this.status.compiled=!0,this.status.compiling=!1,this.status.error=null)}}class We extends $e{constructor(e){let{renderer:t}=e;const{label:s}=e;t=t&&t.renderer||t;const r="ComputePipelineEntry";U(t,s?s+" "+r:r),super(e),this.type=r,this.shaders={compute:{head:"",code:"",module:null}},this.descriptor=null}setPipelineEntryProperties(e){const{bindGroups:t}=e;this.setPipelineEntryBindGroups(t)}patchShaders(){this.shaders.compute.head="",this.shaders.compute.code="";const e=[];this.bindGroups.forEach(t=>{let s=0;t.bindings.forEach((r,i)=>{r.wgslGroupFragment.forEach((n,o)=>{e.push({groupIndex:t.index,visibility:r.visibility,bindIndex:s,wgslStructFragment:r.wgslStructFragment,wgslGroupFragment:n,newLine:i===t.bindings.length-1&&o===r.wgslGroupFragment.length-1}),s++})})}),e.forEach(t=>{t.wgslStructFragment&&this.shaders.compute.head.indexOf(t.wgslStructFragment)===-1&&(this.shaders.compute.head=`
${t.wgslStructFragment}
${this.shaders.compute.head}`),this.shaders.compute.head.indexOf(t.wgslGroupFragment)===-1&&(this.shaders.compute.head=`${this.shaders.compute.head}
@group(${t.groupIndex}) @binding(${t.bindIndex}) ${t.wgslGroupFragment}`),t.newLine&&(this.shaders.compute.head+=`
`)}),this.shaders.compute.code=this.shaders.compute.head+this.options.shaders.compute.code}createShaders(){this.patchShaders(),this.shaders.compute.module=this.createShaderModule({code:this.shaders.compute.code,type:"compute"})}createPipelineDescriptor(){this.shaders.compute.module&&(this.descriptor={label:this.options.label,layout:this.layout,compute:{module:this.shaders.compute.module,entryPoint:this.options.shaders.compute.entryPoint}})}createComputePipeline(){if(this.shaders.compute.module)try{this.pipeline=this.renderer.createComputePipeline(this.descriptor)}catch(e){this.status.error=e,I(e)}}async createComputePipelineAsync(){if(this.shaders.compute.module)try{this.pipeline=await this.renderer.createComputePipelineAsync(this.descriptor),this.status.compiled=!0,this.status.compiling=!1,this.status.error=null}catch(e){this.status.error=e,I(e)}}async compilePipelineEntry(){super.compilePipelineEntry(),this.options.useAsync?await this.createComputePipelineAsync():(this.createComputePipeline(),this.status.compiled=!0,this.status.compiling=!1,this.status.error=null)}}class Mt{constructor(){this.type="PipelineManager",this.currentPipelineIndex=null,this.pipelineEntries=[]}isSameRenderPipeline(e){const{shaders:t,cullMode:s,depth:r,depthWriteEnabled:i,depthCompare:n,transparent:o,verticesOrder:a,topology:h,sampleCount:u}=e;return this.pipelineEntries.filter(c=>c instanceof qe).find(c=>{const{options:l}=c;return t.vertex.code.localeCompare(l.shaders.vertex.code)===0&&t.vertex.entryPoint===l.shaders.vertex.entryPoint&&t.fragment.code.localeCompare(l.shaders.fragment.code)===0&&t.fragment.entryPoint===l.shaders.fragment.entryPoint&&s===l.cullMode&&r===l.depth&&i===l.depthWriteEnabled&&n===l.depthCompare&&o===l.transparent&&u===l.sampleCount&&a===l.verticesOrder&&h===l.topology})}createRenderPipeline(e){const t=this.isSameRenderPipeline(e);if(t)return t;{const s=new qe(e);return this.pipelineEntries.push(s),s}}isSameComputePipeline(e){const{shaders:t}=e;return this.pipelineEntries.filter(s=>s instanceof We).find(s=>{const{options:r}=s;return t.compute.code.localeCompare(r.shaders.compute.code)===0&&t.compute.entryPoint===r.shaders.compute.entryPoint})}createComputePipeline(e){const t=this.isSameComputePipeline(e);if(t)return t;{const s=new We(e);return this.pipelineEntries.push(s),s}}setCurrentPipeline(e,t){t.index!==this.currentPipelineIndex&&(e.setPipeline(t.pipeline),this.currentPipelineIndex=t.index)}resetCurrentPipeline(){this.currentPipelineIndex=null}}class qt{constructor(){this.shouldWatch=!0,this.entries=[],this.resizeObserver=new ResizeObserver(e=>{const t=e.map(s=>this.entries.filter(r=>r.element.isSameNode(s.target))).flat().sort((s,r)=>r.priority-s.priority);t==null||t.forEach(s=>{s&&s.callback&&s.callback()})})}useObserver(e=!0){this.shouldWatch=e}observe({element:e,priority:t,callback:s}){if(!e||!this.shouldWatch)return;this.resizeObserver.observe(e);const r={element:e,priority:t,callback:s};this.entries.push(r)}unobserve(e){this.resizeObserver.unobserve(e),this.entries=this.entries.filter(t=>!t.element.isSameNode(e))}destroy(){this.resizeObserver.disconnect()}}const Ne=new qt;class Ye{constructor({element:e=document.body,priority:t=1,onSizeChanged:s=(i=null)=>{},onPositionChanged:r=(i=null)=>{}}={}){if(typeof e=="string"){if(this.element=document.querySelector(e),!this.element){const i=typeof e=="string"?`'${e}' selector`:`${e} HTMLElement`;I(`DOMElement: corresponding ${i} not found.`)}}else this.element=e;this.priority=t,this.isResizing=!1,this.onSizeChanged=s,this.onPositionChanged=r,this.resizeManager=Ne,this.resizeManager.observe({element:this.element,priority:this.priority,callback:()=>{this.setSize()}}),this.setSize()}compareBoundingRect(e,t){return!["x","y","left","top","right","bottom","width","height"].some(s=>e[s]!==t[s])}get boundingRect(){return this._boundingRect}set boundingRect(e){const t=!!this.boundingRect&&this.compareBoundingRect(e,this.boundingRect);this._boundingRect={top:e.top,right:e.right,bottom:e.bottom,left:e.left,width:e.width,height:e.height,x:e.x,y:e.y},t||this.onSizeChanged(this.boundingRect)}updateScrollPosition(e={x:0,y:0}){this.isResizing||(this._boundingRect.top+=e.y,this._boundingRect.left+=e.x,(e.x||e.y)&&this.onPositionChanged(this.boundingRect))}setSize(e=null){this.element&&(this.boundingRect=e??this.element.getBoundingClientRect(),this.isResizing=!1)}destroy(){this.resizeManager.unobserve(this.element)}}const Wt=`
struct VSOutput {
  @builtin(position) position: vec4f,
  @location(0) uv: vec2f,
};

@fragment fn main(fsInput: VSOutput) -> @location(0) vec4f {
  return textureSample(renderTexture, defaultSampler, fsInput.uv);
}`;class vt extends je{constructor(e,t={}){var s;e=e&&e.renderer||e,U(e,t.label?t.label+" ShaderPass":"ShaderPass"),t.transparent=!0,t.label=t.label??"ShaderPass "+((s=e.shaderPasses)==null?void 0:s.length),t.shaders||(t.shaders={}),t.shaders.fragment||(t.shaders.fragment={code:Wt,entryPoint:"main"}),t.depth=!1,super(e,t),this.type="ShaderPass",this.createRenderTexture({label:t.label?`${t.label} render texture`:"Shader pass render texture",name:"renderTexture",fromTexture:this.renderTarget?this.renderTarget.renderTexture:null})}get renderTexture(){return this.renderTextures.find(e=>e.options.name==="renderTexture")}setRenderTarget(e){super.setRenderTarget(e),e?this.renderTexture.copy(this.renderTarget.renderTexture):(this.renderTexture.options.fromTexture=null,this.renderTexture.createTexture())}addToScene(){this.renderer.shaderPasses.push(this),this.autoRender&&this.renderer.scene.addShaderPass(this)}removeFromScene(){this.renderTarget&&this.renderTarget.destroy(),this.autoRender&&this.renderer.scene.removeShaderPass(this),this.renderer.shaderPasses=this.renderer.shaderPasses.filter(e=>e.uuid!==this.uuid)}}class Ce{constructor(e,{label:t="Render Pass",sampleCount:s=4,loadOp:r="clear",clearValue:i=[0,0,0,0],targetFormat:n,depth:o=!0,depthTexture:a,depthLoadOp:h="clear",depthClearValue:u=1}={}){e=e&&e.renderer||e,U(e,"RenderPass"),this.type="RenderPass",this.uuid=R(),this.renderer=e,this.options={label:t,sampleCount:s,loadOp:r,clearValue:i,targetFormat:n??this.renderer.options.preferredFormat,depth:o,...a!==void 0&&{depthTexture:a},depthLoadOp:h,depthClearValue:u},this.setClearValue(i),this.options.depth&&this.createDepthTexture(),this.viewTexture=new te(this.renderer,{label:this.options.label+" view texture",name:"viewTexture",format:this.options.targetFormat,sampleCount:this.options.sampleCount}),this.setRenderPassDescriptor()}createDepthTexture(){this.depthTexture=new te(this.renderer,{label:this.options.label+" depth texture",name:"depthTexture",usage:"depthTexture",format:"depth24plus",sampleCount:this.options.sampleCount,...this.options.depthTexture&&{fromTexture:this.options.depthTexture}})}resetRenderPassDepth(){this.depthTexture.forceResize({width:Math.floor(this.renderer.pixelRatioBoundingRect.width),height:Math.floor(this.renderer.pixelRatioBoundingRect.height),depth:1}),this.descriptor.depthStencilAttachment.view=this.depthTexture.texture.createView({label:this.depthTexture.options.label+" view"})}resetRenderPassView(){this.viewTexture.forceResize({width:Math.floor(this.renderer.pixelRatioBoundingRect.width),height:Math.floor(this.renderer.pixelRatioBoundingRect.height),depth:1}),this.descriptor.colorAttachments[0].view=this.viewTexture.texture.createView({label:this.viewTexture.options.label+" view"})}setRenderPassDescriptor(){this.descriptor={label:this.options.label+" descriptor",colorAttachments:[{view:this.viewTexture.texture.createView({label:this.viewTexture.options.label+" view"}),clearValue:this.options.clearValue,loadOp:this.options.loadOp,storeOp:"store"}],...this.options.depth&&{depthStencilAttachment:{view:this.depthTexture.texture.createView({label:this.depthTexture.options.label+" view"}),depthClearValue:this.options.depthClearValue,depthLoadOp:this.options.depthLoadOp,depthStoreOp:"store"}}}}resize(){this.options.depth&&this.resetRenderPassDepth(),this.resetRenderPassView()}setLoadOp(e="clear"){this.options.loadOp=e,this.descriptor&&this.descriptor.colorAttachments&&(this.descriptor.colorAttachments[0].loadOp=e)}setDepthLoadOp(e="clear"){this.options.depthLoadOp=e,this.options.depth&&this.descriptor.depthStencilAttachment&&(this.descriptor.depthStencilAttachment.depthLoadOp=e)}setClearValue(e=[0,0,0,0]){if(this.renderer.alphaMode==="premultiplied"){const t=e[3];e[0]=Math.min(e[0],t),e[1]=Math.min(e[1],t),e[2]=Math.min(e[2],t)}else this.options.clearValue=e;this.descriptor&&this.descriptor.colorAttachments&&(this.descriptor.colorAttachments[0].clearValue=e)}destroy(){var e;(e=this.viewTexture)==null||e.destroy(),!this.options.depthTexture&&this.depthTexture&&this.depthTexture.destroy()}}class Xe{constructor(e,t){D(this,oe,void 0);_(this,oe,!0),e=e&&e.renderer||e,U(e,"RenderTarget"),this.type="RenderTarget",this.renderer=e,this.uuid=R();const{label:s,targetFormat:r,autoRender:i,...n}=t;this.options={label:s,...n,targetFormat:r??this.renderer.options.preferredFormat,autoRender:i},i!==void 0&&_(this,oe,i),this.renderPass=new Ce(this.renderer,{label:this.options.label?`${this.options.label} Render Pass`:"Render Target Render Pass",targetFormat:this.options.targetFormat,depthTexture:this.renderer.renderPass.depthTexture,...n}),this.renderTexture=new te(this.renderer,{label:this.options.label?`${this.options.label} Render Texture`:"Render Target Render Texture",name:"renderTexture",format:this.options.targetFormat}),this.addToScene()}addToScene(){this.renderer.renderTargets.push(this),M(this,oe)&&this.renderer.scene.addRenderTarget(this)}removeFromScene(){M(this,oe)&&this.renderer.scene.removeRenderTarget(this),this.renderer.renderTargets=this.renderer.renderTargets.filter(e=>e.uuid!==this.uuid)}resize(e){var t,s;this.renderPass.options.depthTexture.texture=this.renderer.renderPass.depthTexture.texture,(t=this.renderPass)==null||t.resize(),(s=this.renderTexture)==null||s.resize()}remove(){this.destroy()}destroy(){var e,t;this.renderer.meshes.forEach(s=>{s.renderTarget&&s.renderTarget.uuid===this.uuid&&s.setRenderTarget(null)}),this.renderer.shaderPasses.forEach(s=>{s.renderTarget&&s.renderTarget.uuid===this.uuid&&(s.renderTarget=null,s.setRenderTarget(null))}),this.removeFromScene(),(e=this.renderPass)==null||e.destroy(),(t=this.renderTexture)==null||t.destroy()}}oe=new WeakMap;class Rt extends je{constructor(e,t={}){var s;e=e&&e.renderer||e,U(e,t.label?t.label+" PingPongPlane":"PingPongPlane"),t.renderTarget=new Xe(e,{label:t.label?t.label+" render target":"Ping Pong render target",depth:!1,...t.targetFormat&&{targetFormat:t.targetFormat}}),t.transparent=!1,t.depth=!1,t.label=t.label??"PingPongPlane "+((s=e.pingPongPlanes)==null?void 0:s.length),super(e,t),this.type="PingPongPlane",this.createRenderTexture({label:t.label?`${t.label} render texture`:"PingPongPlane render texture",name:"renderTexture",...t.targetFormat&&{format:t.targetFormat}})}get renderTexture(){return this.renderTextures.find(e=>e.options.name==="renderTexture")}addToScene(){this.renderer.pingPongPlanes.push(this),this.autoRender&&this.renderer.scene.addPingPongPlane(this)}removeFromScene(){this.renderTarget&&this.renderTarget.destroy(),this.autoRender&&this.renderer.scene.removePingPongPlane(this),this.renderer.pingPongPlanes=this.renderer.pingPongPlanes.filter(e=>e.uuid!==this.uuid)}}class Bt extends Ie{constructor(t,s,r){super(t);D(this,ae,void 0);D(this,he,void 0);_(this,ae,new f),_(this,he,new f),t=t&&t.renderer||t,Oe(t,"DOM3DObject"),this.renderer=t,this.size={world:{width:0,height:0,top:0,left:0},document:{width:0,height:0,top:0,left:0}},this.watchScroll=r.watchScroll,this.camera=this.renderer.camera,this.setDOMElement(s)}setDOMElement(t){this.domElement=new Ye({element:t,onSizeChanged:s=>this.resize(s),onPositionChanged:s=>this.onPositionChanged(s)})}onPositionChanged(t){this.watchScroll&&(this.size.document=t??this.domElement.element.getBoundingClientRect(),this.updateSizeAndPosition())}resetDOMElement(t){this.domElement&&this.domElement.destroy(),this.setDOMElement(t)}updateSizeAndPosition(){this.setWorldSizes(),this.applyPosition(),this.shouldUpdateModelMatrix()}shouldUpdateMatrixStack(){this.updateSizeAndPosition(),super.shouldUpdateMatrixStack()}resize(t){var s;!t&&(!this.domElement||(s=this.domElement)!=null&&s.isResizing)||(this.size.document=t??this.domElement.element.getBoundingClientRect(),this.shouldUpdateMatrixStack())}get boundingRect(){return this.domElement.boundingRect}setTransforms(){super.setTransforms(),this.transforms.origin.model.set(.5,.5,0),this.transforms.origin.world=new f,this.transforms.position.document=new f,this.documentPosition.onChange(()=>this.applyPosition()),this.transformOrigin.onChange(()=>this.setWorldTransformOrigin())}get documentPosition(){return this.transforms.position.document}set documentPosition(t){this.transforms.position.document=t,this.applyPosition()}get DOMObjectWorldScale(){return M(this,he).clone()}get worldScale(){return this.DOMObjectWorldScale.multiply(this.scale)}get worldPosition(){return M(this,ae).clone()}get transformOrigin(){return this.transforms.origin.model}set transformOrigin(t){this.transforms.origin.model=t,this.setWorldTransformOrigin()}get worldTransformOrigin(){return this.transforms.origin.world}set worldTransformOrigin(t){this.transforms.origin.world=t}applyPosition(){this.applyDocumentPosition(),super.applyPosition()}applyDocumentPosition(){let t=new f(0,0,0);this.documentPosition.equals(t)||(t=this.documentToWorldSpace(this.documentPosition)),M(this,ae).set(this.position.x+this.size.world.left+t.x,this.position.y+this.size.world.top+t.y,this.position.z+this.documentPosition.z/this.camera.CSSPerspective)}applyTransformOrigin(){this.size&&(this.setWorldTransformOrigin(),super.applyTransformOrigin())}updateModelMatrix(){this.modelMatrix.composeFromOrigin(M(this,ae),this.quaternion,this.scale,this.worldTransformOrigin),this.modelMatrix.scale(M(this,he)),this.shouldUpdateWorldMatrix()}documentToWorldSpace(t=new f){return new f(t.x*this.renderer.pixelRatio/this.renderer.boundingRect.width*this.camera.screenRatio.width,-(t.y*this.renderer.pixelRatio/this.renderer.boundingRect.height)*this.camera.screenRatio.height,t.z)}setWorldSizes(){const t=this.renderer.boundingRect,s={x:this.size.document.width/2+this.size.document.left,y:this.size.document.height/2+this.size.document.top},r={x:t.width/2+t.left,y:t.height/2+t.top};this.size.world={width:this.size.document.width/t.width*this.camera.screenRatio.width/2,height:this.size.document.height/t.height*this.camera.screenRatio.height/2,top:(r.y-s.y)/t.height*this.camera.screenRatio.height,left:(s.x-r.x)/t.width*this.camera.screenRatio.width},M(this,he).set(this.size.world.width,this.size.world.height,1),this.setWorldTransformOrigin()}setWorldTransformOrigin(){this.transforms.origin.world=new f((this.transformOrigin.x*2-1)*this.size.world.width,-(this.transformOrigin.y*2-1)*this.size.world.height,this.transformOrigin.z),this.shouldUpdateModelMatrix(),this.shouldUpdateProjectionMatrixStack()}updateScrollPosition(t={x:0,y:0}){(t.x||t.y)&&this.domElement.updateScrollPosition(t)}destroy(){var t;(t=this.domElement)==null||t.destroy()}}ae=new WeakMap,he=new WeakMap;const Tt={autoloadSources:!0,watchScroll:!0};class He extends wt(Bt){constructor(e,t,s){super(e,t,{...Tt,...s}),this._onLoadingCallback=i=>{},s={...Tt,...s},e=e&&e.renderer||e,Oe(e,s.label?s.label+" DOMMesh":"DOMMesh"),this.type="DOMMesh";const{autoloadSources:r}=s;this.autoloadSources=r,this.sourcesReady=!1,this.setInitSources()}get ready(){return this._ready}set ready(e){this._ready=e,this.DOMMeshReady&&this._onReadyCallback&&this._onReadyCallback()}get sourcesReady(){return this._sourcesReady}set sourcesReady(e){this._sourcesReady=e,this.DOMMeshReady&&this._onReadyCallback&&this._onReadyCallback()}get DOMMeshReady(){return this.ready&&this.sourcesReady}addToScene(){super.addToScene(),this.renderer.domMeshes.push(this)}removeFromScene(){super.removeFromScene(),this.renderer.domMeshes=this.renderer.domMeshes.filter(e=>e.uuid!==this.uuid)}setInitSources(){let e=0,t=0;if(this.autoloadSources){const s=this.domElement.element.querySelectorAll("img"),r=this.domElement.element.querySelectorAll("video"),i=this.domElement.element.querySelectorAll("canvas");e=s.length+r.length+i.length;const n=o=>{t++,this._onLoadingCallback&&this._onLoadingCallback(o),t===e&&(this.sourcesReady=!0)};e||(this.sourcesReady=!0),s.length&&s.forEach(o=>{const a=this.createTexture({name:o.getAttribute("data-texture-name")??"texture"+this.textures.length});a.onSourceUploaded(()=>n(a)).loadImage(o.src)}),r.length&&r.forEach(o=>{const a=this.createTexture({name:o.getAttribute("data-texture-name")??"texture"+this.textures.length});a.onSourceUploaded(()=>n(a)).loadVideo(o)}),i.length&&i.forEach(o=>{const a=this.createTexture({name:o.getAttribute("data-texture-name")??"texture"+this.textures.length});a.onSourceUploaded(()=>n(a)).loadCanvas(o)})}else this.sourcesReady=!0}resetDOMElement(e){e?super.resetDOMElement(e):!e&&!this.renderer.production&&V(`${this.options.label}: You are trying to reset a ${this.type} with a HTML element that does not exist. The old HTML element will be kept instead.`)}get pixelRatioBoundingRect(){const e=window.devicePixelRatio??1,t=this.renderer.pixelRatio/e;return Object.keys(this.domElement.boundingRect).reduce((s,r)=>({...s,[r]:this.domElement.boundingRect[r]*t}),{x:0,y:0,width:0,height:0,top:0,right:0,bottom:0,left:0})}createRenderTexture(e){return e={...e,size:{width:this.pixelRatioBoundingRect.width,height:this.pixelRatioBoundingRect.height}},super.createRenderTexture(e)}resizeRenderTextures(){var e;(e=this.renderTextures)==null||e.filter(t=>t.options.usage==="texture").forEach(t=>t.resize({width:this.pixelRatioBoundingRect.width,height:this.pixelRatioBoundingRect.height}))}onLoading(e){return e&&(this._onLoadingCallback=e),this}}const Nt={label:"Plane",instancesCount:1,vertexBuffers:[]};class Ze extends He{constructor(e,t,s={}){e=e&&e.renderer||e,Oe(e,s.label?s.label+" Plane":"Plane");const r={...Nt,...s};let{geometry:i,widthSegments:n,heightSegments:o,...a}=r;const{instancesCount:h,vertexBuffers:u,...c}=a;if(!i||i.type!=="PlaneGeometry"){n=n??1,o=o??1;const l=n*o+n;u.length||(i=Te.getPlaneGeometryByID(l)),i?i.instancesCount=h:(i=new Ve({widthSegments:n,heightSegments:o,instancesCount:h,vertexBuffers:u}),Te.addPlaneGeometry(i))}super(e,t,{geometry:i,...c}),this.type="Plane"}mouseToPlaneCoords(e=new A){const t={x:2*(e.x/this.renderer.pixelRatioBoundingRect.width)-1,y:2*(1-e.y/this.renderer.pixelRatioBoundingRect.height)-1},s=this.camera.position.clone(),r=new f(t.x,t.y,-.5);r.unproject(this.camera),r.sub(s).normalize();const i=new f(0,0,1);i.applyQuat(this.quaternion).normalize();const n=new f(0,0,0),o=i.dot(r);if(Math.abs(o)>=1e-4){const a=this.modelMatrix.getInverse().premultiply(this.camera.viewMatrix),h=this.worldTransformOrigin.clone().add(this.worldPosition),u=new f(this.worldPosition.x-h.x,this.worldPosition.y-h.y,this.worldPosition.z-h.z);u.applyQuat(this.quaternion),h.add(u);const c=i.dot(h.clone().sub(s))/o;n.copy(s.add(r.multiplyScalar(c))),n.applyMat4(a)}else n.set(1/0,1/0,1/0);return new A(n.x,n.y)}}class Ct{constructor({renderer:e}){e=e&&e.renderer||e,U(e,"Scene"),this.renderer=e,this.computePassEntries=[],this.renderPassEntries={pingPong:[],renderTarget:[],screen:[{renderPass:this.renderer.renderPass,renderTexture:null,onBeforeRenderPass:null,onAfterRenderPass:null,element:null,stack:{unProjected:{opaque:[],transparent:[]},projected:{opaque:[],transparent:[]}}}]}}getRenderPassEntryLength(e){return e?e.element?1:e.stack.unProjected.opaque.length+e.stack.unProjected.transparent.length+e.stack.projected.opaque.length+e.stack.projected.transparent.length:0}addComputePass(e){this.computePassEntries.push(e),this.computePassEntries.sort((t,s)=>t.renderOrder!==s.renderOrder?t.renderOrder-s.renderOrder:t.index-s.index)}removeComputePass(e){this.computePassEntries=this.computePassEntries.filter(t=>t.uuid!==e.uuid)}addRenderTarget(e){this.renderPassEntries.renderTarget.find(t=>t.renderPass.uuid===e.renderPass.uuid)||this.renderPassEntries.renderTarget.push({renderPass:e.renderPass,renderTexture:e.renderTexture,onBeforeRenderPass:null,onAfterRenderPass:null,element:null,stack:{unProjected:{opaque:[],transparent:[]},projected:{opaque:[],transparent:[]}}})}removeRenderTarget(e){this.renderPassEntries.renderTarget=this.renderPassEntries.renderTarget.filter(t=>t.renderPass.uuid!==e.renderPass.uuid)}getMeshProjectionStack(e){const t=e.renderTarget?this.renderPassEntries.renderTarget.find(r=>r.renderPass.uuid===e.renderTarget.renderPass.uuid):this.renderPassEntries.screen[0],{stack:s}=t;return e.material.options.rendering.useProjection?s.projected:s.unProjected}addMesh(e){const t=this.getMeshProjectionStack(e),s=e.transparent?[...t.transparent]:[...t.opaque];let r=-1;for(let i=s.length-1;i>=0;i--)if(s[i].material.pipelineEntry.index===e.material.pipelineEntry.index){r=i+1;break}r=Math.max(0,r),s.splice(r,0,e),s.sort((i,n)=>i.index-n.index),(e instanceof He||e instanceof Ze)&&e.transparent&&s.sort((i,n)=>n.documentPosition.z-i.documentPosition.z),s.sort((i,n)=>i.renderOrder-n.renderOrder),e.transparent?t.transparent=s:t.opaque=s}removeMesh(e){const t=this.getMeshProjectionStack(e);e.transparent?t.transparent=t.transparent.filter(s=>s.uuid!==e.uuid):t.opaque=t.opaque.filter(s=>s.uuid!==e.uuid)}addShaderPass(e){const t=e.renderTarget?null:(i,n)=>{e.renderTexture&&i.copyTextureToTexture({texture:n},{texture:e.renderTexture.texture},[e.renderTexture.size.width,e.renderTexture.size.height]),this.renderer.postProcessingPass.setLoadOp("clear")},s=e.renderTarget?(i,n)=>{e.renderTarget&&e.renderTarget.renderTexture&&i.copyTextureToTexture({texture:n},{texture:e.renderTarget.renderTexture.texture},[e.renderTarget.renderTexture.size.width,e.renderTarget.renderTexture.size.height])}:null,r={renderPass:this.renderer.postProcessingPass,renderTexture:null,onBeforeRenderPass:t,onAfterRenderPass:s,element:e,stack:null};this.renderPassEntries.screen.push(r),this.renderPassEntries.screen.sort((i,n)=>{const o=i.element&&!i.element.renderTarget,a=i.element?i.element.renderOrder:0,h=i.element?i.element.index:0,u=n.element&&!n.element.renderTarget,c=n.element?n.element.renderOrder:0,l=n.element?n.element.index:0;return o&&!u?1:!o&&u?-1:a!==c?a-c:h-l})}removeShaderPass(e){this.renderPassEntries.screen=this.renderPassEntries.screen.filter(t=>!t.element||t.element.uuid!==e.uuid)}addPingPongPlane(e){this.renderPassEntries.pingPong.push({renderPass:e.renderTarget.renderPass,renderTexture:e.renderTarget.renderTexture,onBeforeRenderPass:null,onAfterRenderPass:(t,s)=>{t.copyTextureToTexture({texture:s},{texture:e.renderTexture.texture},[e.renderTexture.size.width,e.renderTexture.size.height])},element:e,stack:null}),this.renderPassEntries.pingPong.sort((t,s)=>t.element.renderOrder-s.element.renderOrder)}removePingPongPlane(e){this.renderPassEntries.pingPong=this.renderPassEntries.pingPong.filter(t=>t.element.uuid!==e.uuid)}getObjectRenderPassEntry(e){if(e instanceof Xe)return this.renderPassEntries.renderTarget.find(t=>t.renderPass.uuid===e.renderPass.uuid);if(e instanceof Rt)return this.renderPassEntries.pingPong.find(t=>t.element.uuid===e.uuid);if(e instanceof vt)return this.renderPassEntries.screen.find(t=>{var s;return((s=t.element)==null?void 0:s.uuid)===e.uuid});{const t=e.renderTarget?"renderTarget":"screen";return this.renderPassEntries[t].find(s=>[...s.stack.unProjected.opaque,...s.stack.unProjected.transparent,...s.stack.projected.opaque,...s.stack.projected.transparent].some(r=>r.uuid===e.uuid))}}renderSinglePassEntry(e,t){var i;const s=this.renderer.setRenderPassCurrentTexture(t.renderPass,(i=t.renderTexture)==null?void 0:i.texture);t.onBeforeRenderPass&&t.onBeforeRenderPass(e,s);const r=e.beginRenderPass(t.renderPass.descriptor);t.element?t.element.render(r):t.stack&&(t.stack.unProjected.opaque.forEach(n=>n.render(r)),t.stack.unProjected.transparent.forEach(n=>n.render(r)),(t.stack.projected.opaque.length||t.stack.projected.transparent.length)&&(this.renderer.cameraBindGroup&&r.setBindGroup(this.renderer.cameraBindGroup.index,this.renderer.cameraBindGroup.bindGroup),t.stack.projected.opaque.forEach(n=>n.render(r)),t.stack.projected.transparent.forEach(n=>n.render(r)))),r.end(),t.onAfterRenderPass&&t.onAfterRenderPass(e,s),this.renderer.pipelineManager.resetCurrentPipeline()}render(e){this.computePassEntries.forEach(t=>{const s=e.beginComputePass();t.render(s),s.end(),t.copyBufferToResult(e),this.renderer.pipelineManager.resetCurrentPipeline()});for(const t in this.renderPassEntries){let s=0;this.renderPassEntries[t].forEach((r,i)=>{this.getRenderPassEntryLength(r)&&(r.renderPass.setLoadOp(t==="screen"&&s!==0?"load":"clear"),s++,this.renderSinglePassEntry(e,r))})}}}class Ee{constructor(){D(this,fe,void 0);_(this,fe,0),this.queue=[]}add(e=r=>{},{order:t=this.queue.length,once:s=!1}={}){const r={callback:e,order:t,once:s,id:M(this,fe)};return St(this,fe)._++,this.queue.push(r),this.queue.sort((i,n)=>i.order-n.order),r.id}remove(e=0){this.queue=this.queue.filter(t=>t.id!==e)}execute(e){this.queue.forEach(t=>{t.callback(e),t.once&&this.remove(t.id)})}}fe=new WeakMap;class Qe{constructor({deviceManager:e,container:t,pixelRatio:s=1,preferredFormat:r,alphaMode:i="premultiplied",multisampled:n=!0,renderPass:o}){var h;this._onBeforeRenderCallback=u=>{},this._onAfterRenderCallback=u=>{},this._onAfterResizeCallback=()=>{},this.type="GPURenderer",this.uuid=R(),this.deviceManager=e,this.deviceManager.addRenderer(this),o={depth:!0,sampleCount:4,clearValue:[0,0,0,0],...o},r=r??((h=this.deviceManager.gpu)==null?void 0:h.getPreferredCanvasFormat()),this.options={deviceManager:e,container:t,pixelRatio:s,preferredFormat:r,alphaMode:i,multisampled:n,renderPass:o},this.pixelRatio=s??window.devicePixelRatio??1,this.alphaMode=i,this.setTasksQueues(),this.setRendererObjects();const a=t instanceof HTMLCanvasElement;this.canvas=a?t:document.createElement("canvas"),this.domElement=new Ye({element:t,priority:5,onSizeChanged:u=>this.resize(u)}),a||this.domElement.element.appendChild(this.canvas),this.deviceManager.device&&this.setContext()}setSize(e){const t=window.devicePixelRatio??1,s=this.pixelRatio/t;this.canvas.style.width=Math.floor(e.width)+"px",this.canvas.style.height=Math.floor(e.height)+"px";const r={width:Math.floor(e.width*s),height:Math.floor(e.height*s)};this.canvas.width=this.device?Math.min(r.width,this.device.limits.maxTextureDimension2D):r.width,this.canvas.height=this.device?Math.min(r.height,this.device.limits.maxTextureDimension2D):r.height}resize(e=null){!this.domElement&&!e||(e||(e=this.domElement.element.getBoundingClientRect()),this.setSize(e),this.onResize(),this._onAfterResizeCallback&&this._onAfterResizeCallback())}onResize(){var e,t;(e=this.renderPass)==null||e.resize(),(t=this.postProcessingPass)==null||t.resize(),this.renderTargets.forEach(s=>s.resize(this.pixelRatioBoundingRect)),this.renderTextures.forEach(s=>s.resize()),this.computePasses.forEach(s=>s.resize()),this.pingPongPlanes.forEach(s=>s.resize(this.boundingRect)),this.shaderPasses.forEach(s=>s.resize(this.boundingRect)),this.meshes.forEach(s=>{"domElement"in s?this.onBeforeCommandEncoderCreation.add(()=>{s.domElement.isResizing||s.domElement.setSize()},{once:!0}):s.resize(this.boundingRect)})}get boundingRect(){var e;if(this.domElement.boundingRect)return this.domElement.boundingRect;{const t=(e=this.domElement.element)==null?void 0:e.getBoundingClientRect();return{top:t.top,right:t.right,bottom:t.bottom,left:t.left,width:t.width,height:t.height,x:t.x,y:t.y}}}get pixelRatioBoundingRect(){const e=window.devicePixelRatio??1,t=this.pixelRatio/e;return Object.keys(this.boundingRect).reduce((s,r)=>({...s,[r]:this.boundingRect[r]*t}),{x:0,y:0,width:0,height:0,top:0,right:0,bottom:0,left:0})}get device(){return this.deviceManager.device}get ready(){return this.deviceManager.ready&&!!this.canvas.style.width}get production(){return this.deviceManager.production}get samplers(){return this.deviceManager.samplers}get buffers(){return this.deviceManager.buffers}get pipelineManager(){return this.deviceManager.pipelineManager}get deviceRenderedObjects(){return this.deviceManager.deviceRenderedObjects}configureContext(){this.context.configure({device:this.device,format:this.options.preferredFormat,alphaMode:this.alphaMode,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST})}setContext(){this.context=this.canvas.getContext("webgpu"),this.device&&(this.configureContext(),this.setMainRenderPasses(),this.setScene())}loseContext(){this.renderedObjects.forEach(e=>e.loseContext())}restoreContext(){var e,t;this.configureContext(),this.renderTextures.forEach(s=>{s.forceResize({width:Math.floor(this.pixelRatioBoundingRect.width),height:Math.floor(this.pixelRatioBoundingRect.height),depth:1})}),(e=this.renderPass)==null||e.resize(),(t=this.postProcessingPass)==null||t.resize(),this.renderTargets.forEach(s=>s.resize(this.pixelRatioBoundingRect)),this.renderedObjects.forEach(s=>s.restoreContext())}setMainRenderPasses(){this.renderPass=new Ce(this,{label:"Main render pass",targetFormat:this.options.preferredFormat,...this.options.renderPass}),this.postProcessingPass=new Ce(this,{label:"Post processing render pass",targetFormat:this.options.preferredFormat,depth:!1,sampleCount:this.options.renderPass.sampleCount})}setScene(){this.scene=new Ct({renderer:this})}createBuffer(e){var s;const t=(s=this.device)==null?void 0:s.createBuffer(e);return this.deviceManager.addBuffer(t),t}removeBuffer(e,t){this.deviceManager.removeBuffer(e,t)}queueWriteBuffer(e,t,s){var r;(r=this.device)==null||r.queue.writeBuffer(e,t,s)}copyBufferToBuffer({srcBuffer:e,dstBuffer:t,commandEncoder:s}){var i,n;if(!e)return V(`${this.type}: cannot copy to buffer because the source buffer has not been provided`),null;if(t||(t=this.createBuffer({label:this.type+": destination copy buffer from: "+e.label,size:e.size,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST})),e.mapState!=="unmapped"){V(`${this.type}: Cannot copy from ${e} because it is currently mapped`);return}if(t.mapState!=="unmapped"){V(`${this.type}: Cannot copy from ${t} because it is currently mapped`);return}const r=!!s;if(r||(s=(i=this.device)==null?void 0:i.createCommandEncoder({label:"Copy buffer command encoder"})),s.copyBufferToBuffer(e,0,t,0,t.size),!r){const o=s.finish();(n=this.device)==null||n.queue.submit([o])}return t}get bindGroups(){return this.deviceManager.bindGroups}addBindGroup(e){this.deviceManager.addBindGroup(e)}removeBindGroup(e){this.deviceManager.removeBindGroup(e)}createBindGroupLayout(e){var t;return(t=this.device)==null?void 0:t.createBindGroupLayout(e)}createBindGroup(e){var t;return(t=this.device)==null?void 0:t.createBindGroup(e)}createShaderModule(e){var t;return(t=this.device)==null?void 0:t.createShaderModule(e)}createPipelineLayout(e){var t;return(t=this.device)==null?void 0:t.createPipelineLayout(e)}createRenderPipeline(e){var t;return(t=this.device)==null?void 0:t.createRenderPipeline(e)}async createRenderPipelineAsync(e){var t;return await((t=this.device)==null?void 0:t.createRenderPipelineAsync(e))}createComputePipeline(e){var t;return(t=this.device)==null?void 0:t.createComputePipeline(e)}async createComputePipelineAsync(e){var t;return await((t=this.device)==null?void 0:t.createComputePipelineAsync(e))}get textures(){return this.deviceManager.textures}addTexture(e){this.deviceManager.addTexture(e)}removeTexture(e){this.deviceManager.removeTexture(e)}addRenderTexture(e){this.renderTextures.push(e)}removeRenderTexture(e){this.renderTextures=this.renderTextures.filter(t=>t.uuid!==e.uuid)}createTexture(e){var t;return(t=this.device)==null?void 0:t.createTexture(e)}uploadTexture(e){this.deviceManager.uploadTexture(e)}importExternalTexture(e){var t;return(t=this.device)==null?void 0:t.importExternalTexture({source:e})}createSampler(e){var s;const t=this.samplers.find(r=>JSON.stringify(r.options)===JSON.stringify(e.options)&&r.sampler);if(t)return t.sampler;{const{type:r,...i}=e.options,n=(s=this.device)==null?void 0:s.createSampler({label:e.label,...i});return this.deviceManager.addSampler(e),n}}removeSampler(e){this.deviceManager.removeSampler(e)}setTasksQueues(){this.onBeforeCommandEncoderCreation=new Ee,this.onBeforeRenderScene=new Ee,this.onAfterRenderScene=new Ee,this.onAfterCommandEncoderSubmission=new Ee}setRendererObjects(){this.computePasses=[],this.pingPongPlanes=[],this.shaderPasses=[],this.renderTargets=[],this.meshes=[],this.renderTextures=[]}get renderedObjects(){return[...this.computePasses,...this.meshes,...this.shaderPasses,...this.pingPongPlanes]}getObjectsByBindGroup(e){return this.deviceRenderedObjects.filter(t=>[...t.material.bindGroups,...t.material.inputsBindGroups,...t.material.clonedBindGroups].some(s=>s.uuid===e.uuid))}getObjectsByTexture(e){return this.deviceRenderedObjects.filter(t=>[...t.material.textures,...t.material.renderTextures].some(s=>s.uuid===e.uuid))}onBeforeRender(e){return e&&(this._onBeforeRenderCallback=e),this}onAfterRender(e){return e&&(this._onAfterRenderCallback=e),this}onAfterResize(e){return e&&(this._onAfterResizeCallback=e),this}setRenderPassCurrentTexture(e,t=null){return t||(t=this.context.getCurrentTexture(),t.label=`${this.type} context current texture`),e.options.sampleCount>1?(e.descriptor.colorAttachments[0].view=e.viewTexture.texture.createView({label:e.viewTexture.options.label+" view"}),e.descriptor.colorAttachments[0].resolveTarget=t.createView({label:t.label+" resolve target view"})):e.descriptor.colorAttachments[0].view=t.createView({label:t.label+" view"}),t}renderSingleComputePass(e,t){const s=e.beginComputePass();t.render(s),s.end(),t.copyBufferToResult(e)}renderSingleMesh(e,t){const s=e.beginRenderPass(this.renderPass.descriptor);t.render(s),s.end()}renderOnce(e){var r,i;const t=(r=this.device)==null?void 0:r.createCommandEncoder({label:"Renderer once command encoder"});this.pipelineManager.resetCurrentPipeline(),e.forEach(n=>{n instanceof ut?this.renderSingleComputePass(t,n):this.renderSingleMesh(t,n)});const s=t.finish();(i=this.device)==null||i.queue.submit([s]),this.pipelineManager.resetCurrentPipeline()}forceClear(e){var r,i;const t=!!e;if(t||(e=(r=this.device)==null?void 0:r.createCommandEncoder({label:"Force clear command encoder"})),this.setRenderPassCurrentTexture(this.renderPass),e.beginRenderPass(this.renderPass.descriptor).end(),!t){const n=e.finish();(i=this.device)==null||i.queue.submit([n])}}onBeforeCommandEncoder(){this.ready&&this.onBeforeCommandEncoderCreation.execute()}onAfterCommandEncoder(){this.ready&&this.onAfterCommandEncoderSubmission.execute()}render(e){var t;this.ready&&(this._onBeforeRenderCallback&&this._onBeforeRenderCallback(e),this.onBeforeRenderScene.execute(e),(t=this.scene)==null||t.render(e),this._onAfterRenderCallback&&this._onAfterRenderCallback(e),this.onAfterRenderScene.execute(e))}destroy(){var e,t,s,r;(e=this.domElement)==null||e.destroy(),(t=this.renderPass)==null||t.destroy(),(s=this.postProcessingPass)==null||s.destroy(),this.renderTargets.forEach(i=>i.destroy()),this.renderedObjects.forEach(i=>i.remove()),this.renderTextures.forEach(i=>i.destroy()),(r=this.context)==null||r.unconfigure()}}class Je extends Qe{constructor({deviceManager:e,container:t,pixelRatio:s=1,preferredFormat:r,alphaMode:i="premultiplied",multisampled:n=!0,renderPass:o,camera:a={}}){super({deviceManager:e,container:t,pixelRatio:s,preferredFormat:r,alphaMode:i,multisampled:n,renderPass:o}),this.type="GPUCameraRenderer",a={fov:50,near:.01,far:50,...a},this.options={...this.options,camera:a},this.setCamera(a)}setContext(){super.setContext(),this.device&&this.setCameraBufferBinding()}loseContext(){super.loseContext(),this.cameraBindGroup.loseContext()}async restoreContext(){return this.cameraBufferBinding.shouldUpdate=!0,super.restoreContext()}setCamera(e){const t=this.boundingRect?this.boundingRect.width:1,s=this.boundingRect?this.boundingRect.height:1;this.camera=new nt({fov:e.fov,near:e.near,far:e.far,width:t,height:s,pixelRatio:this.pixelRatio,onMatricesChanged:()=>{this.onCameraMatricesChanged()}})}onCameraMatricesChanged(){this.updateCameraBindings(),this.meshes.forEach(e=>{"modelViewMatrix"in e&&e.shouldUpdateMatrixStack()})}setCameraBufferBinding(){this.cameraBufferBinding=new de({label:"Camera",name:"camera",visibility:"vertex",struct:{model:{name:"model",type:"mat4x4f",value:this.camera.modelMatrix,onBeforeUpdate:()=>{this.cameraBufferBinding.inputs.model.value=this.camera.modelMatrix}},view:{name:"view",type:"mat4x4f",value:this.camera.viewMatrix,onBeforeUpdate:()=>{this.cameraBufferBinding.inputs.view.value=this.camera.viewMatrix}},projection:{name:"projection",type:"mat4x4f",value:this.camera.projectionMatrix,onBeforeUpdate:()=>{this.cameraBufferBinding.inputs.projection.value=this.camera.projectionMatrix}}}}),this.cameraBindGroup=new ve(this,{label:"Camera Uniform bind group",bindings:[this.cameraBufferBinding]})}setCameraBindGroup(){this.cameraBindGroup.shouldCreateBindGroup&&(this.cameraBindGroup.setIndex(0),this.cameraBindGroup.createBindGroup())}updateCameraBindings(){var e,t,s;(e=this.cameraBufferBinding)==null||e.shouldUpdateBinding("model"),(t=this.cameraBufferBinding)==null||t.shouldUpdateBinding("view"),(s=this.cameraBufferBinding)==null||s.shouldUpdateBinding("projection")}getObjectsByBindGroup(e){return this.deviceRenderedObjects.filter(t=>[...t.material.bindGroups,...t.material.inputsBindGroups,...t.material.clonedBindGroups,this.cameraBindGroup].some(s=>s.uuid===e.uuid))}setPerspective({fov:e,near:t,far:s}={}){var r;(r=this.camera)==null||r.setPerspective({fov:e,near:t,far:s,width:this.boundingRect.width,height:this.boundingRect.height,pixelRatio:this.pixelRatio})}setCameraPosition(e=new f(0,0,1)){this.camera.position.copy(e)}onResize(){super.onResize(),this.setPerspective(),this.updateCameraBindings()}updateCamera(){var e,t;(e=this.camera)==null||e.updateMatrixStack(),this.setCameraBindGroup(),(t=this.cameraBindGroup)==null||t.update()}renderSingleMesh(e,t){const s=e.beginRenderPass(this.renderPass.descriptor);t.material.options.rendering.useProjection&&s.setBindGroup(this.cameraBindGroup.index,this.cameraBindGroup.bindGroup),t.render(s),s.end()}render(e){this.ready&&(this.updateCamera(),super.render(e))}destroy(){var e;(e=this.cameraBindGroup)==null||e.destroy(),super.destroy()}}class Et{constructor({label:e,production:t=!1,onError:s=()=>{},onDeviceLost:r=i=>{}}){this.index=0,this.label=e??"GPUDeviceManager instance",this.production=t,this.ready=!1,this.onError=s,this.onDeviceLost=r,this.gpu=navigator.gpu,this.setPipelineManager(),this.setDeviceObjects()}async setAdapterAndDevice(){await this.setAdapter(),await this.setDevice()}async init(){await this.setAdapterAndDevice(),this.device&&this.renderers.forEach(e=>{e.context||e.setContext()})}async setAdapter(){var e,t;this.gpu||(this.onError(),I("GPURenderer: WebGPU is not supported on your browser/OS. No 'gpu' object in 'navigator'."));try{this.adapter=await((e=this.gpu)==null?void 0:e.requestAdapter()),(t=this.adapter)==null||t.requestAdapterInfo().then(s=>{this.adapterInfos=s})}catch{this.onError(),I("GPUDeviceManager: WebGPU is not supported on your browser/OS. 'requestAdapter' failed.")}}async setDevice(){var e,t;try{this.device=await((e=this.adapter)==null?void 0:e.requestDevice({label:this.label+" "+this.index})),this.device&&(this.ready=!0,this.index++)}catch(s){this.onError(),I(`${this.label}: WebGPU is not supported on your browser/OS. 'requestDevice' failed: ${s}`)}(t=this.device)==null||t.lost.then(s=>{V(`${this.label}: WebGPU device was lost: ${s.message}`),this.loseDevice(),s.reason!=="destroyed"&&this.onDeviceLost(s)})}setPipelineManager(){this.pipelineManager=new Mt}loseDevice(){this.ready=!1,this.samplers.forEach(e=>e.sampler=null),this.renderers.forEach(e=>e.loseContext()),this.buffers=[]}async restoreDevice(){await this.setAdapterAndDevice(),this.device&&(this.samplers.forEach(e=>{const{type:t,...s}=e.options;e.sampler=this.device.createSampler({label:e.label,...s})}),this.renderers.forEach(e=>e.restoreContext()))}setDeviceObjects(){this.renderers=[],this.bindGroups=[],this.buffers=[],this.samplers=[],this.textures=[],this.texturesQueue=[]}addRenderer(e){this.renderers.push(e)}removeRenderer(e){this.renderers=this.renderers.filter(t=>t.uuid!==e.uuid)}get deviceRenderedObjects(){return this.renderers.map(e=>e.renderedObjects).flat()}addBindGroup(e){this.bindGroups.find(t=>t.uuid===e.uuid)||this.bindGroups.push(e)}removeBindGroup(e){this.bindGroups=this.bindGroups.filter(t=>t.uuid!==e.uuid)}addBuffer(e){this.buffers.push(e)}removeBuffer(e,t){e&&(this.buffers=this.buffers.filter(s=>!(s.label===(t??e.label)&&s.size===e.size)))}addSampler(e){this.samplers.push(e)}removeSampler(e){this.samplers=this.samplers.filter(t=>t.uuid!==e.uuid)}addTexture(e){this.textures.push(e)}uploadTexture(e){var t,s;if(e.source)try{(t=this.device)==null||t.queue.copyExternalImageToTexture({source:e.source,flipY:e.options.flipY},{texture:e.texture,premultipliedAlpha:e.options.premultipliedAlpha},{width:e.size.width,height:e.size.height}),e.texture.mipLevelCount>1&&Ot(this.device,e.texture),this.texturesQueue.push(e)}catch({message:r}){I(`GPUDeviceManager: could not upload texture: ${e.options.name} because: ${r}`)}else(s=this.device)==null||s.queue.writeTexture({texture:e.texture},new Uint8Array(e.options.placeholderColor),{bytesPerRow:e.size.width*4},{width:e.size.width,height:e.size.height})}removeTexture(e){this.textures=this.textures.filter(t=>t.uuid!==e.uuid)}render(){var s,r;if(!this.ready)return;this.renderers.forEach(i=>i.onBeforeCommandEncoder());const e=(s=this.device)==null?void 0:s.createCommandEncoder({label:this.label+" command encoder"});this.renderers.forEach(i=>i.render(e));const t=e.finish();(r=this.device)==null||r.queue.submit([t]),this.textures.filter(i=>!i.parentMesh&&i.sourceLoaded&&!i.sourceUploaded).forEach(i=>this.uploadTexture(i)),this.texturesQueue.forEach(i=>{i.sourceUploaded=!0}),this.texturesQueue=[],this.renderers.forEach(i=>i.onAfterCommandEncoder())}destroy(){var e;(e=this.device)==null||e.destroy(),this.device=null,this.renderers.forEach(t=>t.destroy()),this.bindGroups.forEach(t=>t.destroy()),this.buffers.forEach(t=>t==null?void 0:t.destroy()),this.textures.forEach(t=>t.destroy()),this.setDeviceObjects()}}class Ke extends Je{constructor({deviceManager:e,container:t,pixelRatio:s=1,preferredFormat:r,alphaMode:i="premultiplied",multisampled:n=!0,renderPass:o,camera:a}){super({deviceManager:e,container:t,pixelRatio:s,preferredFormat:r,alphaMode:i,renderPass:o,multisampled:n,camera:a}),this.type="GPUCurtainsRenderer"}setRendererObjects(){super.setRendererObjects(),this.domMeshes=[]}}class Yt{constructor({scroll:e={x:0,y:0},delta:t={x:0,y:0},shouldWatch:s=!0,onScroll:r=(i={x:0,y:0})=>{}}={}){this.scroll=e,this.delta=t,this.shouldWatch=s,this.onScroll=r,this.shouldWatch&&window.addEventListener("scroll",this.setScroll.bind(this),{passive:!0})}setScroll(){this.updateScrollValues({x:window.pageXOffset,y:window.pageYOffset})}updateScrollValues({x:e,y:t}){const s=this.scroll;this.scroll={x:e,y:t},this.delta={x:s.x-this.scroll.x,y:s.y-this.scroll.y},this.onScroll&&this.onScroll(this.delta)}destroy(){this.shouldWatch&&window.removeEventListener("scroll",this.setScroll.bind(this),{passive:!0})}}class Xt{constructor({container:e,pixelRatio:t=window.devicePixelRatio??1,preferredFormat:s,alphaMode:r="premultiplied",production:i=!1,multisampled:n=!0,renderPass:o,camera:a,autoRender:h=!0,autoResize:u=!0,watchScroll:c=!0}){this._onRenderCallback=()=>{},this._onScrollCallback=()=>{},this._onErrorCallback=()=>{},this._onContextLostCallback=()=>{},this.type="CurtainsGPU",this.options={container:e,pixelRatio:t,camera:a,production:i,preferredFormat:s,alphaMode:r,multisampled:n,renderPass:o,autoRender:h,autoResize:u,watchScroll:c},this.setDeviceManager(),e&&this.setContainer(e)}setContainer(e){if(e)if(typeof e=="string")if(e=document.querySelector(e),e)this.options.container=e;else{const t=document.createElement("div");t.setAttribute("id","curtains-gpu-canvas"),document.body.appendChild(t),this.options.container=t}else e instanceof Element&&(this.options.container=e);else{const t=document.createElement("div");t.setAttribute("id","curtains-gpu-canvas"),document.body.appendChild(t),this.options.container=t}this.container=this.options.container,this.setCurtains()}setMainRenderer(){this.createCurtainsRenderer({deviceManager:this.deviceManager,container:this.options.container,pixelRatio:this.options.pixelRatio,preferredFormat:this.options.preferredFormat,alphaMode:this.options.alphaMode,multisampled:this.options.multisampled,renderPass:this.options.renderPass,camera:this.options.camera})}patchRendererOptions(e){return e.pixelRatio===void 0&&(e.pixelRatio=this.options.pixelRatio),e}createRenderer(e){return e=this.patchRendererOptions(e),new Qe({...e,deviceManager:this.deviceManager})}createCameraRenderer(e){return e=this.patchRendererOptions(e),new Je({...e,deviceManager:this.deviceManager})}createCurtainsRenderer(e){return e=this.patchRendererOptions(e),new Ke({...e,deviceManager:this.deviceManager})}setDeviceManager(){this.deviceManager=new Et({label:"GPUCurtains default device",production:this.options.production,onError:()=>setTimeout(()=>{this._onErrorCallback&&this._onErrorCallback()},0),onDeviceLost:e=>this._onContextLostCallback&&this._onContextLostCallback(e)})}get renderers(){return this.deviceManager.renderers}get renderer(){return this.renderers[0]}async setDevice(){await this.deviceManager.init()}async restoreContext(){await this.deviceManager.restoreDevice()}setCurtains(){this.initEvents(),this.setMainRenderer(),this.options.autoRender&&this.animate()}get pingPongPlanes(){var e;return(e=this.renderers)==null?void 0:e.map(t=>t.pingPongPlanes).flat()}get shaderPasses(){var e;return(e=this.renderers)==null?void 0:e.map(t=>t.shaderPasses).flat()}get meshes(){var e;return(e=this.renderers)==null?void 0:e.map(t=>t.meshes).flat()}get domMeshes(){var e;return(e=this.renderers)==null?void 0:e.filter(t=>t instanceof Ke).map(t=>t.domMeshes).flat()}get planes(){return this.domMeshes.filter(e=>e instanceof Ze)}get computePasses(){var e;return(e=this.renderers)==null?void 0:e.map(t=>t.computePasses).flat()}get camera(){var e;return(e=this.renderer)==null?void 0:e.camera}setPerspective({fov:e=50,near:t=.01,far:s=50}={}){var r;(r=this.renderer)==null||r.setPerspective({fov:e,near:t,far:s})}setCameraPosition(e=new f(0,0,1)){var t;(t=this.renderer)==null||t.setCameraPosition(e)}get boundingRect(){var e;return(e=this.renderer)==null?void 0:e.boundingRect}initScroll(){this.scrollManager=new Yt({scroll:{x:window.pageXOffset,y:window.pageYOffset},delta:{x:0,y:0},shouldWatch:this.options.watchScroll,onScroll:e=>this.updateScroll(e)})}updateScroll(e={x:0,y:0}){this.domMeshes.forEach(t=>{t.domElement&&t.updateScrollPosition(e)}),this._onScrollCallback&&this._onScrollCallback()}updateScrollValues(e={x:0,y:0}){this.scrollManager.updateScrollValues(e)}get scrollDelta(){return this.scrollManager.delta}get scrollValues(){return this.scrollManager.scroll}initEvents(){Ne.useObserver(this.options.autoResize),this.initScroll()}onRender(e){return e&&(this._onRenderCallback=e),this}onScroll(e){return e&&(this._onScrollCallback=e),this}onError(e){return e&&(this._onErrorCallback=e),this}onContextLost(e){return e&&(this._onContextLostCallback=e),this}animate(){this.render(),this.animationFrameID=window.requestAnimationFrame(this.animate.bind(this))}render(){this._onRenderCallback&&this._onRenderCallback(),this.deviceManager.render()}destroy(){var e;this.animationFrameID&&window.cancelAnimationFrame(this.animationFrameID),this.deviceManager.destroy(),(e=this.scrollManager)==null||e.destroy(),Ne.destroy()}}class Ht extends Be{constructor({widthSegments:e=1,heightSegments:t=1,depthSegments:s=1,instancesCount:r=1,vertexBuffers:i=[],topology:n}={}){super({verticesOrder:"ccw",topology:n,instancesCount:r,vertexBuffers:i}),this.type="BoxGeometry",e=Math.floor(e),t=Math.floor(t),s=Math.floor(s);const o=[],a=[],h=[],u=[];let c=0;const l=(p,y,b,x,g,T,C,P,v,B)=>{const w=T/v,S=C/B,E=T/2,k=C/2,X=P/2,q=v+1,J=B+1;let H=0;const O=new f;for(let F=0;F<J;F++){const L=F*S-k;for(let j=0;j<q;j++){const N=j*w-E;O[p]=N*x,O[y]=L*g,O[b]=X,o.push(O.x,O.y,O.z),O[p]=0,O[y]=0,O[b]=P>0?1:-1,h.push(O.x,O.y,O.z),a.push(j/v),a.push(F/B),H+=1}}for(let F=0;F<B;F++)for(let L=0;L<v;L++){const j=c+L+q*F,N=c+L+q*(F+1),K=c+(L+1)+q*(F+1),ue=c+(L+1)+q*F;u.push(j,N,ue),u.push(N,K,ue),c+=H}};l("z","y","x",-1,-1,2,2,2,s,t),l("z","y","x",1,-1,2,2,-2,s,t),l("x","z","y",1,1,2,2,2,e,s),l("x","z","y",1,-1,2,2,-2,e,s),l("x","y","z",1,-1,2,2,2,e,t),l("x","y","z",-1,-1,2,2,-2,e,t),this.setAttribute({name:"position",type:"vec3f",bufferFormat:"float32x3",size:3,array:new Float32Array(o)}),this.setAttribute({name:"uv",type:"vec2f",bufferFormat:"float32x2",size:2,array:new Float32Array(a)}),this.setAttribute({name:"normal",type:"vec3f",bufferFormat:"float32x3",size:3,array:new Float32Array(h)}),this.setIndexBuffer({array:this.useUint16IndexArray?new Uint16Array(u):new Uint32Array(u),bufferFormat:this.useUint16IndexArray?"uint16":"uint32"})}}class Zt extends Be{constructor({widthSegments:e=32,heightSegments:t=16,phiStart:s=0,phiLength:r=Math.PI*2,thetaStart:i=0,thetaLength:n=Math.PI,instancesCount:o=1,vertexBuffers:a=[],topology:h}={}){super({verticesOrder:"ccw",topology:h,instancesCount:o,vertexBuffers:a}),this.type="SphereGeometry",e=Math.max(3,Math.floor(e)),t=Math.max(2,Math.floor(t));const u=1,c=Math.min(i+n,Math.PI);let l=0;const p=[],y=new f,b=new f,x=[],g=[],T=[],C=[];for(let P=0;P<=t;P++){const v=[],B=P/t;let w=0;P===0&&i===0?w=.5/e:P===t&&c===Math.PI&&(w=-.5/e);for(let S=0;S<=e;S++){const E=S/e;y.x=-u*Math.cos(s+E*r)*Math.sin(i+B*n),y.y=u*Math.cos(i+B*n),y.z=u*Math.sin(s+E*r)*Math.sin(i+B*n),g.push(y.x,y.y,y.z),b.copy(y).normalize(),T.push(b.x,b.y,b.z),C.push(E+w,B),v.push(l++)}p.push(v)}for(let P=0;P<t;P++)for(let v=0;v<e;v++){const B=p[P][v+1],w=p[P][v],S=p[P+1][v],E=p[P+1][v+1];(P!==0||i>0)&&x.push(B,w,E),(P!==t-1||c<Math.PI)&&x.push(w,S,E)}this.setAttribute({name:"position",type:"vec3f",bufferFormat:"float32x3",size:3,array:new Float32Array(g)}),this.setAttribute({name:"uv",type:"vec2f",bufferFormat:"float32x2",size:2,array:new Float32Array(C)}),this.setAttribute({name:"normal",type:"vec3f",bufferFormat:"float32x3",size:3,array:new Float32Array(T)}),this.setIndexBuffer({array:this.useUint16IndexArray?new Uint16Array(x):new Uint32Array(x),bufferFormat:this.useUint16IndexArray?"uint16":"uint32"})}}m.BindGroup=ve,m.Binding=we,m.Box3=le,m.BoxGeometry=Ht,m.BufferBinding=de,m.Camera=nt,m.ComputeMaterial=ht,m.ComputePass=ut,m.ComputePipelineEntry=We,m.DOMElement=Ye,m.DOMFrustum=lt,m.DOMMesh=He,m.DOMObject3D=Bt,m.FullscreenPlane=je,m.GPUCameraRenderer=Je,m.GPUCurtains=Xt,m.GPUCurtainsRenderer=Ke,m.GPUDeviceManager=Et,m.GPURenderer=Qe,m.Geometry=De,m.IndexedGeometry=Be,m.Mat4=z,m.Material=Le,m.Mesh=jt,m.Object3D=Re,m.PingPongPlane=Rt,m.PipelineEntry=$e,m.PipelineManager=Mt,m.Plane=Ze,m.PlaneGeometry=Ve,m.ProjectedObject3D=Ie,m.Quat=Y,m.RenderMaterial=ct,m.RenderPass=Ce,m.RenderPipelineEntry=qe,m.RenderTarget=Xe,m.RenderTexture=te,m.Sampler=ot,m.SamplerBinding=rt,m.Scene=Ct,m.ShaderPass=vt,m.SphereGeometry=Zt,m.Texture=se,m.TextureBindGroup=ke,m.TextureBinding=_e,m.Vec2=A,m.Vec3=f,m.WritableBufferBinding=Fe,Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});
