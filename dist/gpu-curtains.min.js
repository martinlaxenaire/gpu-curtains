var GPUCurtains=(()=>{var et=Object.defineProperty;var Mt=Object.getOwnPropertyDescriptor;var Rt=Object.getOwnPropertyNames;var Tt=Object.prototype.hasOwnProperty;var Ct=(h,e)=>{for(var t in e)et(h,t,{get:e[t],enumerable:!0})},Gt=(h,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Rt(e))!Tt.call(h,s)&&s!==t&&et(h,s,{get:()=>e[s],enumerable:!(r=Mt(e,s))||r.enumerable});return h};var Et=h=>Gt(et({},"__esModule",{value:!0}),h);var Dt={};Ct(Dt,{BindGroup:()=>X,Binding:()=>Y,Box3:()=>se,BoxGeometry:()=>Je,BufferBinding:()=>j,Camera:()=>Te,ComputeMaterial:()=>Ge,ComputePass:()=>Ee,ComputePipelineEntry:()=>ge,DOMElement:()=>H,DOMFrustum:()=>we,DOMMesh:()=>de,DOMObject3D:()=>Oe,FullscreenPlane:()=>oe,GPUCameraRenderer:()=>De,GPUCurtains:()=>Ze,GPUCurtainsRenderer:()=>Le,GPURenderer:()=>Ve,Geometry:()=>ie,IndexedGeometry:()=>K,Mat4:()=>E,Material:()=>re,Mesh:()=>He,Object3D:()=>J,PingPongPlane:()=>Ye,PipelineEntry:()=>ue,PipelineManager:()=>Se,Plane:()=>ze,PlaneGeometry:()=>ne,ProjectedObject3D:()=>ae,Quat:()=>L,RenderMaterial:()=>Ue,RenderPass:()=>he,RenderPipelineEntry:()=>xe,RenderTarget:()=>Fe,RenderTexture:()=>_,Sampler:()=>Ce,SamplerBinding:()=>Re,Scene:()=>Ae,ShaderPass:()=>Qe,SphereGeometry:()=>Ke,Texture:()=>I,TextureBindGroup:()=>fe,TextureBinding:()=>Z,Vec2:()=>W,Vec3:()=>c,WritableBufferBinding:()=>ce});var V=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,h=>{let e=Math.random()*16|0;return(h==="x"?e:e&3|8).toString(16).toUpperCase()}),me=h=>h.replace(/(?:^\w|[A-Z]|\b\w)/g,(e,t)=>t===0?e.toLowerCase():e.toUpperCase()).replace(/\s+/g,""),ke=h=>{let e=me(h);return e.charAt(0).toUpperCase()+e.slice(1)},tt=0,O=h=>{tt>100||(console.warn(tt===100?"GPUCurtains: too many warnings thrown, stop logging.":h),tt++)};var S=h=>{throw new Error(h)};var rt=(h,e="GPURenderer",t)=>{let r=t?`Unable to create ${t} because the ${e} is not defined: ${h}`:`The ${e} is not defined: ${h}`;S(r)},b=(h,e)=>{let t=h&&(h.type==="GPURenderer"||h.type==="GPUCameraRenderer"||h.type==="GPUCurtainsRenderer");return t||rt(h,"GPURenderer",e),t},Pe=(h,e)=>{let t=h&&(h.type==="GPUCameraRenderer"||h.type==="GPUCurtainsRenderer");return t||rt(h,"GPUCameraRenderer",e),t},be=(h,e)=>{let t=h&&h.type==="GPUCurtainsRenderer";return t||rt(h,"GPUCurtainsRenderer",e),t},ht=(()=>{let h,e,t={};return function(s,i){e||(e=s.createShaderModule({label:"textured quad shaders for mip level generation",code:`
            struct VSOutput {
              @builtin(position) position: vec4f,
              @location(0) texcoord: vec2f,
            };

            @vertex fn vs(
              @builtin(vertex_index) vertexIndex : u32
            ) -> VSOutput {
              var pos = array<vec2f, 6>(

                vec2f( 0.0,  0.0),  // center
                vec2f( 1.0,  0.0),  // right, center
                vec2f( 0.0,  1.0),  // center, top

                // 2st triangle
                vec2f( 0.0,  1.0),  // center, top
                vec2f( 1.0,  0.0),  // right, center
                vec2f( 1.0,  1.0),  // right, top
              );

              var vsOutput: VSOutput;
              let xy = pos[vertexIndex];
              vsOutput.position = vec4f(xy * 2.0 - 1.0, 0.0, 1.0);
              vsOutput.texcoord = vec2f(xy.x, 1.0 - xy.y);
              return vsOutput;
            }

            @group(0) @binding(0) var ourSampler: sampler;
            @group(0) @binding(1) var ourTexture: texture_2d<f32>;

            @fragment fn fs(fsInput: VSOutput) -> @location(0) vec4f {
              return textureSample(ourTexture, ourSampler, fsInput.texcoord);
            }
          `}),h=s.createSampler({minFilter:"linear"})),t[i.format]||(t[i.format]=s.createRenderPipeline({label:"mip level generator pipeline",layout:"auto",vertex:{module:e,entryPoint:"vs"},fragment:{module:e,entryPoint:"fs",targets:[{format:i.format}]}}));let n=t[i.format],o=s.createCommandEncoder({label:"mip gen encoder"}),a=i.width,u=i.height,d=0;for(;a>1||u>1;){a=Math.max(1,a/2|0),u=Math.max(1,u/2|0);let m=s.createBindGroup({layout:n.getBindGroupLayout(0),entries:[{binding:0,resource:h},{binding:1,resource:i.createView({baseMipLevel:d,mipLevelCount:1})}]});++d;let p={label:"our basic canvas renderPass",colorAttachments:[{view:i.createView({baseMipLevel:d,mipLevelCount:1}),loadOp:"clear",storeOp:"store"}]},f=o.beginRenderPass(p);f.setPipeline(n),f.setBindGroup(0,m),f.draw(6),f.end()}let l=o.finish();s.queue.submit([l])}})();var Y=class{constructor({label:e="Uniform",name:t="uniform",bindingType:r="uniform",bindIndex:s=0,visibility:i}){this.label=e,this.name=me(t),this.bindingType=r,this.bindIndex=s,this.visibility=i?(()=>{switch(i){case"vertex":return GPUShaderStage.VERTEX;case"fragment":return GPUShaderStage.FRAGMENT;case"compute":return GPUShaderStage.COMPUTE;default:return GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE}})():GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,this.options={label:e,name:t,bindingType:r,bindIndex:s,visibility:i}}};var We=h=>({i32:{numElements:1,align:4,size:4,type:"i32",View:Int32Array},u32:{numElements:1,align:4,size:4,type:"u32",View:Uint32Array},f32:{numElements:1,align:4,size:4,type:"f32",View:Float32Array},f16:{numElements:1,align:2,size:2,type:"u16",View:Uint16Array},vec2f:{numElements:2,align:8,size:8,type:"f32",View:Float32Array},vec2i:{numElements:2,align:8,size:8,type:"i32",View:Int32Array},vec2u:{numElements:2,align:8,size:8,type:"u32",View:Uint32Array},vec2h:{numElements:2,align:4,size:4,type:"u16",View:Uint16Array},vec3i:{numElements:3,align:16,size:12,type:"i32",View:Int32Array},vec3u:{numElements:3,align:16,size:12,type:"u32",View:Uint32Array},vec3f:{numElements:3,align:16,size:12,type:"f32",View:Float32Array},vec3h:{numElements:3,align:8,size:6,type:"u16",View:Uint16Array},vec4i:{numElements:4,align:16,size:16,type:"i32",View:Int32Array},vec4u:{numElements:4,align:16,size:16,type:"u32",View:Uint32Array},vec4f:{numElements:4,align:16,size:16,type:"f32",View:Float32Array},vec4h:{numElements:4,align:8,size:8,type:"u16",View:Uint16Array},mat2x2f:{numElements:4,align:8,size:16,type:"f32",View:Float32Array},mat2x2h:{numElements:4,align:4,size:8,type:"u16",View:Uint16Array},mat3x2f:{numElements:6,align:8,size:24,type:"f32",View:Float32Array},mat3x2h:{numElements:6,align:4,size:12,type:"u16",View:Uint16Array},mat4x2f:{numElements:8,align:8,size:32,type:"f32",View:Float32Array},mat4x2h:{numElements:8,align:4,size:16,type:"u16",View:Uint16Array},mat2x3f:{numElements:8,align:16,size:32,pad:[3,1],type:"f32",View:Float32Array},mat2x3h:{numElements:8,align:8,size:16,pad:[3,1],type:"u16",View:Uint16Array},mat3x3f:{numElements:12,align:16,size:48,pad:[3,1],type:"f32",View:Float32Array},mat3x3h:{numElements:12,align:8,size:24,pad:[3,1],type:"u16",View:Uint16Array},mat4x3f:{numElements:16,align:16,size:64,pad:[3,1],type:"f32",View:Float32Array},mat4x3h:{numElements:16,align:8,size:32,pad:[3,1],type:"u16",View:Uint16Array},mat2x4f:{numElements:8,align:16,size:32,type:"f32",View:Float32Array},mat2x4h:{numElements:8,align:8,size:16,type:"u16",View:Uint16Array},mat3x4f:{numElements:12,align:16,size:48,pad:[3,1],type:"f32",View:Float32Array},mat3x4h:{numElements:12,align:8,size:24,pad:[3,1],type:"u16",View:Uint16Array},mat4x4f:{numElements:16,align:16,size:64,type:"f32",View:Float32Array},mat4x4h:{numElements:16,align:8,size:32,type:"u16",View:Uint16Array}})[h],je=h=>(()=>{switch(h.bindingType){case"storage":return`var<${h.bindingType}, ${h.options.access}>`;case"uniform":default:return"var<uniform>"}})(),lt=h=>(()=>{switch(h.bindingType){case"storageTexture":return`var ${h.name}: texture_storage_2d<${h.options.format}, ${h.options.access}>;`;case"externalTexture":return`var ${h.name}: texture_external;`;case"texture":default:return`var ${h.name}: texture_2d<f32>;`}})(),mt=h=>h.bindingType==="storage"&&h.options.access==="read_write"?"storage":h.bindingType==="storage"?"read-only-storage":"uniform",pt=h=>(()=>{switch(h.bindingType){case"externalTexture":return{externalTexture:{}};case"storageTexture":return{storageTexture:{format:h.options.format,viewDimension:"2d"}};case"texture":return{texture:{viewDimension:"2d"}};default:return null}})();var W=class h{constructor(e=0,t=e){this.type="Vec2",this._x=e,this._y=t}get x(){return this._x}set x(e){let t=e!==this._x;this._x=e,t&&this._onChangeCallback&&this._onChangeCallback()}get y(){return this._y}set y(e){let t=e!==this._y;this._y=e,t&&this._onChangeCallback&&this._onChangeCallback()}onChange(e){return e&&(this._onChangeCallback=e),this}set(e=0,t=e){return this.x=e,this.y=t,this}add(e=new h){return this.x+=e.x,this.y+=e.y,this}addScalar(e=0){return this.x+=e,this.y+=e,this}sub(e=new h){return this.x-=e.x,this.y-=e.y,this}subScalar(e=0){return this.x-=e,this.y-=e,this}multiply(e=new h(1)){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e=1){return this.x*=e,this.y*=e,this}copy(e=new h){return this.x=e.x,this.y=e.y,this}clone(){return new h(this.x,this.y)}max(e=new h){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}min(e=new h){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}equals(e=new h){return this.x===e.x&&this.y===e.y}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.lengthSq())}normalize(){let e=this.x*this.x+this.y*this.y;return e>0&&(e=1/Math.sqrt(e)),this.x*=e,this.y*=e,this}dot(e=new h){return this.x*e.x+this.y*e.y}lerp(e=new h,t=1){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}};var L=class h{constructor(e=new Float32Array([0,0,0,1]),t="XYZ"){this.type="Quat",this.elements=e,this.axisOrder=t}setFromArray(e=new Float32Array([0,0,0,1])){return this.elements[0]=e[0],this.elements[1]=e[1],this.elements[2]=e[2],this.elements[3]=e[3],this}setAxisOrder(e="XYZ"){switch(e=e.toUpperCase(),e){case"XYZ":case"YXZ":case"ZXY":case"ZYX":case"YZX":case"XZY":this.axisOrder=e;break;default:this.axisOrder="XYZ"}return this}copy(e=new h){return this.elements=e.elements,this.axisOrder=e.axisOrder,this}clone(){return new h().copy(this)}equals(e=new h){return this.elements[0]===e.elements[0]&&this.elements[1]===e.elements[1]&&this.elements[2]===e.elements[2]&&this.elements[3]===e.elements[3]&&this.axisOrder===e.axisOrder}setFromVec3(e=new c){let t=e.x*.5,r=e.y*.5,s=e.z*.5,i=Math.cos(t),n=Math.cos(r),o=Math.cos(s),a=Math.sin(t),u=Math.sin(r),d=Math.sin(s);return this.axisOrder==="XYZ"?(this.elements[0]=a*n*o+i*u*d,this.elements[1]=i*u*o-a*n*d,this.elements[2]=i*n*d+a*u*o,this.elements[3]=i*n*o-a*u*d):this.axisOrder==="YXZ"?(this.elements[0]=a*n*o+i*u*d,this.elements[1]=i*u*o-a*n*d,this.elements[2]=i*n*d-a*u*o,this.elements[3]=i*n*o+a*u*d):this.axisOrder==="ZXY"?(this.elements[0]=a*n*o-i*u*d,this.elements[1]=i*u*o+a*n*d,this.elements[2]=i*n*d+a*u*o,this.elements[3]=i*n*o-a*u*d):this.axisOrder==="ZYX"?(this.elements[0]=a*n*o-i*u*d,this.elements[1]=i*u*o+a*n*d,this.elements[2]=i*n*d-a*u*o,this.elements[3]=i*n*o+a*u*d):this.axisOrder==="YZX"?(this.elements[0]=a*n*o+i*u*d,this.elements[1]=i*u*o+a*n*d,this.elements[2]=i*n*d-a*u*o,this.elements[3]=i*n*o-a*u*d):this.axisOrder==="XZY"&&(this.elements[0]=a*n*o-i*u*d,this.elements[1]=i*u*o-a*n*d,this.elements[2]=i*n*d+a*u*o,this.elements[3]=i*n*o+a*u*d),this}setFromAxisAngle(e=new c,t=0){let r=t/2,s=Math.sin(r);return this.elements[0]=e.x*s,this.elements[1]=e.y*s,this.elements[2]=e.z*s,this.elements[3]=Math.cos(r),this}setFromRotationMatrix(e){let t=e.elements,r=t[0],s=t[4],i=t[8],n=t[1],o=t[5],a=t[9],u=t[2],d=t[6],l=t[10],m=r+o+l;if(m>0){let p=.5/Math.sqrt(m+1);this.elements[3]=.25/p,this.elements[0]=(d-a)*p,this.elements[1]=(i-u)*p,this.elements[2]=(n-s)*p}else if(r>o&&r>l){let p=2*Math.sqrt(1+r-o-l);this.elements[3]=(d-a)/p,this.elements[0]=.25*p,this.elements[1]=(s+n)/p,this.elements[2]=(i+u)/p}else if(o>l){let p=2*Math.sqrt(1+o-r-l);this.elements[3]=(i-u)/p,this.elements[0]=(s+n)/p,this.elements[1]=.25*p,this.elements[2]=(a+d)/p}else{let p=2*Math.sqrt(1+l-r-o);this.elements[3]=(n-s)/p,this.elements[0]=(i+u)/p,this.elements[1]=(a+d)/p,this.elements[2]=.25*p}return this}};var E=class h{constructor(e=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])){this.type="Mat4",this.elements=e}set(e,t,r,s,i,n,o,a,u,d,l,m,p,f,g,P){let x=this.elements;return x[0]=e,x[1]=t,x[2]=r,x[3]=s,x[4]=i,x[5]=n,x[6]=o,x[7]=a,x[8]=u,x[9]=d,x[10]=l,x[11]=m,x[12]=p,x[13]=f,x[14]=g,x[15]=P,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}setFromArray(e=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])){for(let t=0;t<this.elements.length;t++)this.elements[t]=e[t];return this}copy(e=new h){let t=e.elements;return this.elements[0]=t[0],this.elements[1]=t[1],this.elements[2]=t[2],this.elements[3]=t[3],this.elements[4]=t[4],this.elements[5]=t[5],this.elements[6]=t[6],this.elements[7]=t[7],this.elements[8]=t[8],this.elements[9]=t[9],this.elements[10]=t[10],this.elements[11]=t[11],this.elements[12]=t[12],this.elements[13]=t[13],this.elements[14]=t[14],this.elements[15]=t[15],this}clone(){return new h().copy(this)}multiply(e=new h){return this.multiplyMatrices(this,e)}premultiply(e=new h){return this.multiplyMatrices(e,this)}multiplyMatrices(e=new h,t=new h){let r=e.elements,s=t.elements,i=this.elements,n=r[0],o=r[4],a=r[8],u=r[12],d=r[1],l=r[5],m=r[9],p=r[13],f=r[2],g=r[6],P=r[10],x=r[14],T=r[3],C=r[7],B=r[11],M=r[15],R=s[0],y=s[4],w=s[8],G=s[12],z=s[1],N=s[5],F=s[9],ee=s[13],Q=s[2],U=s[6],v=s[10],A=s[14],D=s[3],$=s[7],te=s[11],le=s[15];return i[0]=n*R+o*z+a*Q+u*D,i[4]=n*y+o*N+a*U+u*$,i[8]=n*w+o*F+a*v+u*te,i[12]=n*G+o*ee+a*A+u*le,i[1]=d*R+l*z+m*Q+p*D,i[5]=d*y+l*N+m*U+p*$,i[9]=d*w+l*F+m*v+p*te,i[13]=d*G+l*ee+m*A+p*le,i[2]=f*R+g*z+P*Q+x*D,i[6]=f*y+g*N+P*U+x*$,i[10]=f*w+g*F+P*v+x*te,i[14]=f*G+g*ee+P*A+x*le,i[3]=T*R+C*z+B*Q+M*D,i[7]=T*y+C*N+B*U+M*$,i[11]=T*w+C*F+B*v+M*te,i[15]=T*G+C*ee+B*A+M*le,this}premultiplyTranslate(e=new c){let n=e.x,o=e.y,a=e.z,u=this.elements,d=this.elements,l=u[0],m=u[4],p=u[8],f=u[12],g=u[1],P=u[5],x=u[9],T=u[13],C=u[2],B=u[6],M=u[10],R=u[14],y=u[3],w=u[7],G=u[11],z=u[15];return d[0]=1*l+n*y,d[4]=1*m+n*w,d[8]=1*p+n*G,d[12]=1*f+n*z,d[1]=1*g+o*y,d[5]=1*P+o*w,d[9]=1*x+o*G,d[13]=1*T+o*z,d[2]=1*C+a*y,d[6]=1*B+a*w,d[10]=1*M+a*G,d[14]=1*R+a*z,d[3]=1*y,d[7]=1*w,d[11]=1*G,d[15]=1*z,this}premultiplyScale(e=new c){let t=this.elements,r=this.elements,s=e.x,i=e.y,n=e.z,o=1,a=t[0],u=t[4],d=t[8],l=t[12],m=t[1],p=t[5],f=t[9],g=t[13],P=t[2],x=t[6],T=t[10],C=t[14],B=t[3],M=t[7],R=t[11],y=t[15];return r[0]=s*a,r[4]=s*u,r[8]=s*d,r[12]=s*l,r[1]=i*m,r[5]=i*p,r[9]=i*f,r[13]=i*g,r[2]=n*P,r[6]=n*x,r[10]=n*T,r[14]=n*C,r[3]=o*B,r[7]=o*M,r[11]=o*R,r[15]=o*y,this}invert(){let e=this.elements,t=e[0],r=e[1],s=e[2],i=e[3],n=e[4],o=e[5],a=e[6],u=e[7],d=e[8],l=e[9],m=e[10],p=e[11],f=e[12],g=e[13],P=e[14],x=e[15],T=l*P*u-g*m*u+g*a*p-o*P*p-l*a*x+o*m*x,C=f*m*u-d*P*u-f*a*p+n*P*p+d*a*x-n*m*x,B=d*g*u-f*l*u+f*o*p-n*g*p-d*o*x+n*l*x,M=f*l*a-d*g*a-f*o*m+n*g*m+d*o*P-n*l*P,R=t*T+r*C+s*B+i*M;if(R===0)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);let y=1/R;return e[0]=T*y,e[1]=(g*m*i-l*P*i-g*s*p+r*P*p+l*s*x-r*m*x)*y,e[2]=(o*P*i-g*a*i+g*s*u-r*P*u-o*s*x+r*a*x)*y,e[3]=(l*a*i-o*m*i-l*s*u+r*m*u+o*s*p-r*a*p)*y,e[4]=C*y,e[5]=(d*P*i-f*m*i+f*s*p-t*P*p-d*s*x+t*m*x)*y,e[6]=(f*a*i-n*P*i-f*s*u+t*P*u+n*s*x-t*a*x)*y,e[7]=(n*m*i-d*a*i+d*s*u-t*m*u-n*s*p+t*a*p)*y,e[8]=B*y,e[9]=(f*l*i-d*g*i-f*r*p+t*g*p+d*r*x-t*l*x)*y,e[10]=(n*g*i-f*o*i+f*r*u-t*g*u-n*r*x+t*o*x)*y,e[11]=(d*o*i-n*l*i-d*r*u+t*l*u+n*r*p-t*o*p)*y,e[12]=M*y,e[13]=(d*g*s-f*l*s+f*r*m-t*g*m-d*r*P+t*l*P)*y,e[14]=(f*o*s-n*g*s-f*r*a+t*g*a+n*r*P-t*o*P)*y,e[15]=(n*l*s-d*o*s+d*r*a-t*l*a-n*r*m+t*o*m)*y,this}getInverse(){return this.clone().invert()}translate(e=new c){let t=this.elements;return t[12]=t[0]*e.x+t[4]*e.y+t[8]*e.z+t[12],t[13]=t[1]*e.x+t[5]*e.y+t[9]*e.z+t[13],t[14]=t[2]*e.x+t[6]*e.y+t[10]*e.z+t[14],t[15]=t[3]*e.x+t[7]*e.y+t[11]*e.z+t[15],this}scale(e=new c){let t=this.elements;return t[0]*=e.x,t[1]*=e.x,t[2]*=e.x,t[3]*=e.x,t[4]*=e.y,t[5]*=e.y,t[6]*=e.y,t[7]*=e.y,t[8]*=e.z,t[9]*=e.z,t[10]*=e.z,t[11]*=e.z,this}rotateFromQuaternion(e=new L){let t=this.elements,r=e.elements[0],s=e.elements[1],i=e.elements[2],n=e.elements[3],o=r+r,a=s+s,u=i+i,d=r*o,l=r*a,m=r*u,p=s*a,f=s*u,g=i*u,P=n*o,x=n*a,T=n*u;return t[0]=1-(p+g),t[4]=l-T,t[8]=m+x,t[1]=l+T,t[5]=1-(d+g),t[9]=f-P,t[2]=m-x,t[6]=f+P,t[10]=1-(d+p),this}lookAt(e=new c,t=new c,r=new c(0,1,0)){let s=this.elements,i=e.clone().sub(t);i.lengthSq()===0&&(i.z=1),i.normalize();let n=new c().crossVectors(r,i);n.lengthSq()===0&&(Math.abs(r.z)===1?i.x+=1e-4:i.z+=1e-4,i.normalize(),n.crossVectors(r,i)),n.normalize();let o=new c().crossVectors(i,n);return s[0]=n.x,s[4]=o.x,s[8]=i.x,s[1]=n.y,s[5]=o.y,s[9]=i.y,s[2]=n.z,s[6]=o.z,s[10]=i.z,this}compose(e=new c,t=new L,r=new c(1)){let s=this.elements,i=t.elements[0],n=t.elements[1],o=t.elements[2],a=t.elements[3],u=i+i,d=n+n,l=o+o,m=i*u,p=i*d,f=i*l,g=n*d,P=n*l,x=o*l,T=a*u,C=a*d,B=a*l,M=r.x,R=r.y,y=r.z;return s[0]=(1-(g+x))*M,s[1]=(p+B)*M,s[2]=(f-C)*M,s[3]=0,s[4]=(p-B)*R,s[5]=(1-(m+x))*R,s[6]=(P+T)*R,s[7]=0,s[8]=(f+C)*y,s[9]=(P-T)*y,s[10]=(1-(m+g))*y,s[11]=0,s[12]=e.x,s[13]=e.y,s[14]=e.z,s[15]=1,this}composeFromOrigin(e=new c,t=new L,r=new c(1),s=new c){let i=this.elements,n=t.elements[0],o=t.elements[1],a=t.elements[2],u=t.elements[3],d=n+n,l=o+o,m=a+a,p=n*d,f=n*l,g=n*m,P=o*l,x=o*m,T=a*m,C=u*d,B=u*l,M=u*m,R=r.x,y=r.y,w=r.z,G=s.x,z=s.y,N=s.z,F=(1-(P+T))*R,ee=(f+M)*R,Q=(g-B)*R,U=(f-M)*y,v=(1-(p+T))*y,A=(x+C)*y,D=(g+B)*w,$=(x-C)*w,te=(1-(p+P))*w;return i[0]=F,i[1]=ee,i[2]=Q,i[3]=0,i[4]=U,i[5]=v,i[6]=A,i[7]=0,i[8]=D,i[9]=$,i[10]=te,i[11]=0,i[12]=e.x+G-(F*G+U*z+D*N),i[13]=e.y+z-(ee*G+v*z+$*N),i[14]=e.z+N-(Q*G+A*z+te*N),i[15]=1,this}};var c=class h{constructor(e=0,t=e,r=e){this.type="Vec3",this._x=e,this._y=t,this._z=r}get x(){return this._x}set x(e){let t=e!==this._x;this._x=e,t&&this._onChangeCallback&&this._onChangeCallback()}get y(){return this._y}set y(e){let t=e!==this._y;this._y=e,t&&this._onChangeCallback&&this._onChangeCallback()}get z(){return this._z}set z(e){let t=e!==this._z;this._z=e,t&&this._onChangeCallback&&this._onChangeCallback()}onChange(e){return e&&(this._onChangeCallback=e),this}set(e=0,t=0,r=0){return this.x=e,this.y=t,this.z=r,this}add(e=new h){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e=0){return this.x+=e,this.y+=e,this.z+=e,this}sub(e=new h){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e=0){return this.x-=e,this.y-=e,this.z-=e,this}multiply(e=new h(1)){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e=1){return this.x*=e,this.y*=e,this.z*=e,this}copy(e=new h){return this.x=e.x,this.y=e.y,this.z=e.z,this}clone(){return new h(this.x,this.y,this.z)}max(e=new h){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}min(e=new h){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}equals(e=new h){return this.x===e.x&&this.y===e.y&&this.z===e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.lengthSq())}normalize(){let e=this.lengthSq();return e>0&&(e=1/Math.sqrt(e)),this.x*=e,this.y*=e,this.z*=e,this}dot(e=new h){return this.x*e.x+this.y*e.y+this.z*e.z}cross(e=new h){return this.crossVectors(this,e)}crossVectors(e=new h,t=new h){let r=e.x,s=e.y,i=e.z,n=t.x,o=t.y,a=t.z;return this.x=s*a-i*o,this.y=i*n-r*a,this.z=r*o-s*n,this}lerp(e=new h,t=1){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}applyMat4(e=new E){let t=this._x,r=this._y,s=this._z,i=e.elements,n=i[3]*t+i[7]*r+i[11]*s+i[15];return n=n||1,this.x=(i[0]*t+i[4]*r+i[8]*s+i[12])/n,this.y=(i[1]*t+i[5]*r+i[9]*s+i[13])/n,this.z=(i[2]*t+i[6]*r+i[10]*s+i[14])/n,this}applyQuat(e=new L){let t=this.x,r=this.y,s=this.z,i=e.elements[0],n=e.elements[1],o=e.elements[2],a=e.elements[3],u=a*t+n*s-o*r,d=a*r+o*t-i*s,l=a*s+i*r-n*t,m=-i*t-n*r-o*s;return this.x=u*a+m*-i+d*-o-l*-n,this.y=d*a+m*-n+l*-i-u*-o,this.z=l*a+m*-o+u*-n-d*-i,this}applyAxisAngle(e=new h,t=0,r=new L){return this.applyQuat(r.setFromAxisAngle(e,t))}project(e){return this.applyMat4(e.viewMatrix).applyMat4(e.projectionMatrix),this}unproject(e){return this.applyMat4(e.projectionMatrix.getInverse()).applyMat4(e.modelMatrix),this}};var wt=4,Ut=4,k=wt*Ut,pe=class{constructor({name:e,key:t,type:r="f32"}){this.name=e,this.key=t,this.type=r,this.bufferLayout=We(this.type.replace("array","").replace("<","").replace(">","")),this.alignment={start:{row:0,byte:0},end:{row:0,byte:0}}}get rowCount(){return this.alignment.end.row-this.alignment.start.row+1}get byteCount(){return Math.abs(this.endOffset-this.startOffset)+1}get paddedByteCount(){return(this.alignment.end.row+1)*k}get startOffset(){return this.getByteCountAtPosition(this.alignment.start)}get endOffset(){return this.getByteCountAtPosition(this.alignment.end)}getPositionAtOffset(e=0){return{row:Math.floor(e/k),byte:e%k}}getByteCountAtPosition(e={row:0,byte:0}){return e.row*k+e.byte}applyOverflowToPosition(e={row:0,byte:0}){if(e.byte>k-1){let t=e.byte%k;e.row+=Math.floor(e.byte/k),e.byte=t}return e}getByteCountBetweenPositions(e={row:0,byte:0},t={row:0,byte:0}){return Math.abs(this.getByteCountAtPosition(t)-this.getByteCountAtPosition(e))}getElementAlignment(e={row:0,byte:0}){let t={start:e,end:e},{size:r,align:s}=this.bufferLayout;return e.byte%s!==0&&(e.byte+=e.byte%s),r<=k&&e.byte+r>k&&(e.row+=1,e.byte=0),t.end={row:e.row+Math.ceil(r/k)-1,byte:e.byte+(r%k===0?k-1:r%k-1)},t.end=this.applyOverflowToPosition(t.end),t}setAlignmentFromPosition(e={row:0,byte:0}){this.alignment=this.getElementAlignment(e)}setAlignment(e=0){this.setAlignmentFromPosition(this.getPositionAtOffset(e))}setView(e,t){this.view=new this.bufferLayout.View(e,this.startOffset,this.byteCount/this.bufferLayout.View.BYTES_PER_ELEMENT)}update(e){if(this.type==="f32"||this.type==="u32"||this.type==="i32")this.view[0]=e;else if(this.type==="vec2f")this.view[0]=e.x??e[0]??0,this.view[1]=e.y??e[1]??0;else if(this.type==="vec3f")this.view[0]=e.x??e[0]??0,this.view[1]=e.y??e[1]??0,this.view[2]=e.z??e[2]??0;else if(e.elements)this.view.set(e.elements);else if(ArrayBuffer.isView(e)||Array.isArray(e))for(let t=0;t<this.view.length;t++)this.view[t]=e[t]?e[t]:0}};var Be=class extends pe{constructor({name:t,key:r,type:s="f32",arrayLength:i=1}){super({name:t,key:r,type:s});this.arrayLength=i,this.numElements=this.arrayLength/this.bufferLayout.numElements}setAlignment(t=0){super.setAlignment(t);let r=this.getElementAlignment(this.getPositionAtOffset(this.endOffset+1));this.stride=this.getByteCountBetweenPositions(this.alignment.end,r.end),this.alignment.end=this.getPositionAtOffset(this.endOffset+this.stride*(this.numElements-1))}update(t){if(ArrayBuffer.isView(t)||Array.isArray(t)){let r=0,s=this.byteCount/this.bufferLayout.View.BYTES_PER_ELEMENT,i=Math.ceil(s/this.numElements);for(let n=0;n<this.numElements;n++)for(let o=0;o<this.bufferLayout.numElements;o++)this.view[o+n*i]=t[r],r++}else O(`BufferArrayElement: value passed to ${this.name} is not an array: ${t}`)}};var Me=class extends Be{constructor({name:t,key:r,type:s="f32",arrayLength:i=1}){super({name:t,key:r,type:s,arrayLength:i});this.stride=1,this.arrayLength=i,this.numElements=this.arrayLength/this.bufferLayout.numElements}get byteCount(){return this.bufferLayout.size*this.numElements}setAlignment(t=0,r=0){this.alignment=this.getElementAlignment(this.getPositionAtOffset(t)),this.stride=r,this.alignment.end=this.getPositionAtOffset(this.endOffset+r*(this.numElements-1))}setView(t,r){this.view=new this.bufferLayout.View(this.bufferLayout.numElements*this.numElements),this.viewSetFunction=(s=>{switch(this.bufferLayout.View){case Int32Array:return s.setInt32.bind(s);case Uint16Array:return s.setUint16.bind(s);case Uint32Array:return s.setUint32.bind(s);case Float32Array:default:return s.setFloat32.bind(s)}})(r)}update(t){super.update(t);for(let r=0;r<this.numElements;r++){let s=this.view.subarray(r*this.bufferLayout.numElements,r*this.bufferLayout.numElements+this.bufferLayout.numElements),i=this.startOffset+r*this.stride;s.forEach((n,o)=>{this.viewSetFunction(i+o*this.bufferLayout.View.BYTES_PER_ELEMENT,n,!0)})}}};var j=class extends Y{constructor({label:t="Uniform",name:r="uniform",bindingType:s,bindIndex:i=0,visibility:n,useStruct:o=!0,access:a="read",bindings:u={}}){s=s??"uniform";super({label:t,name:r,bindIndex:i,bindingType:s,visibility:n});this.options={...this.options,useStruct:o,access:a,bindings:u},this.arrayBufferSize=0,this.shouldUpdate=!1,this.useStruct=o,this.bufferElements=[],this.bindings={},this.buffer=null,this.setBindings(u),this.setBufferAttributes(),this.setWGSLFragment()}get resourceLayout(){return{buffer:{type:mt(this)}}}get resource(){return{buffer:this.buffer}}setBindings(t){Object.keys(t).forEach(r=>{let s={};for(let i in t[r])i!=="value"&&(s[i]=t[r][i]);Object.defineProperty(s,"value",{get(){return s._value},set(i){s._value=i,s.shouldUpdate=!0}}),s.value=t[r].value,(s.value instanceof W||s.value instanceof c)&&s.value.onChange(()=>s.shouldUpdate=!0),this.bindings[r]=s})}setBufferAttributes(){let t=Object.keys(this.bindings).filter(s=>this.bindings[s].type.indexOf("array")!==-1),r=Object.keys(this.bindings).sort((s,i)=>{let n=Math.min(0,this.bindings[s].type.indexOf("array")),o=Math.min(0,this.bindings[i].type.indexOf("array"));return n-o});if(t.length>1&&(r=r.filter(s=>!t.includes(s))),r.forEach(s=>{let i=this.bindings[s],n={name:me(i.name??s),key:s,type:i.type},o=i.type.indexOf("array")!==-1&&(Array.isArray(i.value)||ArrayBuffer.isView(i.value));this.bufferElements.push(o?new Be({...n,arrayLength:i.value.length}):new pe(n))}),this.bufferElements.forEach((s,i)=>{let n=i===0?0:this.bufferElements[i-1].endOffset+1;s.setAlignment(n)}),t.length>1)if(t.map(n=>{let o=this.bindings[n],a=We(o.type.replace("array","").replace("<","").replace(">",""));return o.value.length/a.numElements}).every((n,o,a)=>n===a[0])){let n=t.map(u=>{let d=this.bindings[u];return new Me({name:me(d.name??u),key:u,type:d.type,arrayLength:d.value.length})}),o=t.map(u=>{let d=this.bindings[u];return new pe({name:me(d.name??u),key:u,type:d.type.replace("array","").replace("<","").replace(">","")})});o.forEach((u,d)=>{d===0?this.bufferElements.length?u.setAlignmentFromPosition({row:this.bufferElements[this.bufferElements.length-1].alignment.end.row+1,byte:0}):u.setAlignment(0):u.setAlignment(o[d-1].endOffset+1)});let a=o[o.length-1].endOffset+1-o[0].startOffset;n.forEach((u,d)=>{u.setAlignment(o[d].startOffset,a)}),this.bufferElements=[...this.bufferElements,...n]}else O(`BufferBinding: "${this.label}" contains multiple array inputs that should use an interleaved array, but their size does not match. These inputs cannot be added to the BufferBinding: "${t.join(", ")}"`);this.arrayBufferSize=this.bufferElements.length?this.bufferElements[this.bufferElements.length-1].paddedByteCount:0,this.arrayBuffer=new ArrayBuffer(this.arrayBufferSize),this.arrayView=new DataView(this.arrayBuffer,0,this.arrayBuffer.byteLength),this.bufferElements.forEach(s=>{s.setView(this.arrayBuffer,this.arrayView)}),this.shouldUpdate=this.arrayBufferSize>0}setWGSLFragment(){let t=ke(this.label);if(this.useStruct){let r=this.bufferElements.filter(i=>!(i instanceof Me)),s=this.bufferElements.filter(i=>i instanceof Me);if(s.length){let i=this.bindingType==="uniform"?`, ${s[0].numElements}`:"";if(r.length){this.wgslStructFragment=`struct ${t}Element {
	${s.map(a=>a.name+": "+a.type.replace("array","").replace("<","").replace(">","")).join(`,
	`)}
};

`;let n=`${this.name}Element: array<${t}Element${i}>,`;this.wgslStructFragment+=`struct ${t} {
	${r.map(a=>a.name+": "+a.type).join(`,
	`)}
	${n}
};`;let o=je(this);this.wgslGroupFragment=[`${o} ${this.name}: ${t};`]}else{this.wgslStructFragment=`struct ${t} {
	${this.bufferElements.map(o=>o.name+": "+o.type.replace("array","").replace("<","").replace(">","")).join(`,
	`)}
};`;let n=je(this);this.wgslGroupFragment=[`${n} ${this.name}: array<${t}${i}>;`]}}else{this.wgslStructFragment=`struct ${t} {
	${this.bufferElements.map(n=>{let o=this.bindingType==="uniform"&&"numElements"in n?`array<${n.type.replace("array","").replace("<","").replace(">","")}, ${n.numElements}>`:n.type;return n.name+": "+o}).join(`,
	`)}
};`;let i=je(this);this.wgslGroupFragment=[`${i} ${this.name}: ${t};`]}}else this.wgslStructFragment="",this.wgslGroupFragment=this.bufferElements.map(r=>`${je(this)} ${r.name}: ${r.type};`)}shouldUpdateBinding(t=""){let r=Object.keys(this.bindings).find(s=>this.bindings[s].name===t);r&&(this.bindings[r].shouldUpdate=!0)}update(){Object.keys(this.bindings).forEach(t=>{let r=this.bindings[t],s=this.bufferElements.find(i=>i.key===t);r.shouldUpdate&&s&&(r.onBeforeUpdate&&r.onBeforeUpdate(),s.update(r.value),this.shouldUpdate=!0,r.shouldUpdate=!1)})}};var ce=class extends j{constructor({label:t="Work",name:r="work",bindingType:s,bindIndex:i=0,useStruct:n=!0,bindings:o={},visibility:a,access:u="read_write",shouldCopyResult:d=!1}){s="storage",a="compute";super({label:t,name:r,bindIndex:i,bindingType:s,useStruct:n,bindings:o,visibility:a,access:u});this.options={...this.options,shouldCopyResult:d},this.shouldCopyResult=d,this.result=new Float32Array(this.arrayBuffer.slice(0)),this.resultBuffer=null}};var X=class{constructor(e,{label:t="BindGroup",index:r=0,bindings:s=[],inputs:i}={}){this.type="BindGroup",e=e&&e.renderer||e,b(e,this.type),this.renderer=e,this.options={label:t,index:r,bindings:s,...i&&{inputs:i}},this.index=r,this.uuid=V(),this.bindings=[],s.length&&this.addBindings(s),this.options.inputs&&this.setInputBindings(),this.resetEntries(),this.bindGroupLayout=null,this.bindGroup=null,this.needsReset=!1,this.needsPipelineFlush=!1}setIndex(e){this.index=e}addBindings(e=[]){this.bindings=[...this.bindings,...e]}addBinding(e){this.bindings.push(e)}createInputBindings(e="uniform",t={}){return[...Object.keys(t).map(r=>{let s=t[r],i={label:ke(s.label||r),name:r,bindingType:e,useStruct:!0,visibility:s.access==="read_write"?"compute":s.visibility,access:s.access??"read",bindings:s.bindings},n=i.access==="read_write"?ce:j;return s.useStruct!==!1?new n(i):Object.keys(s.bindings).map(o=>(i.label=ke(s.label?s.label+o:r+o),i.name=r+o,i.useStruct=!1,i.bindings={[o]:s.bindings[o]},new n(i)))})].flat()}setInputBindings(){this.addBindings([...this.createInputBindings("uniform",this.options.inputs.uniforms),...this.createInputBindings("storage",this.options.inputs.storages)])}get shouldCreateBindGroup(){return!this.bindGroup&&!!this.bindings.length}resetEntries(){this.entries={bindGroupLayout:[],bindGroup:[]}}createBindGroup(){this.fillEntries(),this.setBindGroupLayout(),this.setBindGroup()}resetBindGroup(){this.resetEntries(),this.createBindGroup()}loseContext(){this.resetEntries(),this.bufferBindings.forEach(e=>{e.buffer=null,"resultBuffer"in e&&(e.resultBuffer=null)}),this.bindGroup=null,this.bindGroupLayout=null,this.needsPipelineFlush=!0}get bufferBindings(){return this.bindings.filter(e=>e instanceof j||e instanceof ce)}createBindingBuffer(e){e.buffer=this.renderer.createBuffer({label:this.options.label+": "+e.bindingType+" buffer from: "+e.label,size:e.arrayBuffer.byteLength,usage:e.bindingType==="uniform"?GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC|GPUBufferUsage.VERTEX:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC|GPUBufferUsage.VERTEX}),"resultBuffer"in e&&(e.resultBuffer=this.renderer.createBuffer({label:this.options.label+": Result buffer from: "+e.label,size:e.arrayBuffer.byteLength,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}))}fillEntries(){this.bindings.forEach(e=>{e.visibility||(e.visibility=GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE),"buffer"in e&&!e.buffer&&this.createBindingBuffer(e),this.entries.bindGroupLayout.push({binding:this.entries.bindGroupLayout.length,...e.resourceLayout,visibility:e.visibility}),this.entries.bindGroup.push({binding:this.entries.bindGroup.length,resource:e.resource})})}getBindingByName(e=""){return this.bindings.find(t=>t.name===e)}setBindGroupLayout(){this.bindGroupLayout=this.renderer.createBindGroupLayout({label:this.options.label+" layout",entries:this.entries.bindGroupLayout})}setBindGroup(){this.bindGroup=this.renderer.createBindGroup({label:this.options.label,layout:this.bindGroupLayout,entries:this.entries.bindGroup})}updateBufferBindings(){this.bufferBindings.forEach((e,t)=>{e.update(),e.shouldUpdate&&(!e.useStruct&&e.bufferElements.length>1?this.renderer.queueWriteBuffer(e.buffer,0,e.bufferElements[t].view):this.renderer.queueWriteBuffer(e.buffer,0,e.arrayBuffer)),e.shouldUpdate=!1})}update(){this.updateBufferBindings(),this.needsReset&&(this.resetBindGroup(),this.needsReset=!1)}clone({bindings:e=[],keepLayout:t=!1}={}){let r={...this.options};r.label+=" (copy)";let s=new this.constructor(this.renderer,{label:r.label});return s.setIndex(this.index),s.options=r,(e.length?e:this.bindings).forEach((n,o)=>{s.addBinding(n),"buffer"in n&&!n.buffer&&s.createBindingBuffer(n),t||s.entries.bindGroupLayout.push({binding:s.entries.bindGroupLayout.length,...n.resourceLayout,visibility:n.visibility}),s.entries.bindGroup.push({binding:s.entries.bindGroup.length,resource:n.resource})}),t&&(s.entries.bindGroupLayout=[...this.entries.bindGroupLayout]),s.setBindGroupLayout(),s.setBindGroup(),s}destroy(){this.bufferBindings.forEach(e=>{"buffer"in e&&(this.renderer.removeBuffer(e.buffer),e.buffer?.destroy()),"resultBuffer"in e&&(this.renderer.removeBuffer(e.resultBuffer),e.resultBuffer?.destroy())}),this.bindings=[],this.bindGroupLayout=null,this.bindGroup=null,this.resetEntries()}};var Z=class extends Y{constructor({label:t="Texture",name:r="texture",bindingType:s,bindIndex:i=0,visibility:n,texture:o,format:a="rgba8unorm",access:u="write"}){s=s??"texture",s==="storageTexture"&&(n="compute");super({label:t,name:r,bindingType:s,bindIndex:i,visibility:n});this.options={...this.options,texture:o,format:a,access:u},this.resource=o,this.setWGSLFragment()}get resourceLayout(){return pt(this)}get resource(){return this.texture instanceof GPUExternalTexture?this.texture:this.texture instanceof GPUTexture?this.texture.createView():null}set resource(t){this.texture=t}setBindingType(t){t!==this.bindingType&&(this.bindingType=t,this.setWGSLFragment())}setWGSLFragment(){this.wgslGroupFragment=[`${lt(this)}`]}};var J=class{constructor(){this.setMatrices(),this.setTransforms()}setTransforms(){this.transforms={origin:{model:new c},quaternion:new L,rotation:new c,position:{world:new c},scale:new c(1)},this.rotation.onChange(()=>this.applyRotation()),this.position.onChange(()=>this.applyPosition()),this.scale.onChange(()=>this.applyScale()),this.transformOrigin.onChange(()=>this.applyTransformOrigin())}get rotation(){return this.transforms.rotation}set rotation(e){this.transforms.rotation=e,this.applyRotation()}get quaternion(){return this.transforms.quaternion}set quaternion(e){this.transforms.quaternion=e}get position(){return this.transforms.position.world}set position(e){this.transforms.position.world=e}get scale(){return this.transforms.scale}set scale(e){this.transforms.scale=e,this.applyScale()}get transformOrigin(){return this.transforms.origin.model}set transformOrigin(e){this.transforms.origin.model=e}applyRotation(){this.quaternion.setFromVec3(this.rotation),this.shouldUpdateModelMatrix()}applyPosition(){this.shouldUpdateModelMatrix()}applyScale(){this.shouldUpdateModelMatrix()}applyTransformOrigin(){this.shouldUpdateModelMatrix()}setMatrices(){this.matrices={model:{matrix:new E,shouldUpdate:!1,onUpdate:()=>this.updateModelMatrix()}}}get modelMatrix(){return this.matrices.model.matrix}set modelMatrix(e){this.matrices.model.matrix=e,this.shouldUpdateModelMatrix()}shouldUpdateModelMatrix(){this.matrices.model.shouldUpdate=!0}lookAt(e=new c){let t=new E().lookAt(e,this.position);this.quaternion.setFromRotationMatrix(t),this.shouldUpdateModelMatrix()}updateModelMatrix(){this.modelMatrix=this.modelMatrix.composeFromOrigin(this.position,this.quaternion,this.scale,this.transformOrigin)}onAfterMatrixStackUpdate(){}updateSizeAndPosition(){this.shouldUpdateModelMatrix()}updateMatrixStack(){let e=!!Object.keys(this.matrices).find(t=>this.matrices[t].shouldUpdate);for(let t in this.matrices)this.matrices[t].shouldUpdate&&(this.matrices[t].onUpdate(),this.matrices[t].shouldUpdate=!1);e&&this.onAfterMatrixStackUpdate()}};var ct={name:"texture",generateMips:!1,flipY:!1,format:"rgba8unorm",placeholderColor:[0,0,0,255],useExternalTextures:!0,fromTexture:null},I=class extends J{constructor(t,r=ct){super();this.#e=new c(1);this.#t=new c(1);this.#r=new c(1);this.#s=new E;this._onSourceLoadedCallback=()=>{};this._onSourceUploadedCallback=()=>{};this.type="Texture",t=t&&t.renderer||t,b(t,r.label?r.label+" "+this.type:this.type),this.renderer=t,this.uuid=V();let s={...ct,source:r.fromTexture?r.fromTexture.options.source:null,sourceType:r.fromTexture?r.fromTexture.options.sourceType:null};this.options={...s,...r},this.options.label=this.options.label??this.options.name,this.texture=null,this.externalTexture=null,this.source=null,this.size={width:1,height:1},this.textureMatrix=new j({label:this.options.label+": model matrix",name:this.options.name+"Matrix",useStruct:!1,bindings:{matrix:{name:this.options.name+"Matrix",type:"mat4x4f",value:this.modelMatrix}}}),this.setBindings(),this._parent=null,this.sourceLoaded=!1,this.sourceUploaded=!1,this.shouldUpdate=!1,this.shouldUpdateBindGroup=!1,this.renderer.addTexture(this)}#e;#t;#r;#s;setBindings(){this.bindings=[new Z({label:this.options.label+": texture",name:this.options.name,texture:this.options.sourceType==="externalVideo"?this.externalTexture:this.texture,bindingType:this.options.sourceType==="externalVideo"?"externalTexture":"texture"}),this.textureMatrix]}get textureBinding(){return this.bindings[0]}get parent(){return this._parent}set parent(t){this._parent=t,this.resize()}get sourceLoaded(){return this._sourceLoaded}set sourceLoaded(t){t&&!this.sourceLoaded&&this._onSourceLoadedCallback&&this._onSourceLoadedCallback(),this._sourceLoaded=t}get sourceUploaded(){return this._sourceUploaded}set sourceUploaded(t){t&&!this.sourceUploaded&&this._onSourceUploadedCallback&&this._onSourceUploadedCallback(),this._sourceUploaded=t}setTransforms(){super.setTransforms(),this.transforms.quaternion.setAxisOrder("ZXY"),this.transforms.origin.model.set(.5,.5,0)}updateModelMatrix(){if(!this.parent)return;let t=this.parent.scale?this.parent.scale:new c(1,1,1),r=this.parent.boundingRect?this.parent.boundingRect.width*t.x:this.size.width,s=this.parent.boundingRect?this.parent.boundingRect.height*t.y:this.size.height,i=r/s,n=this.size.width,o=this.size.height,a=n/o;r>s?(this.#e.set(i,1,1),this.#t.set(1/a,1,1)):(this.#e.set(1,1/i,1),this.#t.set(1,a,1));let u=i>a!=r>s?1:r>s?this.#e.x*this.#t.x:this.#t.y*this.#e.y;this.#r.set(1/(u*this.scale.x),1/(u*this.scale.y),1),this.#s.rotateFromQuaternion(this.quaternion),this.modelMatrix.identity().premultiplyTranslate(this.transformOrigin.clone().multiplyScalar(-1)).premultiplyScale(this.#r).premultiplyScale(this.#e).premultiply(this.#s).premultiplyScale(this.#t).premultiplyTranslate(this.transformOrigin).translate(this.position)}onAfterMatrixStackUpdate(){this.textureMatrix.shouldUpdateBinding(this.options.name+"Matrix")}resize(){this.source&&this.source instanceof HTMLCanvasElement&&(this.source.width!==this.size.width||this.source.height!==this.size.height)&&(this.setSourceSize(),this.createTexture()),this.shouldUpdateModelMatrix()}getNumMipLevels(...t){let r=Math.max(...t);return 1+Math.log2(r)|0}uploadTexture(){this.renderer.uploadTexture(this),this.shouldUpdate=!1}uploadVideoTexture(){this.externalTexture=this.renderer.importExternalTexture(this.source),this.textureBinding.resource=this.externalTexture,this.textureBinding.setBindingType("externalTexture"),this.shouldUpdateBindGroup=!0,this.shouldUpdate=!1,this.sourceUploaded=!0}copy(t){if(this.options.sourceType==="externalVideo"&&t.options.sourceType!=="externalVideo"){O(`${this.options.label}: cannot copy a GPUTexture to a GPUExternalTexture`);return}else if(this.options.sourceType!=="externalVideo"&&t.options.sourceType==="externalVideo"){O(`${this.options.label}: cannot copy a GPUExternalTexture to a GPUTexture`);return}this.options.fromTexture=t,this.options.sourceType=t.options.sourceType,this.options.generateMips=t.options.generateMips,this.options.flipY=t.options.flipY,this.options.format=t.options.format,this.options.placeholderColor=t.options.placeholderColor,this.options.useExternalTextures=t.options.useExternalTextures,this.sourceLoaded=t.sourceLoaded,this.sourceUploaded=t.sourceUploaded,t.texture&&(t.sourceLoaded&&(this.size=t.size,this.source=t.source,this.resize()),t.sourceUploaded?(this.texture=t.texture,this.textureBinding.resource=this.texture,this.shouldUpdateBindGroup=!0):this.createTexture())}createTexture(){let t={label:this.options.label,format:this.options.format,size:[this.size.width,this.size.height],usage:this.source?GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST};this.options.sourceType!=="externalVideo"&&(t.mipLevelCount=this.options.generateMips?this.getNumMipLevels(this.size.width,this.size.height):1,this.texture?.destroy(),this.texture=this.renderer.createTexture(t),this.textureBinding.resource=this.texture,this.shouldUpdateBindGroup=!!this.source),this.shouldUpdate=!0}setSourceSize(){this.size={width:this.source.naturalWidth||this.source.width||this.source.videoWidth,height:this.source.naturalHeight||this.source.height||this.source.videoHeight}}async loadImageBitmap(t){let s=await(await fetch(t)).blob();return await createImageBitmap(s,{colorSpaceConversion:"none"})}async loadImage(t){let r=typeof t=="string"?t:t.getAttribute("src");this.options.source=r,this.options.sourceType="image",this.sourceLoaded=!1,this.sourceUploaded=!1,this.source=await this.loadImageBitmap(this.options.source),this.setSourceSize(),this.resize(),this.sourceLoaded=!0,this.createTexture()}onVideoFrameCallback(){this.videoFrameCallbackId&&(this.shouldUpdate=!0,this.source.requestVideoFrameCallback(this.onVideoFrameCallback.bind(this)))}onVideoLoaded(t){this.sourceLoaded||(this.source=t,this.setSourceSize(),this.resize(),this.options.useExternalTextures?(this.options.sourceType="externalVideo",this.texture?.destroy()):(this.options.sourceType="video",this.createTexture()),"requestVideoFrameCallback"in HTMLVideoElement.prototype&&(this.videoFrameCallbackId=this.source.requestVideoFrameCallback(this.onVideoFrameCallback.bind(this))),this.sourceLoaded=!0)}get isVideoSource(){return this.source&&(this.options.sourceType==="video"||this.options.sourceType==="externalVideo")}loadVideo(t){let r;typeof t=="string"?(r=document.createElement("video"),r.src=t):r=t,r.preload="auto",r.muted=!0,r.loop=!0,r.crossOrigin="anonymous",r.setAttribute("playsinline",""),this.options.source=r.src,this.sourceLoaded=!1,this.sourceUploaded=!1,r.readyState>=r.HAVE_ENOUGH_DATA?this.onVideoLoaded(r):r.addEventListener("canplaythrough",this.onVideoLoaded.bind(this,r),{once:!0}),isNaN(r.duration)&&r.load()}loadCanvas(t){this.options.source=t,this.options.sourceType="canvas",this.sourceLoaded=!1,this.sourceUploaded=!1,this.source=t,this.setSourceSize(),this.resize(),this.sourceLoaded=!0,this.createTexture()}onSourceLoaded(t){return t&&(this._onSourceLoadedCallback=t),this}onSourceUploaded(t){return t&&(this._onSourceUploadedCallback=t),this}render(){this.updateMatrixStack(),this.textureMatrix.update(),this.options.sourceType==="externalVideo"&&(this.shouldUpdate=!0),this.isVideoSource&&!this.videoFrameCallbackId&&this.source.readyState>=this.source.HAVE_CURRENT_DATA&&!this.source.paused&&(this.shouldUpdate=!0),this.shouldUpdate&&this.options.sourceType&&this.options.sourceType!=="externalVideo"&&this.uploadTexture()}destroy(){this.videoFrameCallbackId&&this.source.cancelVideoFrameCallback(this.videoFrameCallbackId),this.isVideoSource&&this.source.removeEventListener("canplaythrough",this.onVideoLoaded.bind(this,this.source),{once:!0}),this.renderer.removeTexture(this),this.texture?.destroy(),this.texture=null}};var fe=class extends X{constructor(t,{label:r,index:s=0,bindings:i=[],inputs:n,textures:o=[],samplers:a=[]}={}){let u="TextureBindGroup";t=t&&t.renderer||t,b(t,u);super(t,{label:r,index:s,bindings:i,inputs:n});this.options={...this.options,textures:[],samplers:[]},o.length&&o.forEach(d=>this.addTexture(d)),a.length&&a.forEach(d=>this.addSampler(d)),this.type=u,this.externalTexturesIDs=[]}addTexture(t){this.textures.push(t),this.addBindings([...t.bindings])}get textures(){return this.options.textures}addSampler(t){this.samplers.push(t),this.addBindings([t.binding])}get samplers(){return this.options.samplers}get shouldCreateBindGroup(){return!this.bindGroup&&!!this.bindings.length&&!this.textures.find(t=>!(t.texture||t.externalTexture))&&!this.samplers.find(t=>!t.sampler)}resetTextureBindGroup(){let t=[...this.bindings].reduce((r,s,i)=>(s instanceof Z&&r.push(i),r),[]);t.length&&(t.forEach(r=>{this.entries.bindGroup[r].resource=this.bindings[r].resource}),this.setBindGroup())}shouldUpdateVideoTextureBindGroupLayout(t){return this.externalTexturesIDs.includes(t)?!1:(this.externalTexturesIDs.push(t),this.needsPipelineFlush=!0,this.needsPipelineFlush)}updateVideoTextureBindGroupLayout(t){let r=this.textures[t],s=[...this.bindings].reduce((i,n,o)=>(n.bindingType==="externalTexture"&&i.push(o),i),[]);s.length&&(s.forEach(i=>{this.entries.bindGroupLayout[i]={binding:this.entries.bindGroupLayout[i].binding,externalTexture:r.externalTexture,visibility:this.entries.bindGroupLayout[i].visibility},this.bindings[i]&&(this.bindings[i].wgslGroupFragment=r.textureBinding.wgslGroupFragment)}),this.setBindGroupLayout())}updateTextures(){this.textures.forEach((t,r)=>{t instanceof I&&(t.options.fromTexture&&t.options.fromTexture.sourceUploaded&&!t.sourceUploaded&&t.copy(t.options.fromTexture),t.shouldUpdate&&t.options.sourceType&&t.options.sourceType==="externalVideo"&&(t.uploadVideoTexture(),this.shouldUpdateVideoTextureBindGroupLayout(r)&&this.updateVideoTextureBindGroupLayout(r))),t.shouldUpdateBindGroup&&(t.texture||t.externalTexture)&&(this.resetTextureBindGroup(),t.shouldUpdateBindGroup=!1)})}update(){this.updateTextures(),super.update()}destroy(){super.destroy(),this.options.textures=[],this.options.samplers=[]}};var Re=class extends Y{constructor({label:t="Sampler",name:r="sampler",bindingType:s,bindIndex:i=0,visibility:n,sampler:o}){s=s??"sampler";super({label:t,name:r,bindIndex:i,bindingType:s,visibility:n});this.options={...this.options,sampler:o},this.resource=o,this.setWGSLFragment()}get resourceLayout(){return{sampler:{type:"filtering"}}}get resource(){return this.sampler}set resource(t){this.sampler=t}setWGSLFragment(){this.wgslGroupFragment=[`var ${this.name}: ${this.bindingType};`]}};var Te=class extends J{constructor({fov:t=50,near:r=.01,far:s=50,width:i=1,height:n=1,pixelRatio:o=1,onMatricesChanged:a=()=>{}}={}){super();this.position.set(0,0,5),this.onMatricesChanged=a,this.size={width:1,height:1},this.setPerspective(t,r,s,i,n,o)}#e;#t;#r;#s;setMatrices(){super.setMatrices(),this.matrices={...this.matrices,view:{matrix:new E,shouldUpdate:!1,onUpdate:()=>{this.viewMatrix.copy(this.modelMatrix).invert()}},projection:{matrix:new E,shouldUpdate:!1,onUpdate:()=>this.updateProjectionMatrix()}}}get viewMatrix(){return this.matrices.view.matrix}set viewMatrix(t){this.matrices.view.matrix=t,this.matrices.view.shouldUpdate=!0}get projectionMatrix(){return this.matrices.projection.matrix}set projectionMatrix(t){this.matrices.projection.matrix=t,this.shouldUpdateProjectionMatrix()}shouldUpdateProjectionMatrix(){this.matrices.projection.shouldUpdate=!0}updateModelMatrix(){super.updateModelMatrix(),this.setScreenRatios(),this.matrices.view.shouldUpdate=!0}get fov(){return this.#e}set fov(t){t=Math.max(1,Math.min(t??this.fov,179)),t!==this.fov&&(this.#e=t,this.shouldUpdateProjectionMatrix()),this.setScreenRatios(),this.setCSSPerspective()}get near(){return this.#t}set near(t){t=Math.max(t??this.near,.01),t!==this.near&&(this.#t=t,this.shouldUpdateProjectionMatrix())}get far(){return this.#r}set far(t){t=Math.max(t??this.far,this.near+1),t!==this.far&&(this.#r=t,this.shouldUpdateProjectionMatrix())}get pixelRatio(){return this.#s}set pixelRatio(t){this.#s=t??this.pixelRatio,this.setCSSPerspective()}setSize({width:t,height:r}){(t!==this.size.width||r!==this.size.height)&&this.shouldUpdateProjectionMatrix(),this.size.width=t,this.size.height=r,this.setScreenRatios(),this.setCSSPerspective()}setPerspective(t=this.fov,r=this.near,s=this.far,i=this.size.width,n=this.size.height,o=this.pixelRatio){this.setSize({width:i,height:n}),this.pixelRatio=o,this.fov=t,this.near=r,this.far=s}onAfterMatrixStackUpdate(){this.onMatricesChanged()}setCSSPerspective(){this.CSSPerspective=Math.pow(Math.pow(this.size.width/(2*this.pixelRatio),2)+Math.pow(this.size.height/(2*this.pixelRatio),2),.5)/Math.tan(this.fov*.5*Math.PI/180)}setScreenRatios(t=0){let r=this.position.z;t<r?t-=r:t+=r;let s=this.fov*Math.PI/180,i=2*Math.tan(s/2)*Math.abs(t);this.screenRatio={width:i*this.size.width/this.size.height,height:i}}lookAt(t=new c){let r=new E().lookAt(this.position,t);this.quaternion.setFromRotationMatrix(r),this.shouldUpdateModelMatrix()}updateProjectionMatrix(){let t=this.size.width/this.size.height,r=this.near*Math.tan(Math.PI/180*.5*this.fov),s=2*r,i=t*s,n=-.5*i,o=n+i,a=r-s,u=2*this.near/(o-n),d=2*this.near/(r-a),l=(o+n)/(o-n),m=(r+a)/(r-a),p=-(this.far+this.near)/(this.far-this.near),f=-2*this.far*this.near/(this.far-this.near);this.projectionMatrix.set(u,0,0,0,0,d,0,0,l,m,p,-1,0,0,f,0)}};var Ce=class{constructor(e,{label:t="Sampler",name:r,addressModeU:s="repeat",addressModeV:i="repeat",magFilter:n="linear",minFilter:o="linear",mipmapFilter:a="linear",maxAnisotropy:u=1}={}){this.type="Sampler",e=e&&e.renderer||e,b(e,t?t+" "+this.type:this.type),this.renderer=e,this.label=t,!r&&!this.renderer.production&&(r="sampler"+this.renderer.samplers.length,O(`Sampler: you are trying to create a sampler without the mandatory name parameter. A default name will be used instead: ${r}`)),this.name=r,this.options={addressModeU:s,addressModeV:i,magFilter:n,minFilter:o,mipmapFilter:a,maxAnisotropy:u},this.createSampler(),this.createBinding()}createSampler(){this.sampler=this.renderer.createSampler(this)}createBinding(){this.binding=new Re({label:this.label,name:this.name,bindingType:"sampler",sampler:this.sampler})}};var ft={label:"RenderTexture",name:"renderTexture",usage:"texture",access:"write",fromTexture:null},_=class{constructor(e,t=ft){e=e&&e.renderer||e,b(e,t.label?t.label+" RenderTexture":"RenderTexture"),this.type="RenderTexture",this.renderer=e,this.uuid=V(),this.options={...ft,...t},this.options.format||(this.options.format=this.renderer.preferredFormat),this.shouldUpdateBindGroup=!1,this.setSize(this.options.size),this.setBindings(),this.createTexture()}setSize(e=null){e||(e={width:this.renderer.pixelRatioBoundingRect.width,height:this.renderer.pixelRatioBoundingRect.height}),this.size=e}copy(e){this.options.fromTexture=e,this.createTexture()}createTexture(){if(this.options.fromTexture){this.size=this.options.fromTexture.size,this.texture=this.options.fromTexture.texture,this.textureBinding.resource=this.texture;return}this.texture?.destroy(),this.texture=this.renderer.createTexture({label:this.options.label,format:this.options.format,size:[this.size.width,this.size.height],usage:this.options.usage==="texture"?GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT:GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST}),this.textureBinding.resource=this.texture}setBindings(){this.bindings=[new Z({label:this.options.label+": "+this.options.name+" render texture",name:this.options.name,texture:this.texture,bindingType:this.options.usage})]}get textureBinding(){return this.bindings[0]}resize(e=null){this.setSize(e),this.createTexture(),this.shouldUpdateBindGroup=!0}destroy(){this.texture?.destroy(),this.texture=null}};var re=class{constructor(e,t){this.type="Material",e=e&&e.renderer||e,b(e,this.type),this.renderer=e,this.uuid=V();let{shaders:r,label:s,useAsyncPipeline:i,inputs:n,bindGroups:o,samplers:a}=t;this.options={shaders:r,label:s,...i!==void 0&&{useAsyncPipeline:i},...n!==void 0&&{inputs:n},...o!==void 0&&{bindGroups:o},...a!==void 0&&{samplers:a}},this.bindGroups=[],this.texturesBindGroups=[],this.clonedBindGroups=[],this.setBindGroups(),this.setTextures(),this.setSamplers()}compileMaterial(){let e=this.texturesBindGroup.bindings.length?1:0;this.bindGroups.length>=this.inputsBindGroups.length+e||this.createBindGroups()}get ready(){return!!(this.renderer.ready&&this.pipelineEntry&&this.pipelineEntry.pipeline&&this.pipelineEntry.ready)}loseContext(){this.textures.forEach(e=>{e.texture=null,e.sourceUploaded=!1}),this.renderTextures.forEach(e=>{e.texture=null}),[...this.bindGroups,...this.clonedBindGroups,...this.inputsBindGroups].forEach(e=>e.loseContext()),this.pipelineEntry.pipeline=null}restoreContext(){this.samplers.forEach(e=>{e.createSampler(),e.binding.resource=e.sampler}),this.textures.forEach(e=>{e.createTexture(),e.resize()}),this.renderTextures.forEach(e=>{e.resize(e.size)}),[...this.bindGroups,...this.clonedBindGroups,...this.inputsBindGroups].forEach(e=>{e.shouldCreateBindGroup&&e.createBindGroup(),e.bufferBindings.forEach(t=>t.shouldUpdate=!0)})}getShaderCode(e="full"){return this.pipelineEntry?(e=(()=>{switch(e){case"vertex":case"fragment":case"compute":case"full":return e;default:return"full"}})(),this.pipelineEntry.shaders[e].code):""}getAddedShaderCode(e="vertex"){return this.pipelineEntry?(e=(()=>{switch(e){case"vertex":case"fragment":case"compute":return e;default:return"vertex"}})(),this.pipelineEntry.shaders[e].head):""}setBindGroups(){if(this.uniforms={},this.storages={},this.inputsBindGroups=[],this.inputsBindings=[],this.options.inputs){let e=new X(this.renderer,{label:this.options.label+": Bindings bind group",inputs:this.options.inputs});this.processBindGroupBindings(e),this.inputsBindGroups.push(e)}this.options.bindGroups?.forEach(e=>{this.processBindGroupBindings(e),this.inputsBindGroups.push(e)})}get texturesBindGroup(){return this.texturesBindGroups[0]}processBindGroupBindings(e){e.bindings.forEach(t=>{t.bindingType==="uniform"&&(this.uniforms={...this.uniforms,[t.name]:t.bindings}),t.bindingType==="storage"&&(this.storages={...this.storages,[t.name]:t.bindings}),this.inputsBindings.push(t)})}createBindGroups(){this.texturesBindGroup.shouldCreateBindGroup&&(this.texturesBindGroup.setIndex(this.bindGroups.length),this.texturesBindGroup.createBindGroup(),this.bindGroups.push(this.texturesBindGroup)),this.inputsBindGroups.forEach(e=>{e.shouldCreateBindGroup&&(e.setIndex(this.bindGroups.length),e.createBindGroup(),this.bindGroups.push(e))}),this.options.bindGroups?.forEach(e=>{!e.shouldCreateBindGroup&&!this.bindGroups.find(t=>t.uuid===e.uuid)&&(e.setIndex(this.bindGroups.length),this.bindGroups.push(e)),e instanceof fe&&!this.texturesBindGroups.find(t=>t.uuid===e.uuid)&&(this.texturesBindGroups.push(e),e.textures.forEach(t=>{t instanceof I&&!this.textures.find(r=>r.uuid===t.uuid)?this.textures.push(t):t instanceof _&&!this.renderTextures.find(r=>r.uuid===t.uuid)&&this.renderTextures.push(t)}))})}cloneBindGroup({bindGroup:e,bindings:t=[],keepLayout:r=!0}){if(!e)return null;let s=e.clone({bindings:t,keepLayout:r});return this.clonedBindGroups.push(s),s}getBindGroupByBindingName(e=""){return(this.ready?this.bindGroups:this.inputsBindGroups).find(t=>t.bindings.find(r=>r.name===e))}destroyBindGroup(e){let t=this.renderer.getObjectsByBindGroup(e);(!t||!t.find(s=>s.material.uuid!==this.uuid))&&e.destroy()}destroyBindGroups(){this.bindGroups.forEach(e=>this.destroyBindGroup(e)),this.clonedBindGroups.forEach(e=>this.destroyBindGroup(e)),this.texturesBindGroups=[],this.inputsBindGroups=[],this.bindGroups=[],this.clonedBindGroups=[]}updateBindGroups(){this.bindGroups.forEach(e=>{e.update(),e.needsPipelineFlush&&this.pipelineEntry.ready&&(this.pipelineEntry.flushPipelineEntry(this.bindGroups),e.needsPipelineFlush=!1)})}getBindingByName(e=""){return this.inputsBindings.find(t=>t.name===e)}shouldUpdateInputsBindings(e,t){if(!e)return;let r=this.getBindingByName(e);r&&(t?r.shouldUpdateBinding(t):Object.keys(r.bindings).forEach(s=>r.shouldUpdateBinding(s)))}setTextures(){this.textures=[],this.renderTextures=[],this.texturesBindGroups.push(new fe(this.renderer,{label:this.options.label+": Textures bind group"}))}addTexture(e){e instanceof I?this.textures.push(e):e instanceof _&&this.renderTextures.push(e),(this.options.shaders.vertex&&this.options.shaders.vertex.code.indexOf(e.options.name)!==-1||this.options.shaders.fragment&&this.options.shaders.fragment.code.indexOf(e.options.name)!==-1||this.options.shaders.compute&&this.options.shaders.compute.code.indexOf(e.options.name)!==-1)&&this.texturesBindGroup.addTexture(e)}destroyTexture(e){let t=this.renderer.getObjectsByTexture(e);(!t||!t.find(s=>s.material.uuid!==this.uuid))&&e.destroy()}destroyTextures(){this.textures?.forEach(e=>this.destroyTexture(e)),this.renderTextures?.forEach(e=>this.destroyTexture(e)),this.textures=[],this.renderTextures=[]}setSamplers(){if(this.samplers=[],this.options.samplers?.forEach(t=>{this.addSampler(t)}),!this.samplers.find(t=>t.name==="defaultSampler")){let t=new Ce(this.renderer,{name:"defaultSampler"});this.addSampler(t)}}addSampler(e){this.samplers.push(e),(this.options.shaders.vertex&&this.options.shaders.vertex.code.indexOf(e.name)!==-1||this.options.shaders.fragment&&this.options.shaders.fragment.code.indexOf(e.name)!==-1||this.options.shaders.compute&&this.options.shaders.compute.code.indexOf(e.name)!==-1)&&this.texturesBindGroup.addSampler(e)}onBeforeRender(){this.compileMaterial(),this.textures.forEach(e=>{e.render()}),this.updateBindGroups()}setPipeline(e){this.renderer.pipelineManager.setCurrentPipeline(e,this.pipelineEntry)}render(e){this.ready&&(this.setPipeline(e),this.bindGroups.forEach(t=>{e.setBindGroup(t.index,t.bindGroup)}))}destroy(){this.destroyBindGroups(),this.destroyTextures()}};var Ge=class extends re{constructor(t,r){t=t&&t.renderer||t;let s="ComputeMaterial";b(t,s);super(t,r);this.type=s,this.renderer=t;let{shaders:i}=r;(!i||!i.compute)&&(i={compute:{code:"",entryPoint:"main"}}),i.compute.code||(i.compute.code=""),i.compute.entryPoint||(i.compute.entryPoint="main"),this.options={...this.options,shaders:i,...r.dispatchSize!==void 0&&{dispatchSize:r.dispatchSize}},this.workGroups=[],this.addWorkGroup({bindGroups:this.bindGroups,dispatchSize:this.options.dispatchSize}),this.pipelineEntry=this.renderer.pipelineManager.createComputePipeline({label:this.options.label+" compute pipeline",shaders:this.options.shaders,useAsync:this.options.useAsyncPipeline})}setPipelineEntryProperties(){this.pipelineEntry.setPipelineEntryProperties({bindGroups:this.bindGroups})}async compilePipelineEntry(){await this.pipelineEntry.compilePipelineEntry()}async compileMaterial(){super.compileMaterial(),this.pipelineEntry&&this.pipelineEntry.canCompile&&(this.setPipelineEntryProperties(),await this.compilePipelineEntry())}getShaderCode(t="compute"){return super.getShaderCode(t)}getAddedShaderCode(t="compute"){return super.getAddedShaderCode(t)}get hasMappedBuffer(){return!!this.bindGroups.some(r=>r.bindings.some(s=>s.resultBuffer&&s.resultBuffer.mapState!=="unmapped"))}addWorkGroup({bindGroups:t=[],dispatchSize:r=1}){Array.isArray(r)?(r[0]=Math.ceil(r[0]??1),r[1]=Math.ceil(r[1]??1),r[2]=Math.ceil(r[2]??1)):isNaN(r)||(r=[Math.ceil(r),1,1]),this.workGroups.push({bindGroups:t,dispatchSize:r})}renderWorkGroup(t,r){r.bindGroups.forEach(s=>{t.setBindGroup(s.index,s.bindGroup)}),t.dispatchWorkgroups(r.dispatchSize[0],r.dispatchSize[1],r.dispatchSize[2])}render(t){this.ready&&(this.setPipeline(t),this.workGroups.forEach(r=>{this.renderWorkGroup(t,r)}))}copyBufferToResult(t){this.bindGroups.forEach(r=>{r.bindings.forEach(s=>{"shouldCopyResult"in s&&s.shouldCopyResult&&t.copyBufferToBuffer(s.buffer,0,s.resultBuffer,0,s.resultBuffer.size)})})}setWorkGroupsResult(){this.bindGroups.forEach(t=>{t.bindings.forEach(r=>{r.shouldCopyResult&&this.setBufferResult(r)})})}setBufferResult(t){t.resultBuffer?.mapState==="unmapped"&&t.resultBuffer.mapAsync(GPUMapMode.READ).then(()=>{t.result=new Float32Array(t.resultBuffer.getMappedRange().slice(0)),t.resultBuffer.unmap()})}getWorkGroupResult({workGroupName:t="",bindingName:r=""}){let s;if(this.bindGroups.forEach(i=>{s=i.bindings.find(n=>n.name===t)}),s)if(r){let i=s.bindingElements.find(n=>n.name===r);return i?s.result.slice(i.startOffset,i.endOffset):s.result.slice()}else return s.result.slice();else return null}};var vt=0,Ee=class{constructor(e,t={}){this.#e=!0;this._onReadyCallback=()=>{};this._onBeforeRenderCallback=()=>{};this._onRenderCallback=()=>{};this._onAfterRenderCallback=()=>{};this._onAfterResizeCallback=()=>{};let r="ComputePass";e=e&&e.renderer||e,b(e,t.label?`${t.label} ${r}`:r),t.label=t.label??"ComputePass "+e.computePasses?.length,this.renderer=e,this.type=r,this.uuid=V(),Object.defineProperty(this,"index",{value:vt++});let{label:s,shaders:i,renderOrder:n,inputs:o,bindGroups:a,autoRender:u,useAsyncPipeline:d,texturesOptions:l,dispatchSize:m}=t;this.options={label:s,shaders:i,...u!==void 0&&{autoRender:u},...n!==void 0&&{renderOrder:n},...d!==void 0&&{useAsyncPipeline:d},...m!==void 0&&{dispatchSize:m},texturesOptions:l},this.renderOrder=n??0,u!==void 0&&(this.#e=u),this.userData={},this.ready=!1,this.setComputeMaterial({label:this.options.label,shaders:this.options.shaders,inputs:o,bindGroups:a,useAsyncPipeline:d,dispatchSize:m}),this.addToScene()}#e;get ready(){return this._ready}set ready(e){e&&this._onReadyCallback&&this._onReadyCallback(),this._ready=e}addToScene(){this.renderer.computePasses.push(this),this.#e&&this.renderer.scene.addComputePass(this)}removeFromScene(){this.#e&&this.renderer.scene.removeComputePass(this),this.renderer.computePasses=this.renderer.computePasses.filter(e=>e.uuid!==this.uuid)}setComputeMaterial(e){this.material=new Ge(this.renderer,e)}loseContext(){this.material.loseContext()}restoreContext(){this.material.restoreContext()}get textures(){return this.material?.textures||[]}get renderTextures(){return this.material?.renderTextures||[]}createTexture(e){e.name||(e.name="texture"+this.textures.length),e.label||(e.label=this.options.label+" "+e.name);let t=new I(this.renderer,{...e,...this.options.texturesOptions});return this.addTexture(t),t}addTexture(e){this.material.addTexture(e)}createRenderTexture(e){e.name||(e.name="renderTexture"+this.renderTextures.length);let t=new _(this.renderer,e);return this.addRenderTexture(t),t}addRenderTexture(e){this.material.addTexture(e)}get uniforms(){return this.material?.uniforms}get storages(){return this.material?.storages}resize(){this._onAfterResizeCallback&&this._onAfterResizeCallback()}onReady(e){return e&&(this._onReadyCallback=e),this}onBeforeRender(e){return e&&(this._onBeforeRenderCallback=e),this}onRender(e){return e&&(this._onRenderCallback=e),this}onAfterRender(e){return e&&(this._onAfterRenderCallback=e),this}onAfterResize(e){return e&&(this._onAfterResizeCallback=e),this}onBeforeRenderPass(){this.renderer.ready&&(this.material&&this.material.ready&&!this.ready&&(this.ready=!0),this._onBeforeRenderCallback&&this._onBeforeRenderCallback(),this.material.onBeforeRender())}onRenderPass(e){this.material.ready&&(this._onRenderCallback&&this._onRenderCallback(),this.material.render(e))}onAfterRenderPass(){this._onAfterRenderCallback&&this._onAfterRenderCallback()}render(e){this.onBeforeRenderPass(),this.renderer.ready&&(this.onRenderPass(e),this.onAfterRenderPass())}get canRender(){return this.material?!this.material.hasMappedBuffer:!1}copyBufferToResult(e){this.material?.copyBufferToResult(e)}setWorkGroupsResult(){this.material?.setWorkGroupsResult()}getWorkGroupResult({workGroupName:e,bindingName:t}){return this.material?.getWorkGroupResult({workGroupName:e,bindingName:t})}remove(){this.removeFromScene(),this.destroy()}destroy(){this.material?.destroy()}};var q=[new c,new c,new c,new c,new c,new c,new c,new c],se=class h{constructor(e=new c(1/0),t=new c(-1/0)){this.min=e,this.max=t}set(e=new c(1/0),t=new c(-1/0)){return this.min.copy(e),this.max.copy(t),this}clone(){return new h().set(this.min,this.max)}getCenter(){return this.max.clone().add(this.min).multiplyScalar(.5)}getSize(){return this.max.clone().sub(this.min)}applyMat4(e=new E){let t=[];this.min.z===this.max.z?(t[0]=q[0].set(this.min.x,this.min.y,this.min.z).applyMat4(e),t[1]=q[2].set(this.min.x,this.max.y,this.min.z).applyMat4(e),t[2]=q[4].set(this.max.x,this.min.y,this.min.z).applyMat4(e),t[3]=q[6].set(this.max.x,this.max.y,this.min.z).applyMat4(e)):(t[0]=q[0].set(this.min.x,this.min.y,this.min.z).applyMat4(e),t[1]=q[1].set(this.min.x,this.min.y,this.max.z).applyMat4(e),t[2]=q[2].set(this.min.x,this.max.y,this.min.z).applyMat4(e),t[3]=q[3].set(this.min.x,this.max.y,this.max.z).applyMat4(e),t[4]=q[4].set(this.max.x,this.min.y,this.min.z).applyMat4(e),t[5]=q[5].set(this.max.x,this.min.y,this.max.z).applyMat4(e),t[6]=q[6].set(this.max.x,this.max.y,this.min.z).applyMat4(e),t[7]=q[7].set(this.max.x,this.max.y,this.max.z).applyMat4(e));let r=new h;for(let s=0,i=t.length;s<i;s++)r.min.min(t[s]),r.max.max(t[s]);return r}};var xt={top:0,right:0,bottom:0,left:0},we=class{constructor({boundingBox:e=new se,modelViewProjectionMatrix:t=new E,containerBoundingRect:r={top:0,right:0,bottom:0,left:0,width:0,height:0,x:0,y:0},DOMFrustumMargins:s=xt,onReEnterView:i=()=>{},onLeaveView:n=()=>{}}){this.boundingBox=e,this.modelViewProjectionMatrix=t,this.containerBoundingRect=r,this.DOMFrustumMargins={...xt,...s},this.projectedBoundingRect={top:0,right:0,bottom:0,left:0,width:0,height:0,x:0,y:0},this.onReEnterView=i,this.onLeaveView=n,this.isIntersecting=!1,this.shouldUpdate=!1}setContainerBoundingRect(e){this.containerBoundingRect=e}get DOMFrustumBoundingRect(){return{top:this.projectedBoundingRect.top-this.DOMFrustumMargins.top,right:this.projectedBoundingRect.right+this.DOMFrustumMargins.right,bottom:this.projectedBoundingRect.bottom+this.DOMFrustumMargins.bottom,left:this.projectedBoundingRect.left-this.DOMFrustumMargins.left}}computeProjectedToDocumentCoords(){let e=this.boundingBox.applyMat4(this.modelViewProjectionMatrix);e.min.x=(e.min.x+1)*.5,e.max.x=(e.max.x+1)*.5,e.min.y=1-(e.min.y+1)*.5,e.max.y=1-(e.max.y+1)*.5;let{width:t,height:r,top:s,left:i}=this.containerBoundingRect;this.projectedBoundingRect={left:e.min.x*t+i,x:e.min.x*t+i,top:e.max.y*r+s,y:e.max.y*r+s,right:e.max.x*t+i,bottom:e.min.y*r+s,width:e.max.x*t+i-(e.min.x*t+i),height:e.min.y*r+s-(e.max.y*r+s)},this.intersectsContainer()}intersectsContainer(){Math.round(this.DOMFrustumBoundingRect.right)<=this.containerBoundingRect.left||Math.round(this.DOMFrustumBoundingRect.left)>=this.containerBoundingRect.left+this.containerBoundingRect.width||Math.round(this.DOMFrustumBoundingRect.bottom)<=this.containerBoundingRect.top||Math.round(this.DOMFrustumBoundingRect.top)>=this.containerBoundingRect.top+this.containerBoundingRect.height?(this.isIntersecting&&this.onLeaveView(),this.isIntersecting=!1):(this.isIntersecting||this.onReEnterView(),this.isIntersecting=!0)}};var ie=class{constructor({verticesOrder:e="cw",topology:t="triangle-list",instancesCount:r=1,vertexBuffers:s=[]}={}){this.verticesCount=0,this.verticesOrder=e,this.topology=t,this.instancesCount=r,this.boundingBox=new se,this.type="Geometry",this.vertexBuffers=[],this.addVertexBuffer({name:"attributes"}),this.options={verticesOrder:e,instancesCount:r,vertexBuffers:s,topology:t},s.forEach(i=>{this.addVertexBuffer({stepMode:i.stepMode??"vertex",name:i.name,attributes:i.attributes})})}get shouldCompute(){return!this.vertexBuffers[0].array}get ready(){return!this.shouldCompute&&!this.vertexBuffers.find(e=>!e.buffer)}addVertexBuffer({stepMode:e="vertex",name:t,attributes:r=[]}={}){let s={name:t??"attributes"+this.vertexBuffers.length,stepMode:e,arrayStride:0,bufferLength:0,attributes:[],buffer:null,indexBuffer:null};return r?.forEach(i=>{this.setAttribute({vertexBuffer:s,...i})}),this.vertexBuffers.push(s),s}getVertexBufferByName(e=""){return this.vertexBuffers.find(t=>t.name===e)}setAttribute({vertexBuffer:e=this.vertexBuffers[0],name:t,type:r="vec3f",bufferFormat:s="float32x3",size:i=3,array:n=new Float32Array(this.verticesCount*i),verticesUsed:o=1}){let a=e.attributes,u=a.length;t||(t="geometryAttribute"+u),t==="position"&&(r!=="vec3f"||s!=="float32x3"||i!==3)&&(O(`Geometry 'position' attribute must have this exact properties set:
	type: 'vec3f',
	bufferFormat: 'float32x3',
	size: 3`),r="vec3f",s="float32x3",i=3);let d=n.length/i;t==="position"&&(this.verticesCount=d),e.stepMode==="vertex"&&this.verticesCount&&this.verticesCount!==d*o?S(`Geometry vertex attribute error. Attribute array of size ${i} must be of length: ${this.verticesCount*i}, current given: ${n.length}. (${this.verticesCount} vertices).`):e.stepMode==="instance"&&d!==this.instancesCount&&S(`Geometry instance attribute error. Attribute array of size ${i} must be of length: ${this.instancesCount*i}, current given: ${n.length}. (${this.instancesCount} instances).`);let l={name:t,type:r,bufferFormat:s,size:i,bufferLength:n.length,offset:u?a.reduce((m,p)=>m+p.bufferLength,0):0,bufferOffset:u?a[u-1].bufferOffset+a[u-1].size*4:0,array:n,verticesUsed:o};e.bufferLength+=l.bufferLength*o,e.arrayStride+=l.size,e.attributes.push(l)}getAttributeByName(e){let t;return this.vertexBuffers.forEach(r=>{t=r.attributes.find(s=>s.name===e)}),t}computeGeometry(){this.shouldCompute&&(this.vertexBuffers.forEach((e,t)=>{if(t===0){let i=e.attributes.find(n=>n.name==="position");i||S("Geometry must have a 'position' attribute"),(i.type!=="vec3f"||i.bufferFormat!=="float32x3"||i.size!==3)&&(O(`Geometry 'position' attribute must have this exact properties set:
	type: 'vec3f',
	bufferFormat: 'float32x3',
	size: 3`),i.type="vec3f",i.bufferFormat="float32x3",i.size=3)}e.array=new Float32Array(e.bufferLength);let r=0,s=0;for(let i=0;i<e.bufferLength;i+=e.arrayStride){for(let n=0;n<e.attributes.length;n++){let{name:o,size:a,array:u,verticesUsed:d}=e.attributes[n];for(let l=0;l<a;l++){let m=u[Math.floor(s/d)*a+l];e.array[r]=m,o==="position"&&(l%3===0?(this.boundingBox.min.x>m&&(this.boundingBox.min.x=m),this.boundingBox.max.x<m&&(this.boundingBox.max.x=m)):l%3===1?(this.boundingBox.min.y>m&&(this.boundingBox.min.y=m),this.boundingBox.max.y<m&&(this.boundingBox.max.y=m)):l%3===2&&(this.boundingBox.min.z>m&&(this.boundingBox.min.z=m),this.boundingBox.max.z<m&&(this.boundingBox.max.z=m))),r++}}s++}}),this.#e())}#e(){let e=-1;this.wgslStructFragment=`struct Attributes {
	@builtin(vertex_index) vertexIndex : u32,
	@builtin(instance_index) instanceIndex : u32,${this.vertexBuffers.map(t=>t.attributes.map(r=>(e++,`
	@location(${e}) ${r.name}: ${r.type}`))).join(",")}
};`}setGeometryBuffers(e){this.vertexBuffers.forEach((t,r)=>{e.setVertexBuffer(r,t.buffer)})}drawGeometry(e){e.draw(this.verticesCount,this.instancesCount)}render(e){this.ready&&(this.setGeometryBuffers(e),this.drawGeometry(e))}destroy(){this.vertexBuffers.forEach(e=>{e.buffer?.destroy()}),this.vertexBuffers=[]}};var K=class extends ie{constructor({verticesOrder:t="cw",topology:r="triangle-list",instancesCount:s=1,vertexBuffers:i=[]}={}){super({verticesOrder:t,topology:r,instancesCount:s,vertexBuffers:i});this.type="IndexedGeometry"}get ready(){return!this.shouldCompute&&!this.vertexBuffers.find(t=>!t.buffer)&&this.indexBuffer&&!!this.indexBuffer.buffer}setIndexBuffer({bufferFormat:t="uint32",array:r=new Uint32Array(0)}){this.indexBuffer={array:r,bufferFormat:t,bufferLength:r.length,buffer:null}}setGeometryBuffers(t){super.setGeometryBuffers(t),t.setIndexBuffer(this.indexBuffer.buffer,this.indexBuffer.bufferFormat)}drawGeometry(t){t.drawIndexed(this.indexBuffer.bufferLength,this.instancesCount)}destroy(){super.destroy(),this.indexBuffer?.buffer?.destroy(),this.indexBuffer=null}};var ne=class extends K{constructor({widthSegments:t=1,heightSegments:r=1,instancesCount:s=1,vertexBuffers:i=[],topology:n}={}){super({verticesOrder:"cw",topology:n,instancesCount:s,vertexBuffers:i});this.type="PlaneGeometry",t=Math.floor(t),r=Math.floor(r),this.definition={id:t*r+t,width:t,height:r,count:t*r},this.setIndexArray();let o=this.definition.width*2+2+(this.definition.height-1)*(this.definition.width+1),a=this.getIndexedVerticesAndUVs(o);Object.keys(a).forEach(u=>{this.setAttribute(a[u])})}setIndexArray(){let t=new Uint32Array(this.definition.count*6),r=0;for(let s=0;s<this.definition.height;s++)for(let i=0;i<this.definition.width;i++)t[r++]=i+s*(this.definition.width+1),t[r++]=this.definition.width+i+1+s*(this.definition.width+1),t[r++]=i+1+s*(this.definition.width+1),t[r++]=i+1+s*(this.definition.width+1),t[r++]=this.definition.width+i+1+s*(this.definition.width+1),t[r++]=this.definition.width+i+2+s*(this.definition.width+1);this.setIndexBuffer({array:t})}getIndexedVerticesAndUVs(t){let r={name:"uv",type:"vec2f",bufferFormat:"float32x2",size:2,bufferLength:t*2,array:new Float32Array(t*2)},s={name:"position",type:"vec3f",bufferFormat:"float32x3",size:3,bufferLength:t*3,array:new Float32Array(t*3)},i={name:"normal",type:"vec3f",bufferFormat:"float32x3",size:3,bufferLength:t*3,array:new Float32Array(t*3)},n=0,o=0,a=0;for(let u=0;u<=this.definition.height;u++)for(let d=0;d<=this.definition.width;d++)r.array[a++]=d/this.definition.width,r.array[a++]=1-u/this.definition.height,s.array[n++]=d*2/this.definition.width-1,s.array[n++]=u*2/this.definition.height-1,s.array[n++]=0,i.array[o++]=0,i.array[o++]=0,i.array[o++]=1;return{position:s,uv:r,normal:i}}};var Ue=class extends re{constructor(t,r){t=t&&t.renderer||t;let s="RenderMaterial";b(t,s);super(t,r);this.type=s,this.renderer=t;let{shaders:i,label:n,useAsyncPipeline:o,inputs:a,bindGroups:u,...d}=r;i.vertex.entryPoint||(i.vertex.entryPoint="main"),i.fragment.entryPoint||(i.fragment.entryPoint="main"),this.options={...this.options,shaders:i,label:n,...o!==void 0&&{useAsyncPipeline:o},...a!==void 0&&{inputs:a},...u!==void 0&&{bindGroups:u},rendering:d},this.pipelineEntry=this.renderer.pipelineManager.createRenderPipeline({label:this.options.label+" render pipeline",shaders:this.options.shaders,useAsync:this.options.useAsyncPipeline,...this.options.rendering}),this.attributes=null}setPipelineEntryProperties(){this.pipelineEntry.setPipelineEntryProperties({attributes:this.attributes,bindGroups:this.bindGroups})}async compilePipelineEntry(){await this.pipelineEntry.compilePipelineEntry()}async compileMaterial(){super.compileMaterial(),this.attributes&&this.pipelineEntry&&this.pipelineEntry.canCompile&&(this.setPipelineEntryProperties(),await this.compilePipelineEntry())}setAttributesFromGeometry(t){this.attributes={wgslStructFragment:t.wgslStructFragment,vertexBuffers:t.vertexBuffers}}createBindGroups(){let t=this.options.rendering.useProjection?1:0;this.texturesBindGroup.shouldCreateBindGroup&&(this.texturesBindGroup.setIndex(this.bindGroups.length+t),this.texturesBindGroup.createBindGroup(),this.bindGroups.push(this.texturesBindGroup)),this.inputsBindGroups.forEach(r=>{r.shouldCreateBindGroup&&(r.setIndex(this.bindGroups.length+t),r.createBindGroup(),this.bindGroups.push(r))})}};var st=`
struct VertexOutput {
  @builtin(position) position: vec4f,
  @location(0) uv: vec2f,
};

@vertex fn main(
  attributes: Attributes,
) -> VertexOutput {
  var vsOutput: VertexOutput;

  vsOutput.position = vec4f(attributes.position, 1.0);
  vsOutput.uv = attributes.uv;
  
  return vsOutput;
}`;var it=`
@fragment fn main() -> @location(0) vec4f {
  return vec4(0.0, 0.0, 0.0, 1.0);
}`;var St=0,gt={geometry:new ie,shaders:{},autoRender:!0,useProjection:!1,cullMode:"back",depthWriteEnabled:!0,depthCompare:"less",transparent:!1,visible:!0,renderOrder:0,texturesOptions:{}};function Ot(h){return class extends h{constructor(...r){super(r[0],r[1],{...gt,...r[2]});this.#e=!0;this._onReadyCallback=()=>{};this._onBeforeRenderCallback=()=>{};this._onRenderCallback=()=>{};this._onAfterRenderCallback=()=>{};this._onAfterResizeCallback=()=>{};let s=r[0],i={...gt,...r[2]};this.type="MeshBase",this.uuid=V(),Object.defineProperty(this,"index",{value:St++}),s=s&&s.renderer||s,b(s,i.label?i.label+" "+this.type:this.type),this.renderer=s;let{label:n,shaders:o,geometry:a,visible:u,renderOrder:d,renderTarget:l,texturesOptions:m,autoRender:p,...f}=i;this.options={...this.options??{},label:n??"Mesh "+this.renderer.meshes.length,shaders:o,texturesOptions:m,...l!==void 0&&{renderTarget:l},...p!==void 0&&{autoRender:p},...f.useAsyncPipeline!==void 0&&{useAsyncPipeline:f.useAsyncPipeline}},this.renderTarget=l??null,this.geometry=a,p!==void 0&&(this.#e=p),this.visible=u,this.renderOrder=d,this.ready=!1,this.userData={},this.computeGeometry(),this.setMaterial({label:this.options.label,shaders:this.options.shaders,...f,verticesOrder:a.verticesOrder,topology:a.topology}),this.addToScene()}#e;get autoRender(){return this.#e}get ready(){return this._ready}set ready(r){r&&this._onReadyCallback&&this._onReadyCallback(),this._ready=r}addToScene(){this.renderer.meshes.push(this),this.#e&&this.renderer.scene.addMesh(this)}removeFromScene(){this.#e&&this.renderer.scene.removeMesh(this),this.renderer.meshes=this.renderer.meshes.filter(r=>r.uuid!==this.uuid)}loseContext(){this.geometry.vertexBuffers.forEach(r=>{r.buffer=null}),"indexBuffer"in this.geometry&&(this.geometry.indexBuffer.buffer=null),this.material.loseContext()}restoreContext(){this.material.restoreContext()}setShaders(){let{shaders:r}=this.options;r?((!r.vertex||!r.vertex.code)&&(r.vertex={code:st,entryPoint:"main"}),(!r.fragment||!r.fragment.code)&&(r.fragment={code:it,entryPoint:"main"})):r={vertex:{code:st,entryPoint:"main"},fragment:{code:it,entryPoint:"main"}}}computeGeometry(){this.geometry.shouldCompute&&this.geometry.computeGeometry()}createGeometryBuffers(){this.geometry.ready||(this.geometry.vertexBuffers.forEach(r=>{r.buffer||(r.buffer=this.renderer.createBuffer({label:this.options.label+": Vertex buffer vertices",size:r.array.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),this.renderer.queueWriteBuffer(r.buffer,0,r.array))}),"indexBuffer"in this.geometry&&this.geometry.indexBuffer&&!this.geometry.indexBuffer.buffer&&(this.geometry.indexBuffer.buffer=this.renderer.createBuffer({label:this.options.label+": Index buffer vertices",size:this.geometry.indexBuffer.array.byteLength,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST}),this.renderer.queueWriteBuffer(this.geometry.indexBuffer.buffer,0,this.geometry.indexBuffer.array)))}setGeometry(){this.geometry&&this.renderer.ready&&(this.createGeometryBuffers(),this.setMaterialGeometryAttributes())}setMaterial(r){this.transparent=r.transparent,this.setShaders(),this.material=new Ue(this.renderer,r)}setMaterialGeometryAttributes(){this.material&&!this.material.attributes&&this.material.setAttributesFromGeometry(this.geometry)}get textures(){return this.material?.textures||[]}get renderTextures(){return this.material?.renderTextures||[]}createTexture(r){r.name||(r.name="texture"+this.textures.length),r.label||(r.label=this.options.label+" "+r.name);let s=new I(this.renderer,{...r,...this.options.texturesOptions});return this.addTexture(s),s}addTexture(r){this.material.addTexture(r),this.onTextureAdded(r)}onTextureAdded(r){r.parent=this}createRenderTexture(r){r.name||(r.name="renderTexture"+this.renderTextures.length);let s=new _(this.renderer,r);return this.addRenderTexture(s),s}addRenderTexture(r){this.material.addTexture(r)}setRenderTarget(r){if(r&&r.type!=="RenderTarget"){O(`${this.options.label??this.type}: renderTarget is not a RenderTarget: ${r}`);return}this.removeFromScene(),this.renderTarget=r,this.addToScene()}get uniforms(){return this.material?.uniforms}get storages(){return this.material?.storages}resizeRenderTextures(){this.renderTextures?.filter(r=>r.options.usage==="texture").forEach(r=>r.resize())}resize(r=null){this.resizeRenderTextures(),super.resize&&super.resize(r),this.textures?.forEach(s=>{s.resize()}),this._onAfterResizeCallback&&this._onAfterResizeCallback()}onReady(r){return r&&(this._onReadyCallback=r),this}onBeforeRender(r){return r&&(this._onBeforeRenderCallback=r),this}onRender(r){return r&&(this._onRenderCallback=r),this}onAfterRender(r){return r&&(this._onAfterRenderCallback=r),this}onAfterResize(r){return r&&(this._onAfterResizeCallback=r),this}onBeforeRenderPass(){this.renderer.ready&&(this.material&&this.material.ready&&this.geometry&&this.geometry.ready&&!this.ready&&(this.ready=!0),this.setGeometry(),this._onBeforeRenderCallback&&this._onBeforeRenderCallback(),this.material.onBeforeRender())}onRenderPass(r){this.material.ready&&(this._onRenderCallback&&this._onRenderCallback(),this.material.render(r),this.geometry.render(r))}onAfterRenderPass(){this._onAfterRenderCallback&&this._onAfterRenderCallback()}render(r){this.onBeforeRenderPass(),!(!this.renderer.ready||!this.visible)&&(super.render&&super.render(),this.onRenderPass(r),this.onAfterRenderPass())}remove(){this.removeFromScene(),this.destroy()}destroy(){super.destroy&&super.destroy(),this.material?.destroy(),this.geometry?.destroy()}}}var qe=Ot;var nt=class{constructor(){this.shouldWatch=!0,this.entries=[],this.resizeObserver=new ResizeObserver(e=>{e.forEach(t=>{let r=this.entries.find(s=>s.element.isSameNode(t.target));r&&r.callback&&r.callback()})})}useObserver(e=!0){this.shouldWatch=e}observe({element:e,callback:t}){if(!e||!this.shouldWatch)return;this.resizeObserver.observe(e);let r={element:e,callback:t};this.entries.push(r)}unobserve(e){this.resizeObserver.unobserve(e),this.entries=this.entries.filter(t=>!t.element.isSameNode(e))}destroy(){this.resizeObserver.disconnect()}},Ie=new nt;var H=class{constructor({element:e=document.body,onSizeChanged:t=(s=null)=>{},onPositionChanged:r=(s=null)=>{}}={}){this.#e=null;if(typeof e=="string"){if(this.element=document.querySelector(e),!this.element){let s=typeof e=="string"?`'${e}' selector`:`${e} HTMLElement`;S(`DOMElement: corresponding ${s} not found.`)}}else this.element=e;this.isResizing=!1,this.onSizeChanged=t,this.onPositionChanged=r,this.resizeManager=Ie,this.resizeManager.observe({element:this.element,callback:()=>{this.setSize()}}),this.setSize()}#e;compareBoundingRect(e,t){return!["x","y","left","top","right","bottom","width","height"].some(r=>e[r]!==t[r])}get boundingRect(){return this._boundingRect}set boundingRect(e){let t=!!this.boundingRect&&this.compareBoundingRect(e,this.boundingRect);this._boundingRect={top:e.top,right:e.right,bottom:e.bottom,left:e.left,width:e.width,height:e.height,x:e.x,y:e.y},t||this.onSizeChanged(this.boundingRect)}updateScrollPosition(e={x:0,y:0}){this.isResizing||(this._boundingRect.top+=e.y,this._boundingRect.left+=e.x,(e.x||e.y)&&this.onPositionChanged(this.boundingRect))}setSize(e=null){this.element&&(this.isResizing=!!this.boundingRect,this.boundingRect=e??this.element.getBoundingClientRect(),this.#e=setTimeout(()=>{this.isResizing=!1,this.#e=null},50))}destroy(){this.resizeManager.unobserve(this.element),this.#e&&clearTimeout(this.#e)}};var ot=class{constructor(){this.planeGeometries=[]}getPlaneGeometry(e){return this.planeGeometries.find(t=>t.definition.id===e.definition.id)}getPlaneGeometryByID(e){return this.planeGeometries.find(t=>t.definition.id===e)}addPlaneGeometry(e){this.planeGeometries.push(e)}destroy(){this.planeGeometries=[]}},ve=new ot;var oe=class extends qe(class{}){constructor(t,r={}){t=t&&t.renderer||t,b(t,r.label?r.label+" FullscreenQuadMesh":"FullscreenQuadMesh");let s=ve.getPlaneGeometryByID(2);s||(s=new ne({widthSegments:1,heightSegments:1}),ve.addPlaneGeometry(s));super(t,null,{geometry:s,...r});this.size={document:{width:0,height:0,top:0,left:0}},this.domElement=new H({element:this.renderer.domElement.element,onSizeChanged:i=>this.resize(i)}),this.type="FullscreenQuadMesh"}resize(t=null){!t&&(!this.domElement||this.domElement?.isResizing)||(this.size.document=t??this.domElement.element.getBoundingClientRect(),super.resize(t))}mouseToPlaneCoords(t=new W){return new W((t.x-this.size.document.left)/this.size.document.width*2-1,1-(t.y-this.size.document.top)/this.size.document.height*2)}};var ae=class extends J{constructor(t){super();t=t&&t.renderer||t,Pe(t,"ProjectedObject3D"),this.camera=t.camera}applyPosition(){super.applyPosition(),this.shouldUpdateProjectionMatrixStack()}applyRotation(){super.applyRotation(),this.shouldUpdateProjectionMatrixStack()}applyScale(){super.applyScale(),this.shouldUpdateProjectionMatrixStack()}applyTransformOrigin(){super.applyTransformOrigin(),this.shouldUpdateProjectionMatrixStack()}setMatrices(){super.setMatrices(),this.matrices={...this.matrices,modelView:{matrix:new E,shouldUpdate:!1,onUpdate:()=>{this.modelViewMatrix.multiplyMatrices(this.viewMatrix,this.modelMatrix)}},modelViewProjection:{matrix:new E,shouldUpdate:!1,onUpdate:()=>{this.modelViewProjectionMatrix.multiplyMatrices(this.projectionMatrix,this.modelViewMatrix)}}}}get modelViewMatrix(){return this.matrices.modelView.matrix}set modelViewMatrix(t){this.matrices.modelView.matrix=t,this.matrices.modelView.shouldUpdate=!0}get viewMatrix(){return this.camera.viewMatrix}get projectionMatrix(){return this.camera.projectionMatrix}get modelViewProjectionMatrix(){return this.matrices.modelViewProjection.matrix}set modelViewProjectionMatrix(t){this.matrices.modelViewProjection.matrix=t,this.matrices.modelViewProjection.shouldUpdate=!0}shouldUpdateProjectionMatrixStack(){this.matrices.modelView.shouldUpdate=!0,this.matrices.modelViewProjection.shouldUpdate=!0}updateSizePositionAndProjection(){this.shouldUpdateModelMatrix(),this.shouldUpdateProjectionMatrixStack()}};var at=`
struct VertexOutput {
  @builtin(position) position: vec4f,
  @location(0) uv: vec2f,
  @location(1) normal: vec3f,
};

@vertex fn main(
  attributes: Attributes,
) -> VertexOutput {
  var vsOutput: VertexOutput;

  vsOutput.position = getOutputPosition(camera, matrices, attributes.position);
  vsOutput.uv = attributes.uv;
  vsOutput.normal = attributes.normal;
  
  return vsOutput;
}`;var ut=`
struct VSOutput {
  @builtin(position) position: vec4f,
  @location(0) uv: vec2f,
  @location(1) normal: vec3f,
};

@fragment fn main(fsInput: VSOutput) -> @location(0) vec4f {
  // normals
  return vec4(fsInput.normal * 0.5 + 0.5, 1.0);
}`;var yt={frustumCulled:!0,DOMFrustumMargins:{top:0,right:0,bottom:0,left:0}};function zt(h){return class extends qe(h){constructor(...r){super(r[0],r[1],{...yt,...r[2],useProjection:!0});this._onReEnterViewCallback=()=>{};this._onLeaveViewCallback=()=>{};let s=r[0],i={...yt,...r[2],useProjection:!0};this.type="MeshTransformed",s=s&&s.renderer||s,Pe(s,i.label?i.label+" "+this.type:this.type),this.renderer=s;let{geometry:n,frustumCulled:o,DOMFrustumMargins:a}=i;this.options={...this.options??{},frustumCulled:o,DOMFrustumMargins:a},this.setDOMFrustum(),this.geometry=n,this.updateSizePositionAndProjection()}setShaders(){let{shaders:r}=this.options;r?((!r.vertex||!r.vertex.code)&&(r.vertex={code:at,entryPoint:"main"}),(!r.fragment||!r.fragment.code)&&(r.fragment={code:ut,entryPoint:"main"})):r={vertex:{code:at,entryPoint:"main"},fragment:{code:ut,entryPoint:"main"}}}setDOMFrustum(){this.domFrustum=new we({boundingBox:this.geometry.boundingBox,modelViewProjectionMatrix:this.modelViewProjectionMatrix,containerBoundingRect:this.renderer.boundingRect,DOMFrustumMargins:this.options.DOMFrustumMargins,onReEnterView:()=>{this._onReEnterViewCallback&&this._onReEnterViewCallback()},onLeaveView:()=>{this._onLeaveViewCallback&&this._onLeaveViewCallback()}}),this.DOMFrustumMargins=this.domFrustum.DOMFrustumMargins,this.frustumCulled=this.options.frustumCulled,this.domFrustum.shouldUpdate=this.frustumCulled}setMaterial(r){let s={label:"Matrices",bindings:{model:{name:"model",type:"mat4x4f",value:this.modelMatrix,onBeforeUpdate:()=>{s.bindings.model.value=this.modelMatrix}},modelView:{name:"modelView",type:"mat4x4f",value:this.modelViewMatrix,onBeforeUpdate:()=>{s.bindings.modelView.value=this.modelViewMatrix}},modelViewProjection:{name:"modelViewProjection",type:"mat4x4f",value:this.modelViewProjectionMatrix,onBeforeUpdate:()=>{s.bindings.modelViewProjection.value=this.modelViewProjectionMatrix}}}};r.inputs||(r.inputs={uniforms:{}}),r.inputs.uniforms.matrices=s,super.setMaterial(r)}resize(r=null){this.domFrustum&&this.domFrustum.setContainerBoundingRect(this.renderer.boundingRect),super.resize(r)}applyScale(){super.applyScale(),this.textures.forEach(r=>r.resize())}get projectedBoundingRect(){return this.domFrustum?.projectedBoundingRect}updateSizePositionAndProjection(){super.updateSizePositionAndProjection()}updateMatrixStack(){super.updateMatrixStack()}onAfterMatrixStackUpdate(){this.material&&this.material.shouldUpdateInputsBindings("matrices"),this.domFrustum&&(this.domFrustum.shouldUpdate=!0)}onReEnterView(r){return r&&(this._onReEnterViewCallback=r),this}onLeaveView(r){return r&&(this._onLeaveViewCallback=r),this}onBeforeRenderPass(){this.updateMatrixStack(),this.domFrustum&&this.domFrustum.shouldUpdate&&this.frustumCulled&&(this.domFrustum.computeProjectedToDocumentCoords(),this.domFrustum.shouldUpdate=!1),super.onBeforeRenderPass()}onRenderPass(r){this.material.ready&&(this._onRenderCallback&&this._onRenderCallback(),(this.domFrustum&&this.domFrustum.isIntersecting||!this.frustumCulled)&&(this.material.render(r),this.geometry.render(r)))}}}var Ne=zt;var He=class extends Ne(ae){constructor(e,t={}){e=e&&e.renderer||e,Pe(e,t.label?t.label+" Mesh":"Mesh"),super(e,null,t),this.type="Mesh"}};var At=0,ue=class{constructor(e){this.type="PipelineEntry";let{renderer:t}=e,{label:r,shaders:s,useAsync:i}=e;t=t&&t.renderer||t,b(t,r?r+" "+this.type:this.type),this.renderer=t,Object.defineProperty(this,"index",{value:At++}),this.layout=null,this.pipeline=null,this.status={compiling:!1,compiled:!1,error:null},this.options={label:r,shaders:s,useAsync:i!==void 0?i:!0}}get ready(){return!this.status.compiling&&this.status.compiled&&!this.status.error}get canCompile(){return!this.status.compiling&&!this.status.compiled&&!this.status.error}setPipelineEntryBindGroups(e){this.bindGroups=e}createShaderModule({code:e="",type:t="vertex"}){let r=this.renderer.createShaderModule({label:this.options.label+": "+t+"Shader module",code:e});return"getCompilationInfo"in r&&!this.renderer.production&&r.getCompilationInfo().then(s=>{for(let i of s.messages){let n="";switch(i.lineNum&&(n+=`Line ${i.lineNum}:${i.linePos} - ${e.substring(i.offset,i.offset+i.length)}
`),n+=i.message,i.type){case"error":console.error(`${this.options.label} compilation error:
${n}`);break;case"warning":console.warn(`${this.options.label} compilation warning:
${n}`);break;case"info":console.log(`${this.options.label} compilation information:
${n}`);break}}}),r}createShaders(){}createPipelineLayout(){this.layout=this.renderer.createPipelineLayout({label:this.options.label+" layout",bindGroupLayouts:this.bindGroups.map(e=>e.bindGroupLayout)})}createPipelineDescriptor(){}flushPipelineEntry(e=[]){this.status.compiling=!1,this.status.compiled=!1,this.status.error=null,this.setPipelineEntryBindGroups(e),this.compilePipelineEntry()}compilePipelineEntry(){this.status.compiling=!0,this.createShaders(),this.createPipelineLayout(),this.createPipelineDescriptor()}};var Pt=`
fn getOutputPosition(camera: Camera, matrices: Matrices, position: vec3f) -> vec4f {
  return camera.projection * matrices.modelView * vec4f(position, 1.0);
}`;var dt=`
fn getUVCover(uv: vec2f, textureMatrix: mat4x4f) -> vec2f {
  return (textureMatrix * vec4f(uv, 0.0, 1.0)).xy;
}`;var bt=`
fn getVertex2DToUVCoords(vertex: vec2f) -> vec2f {
  return vec2(
    vertex.x * 0.5 + 0.5,
    0.5 - vertex.y * 0.5
  );
}

fn getVertex3DToUVCoords(vertex: vec3f) -> vec2f {
  return vec2(
    vertex.x * 0.5 + 0.5,
    0.5 - vertex.y * 0.5
  );
}
`;var _e={vertex:{get_uv_cover:dt},fragment:{get_uv_cover:dt,get_vertex_to_uv_coords:bt}},$e={vertex:{get_output_position:Pt},fragment:{}};var xe=class extends ue{constructor(t){let{renderer:r}=t,{label:s,cullMode:i,depthWriteEnabled:n,depthCompare:o,transparent:a,verticesOrder:u,topology:d,blend:l,useProjection:m}=t;r=r&&r.renderer||r;let p="RenderPipelineEntry";b(r,s?s+" "+p:p);super(t);this.type=p,this.shaders={vertex:{head:"",code:"",module:null},fragment:{head:"",code:"",module:null},full:{code:"",module:null}},this.descriptor=null,this.options={...this.options,cullMode:i,depthWriteEnabled:n,depthCompare:o,transparent:a,verticesOrder:u,topology:d,blend:l,useProjection:m}}setPipelineEntryBindGroups(t){this.bindGroups="cameraBindGroup"in this.renderer&&this.options.useProjection?[this.renderer.cameraBindGroup,...t]:t}setPipelineEntryProperties(t){let{attributes:r,bindGroups:s}=t;this.attributes=r,this.setPipelineEntryBindGroups(s)}patchShaders(){this.shaders.vertex.head="",this.shaders.vertex.code="",this.shaders.fragment.head="",this.shaders.fragment.code="";for(let r in _e.vertex)this.shaders.vertex.head=`${_e.vertex[r]}
${this.shaders.vertex.head}`;for(let r in _e.fragment)this.shaders.fragment.head=`${_e.fragment[r]}
${this.shaders.fragment.head}`;if(this.options.useProjection){for(let r in $e.vertex)this.shaders.vertex.head=`${$e.vertex[r]}
${this.shaders.vertex.head}`;for(let r in $e.fragment)this.shaders.fragment.head=`${$e.fragment[r]}
${this.shaders.fragment.head}`}let t=[];this.bindGroups.forEach(r=>{let s=0;r.bindings.forEach((i,n)=>{i.wgslGroupFragment.forEach((o,a)=>{t.push({groupIndex:r.index,visibility:i.visibility,bindIndex:s,wgslStructFragment:i.wgslStructFragment,wgslGroupFragment:o,newLine:n===r.bindings.length-1&&a===i.wgslGroupFragment.length-1}),s++})})}),t.forEach(r=>{(r.visibility===GPUShaderStage.VERTEX||r.visibility===(GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE))&&(r.wgslStructFragment&&this.shaders.vertex.head.indexOf(r.wgslStructFragment)===-1&&(this.shaders.vertex.head=`
${r.wgslStructFragment}
${this.shaders.vertex.head}`),this.shaders.vertex.head.indexOf(r.wgslGroupFragment)===-1&&(this.shaders.vertex.head=`${this.shaders.vertex.head}
@group(${r.groupIndex}) @binding(${r.bindIndex}) ${r.wgslGroupFragment}`,r.newLine&&(this.shaders.vertex.head+=`
`))),(r.visibility===GPUShaderStage.FRAGMENT||r.visibility===(GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE))&&(r.wgslStructFragment&&this.shaders.fragment.head.indexOf(r.wgslStructFragment)===-1&&(this.shaders.fragment.head=`
${r.wgslStructFragment}
${this.shaders.fragment.head}`),this.shaders.fragment.head.indexOf(r.wgslGroupFragment)===-1&&(this.shaders.fragment.head=`${this.shaders.fragment.head}
@group(${r.groupIndex}) @binding(${r.bindIndex}) ${r.wgslGroupFragment}`,r.newLine&&(this.shaders.fragment.head+=`
`)))}),this.shaders.vertex.head=`${this.attributes.wgslStructFragment}
${this.shaders.vertex.head}`,this.shaders.vertex.code=this.shaders.vertex.head+this.options.shaders.vertex.code,this.shaders.fragment.code=this.shaders.fragment.head+this.options.shaders.fragment.code,this.shaders.full.code=this.shaders.vertex.code+`
`+this.shaders.fragment.code}createShaders(){this.patchShaders(),this.shaders.vertex.module=this.createShaderModule({code:this.shaders.vertex.code,type:"vertex"}),this.shaders.fragment.module=this.createShaderModule({code:this.shaders.fragment.code,type:"fragment"})}createPipelineDescriptor(){if(!this.shaders.vertex.module||!this.shaders.fragment.module)return;let t=-1,r=this.options.blend??(this.options.transparent&&{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha"}});this.descriptor={label:this.options.label,layout:this.layout,vertex:{module:this.shaders.vertex.module,entryPoint:this.options.shaders.vertex.entryPoint,buffers:this.attributes.vertexBuffers.map(s=>({stepMode:s.stepMode,arrayStride:s.arrayStride*4,attributes:s.attributes.map(i=>(t++,{shaderLocation:t,offset:i.bufferOffset,format:i.bufferFormat}))}))},fragment:{module:this.shaders.fragment.module,entryPoint:this.options.shaders.fragment.entryPoint,targets:[{format:this.renderer.preferredFormat,...r&&{blend:r}}]},primitive:{topology:this.options.topology,frontFace:this.options.verticesOrder,cullMode:this.options.cullMode},depthStencil:{depthWriteEnabled:this.options.depthWriteEnabled,depthCompare:this.options.depthCompare,format:"depth24plus"},...this.renderer.sampleCount>1&&{multisample:{count:this.renderer.sampleCount}}}}createRenderPipeline(){if(!(!this.shaders.vertex.module||!this.shaders.fragment.module))try{this.pipeline=this.renderer.createRenderPipeline(this.descriptor)}catch(t){this.status.error=t,S(t)}}async createRenderPipelineAsync(){if(!(!this.shaders.vertex.module||!this.shaders.fragment.module))try{this.pipeline=await this.renderer.createRenderPipelineAsync(this.descriptor),this.status.compiled=!0,this.status.compiling=!1,this.status.error=null}catch(t){this.status.error=t,S(t)}}async compilePipelineEntry(){super.compilePipelineEntry(),this.options.useAsync?await this.createRenderPipelineAsync():(this.createRenderPipeline(),this.status.compiled=!0,this.status.compiling=!1,this.status.error=null)}};var ge=class extends ue{constructor(t){let{renderer:r}=t,{label:s}=t;r=r&&r.renderer||r;let i="ComputePipelineEntry";b(r,s?s+" "+i:i);super(t);this.type=i,this.shaders={compute:{head:"",code:"",module:null}},this.descriptor=null}setPipelineEntryProperties(t){let{bindGroups:r}=t;this.setPipelineEntryBindGroups(r)}patchShaders(){this.shaders.compute.head="",this.shaders.compute.code="";let t=[];this.bindGroups.forEach(r=>{let s=0;r.bindings.forEach((i,n)=>{i.wgslGroupFragment.forEach((o,a)=>{t.push({groupIndex:r.index,visibility:i.visibility,bindIndex:s,wgslStructFragment:i.wgslStructFragment,wgslGroupFragment:o,newLine:n===r.bindings.length-1&&a===i.wgslGroupFragment.length-1}),s++})})}),t.forEach(r=>{r.wgslStructFragment&&this.shaders.compute.head.indexOf(r.wgslStructFragment)===-1&&(this.shaders.compute.head=`
${r.wgslStructFragment}
${this.shaders.compute.head}`),this.shaders.compute.head.indexOf(r.wgslGroupFragment)===-1&&(this.shaders.compute.head=`${this.shaders.compute.head}
@group(${r.groupIndex}) @binding(${r.bindIndex}) ${r.wgslGroupFragment}`),r.newLine&&(this.shaders.compute.head+=`
`)}),this.shaders.compute.code=this.shaders.compute.head+this.options.shaders.compute.code}createShaders(){this.patchShaders(),this.shaders.compute.module=this.createShaderModule({code:this.shaders.compute.code,type:"compute"})}createPipelineDescriptor(){this.shaders.compute.module&&(this.descriptor={label:this.options.label,layout:this.layout,compute:{module:this.shaders.compute.module,entryPoint:this.options.shaders.compute.entryPoint}})}createComputePipeline(){if(this.shaders.compute.module)try{this.pipeline=this.renderer.createComputePipeline(this.descriptor)}catch(t){this.status.error=t,S(t)}}async createComputePipelineAsync(){if(this.shaders.compute.module)try{this.pipeline=await this.renderer.createComputePipelineAsync(this.descriptor),this.status.compiled=!0,this.status.compiling=!1,this.status.error=null}catch(t){this.status.error=t,S(t)}}async compilePipelineEntry(){super.compilePipelineEntry(),this.options.useAsync?await this.createComputePipelineAsync():(this.createComputePipeline(),this.status.compiled=!0,this.status.compiling=!1,this.status.error=null)}};var Se=class{constructor({renderer:e}){this.type="PipelineManager",e=e&&e.renderer||e,b(e,this.type),this.renderer=e,this.currentPipelineIndex=null,this.pipelineEntries=[]}isSameRenderPipeline(e){let{shaders:t,cullMode:r,depthWriteEnabled:s,depthCompare:i,transparent:n,verticesOrder:o,topology:a}=e;return this.pipelineEntries.filter(u=>u instanceof xe).find(u=>{let{options:d}=u;return t.vertex.code.localeCompare(d.shaders.vertex.code)===0&&t.vertex.entryPoint===d.shaders.vertex.entryPoint&&t.fragment.code.localeCompare(d.shaders.fragment.code)===0&&t.fragment.entryPoint===d.shaders.fragment.entryPoint&&r===d.cullMode&&s===d.depthWriteEnabled&&i===d.depthCompare&&n===d.transparent&&o===d.verticesOrder&&a===d.topology})}createRenderPipeline(e){let t=this.isSameRenderPipeline(e);if(t)return t;{let r=new xe({renderer:this.renderer,...e});return this.pipelineEntries.push(r),r}}isSameComputePipeline(e){let{shaders:t}=e;return this.pipelineEntries.filter(r=>r instanceof ge).find(r=>{let{options:s}=r;return t.compute.code.localeCompare(s.shaders.compute.code)===0&&t.compute.entryPoint===s.shaders.compute.entryPoint})}createComputePipeline(e){let t=this.isSameComputePipeline(e);if(t)return t;{let r=new ge({renderer:this.renderer,...e});return this.pipelineEntries.push(r),r}}setCurrentPipeline(e,t){t.index!==this.currentPipelineIndex&&(e.setPipeline(t.pipeline),this.currentPipelineIndex=t.index)}resetCurrentPipeline(){this.currentPipelineIndex=null}};var Oe=class extends ae{constructor(t,r,s){super(t);this.#e=new c;this.#t=new c;t=t&&t.renderer||t,be(t,"DOM3DObject"),this.renderer=t,this.size={world:{width:0,height:0,top:0,left:0},document:{width:0,height:0,top:0,left:0}},this.watchScroll=s.watchScroll,this.camera=this.renderer.camera,this.setDOMElement(r)}#e;#t;setDOMElement(t){this.domElement=new H({element:t,onSizeChanged:r=>this.resize(r),onPositionChanged:r=>{this.watchScroll&&(this.size.document=r,this.updateSizeAndPosition())}})}resetDOMElement(t){this.domElement&&this.domElement.destroy(),this.setDOMElement(t)}updateSizeAndPosition(){this.setWorldSizes(),this.applyPosition(),super.updateSizeAndPosition()}updateSizePositionAndProjection(){this.updateSizeAndPosition(),super.updateSizePositionAndProjection()}resize(t=null){!t&&(!this.domElement||this.domElement?.isResizing)||(this.size.document=t??this.domElement.element.getBoundingClientRect(),this.updateSizePositionAndProjection())}get boundingRect(){return this.domElement.boundingRect}setTransforms(){super.setTransforms(),this.transforms.origin.model.set(.5,.5,0),this.transforms.origin.world=new c,this.transforms.position.document=new c,this.documentPosition.onChange(()=>this.applyPosition()),this.transformOrigin.onChange(()=>this.setWorldTransformOrigin())}get documentPosition(){return this.transforms.position.document}set documentPosition(t){this.transforms.position.document=t,this.applyPosition()}get DOMObjectWorldScale(){return this.#t.clone()}get worldScale(){return this.DOMObjectWorldScale.multiply(this.scale)}get worldPosition(){return this.#e.clone()}get transformOrigin(){return this.transforms.origin.model}set transformOrigin(t){this.transforms.origin.model=t,this.setWorldTransformOrigin()}get worldTransformOrigin(){return this.transforms.origin.world}set worldTransformOrigin(t){this.transforms.origin.world=t}applyPosition(){this.applyDocumentPosition(),super.applyPosition()}applyDocumentPosition(){let t=new c(0,0,0);this.documentPosition.equals(t)||(t=this.documentToWorldSpace(this.documentPosition)),this.#e.set(this.position.x+this.size.world.left+t.x,this.position.y+this.size.world.top+t.y,this.position.z+this.documentPosition.z/this.camera.CSSPerspective)}applyTransformOrigin(){this.size&&(this.setWorldTransformOrigin(),super.applyTransformOrigin())}updateModelMatrix(){this.modelMatrix.composeFromOrigin(this.#e,this.quaternion,this.scale,this.worldTransformOrigin),this.modelMatrix.scale(this.#t)}documentToWorldSpace(t=new c){return new c(t.x*this.renderer.pixelRatio/this.renderer.boundingRect.width*this.camera.screenRatio.width,-(t.y*this.renderer.pixelRatio/this.renderer.boundingRect.height)*this.camera.screenRatio.height,t.z)}setWorldSizes(){let t=this.renderer.boundingRect,r={x:this.size.document.width/2+this.size.document.left,y:this.size.document.height/2+this.size.document.top},s={x:t.width/2+t.left,y:t.height/2+t.top};this.size.world={width:this.size.document.width/t.width*this.camera.screenRatio.width/2,height:this.size.document.height/t.height*this.camera.screenRatio.height/2,top:(s.y-r.y)/t.height*this.camera.screenRatio.height,left:(r.x-s.x)/t.width*this.camera.screenRatio.width},this.#t.set(this.size.world.width,this.size.world.height,1),this.setWorldTransformOrigin()}setWorldTransformOrigin(){this.transforms.origin.world=new c((this.transformOrigin.x*2-1)*this.size.world.width,-(this.transformOrigin.y*2-1)*this.size.world.height,this.transformOrigin.z),this.shouldUpdateModelMatrix(),this.shouldUpdateProjectionMatrixStack()}updateScrollPosition(t={x:0,y:0}){(t.x||t.y)&&this.domElement.updateScrollPosition(t)}destroy(){this.domElement?.destroy()}};var Bt={autoloadSources:!0,watchScroll:!0},de=class extends Ne(Oe){constructor(t,r,s){super(t,r,{...Bt,...s});this._onLoadingCallback=t=>{};s={...Bt,...s},t=t&&t.renderer||t,be(t,s.label?s.label+" DOMMesh":"DOMMesh"),this.type="DOMMesh";let{autoloadSources:i}=s;this.autoloadSources=i,this.sourcesReady=!1,this.setInitSources()}get ready(){return this._ready}set ready(t){this._ready=t,this.DOMMeshReady&&this._onReadyCallback&&this._onReadyCallback()}get sourcesReady(){return this._sourcesReady}set sourcesReady(t){this._sourcesReady=t,this.DOMMeshReady&&this._onReadyCallback&&this._onReadyCallback()}get DOMMeshReady(){return this.ready&&this.sourcesReady}addToScene(){super.addToScene(),this.renderer.domMeshes.push(this)}removeFromScene(){super.removeFromScene(),this.renderer.domMeshes=this.renderer.domMeshes.filter(t=>t.uuid!==this.uuid)}setInitSources(){let t=0,r=0;if(this.autoloadSources){let s=this.domElement.element.querySelectorAll("img"),i=this.domElement.element.querySelectorAll("video"),n=this.domElement.element.querySelectorAll("canvas");t=s.length+i.length+n.length;let o=a=>{r++,this._onLoadingCallback&&this._onLoadingCallback(a),r===t&&(this.sourcesReady=!0)};t||(this.sourcesReady=!0),s.length&&s.forEach(a=>{let u=this.createTexture({name:a.getAttribute("data-texture-name")??"texture"+this.textures.length});u.onSourceUploaded(()=>o(u)).loadImage(a.src)}),i.length&&i.forEach(a=>{let u=this.createTexture({name:a.getAttribute("data-texture-name")??"texture"+this.textures.length});u.onSourceUploaded(()=>o(u)).loadVideo(a)}),n.length&&n.forEach(a=>{let u=this.createTexture({name:a.getAttribute("data-texture-name")??"texture"+this.textures.length});u.onSourceUploaded(()=>o(u)).loadCanvas(a)})}else this.sourcesReady=!0}resetDOMElement(t){t?super.resetDOMElement(t):!t&&!this.renderer.production&&O(`${this.options.label}: You are trying to reset a ${this.type} with a HTML element that does not exist. The old HTML element will be kept instead.`)}get pixelRatioBoundingRect(){let t=window.devicePixelRatio??1,r=this.renderer.pixelRatio/t;return Object.keys(this.domElement.boundingRect).reduce((s,i)=>({...s,[i]:this.domElement.boundingRect[i]*r}),{x:0,y:0,width:0,height:0,top:0,right:0,bottom:0,left:0})}createRenderTexture(t){return t={...t,size:{width:this.pixelRatioBoundingRect.width,height:this.pixelRatioBoundingRect.height}},super.createRenderTexture(t)}resizeRenderTextures(){this.renderTextures?.filter(t=>t.options.usage==="texture").forEach(t=>t.resize({width:this.pixelRatioBoundingRect.width,height:this.pixelRatioBoundingRect.height}))}onLoading(t){return t&&(this._onLoadingCallback=t),this}};var Vt={label:"Plane",instancesCount:1,vertexBuffers:[]},ze=class extends de{constructor(e,t,r={}){e=e&&e.renderer||e,be(e,r.label?r.label+" Plane":"Plane");let s={...Vt,...r},{geometry:i,widthSegments:n,heightSegments:o,...a}=s,{instancesCount:u,vertexBuffers:d,...l}=a;if(!i||i.type!=="PlaneGeometry"){n=n??1,o=o??1;let m=n*o+n;d.length||(i=ve.getPlaneGeometryByID(m)),i?i.instancesCount=u:(i=new ne({widthSegments:n,heightSegments:o,instancesCount:u,vertexBuffers:d}),ve.addPlaneGeometry(i))}super(e,t,{geometry:i,...l}),this.type="Plane"}mouseToPlaneCoords(e=new W){let t={x:2*(e.x/this.renderer.pixelRatioBoundingRect.width)-1,y:2*(1-e.y/this.renderer.pixelRatioBoundingRect.height)-1},r=this.camera.position.clone(),s=new c(t.x,t.y,-.5);s.unproject(this.camera),s.sub(r).normalize();let i=new c(0,0,1);i.applyQuat(this.quaternion).normalize();let n=new c(0,0,0),o=i.dot(s);if(Math.abs(o)>=1e-4){let a=this.modelMatrix.getInverse().premultiply(this.camera.viewMatrix),u=this.worldTransformOrigin.clone().add(this.worldPosition),d=new c(this.worldPosition.x-u.x,this.worldPosition.y-u.y,this.worldPosition.z-u.z);d.applyQuat(this.quaternion),u.add(d);let l=i.dot(u.clone().sub(r))/o;n.copy(r.add(s.multiplyScalar(l))),n.applyMat4(a)}else n.set(1/0,1/0,1/0);return new W(n.x,n.y)}};var Ae=class{constructor({renderer:e}){e=e&&e.renderer||e,b(e,"Scene"),this.renderer=e,this.computePassEntries=[],this.renderPassEntries={pingPong:[],renderTarget:[],screen:[{renderPass:this.renderer.renderPass,renderTexture:null,onBeforeRenderPass:null,onAfterRenderPass:null,element:null,stack:{unProjected:{opaque:[],transparent:[]},projected:{opaque:[],transparent:[]}}}]}}addComputePass(e){this.computePassEntries.push(e),this.computePassEntries.sort((t,r)=>t.renderOrder!==r.renderOrder?t.renderOrder-r.renderOrder:t.index-r.index)}removeComputePass(e){this.computePassEntries=this.computePassEntries.filter(t=>t.uuid!==e.uuid)}addRenderTarget(e){this.renderPassEntries.renderTarget.find(t=>t.renderPass.uuid===e.renderPass.uuid)||this.renderPassEntries.renderTarget.push({renderPass:e.renderPass,renderTexture:e.renderTexture,onBeforeRenderPass:null,onAfterRenderPass:null,element:null,stack:{unProjected:{opaque:[],transparent:[]},projected:{opaque:[],transparent:[]}}})}removeRenderTarget(e){this.renderPassEntries.renderTarget=this.renderPassEntries.renderTarget.filter(t=>t.renderPass.uuid!==e.renderPass.uuid)}getMeshProjectionStack(e){let t=e.renderTarget?this.renderPassEntries.renderTarget.find(s=>s.renderPass.uuid===e.renderTarget.renderPass.uuid):this.renderPassEntries.screen[0],{stack:r}=t;return e.material.options.rendering.useProjection?r.projected:r.unProjected}addMesh(e){let t=this.getMeshProjectionStack(e),r=e.transparent?[...t.transparent]:[...t.opaque],s=-1;for(let i=r.length-1;i>=0;i--)if(r[i].material.pipelineEntry.index===e.material.pipelineEntry.index){s=i+1;break}s=Math.max(0,s),r.splice(s,0,e),r.sort((i,n)=>i.index-n.index),(e instanceof de||e instanceof ze)&&e.transparent&&r.sort((i,n)=>n.documentPosition.z-i.documentPosition.z),r.sort((i,n)=>i.renderOrder-n.renderOrder),e.transparent?t.transparent=r:t.opaque=r}removeMesh(e){let t=this.getMeshProjectionStack(e);e.transparent?t.transparent=t.transparent.filter(r=>r.uuid!==e.uuid):t.opaque=t.opaque.filter(r=>r.uuid!==e.uuid)}addShaderPass(e){this.renderPassEntries.screen.push({renderPass:this.renderer.renderPass,renderTexture:null,onBeforeRenderPass:(t,r)=>{e.renderTarget||(e.renderTexture&&t.copyTextureToTexture({texture:r},{texture:e.renderTexture.texture},[e.renderTexture.size.width,e.renderTexture.size.height]),this.renderer.renderPass.setLoadOp("clear"))},onAfterRenderPass:null,element:e,stack:null}),this.renderPassEntries.screen.sort((t,r)=>{let s=t.element&&!t.element.renderTarget,i=t.element?t.element.renderOrder:0,n=t.element?t.element.index:0,o=r.element&&!r.element.renderTarget,a=r.element?r.element.renderOrder:0,u=r.element?r.element.index:0;return s&&!o?1:!s&&o?-1:i!==a?i-a:n-u})}removeShaderPass(e){this.renderPassEntries.screen=this.renderPassEntries.screen.filter(t=>!t.element||t.element.uuid!==e.uuid)}addPingPongPlane(e){this.renderPassEntries.pingPong.push({renderPass:e.renderTarget.renderPass,renderTexture:e.renderTarget.renderTexture,onBeforeRenderPass:null,onAfterRenderPass:(t,r)=>{t.copyTextureToTexture({texture:r},{texture:e.renderTexture.texture},[e.renderTexture.size.width,e.renderTexture.size.height])},element:e,stack:null}),this.renderPassEntries.pingPong.sort((t,r)=>t.element.renderOrder-r.element.renderOrder)}removePingPongPlane(e){this.renderPassEntries.pingPong=this.renderPassEntries.pingPong.filter(t=>t.element.uuid!==e.uuid)}renderSinglePassEntry(e,t){let r=this.renderer.setRenderPassCurrentTexture(t.renderPass,t.renderTexture?.texture);t.onBeforeRenderPass&&t.onBeforeRenderPass(e,r);let s=e.beginRenderPass(t.renderPass.descriptor);t.element?t.element.render(s):t.stack&&(t.stack.unProjected.opaque.forEach(i=>i.render(s)),t.stack.unProjected.transparent.forEach(i=>i.render(s)),(t.stack.projected.opaque.length||t.stack.projected.transparent.length)&&(this.renderer.cameraBindGroup&&s.setBindGroup(this.renderer.cameraBindGroup.index,this.renderer.cameraBindGroup.bindGroup),t.stack.projected.opaque.forEach(i=>i.render(s)),t.stack.projected.transparent.forEach(i=>i.render(s)))),s.end(),t.onAfterRenderPass&&t.onAfterRenderPass(e,r),this.renderer.pipelineManager.resetCurrentPipeline()}render(e){this.computePassEntries.forEach(t=>{if(!t.canRender)return;let r=e.beginComputePass();t.render(r),r.end(),t.copyBufferToResult(e),this.renderer.pipelineManager.resetCurrentPipeline()});for(let t in this.renderPassEntries){let r=0;this.renderPassEntries[t].forEach(s=>{!s.element&&!s.stack.unProjected.opaque.length&&!s.stack.unProjected.transparent.length&&!s.stack.projected.opaque.length&&!s.stack.projected.transparent.length||(s.renderPass.setLoadOp(t==="screen"&&r!==0?"load":"clear"),r++,this.renderSinglePassEntry(e,s))})}}onAfterCommandEncoder(){this.computePassEntries.forEach(e=>{e.setWorkGroupsResult()})}};var he=class{constructor(e,{label:t="Render Pass",depth:r=!0,loadOp:s="clear",clearValue:i=[0,0,0,0]}={}){e=e&&e.renderer||e,b(e,"RenderPass"),this.type="RenderPass",this.uuid=V(),this.renderer=e,this.options={label:t,depth:r,loadOp:s,clearValue:i},this.setSize(this.renderer.pixelRatioBoundingRect),this.sampleCount=this.renderer.sampleCount,this.options.depth&&this.createDepthTexture(),this.createRenderTexture(),this.setRenderPassDescriptor()}createDepthTexture(){this.depthTexture=this.renderer.createTexture({label:this.options.label+" depth attachment texture",size:[this.size.width,this.size.height],format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT,sampleCount:this.sampleCount})}createRenderTexture(){this.renderTexture=this.renderer.createTexture({label:this.options.label+" color attachment texture",size:[this.size.width,this.size.height],sampleCount:this.sampleCount,format:this.renderer.preferredFormat,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST|GPUTextureUsage.TEXTURE_BINDING})}resetRenderPassDepth(){this.depthTexture&&this.depthTexture.destroy(),this.createDepthTexture(),this.descriptor.depthStencilAttachment.view=this.depthTexture.createView()}resetRenderPassView(){this.renderTexture&&this.renderTexture.destroy(),this.createRenderTexture(),this.descriptor.colorAttachments[0].view=this.renderTexture.createView()}setRenderPassDescriptor(){this.descriptor={label:this.options.label+" descriptor",colorAttachments:[{view:this.renderTexture.createView(),clearValue:this.options.clearValue,loadOp:this.options.loadOp,storeOp:"store"}],...this.options.depth&&{depthStencilAttachment:{view:this.depthTexture.createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}}}}setSize(e){this.size={width:Math.floor(e.width),height:Math.floor(e.height)}}resize(e){this.setSize(e),this.options.depth&&this.resetRenderPassDepth(),this.resetRenderPassView()}setLoadOp(e="clear"){this.options.loadOp=e,this.descriptor&&this.descriptor.colorAttachments&&(this.descriptor.colorAttachments[0].loadOp=e)}setClearValue(e=[0,0,0,0]){this.options.clearValue=e,this.descriptor&&this.descriptor.colorAttachments&&(this.descriptor.colorAttachments[0].clearValue=e)}destroy(){this.renderTexture?.destroy(),this.depthTexture?.destroy()}};var ye=class{constructor(){this.#e=0;this.queue=[]}#e;add(e=s=>{},{order:t=this.queue.length,once:r=!1}={}){let s={callback:e,order:t,once:r,id:this.#e};return this.#e++,this.queue.push(s),this.queue.sort((i,n)=>i.order-n.order),s.id}remove(e=0){this.queue=this.queue.filter(t=>t.id!==e)}execute(e){this.queue.forEach(t=>{t.callback(e),t.once&&this.remove(t.id)})}};var Ve=class{constructor({container:e,pixelRatio:t=1,sampleCount:r=4,production:s=!1,preferredFormat:i,alphaMode:n="premultiplied",onError:o=()=>{},onContextLost:a=u=>{}}){this._onBeforeRenderCallback=e=>{};this._onAfterRenderCallback=e=>{};this.type="GPURenderer",this.ready=!1,this.gpu=navigator.gpu,this.pixelRatio=t??window.devicePixelRatio??1,this.sampleCount=r,this.production=s,this.alphaMode=n,this.devicesCount=0,this.onError=o,this.onContextLost=a,this.gpu||setTimeout(()=>{this.onError(),S("GPURenderer: WebGPU is not supported on your browser/OS. No 'gpu' object in 'navigator'.")},0),this.preferredFormat=i??this.gpu?.getPreferredCanvasFormat(),this.setTasksQueues(),this.setRendererObjects(),this.canvas=document.createElement("canvas"),this.domElement=new H({element:e}),this.documentBody=new H({element:document.body,onSizeChanged:()=>this.resize()}),this.texturesQueue=[]}setSize(e){let t=window.devicePixelRatio??1,r=this.pixelRatio/t;this.canvas.style.width=Math.floor(e.width)+"px",this.canvas.style.height=Math.floor(e.height)+"px";let s={width:Math.floor(e.width*r),height:Math.floor(e.height*r)};this.canvas.width=this.device?Math.min(s.width,this.device.limits.maxTextureDimension2D):s.width,this.canvas.height=this.device?Math.min(s.height,this.device.limits.maxTextureDimension2D):s.height}resize(e=null){this.domElement&&(e||(e=this.domElement.element.getBoundingClientRect()),this.setSize(e),this.onResize())}onResize(){this.renderPass?.resize(this.pixelRatioBoundingRect),this.renderTargets.forEach(e=>e.resize(this.pixelRatioBoundingRect)),this.pingPongPlanes.forEach(e=>e.resize(this.boundingRect)),this.shaderPasses.forEach(e=>e.resize(this.boundingRect)),this.computePasses.forEach(e=>e.resize()),this.meshes.forEach(e=>{"domElement"in e||e.resize(this.boundingRect)})}get boundingRect(){return this.domElement.boundingRect}get pixelRatioBoundingRect(){let e=window.devicePixelRatio??1,t=this.pixelRatio/e;return Object.keys(this.domElement.boundingRect).reduce((r,s)=>({...r,[s]:this.domElement.boundingRect[s]*t}),{x:0,y:0,width:0,height:0,top:0,right:0,bottom:0,left:0})}async setContext(){this.context=this.canvas.getContext("webgpu"),await this.setAdapter(),await this.setDevice(),this.device&&(this.setMainRenderPass(),this.setPipelineManager(),this.setScene(),this.domElement.element.appendChild(this.canvas),this.ready=!0)}async setAdapter(){this.adapter=await this.gpu?.requestAdapter().catch(()=>{setTimeout(()=>{this.onError(),S("GPURenderer: WebGPU is not supported on your browser/OS. 'requestAdapter' failed.")},0)}),this.adapter?.requestAdapterInfo().then(e=>{this.adapterInfos=e})}async setDevice(){try{this.device=await this.adapter?.requestDevice({label:"GPUCurtains device "+this.devicesCount}),this.devicesCount++,this.context.configure({device:this.device,format:this.preferredFormat,alphaMode:this.alphaMode,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST})}catch(e){setTimeout(()=>{this.onError(),S(`GPURenderer: WebGPU is not supported on your browser/OS. 'requestDevice' failed: ${e}`)},0)}this.device?.lost.then(e=>{O(`GPURenderer: WebGPU device was lost: ${e.message}`),this.loseContext(),e.reason!=="destroyed"&&this.onContextLost(e)})}loseContext(){this.ready=!1,this.samplers.forEach(e=>e.sampler=null),this.sceneObjects.forEach(e=>e.loseContext()),this.buffers=[]}async restoreContext(){await this.setAdapter(),await this.setDevice(),this.samplers.forEach(e=>{e.sampler=this.device?.createSampler({label:e.label,...e.options})}),this.sceneObjects.forEach(e=>e.restoreContext()),this.onResize(),this.ready=!0}setMainRenderPass(){this.renderPass=new he(this,{label:"Main Render pass",depth:!0})}setPipelineManager(){this.pipelineManager=new Se({renderer:this})}setScene(){this.scene=new Ae({renderer:this})}createBuffer(e){let t=this.device?.createBuffer(e);return this.buffers.push(t),t}removeBuffer(e){this.buffers=this.buffers.filter(t=>t.label!==e.label&&t.usage!==e.usage&&t.size!==e.size)}queueWriteBuffer(e,t,r){this.device?.queue.writeBuffer(e,t,r)}createBindGroupLayout(e){return this.device?.createBindGroupLayout(e)}createBindGroup(e){return this.device?.createBindGroup(e)}createShaderModule(e){return this.device?.createShaderModule(e)}createPipelineLayout(e){return this.device?.createPipelineLayout(e)}createRenderPipeline(e){return this.device?.createRenderPipeline(e)}async createRenderPipelineAsync(e){return await this.device?.createRenderPipelineAsync(e)}createComputePipeline(e){return this.device?.createComputePipeline(e)}async createComputePipelineAsync(e){return await this.device?.createComputePipelineAsync(e)}addTexture(e){this.textures.push(e),this.setTexture(e)}removeTexture(e){this.textures=this.textures.filter(t=>t.uuid!==e.uuid)}setTexture(e){e.texture||e.createTexture()}createTexture(e){return this.device?.createTexture(e)}uploadTexture(e){if(e.source)try{this.device?.queue.copyExternalImageToTexture({source:e.source,flipY:e.options.flipY},{texture:e.texture},{width:e.size.width,height:e.size.height}),e.texture.mipLevelCount>1&&ht(this.device,e.texture),this.texturesQueue.push(e)}catch({message:t}){S(`GPURenderer: could not upload texture: ${e.options.name} because: ${t}`)}else this.device?.queue.writeTexture({texture:e.texture},new Uint8Array(e.options.placeholderColor),{bytesPerRow:e.size.width*4},{width:e.size.width,height:e.size.height})}importExternalTexture(e){return this.device?.importExternalTexture({source:e})}createSampler(e){let t=this.samplers.find(r=>JSON.stringify(r.options)===JSON.stringify(e.options)&&r.sampler);if(t)return t.sampler;{let r=this.device?.createSampler({label:e.label,...e.options});return this.samplers.push(e),r}}setTasksQueues(){this.onBeforeCommandEncoderCreation=new ye,this.onBeforeRenderScene=new ye,this.onAfterRenderScene=new ye,this.onAfterCommandEncoderSubmission=new ye}setRendererObjects(){this.buffers=[],this.computePasses=[],this.pingPongPlanes=[],this.shaderPasses=[],this.renderTargets=[],this.meshes=[],this.samplers=[],this.textures=[]}get sceneObjects(){return[...this.computePasses,...this.meshes,...this.shaderPasses,...this.pingPongPlanes]}getObjectsByBindGroup(e){return this.sceneObjects.filter(t=>[...t.material.bindGroups,...t.material.inputsBindGroups,...t.material.clonedBindGroups].filter(r=>r.uuid===e.uuid))}getObjectsByTexture(e){return this.sceneObjects.filter(t=>[...t.material.textures,...t.material.renderTextures].filter(r=>r.uuid===e.uuid))}onBeforeRender(e){return e&&(this._onBeforeRenderCallback=e),this}onAfterRender(e){return e&&(this._onAfterRenderCallback=e),this}setRenderPassCurrentTexture(e,t=null){return t||(t=this.context.getCurrentTexture()),this.sampleCount>1?e.descriptor.colorAttachments[0].resolveTarget=t.createView():e.descriptor.colorAttachments[0].view=t.createView(),t}onBeforeCommandEncoder(){}onAfterCommandEncoder(){this.scene.onAfterCommandEncoder()}renderSingleComputePass(e,t){if(!t.canRender)return;let r=e.beginComputePass();t.render(r),r.end(),t.copyBufferToResult(e)}renderSingleMesh(e,t){let r=e.beginRenderPass(this.renderPass.descriptor);t.render(r),r.end()}renderOnce(e){let t=this.device?.createCommandEncoder({label:"Renderer once command encoder"});this.pipelineManager.resetCurrentPipeline(),e.forEach(s=>{s instanceof Ee?this.renderSingleComputePass(t,s):this.renderSingleMesh(t,s)});let r=t.finish();this.device?.queue.submit([r]),this.pipelineManager.resetCurrentPipeline()}renderScene(){let e=this.device?.createCommandEncoder({label:"Renderer scene command encoder"});this._onBeforeRenderCallback&&this._onBeforeRenderCallback(e),this.onBeforeRenderScene.execute(e),this.scene.render(e),this._onAfterRenderCallback&&this._onAfterRenderCallback(e),this.onAfterRenderScene.execute(e);let t=e.finish();this.device?.queue.submit([t])}render(){this.ready&&(this.onBeforeCommandEncoder(),this.onBeforeCommandEncoderCreation.execute(),this.renderScene(),this.textures.filter(e=>!e.parent&&e.sourceLoaded&&!e.sourceUploaded).forEach(e=>this.uploadTexture(e)),this.texturesQueue.forEach(e=>{e.sourceUploaded=!0}),this.texturesQueue=[],this.onAfterCommandEncoder(),this.onAfterCommandEncoderSubmission.execute())}destroy(){this.domElement?.destroy(),this.documentBody?.destroy(),this.textures=[],this.texturesQueue=[],this.renderPass?.destroy(),this.renderTargets.forEach(e=>e.destroy()),this.sceneObjects.forEach(e=>e.remove()),this.device?.destroy(),this.context?.unconfigure()}};var De=class extends Ve{constructor({container:t,pixelRatio:r=1,sampleCount:s=4,preferredFormat:i,production:n=!1,alphaMode:o="premultiplied",camera:a={},onError:u=()=>{},onContextLost:d=l=>{}}){super({container:t,pixelRatio:r,sampleCount:s,preferredFormat:i,alphaMode:o,production:n,onError:u,onContextLost:d});this.type="GPUCameraRenderer",a={fov:50,near:.01,far:50,...a},this.setCamera(a)}loseContext(){super.loseContext(),this.cameraBindGroup.loseContext()}async restoreContext(){return this.cameraBufferBinding.shouldUpdate=!0,super.restoreContext()}setCamera(t){let r=this.boundingRect?this.boundingRect.width:1,s=this.boundingRect?this.boundingRect.height:1;this.camera=new Te({fov:t.fov,near:t.near,far:t.far,width:r,height:s,pixelRatio:this.pixelRatio,onMatricesChanged:()=>{this.onCameraMatricesChanged()}}),this.setCameraBufferBinding()}onCameraMatricesChanged(){this.updateCameraBindings(),this.meshes.forEach(t=>{"modelViewMatrix"in t&&t.updateSizePositionAndProjection()})}setCameraBufferBinding(){this.cameraBufferBinding=new j({label:"Camera",name:"camera",visibility:"vertex",bindings:{model:{name:"model",type:"mat4x4f",value:this.camera.modelMatrix,onBeforeUpdate:()=>{this.cameraBufferBinding.bindings.model.value=this.camera.modelMatrix}},view:{name:"view",type:"mat4x4f",value:this.camera.viewMatrix,onBeforeUpdate:()=>{this.cameraBufferBinding.bindings.view.value=this.camera.viewMatrix}},projection:{name:"projection",type:"mat4x4f",value:this.camera.projectionMatrix,onBeforeUpdate:()=>{this.cameraBufferBinding.bindings.projection.value=this.camera.projectionMatrix}}}}),this.cameraBindGroup=new X(this,{label:"Camera Uniform bind group",bindings:[this.cameraBufferBinding]})}setCameraBindGroup(){this.cameraBindGroup.shouldCreateBindGroup&&(this.cameraBindGroup.setIndex(0),this.cameraBindGroup.createBindGroup())}updateCameraBindings(){this.cameraBufferBinding?.shouldUpdateBinding("model"),this.cameraBufferBinding?.shouldUpdateBinding("view"),this.cameraBufferBinding?.shouldUpdateBinding("projection")}setPerspective(t,r,s){this.camera?.setPerspective(t,r,s,this.boundingRect.width,this.boundingRect.height,this.pixelRatio)}setCameraPosition(t=new c(0,0,1)){this.camera.position.copy(t)}onResize(){super.onResize(),this.setPerspective(),this.updateCameraBindings()}updateCamera(){this.camera?.updateMatrixStack(),this.setCameraBindGroup(),this.cameraBindGroup?.update()}renderSingleMesh(t,r){let s=t.beginRenderPass(this.renderPass.descriptor);r.material.options.rendering.useProjection&&s.setBindGroup(this.cameraBindGroup.index,this.cameraBindGroup.bindGroup),r.render(s),s.end()}render(){this.ready&&(this.updateCamera(),super.render())}destroy(){this.cameraBindGroup?.destroy(),super.destroy()}};var Fe=class{constructor(e,t){this.#e=!0;e=e&&e.renderer||e,b(e,"RenderTarget"),this.type="RenderTarget",this.renderer=e,this.uuid=V();let{label:r,depth:s,loadOp:i,clearValue:n,autoRender:o}=t;this.options={label:r,depth:s,loadOp:i,clearValue:n,autoRender:o},o!==void 0&&(this.#e=o),this.renderPass=new he(this.renderer,{label:this.options.label?`${this.options.label} Render Pass`:"Render Target Render Pass",depth:this.options.depth,loadOp:this.options.loadOp,clearValue:this.options.clearValue}),this.renderTexture=new _(this.renderer,{label:this.options.label?`${this.options.label} Render Texture`:"Render Target Render Texture",name:"renderTexture"}),this.addToScene()}#e;addToScene(){this.renderer.renderTargets.push(this),this.#e&&this.renderer.scene.addRenderTarget(this)}removeFromScene(){this.#e&&this.renderer.scene.removeRenderTarget(this),this.renderer.renderTargets=this.renderer.renderTargets.filter(e=>e.uuid!==this.uuid)}resize(e){this.renderPass?.resize(e),this.renderTexture?.resize()}remove(){this.destroy()}destroy(){this.renderer.meshes.forEach(e=>{e.renderTarget&&e.renderTarget.uuid===this.uuid&&e.setRenderTarget(null)}),this.renderer.shaderPasses.forEach(e=>{e.renderTarget&&e.renderTarget.uuid===this.uuid&&(e.renderTarget=null,e.setRenderTarget(null))}),this.removeFromScene(),this.renderPass?.destroy(),this.renderTexture?.destroy()}};var Qe=class extends oe{constructor(t,r){t=t&&t.renderer||t,b(t,r.label?r.label+" ShaderPass":"ShaderPass"),r.transparent=!0,r.label=r.label??"ShaderPass "+t.shaderPasses?.length;super(t,r);this.type="ShaderPass",this.createRenderTexture({label:r.label?`${r.label} render texture`:"Shader pass render texture",name:"renderTexture",fromTexture:this.renderTarget?this.renderTarget.renderTexture:null})}get renderTexture(){return this.renderTextures[0]??null}setRenderTarget(t){super.setRenderTarget(t),t?this.renderTexture.copy(this.renderTarget.renderTexture):(this.renderTexture.options.fromTexture=null,this.renderTexture.createTexture())}addToScene(){this.renderer.shaderPasses.push(this),this.autoRender&&this.renderer.scene.addShaderPass(this)}removeFromScene(){this.renderTarget&&this.renderTarget.destroy(),this.autoRender&&this.renderer.scene.removeShaderPass(this),this.renderer.shaderPasses=this.renderer.shaderPasses.filter(t=>t.uuid!==this.uuid)}};var Ye=class extends oe{constructor(t,r={}){t=t&&t.renderer||t,b(t,r.label?r.label+" PingPongPlane":"PingPongPlane"),r.renderTarget=new Fe(t,{label:r.label?r.label+" render target":"Ping Pong render target"}),r.transparent=!1,r.label=r.label??"PingPongPlane "+t.pingPongPlanes?.length;super(t,r);this.type="PingPongPlane",this.createRenderTexture({label:r.label?`${r.label} render texture`:"PingPongPlane render texture",name:"renderTexture"})}get renderTexture(){return this.renderTextures[0]??null}addToScene(){this.renderer.pingPongPlanes.push(this),this.autoRender&&this.renderer.scene.addPingPongPlane(this)}removeFromScene(){this.renderTarget&&this.renderTarget.destroy(),this.autoRender&&this.renderer.scene.removePingPongPlane(this),this.renderer.pingPongPlanes=this.renderer.pingPongPlanes.filter(t=>t.uuid!==this.uuid)}};var Le=class extends De{constructor({container:t,pixelRatio:r=1,sampleCount:s=4,preferredFormat:i,alphaMode:n="premultiplied",production:o=!1,onError:a=()=>{},onContextLost:u=l=>{},camera:d}){super({container:t,pixelRatio:r,sampleCount:s,preferredFormat:i,alphaMode:n,production:o,onError:a,onContextLost:u,camera:d});this.type="GPUCurtainsRenderer"}setRendererObjects(){super.setRendererObjects(),this.domMeshes=[]}onResize(){super.onResize(),this.domMeshes?.forEach(t=>{t.domElement&&t.domElement.setSize()})}};var Xe=class{constructor({scroll:e={x:0,y:0},delta:t={x:0,y:0},shouldWatch:r=!0,onScroll:s=(i={x:0,y:0})=>{}}={}){this.scroll=e,this.delta=t,this.shouldWatch=r,this.onScroll=s,this.handler=this.scrollHandler.bind(this,!0),this.shouldWatch&&window.addEventListener("scroll",this.handler,{passive:!0})}scrollHandler(){this.updateScrollValues({x:window.pageXOffset,y:window.pageYOffset})}updateScrollValues({x:e,y:t}){let r=this.scroll;this.scroll={x:e,y:t},this.delta={x:r.x-this.scroll.x,y:r.y-this.scroll.y},this.onScroll&&this.onScroll(this.delta)}destroy(){this.shouldWatch&&window.removeEventListener("scroll",this.handler,{passive:!0})}};var Ze=class{constructor({container:e,pixelRatio:t=window.devicePixelRatio??1,sampleCount:r=4,preferredFormat:s,alphaMode:i="premultiplied",production:n=!1,camera:o,autoRender:a=!0,autoResize:u=!0,watchScroll:d=!0}){this._onRenderCallback=()=>{};this._onScrollCallback=()=>{};this._onAfterResizeCallback=()=>{};this._onErrorCallback=()=>{};this._onContextLostCallback=()=>{};this.type="CurtainsGPU",this.options={container:e,pixelRatio:t,sampleCount:r,camera:o,production:n,preferredFormat:s,alphaMode:i,autoRender:a,autoResize:u,watchScroll:d},e&&this.setContainer(e)}setContainer(e){if(e)if(typeof e=="string")if(e=document.getElementById(e),e)this.options.container=e;else{let t=document.createElement("div");t.setAttribute("id","curtains-gpu-canvas"),document.body.appendChild(t),this.options.container=t}else e instanceof Element&&(this.options.container=e);else{let t=document.createElement("div");t.setAttribute("id","curtains-gpu-canvas"),document.body.appendChild(t),this.options.container=t}this.container=this.options.container,this.setCurtains()}setRenderer(){this.renderer=new Le({container:this.options.container,pixelRatio:this.options.pixelRatio,sampleCount:this.options.sampleCount,preferredFormat:this.options.preferredFormat,alphaMode:this.options.alphaMode,camera:this.options.camera,production:this.options.production,onError:()=>this._onErrorCallback&&this._onErrorCallback(),onContextLost:e=>this._onContextLostCallback&&this._onContextLostCallback(e)})}restoreContext(){this.renderer?.restoreContext()}async setRendererContext(){await this.renderer.setContext()}setCurtains(){this.initEvents(),this.setRenderer(),this.options.autoRender&&this.animate()}get pingPongPlanes(){return this.renderer?.pingPongPlanes}get shaderPasses(){return this.renderer?.shaderPasses}get meshes(){return this.renderer?.meshes}get domMeshes(){return this.renderer?.domMeshes}get planes(){return this.renderer?.domMeshes.filter(e=>e.type==="Plane")}get computePasses(){return this.renderer?.computePasses}get camera(){return this.renderer?.camera}setPerspective(e=50,t=.01,r=50){this.renderer?.setPerspective(e,t,r)}setCameraPosition(e=new c(0,0,1)){this.renderer?.setCameraPosition(e)}resize(){this.renderer?.resize(),this._onAfterResizeCallback&&this._onAfterResizeCallback()}get boundingRect(){return this.renderer?.boundingRect}initScroll(){this.scrollManager=new Xe({scroll:{x:window.pageXOffset,y:window.pageYOffset},delta:{x:0,y:0},shouldWatch:this.options.watchScroll,onScroll:e=>this.updateScroll(e)})}updateScroll(e={x:0,y:0}){this.renderer.domMeshes.forEach(t=>{t.domElement&&t.updateScrollPosition(e)}),this._onScrollCallback&&this._onScrollCallback()}updateScrollValues(e={x:0,y:0}){this.scrollManager.updateScrollValues(e)}get scrollDelta(){return this.scrollManager.delta}get scrollValues(){return this.scrollManager.scroll}initEvents(){Ie.useObserver(this.options.autoResize),this.initScroll()}onRender(e){return e&&(this._onRenderCallback=e),this}onScroll(e){return e&&(this._onScrollCallback=e),this}onAfterResize(e){return e&&(this._onAfterResizeCallback=e),this}onError(e){return e&&(this._onErrorCallback=e),this}onContextLost(e){return e&&(this._onContextLostCallback=e),this}animate(){this.render(),this.animationFrameID=window.requestAnimationFrame(this.animate.bind(this))}render(){this._onRenderCallback&&this._onRenderCallback(),this.renderer?.render()}destroy(){this.animationFrameID&&window.cancelAnimationFrame(this.animationFrameID),this.renderer?.destroy(),this.scrollManager?.destroy(),Ie.destroy()}};var Je=class extends K{constructor({widthSegments:e=1,heightSegments:t=1,depthSegments:r=1,instancesCount:s=1,vertexBuffers:i=[],topology:n}={}){super({verticesOrder:"ccw",topology:n,instancesCount:s,vertexBuffers:i}),this.type="BoxGeometry",e=Math.floor(e),t=Math.floor(t),r=Math.floor(r);let o=[],a=[],u=[],d=[],l=0,m=(p,f,g,P,x,T,C,B,M,R)=>{let y=T/M,w=C/R,G=T/2,z=C/2,N=B/2,F=M+1,ee=R+1,Q=0,U=new c;for(let v=0;v<ee;v++){let A=v*w-z;for(let D=0;D<F;D++){let $=D*y-G;U[p]=$*P,U[f]=A*x,U[g]=N,o.push(U.x,U.y,U.z),U[p]=0,U[f]=0,U[g]=B>0?1:-1,u.push(U.x,U.y,U.z),a.push(D/M),a.push(v/R),Q+=1}}for(let v=0;v<R;v++)for(let A=0;A<M;A++){let D=l+A+F*v,$=l+A+F*(v+1),te=l+(A+1)+F*(v+1),le=l+(A+1)+F*v;d.push(D,$,le),d.push($,te,le),l+=Q}};m("z","y","x",-1,-1,2,2,2,r,t),m("z","y","x",1,-1,2,2,-2,r,t),m("x","z","y",1,1,2,2,2,e,r),m("x","z","y",1,-1,2,2,-2,e,r),m("x","y","z",1,-1,2,2,2,e,t),m("x","y","z",-1,-1,2,2,-2,e,t),this.setIndexBuffer({array:new Uint32Array(d)}),this.setAttribute({name:"position",type:"vec3f",bufferFormat:"float32x3",size:3,array:new Float32Array(o)}),this.setAttribute({name:"uv",type:"vec2f",bufferFormat:"float32x2",size:2,array:new Float32Array(a)}),this.setAttribute({name:"normal",type:"vec3f",bufferFormat:"float32x3",size:3,array:new Float32Array(u)})}};var Ke=class extends K{constructor({widthSegments:e=32,heightSegments:t=16,phiStart:r=0,phiLength:s=Math.PI*2,thetaStart:i=0,thetaLength:n=Math.PI,instancesCount:o=1,vertexBuffers:a=[],topology:u}={}){super({verticesOrder:"ccw",topology:u,instancesCount:o,vertexBuffers:a}),this.type="SphereGeometry",e=Math.max(3,Math.floor(e)),t=Math.max(2,Math.floor(t));let d=1,l=Math.min(i+n,Math.PI),m=0,p=[],f=new c,g=new c,P=[],x=[],T=[],C=[];for(let B=0;B<=t;B++){let M=[],R=B/t,y=0;B===0&&i===0?y=.5/e:B===t&&l===Math.PI&&(y=-.5/e);for(let w=0;w<=e;w++){let G=w/e;f.x=-d*Math.cos(r+G*s)*Math.sin(i+R*n),f.y=d*Math.cos(i+R*n),f.z=d*Math.sin(r+G*s)*Math.sin(i+R*n),x.push(f.x,f.y,f.z),g.copy(f).normalize(),T.push(g.x,g.y,g.z),C.push(G+y,R),M.push(m++)}p.push(M)}for(let B=0;B<t;B++)for(let M=0;M<e;M++){let R=p[B][M+1],y=p[B][M],w=p[B+1][M],G=p[B+1][M+1];(B!==0||i>0)&&P.push(R,y,G),(B!==t-1||l<Math.PI)&&P.push(y,w,G)}this.setIndexBuffer({array:new Uint32Array(P)}),this.setAttribute({name:"position",type:"vec3f",bufferFormat:"float32x3",size:3,array:new Float32Array(x)}),this.setAttribute({name:"uv",type:"vec2f",bufferFormat:"float32x2",size:2,array:new Float32Array(C)}),this.setAttribute({name:"normal",type:"vec3f",bufferFormat:"float32x3",size:3,array:new Float32Array(T)})}};return Et(Dt);})();
