var GPUCurtains=(()=>{var Xe=Object.defineProperty;var xt=Object.getOwnPropertyDescriptor;var gt=Object.getOwnPropertyNames;var yt=Object.prototype.hasOwnProperty;var Pt=(d,e)=>{for(var t in e)Xe(d,t,{get:e[t],enumerable:!0})},bt=(d,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of gt(e))!yt.call(d,s)&&s!==t&&Xe(d,s,{get:()=>e[s],enumerable:!(r=xt(e,s))||r.enumerable});return d};var Bt=d=>bt(Xe({},"__esModule",{value:!0}),d);var Et={};Pt(Et,{BindGroup:()=>X,Binding:()=>Y,Box3:()=>re,BoxGeometry:()=>Qe,BufferBinding:()=>_,Camera:()=>ge,ComputeMaterial:()=>Pe,ComputePass:()=>_e,ComputePipelineEntry:()=>Te,DOMElement:()=>q,DOMFrustum:()=>be,DOMMesh:()=>ue,DOMObject3D:()=>Ce,FullscreenPlane:()=>ne,GPUCameraRenderer:()=>ve,GPUCurtains:()=>qe,GPUCurtainsRenderer:()=>Oe,GPURenderer:()=>Ue,Geometry:()=>se,IndexedGeometry:()=>J,Mat4:()=>z,Material:()=>te,Mesh:()=>We,Object3D:()=>ee,PingPongPlane:()=>He,PipelineEntry:()=>ae,PipelineManager:()=>Ge,Plane:()=>we,PlaneGeometry:()=>ie,ProjectedObject3D:()=>oe,Quat:()=>H,RenderMaterial:()=>Be,RenderPass:()=>de,RenderPipelineEntry:()=>Me,RenderTarget:()=>Se,RenderTexture:()=>j,Sampler:()=>ye,SamplerBinding:()=>xe,Scene:()=>Ee,ShaderPass:()=>$e,SphereGeometry:()=>Ye,Texture:()=>I,TextureBindGroup:()=>me,TextureBinding:()=>Z,Vec2:()=>$,Vec3:()=>p,WritableBufferBinding:()=>le});var k=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,d=>{let e=Math.random()*16|0;return(d==="x"?e:e&3|8).toString(16).toUpperCase()}),ze=d=>d.replace(/(?:^\w|[A-Z]|\b\w)/g,(e,t)=>t===0?e.toLowerCase():e.toUpperCase()).replace(/\s+/g,""),he=d=>{let e=ze(d);return e.charAt(0).toUpperCase()+e.slice(1)},Ze=0,L=d=>{Ze>100||(console.warn(Ze===100?"GPUCurtains: too many warnings thrown, stop logging.":d),Ze++)};var V=d=>{throw new Error(d)};var Je=(d,e="GPURenderer",t)=>{let r=t?`Unable to create ${t} because the ${e} is not defined: ${d}`:`The ${e} is not defined: ${d}`;V(r)},g=(d,e)=>{let t=d&&(d.type==="GPURenderer"||d.type==="GPUCameraRenderer"||d.type==="GPUCurtainsRenderer");return t||Je(d,"GPURenderer",e),t},ce=(d,e)=>{let t=d&&(d.type==="GPUCameraRenderer"||d.type==="GPUCurtainsRenderer");return t||Je(d,"GPUCameraRenderer",e),t},fe=(d,e)=>{let t=d&&d.type==="GPUCurtainsRenderer";return t||Je(d,"GPUCurtainsRenderer",e),t},rt=(()=>{let d,e,t={};return function(s,i){e||(e=s.createShaderModule({label:"textured quad shaders for mip level generation",code:`
            struct VSOutput {
              @builtin(position) position: vec4f,
              @location(0) texcoord: vec2f,
            };

            @vertex fn vs(
              @builtin(vertex_index) vertexIndex : u32
            ) -> VSOutput {
              var pos = array<vec2f, 6>(

                vec2f( 0.0,  0.0),  // center
                vec2f( 1.0,  0.0),  // right, center
                vec2f( 0.0,  1.0),  // center, top

                // 2st triangle
                vec2f( 0.0,  1.0),  // center, top
                vec2f( 1.0,  0.0),  // right, center
                vec2f( 1.0,  1.0),  // right, top
              );

              var vsOutput: VSOutput;
              let xy = pos[vertexIndex];
              vsOutput.position = vec4f(xy * 2.0 - 1.0, 0.0, 1.0);
              vsOutput.texcoord = vec2f(xy.x, 1.0 - xy.y);
              return vsOutput;
            }

            @group(0) @binding(0) var ourSampler: sampler;
            @group(0) @binding(1) var ourTexture: texture_2d<f32>;

            @fragment fn fs(fsInput: VSOutput) -> @location(0) vec4f {
              return textureSample(ourTexture, ourSampler, fsInput.texcoord);
            }
          `}),d=s.createSampler({minFilter:"linear"})),t[i.format]||(t[i.format]=s.createRenderPipeline({label:"mip level generator pipeline",layout:"auto",vertex:{module:e,entryPoint:"vs"},fragment:{module:e,entryPoint:"fs",targets:[{format:i.format}]}}));let n=t[i.format],o=s.createCommandEncoder({label:"mip gen encoder"}),u=i.width,a=i.height,h=0;for(;u>1||a>1;){u=Math.max(1,u/2|0),a=Math.max(1,a/2|0);let l=s.createBindGroup({layout:n.getBindGroupLayout(0),entries:[{binding:0,resource:d},{binding:1,resource:i.createView({baseMipLevel:h,mipLevelCount:1})}]});++h;let c={label:"our basic canvas renderPass",colorAttachments:[{view:i.createView({baseMipLevel:h,mipLevelCount:1}),loadOp:"clear",storeOp:"store"}]},x=o.beginRenderPass(c);x.setPipeline(n),x.setBindGroup(0,l),x.draw(6),x.end()}let m=o.finish();s.queue.submit([m])}})();var Y=class{constructor({label:e="Uniform",name:t="uniform",bindingType:r="uniform",bindIndex:s=0,visibility:i}){this.label=e,this.name=ze(t),this.bindingType=r,this.bindIndex=s,this.visibility=i?(()=>{switch(i){case"vertex":return GPUShaderStage.VERTEX;case"fragment":return GPUShaderStage.FRAGMENT;case"compute":return GPUShaderStage.COMPUTE;default:return GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE}})():GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,this.options={label:e,name:t,bindingType:r,bindIndex:s,visibility:i}}};var st=d=>({i32:{numElements:1,align:4,size:4,type:"i32",View:Int32Array},u32:{numElements:1,align:4,size:4,type:"u32",View:Uint32Array},f32:{numElements:1,align:4,size:4,type:"f32",View:Float32Array},f16:{numElements:1,align:2,size:2,type:"u16",View:Uint16Array},vec2f:{numElements:2,align:8,size:8,type:"f32",View:Float32Array},vec2i:{numElements:2,align:8,size:8,type:"i32",View:Int32Array},vec2u:{numElements:2,align:8,size:8,type:"u32",View:Uint32Array},vec2h:{numElements:2,align:4,size:4,type:"u16",View:Uint16Array},vec3i:{numElements:3,align:16,size:12,type:"i32",View:Int32Array},vec3u:{numElements:3,align:16,size:12,type:"u32",View:Uint32Array},vec3f:{numElements:3,align:16,size:12,type:"f32",View:Float32Array},vec3h:{numElements:3,align:8,size:6,type:"u16",View:Uint16Array},vec4i:{numElements:4,align:16,size:16,type:"i32",View:Int32Array},vec4u:{numElements:4,align:16,size:16,type:"u32",View:Uint32Array},vec4f:{numElements:4,align:16,size:16,type:"f32",View:Float32Array},vec4h:{numElements:4,align:8,size:8,type:"u16",View:Uint16Array},mat2x2f:{numElements:4,align:8,size:16,type:"f32",View:Float32Array},mat2x2h:{numElements:4,align:4,size:8,type:"u16",View:Uint16Array},mat3x2f:{numElements:6,align:8,size:24,type:"f32",View:Float32Array},mat3x2h:{numElements:6,align:4,size:12,type:"u16",View:Uint16Array},mat4x2f:{numElements:8,align:8,size:32,type:"f32",View:Float32Array},mat4x2h:{numElements:8,align:4,size:16,type:"u16",View:Uint16Array},mat2x3f:{numElements:8,align:16,size:32,pad:[3,1],type:"f32",View:Float32Array},mat2x3h:{numElements:8,align:8,size:16,pad:[3,1],type:"u16",View:Uint16Array},mat3x3f:{numElements:12,align:16,size:48,pad:[3,1],type:"f32",View:Float32Array},mat3x3h:{numElements:12,align:8,size:24,pad:[3,1],type:"u16",View:Uint16Array},mat4x3f:{numElements:16,align:16,size:64,pad:[3,1],type:"f32",View:Float32Array},mat4x3h:{numElements:16,align:8,size:32,pad:[3,1],type:"u16",View:Uint16Array},mat2x4f:{numElements:8,align:16,size:32,type:"f32",View:Float32Array},mat2x4h:{numElements:8,align:8,size:16,type:"u16",View:Uint16Array},mat3x4f:{numElements:12,align:16,size:48,pad:[3,1],type:"f32",View:Float32Array},mat3x4h:{numElements:12,align:8,size:24,pad:[3,1],type:"u16",View:Uint16Array},mat4x4f:{numElements:16,align:16,size:64,type:"f32",View:Float32Array},mat4x4h:{numElements:16,align:8,size:32,type:"u16",View:Uint16Array}})[d],ke=d=>(()=>{switch(d.type){case"array<vec4f>":return 4;case"array<vec3f>":return 3;case"array<vec2f>":return 2;case"array<f32>":default:return 1}})(),Le=d=>(()=>{switch(d.bindingType){case"storage":return`var<${d.bindingType}, ${d.options.access}>`;case"uniform":default:return"var<uniform>"}})(),it=d=>(()=>{switch(d.bindingType){case"storageTexture":return`var ${d.name}: texture_storage_2d<${d.options.format}, ${d.options.access}>;`;case"externalTexture":return`var ${d.name}: texture_external;`;case"texture":default:return`var ${d.name}: texture_2d<f32>;`}})(),nt=d=>d.bindingType==="storage"&&d.options.access==="read_write"?"storage":d.bindingType==="storage"?"read-only-storage":"uniform",ot=d=>(()=>{switch(d.bindingType){case"externalTexture":return{externalTexture:{}};case"storageTexture":return{storageTexture:{format:d.options.format,viewDimension:"2d"}};case"texture":return{texture:{viewDimension:"2d"}};default:return null}})();var $=class d{constructor(e=0,t=e){this.type="Vec2",this._x=e,this._y=t}get x(){return this._x}set x(e){let t=e!==this._x;this._x=e,t&&this._onChangeCallback&&this._onChangeCallback()}get y(){return this._y}set y(e){let t=e!==this._y;this._y=e,t&&this._onChangeCallback&&this._onChangeCallback()}onChange(e){return e&&(this._onChangeCallback=e),this}set(e=0,t=e){return this.x=e,this.y=t,this}add(e=new d){return this.x+=e.x,this.y+=e.y,this}addScalar(e=0){return this.x+=e,this.y+=e,this}sub(e=new d){return this.x-=e.x,this.y-=e.y,this}subScalar(e=0){return this.x-=e,this.y-=e,this}multiply(e=new d(1)){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e=1){return this.x*=e,this.y*=e,this}copy(e=new d){return this.x=e.x,this.y=e.y,this}clone(){return new d(this.x,this.y)}max(e=new d){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}min(e=new d){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}equals(e=new d){return this.x===e.x&&this.y===e.y}normalize(){let e=this.x*this.x+this.y*this.y;return e>0&&(e=1/Math.sqrt(e)),this.x*=e,this.y*=e,this}dot(e=new d){return this.x*e.x+this.y*e.y}lerp(e=new d,t=1){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}};var H=class d{constructor(e=new Float32Array([0,0,0,1]),t="XYZ"){this.type="Quat",this.elements=e,this.axisOrder=t}setFromArray(e=new Float32Array([0,0,0,1])){return this.elements[0]=e[0],this.elements[1]=e[1],this.elements[2]=e[2],this.elements[3]=e[3],this}setAxisOrder(e="XYZ"){switch(e=e.toUpperCase(),e){case"XYZ":case"YXZ":case"ZXY":case"ZYX":case"YZX":case"XZY":this.axisOrder=e;break;default:this.axisOrder="XYZ"}return this}copy(e=new d){return this.elements=e.elements,this.axisOrder=e.axisOrder,this}clone(){return new d().copy(this)}equals(e=new d){return this.elements[0]===e.elements[0]&&this.elements[1]===e.elements[1]&&this.elements[2]===e.elements[2]&&this.elements[3]===e.elements[3]&&this.axisOrder===e.axisOrder}setFromVec3(e=new p){let t=e.x*.5,r=e.y*.5,s=e.z*.5,i=Math.cos(t),n=Math.cos(r),o=Math.cos(s),u=Math.sin(t),a=Math.sin(r),h=Math.sin(s);return this.axisOrder==="XYZ"?(this.elements[0]=u*n*o+i*a*h,this.elements[1]=i*a*o-u*n*h,this.elements[2]=i*n*h+u*a*o,this.elements[3]=i*n*o-u*a*h):this.axisOrder==="YXZ"?(this.elements[0]=u*n*o+i*a*h,this.elements[1]=i*a*o-u*n*h,this.elements[2]=i*n*h-u*a*o,this.elements[3]=i*n*o+u*a*h):this.axisOrder==="ZXY"?(this.elements[0]=u*n*o-i*a*h,this.elements[1]=i*a*o+u*n*h,this.elements[2]=i*n*h+u*a*o,this.elements[3]=i*n*o-u*a*h):this.axisOrder==="ZYX"?(this.elements[0]=u*n*o-i*a*h,this.elements[1]=i*a*o+u*n*h,this.elements[2]=i*n*h-u*a*o,this.elements[3]=i*n*o+u*a*h):this.axisOrder==="YZX"?(this.elements[0]=u*n*o+i*a*h,this.elements[1]=i*a*o+u*n*h,this.elements[2]=i*n*h-u*a*o,this.elements[3]=i*n*o-u*a*h):this.axisOrder==="XZY"&&(this.elements[0]=u*n*o-i*a*h,this.elements[1]=i*a*o-u*n*h,this.elements[2]=i*n*h+u*a*o,this.elements[3]=i*n*o+u*a*h),this}};var z=class d{constructor(e=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])){this.type="Mat4",this.elements=e}set(e,t,r,s,i,n,o,u,a,h,m,l,c,x,P,R){let f=this.elements;return f[0]=e,f[1]=t,f[2]=r,f[3]=s,f[4]=i,f[5]=n,f[6]=o,f[7]=u,f[8]=a,f[9]=h,f[10]=m,f[11]=l,f[12]=c,f[13]=x,f[14]=P,f[15]=R,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}setFromArray(e=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])){for(let t=0;t<this.elements.length;t++)this.elements[t]=e[t];return this}copy(e=new d){let t=e.elements;return this.elements[0]=t[0],this.elements[1]=t[1],this.elements[2]=t[2],this.elements[3]=t[3],this.elements[4]=t[4],this.elements[5]=t[5],this.elements[6]=t[6],this.elements[7]=t[7],this.elements[8]=t[8],this.elements[9]=t[9],this.elements[10]=t[10],this.elements[11]=t[11],this.elements[12]=t[12],this.elements[13]=t[13],this.elements[14]=t[14],this.elements[15]=t[15],this}clone(){return new d().copy(this)}multiply(e=new d){return this.multiplyMatrices(this,e)}premultiply(e=new d){return this.multiplyMatrices(e,this)}multiplyMatrices(e=new d,t=new d){let r=e.elements,s=t.elements,i=this.elements,n=r[0],o=r[4],u=r[8],a=r[12],h=r[1],m=r[5],l=r[9],c=r[13],x=r[2],P=r[6],R=r[10],f=r[14],C=r[3],y=r[7],B=r[11],M=r[15],G=s[0],T=s[4],w=s[8],v=s[12],S=s[1],O=s[5],D=s[9],A=s[13],E=s[2],U=s[6],b=s[10],F=s[14],W=s[3],K=s[7],Q=s[11],Fe=s[15];return i[0]=n*G+o*S+u*E+a*W,i[4]=n*T+o*O+u*U+a*K,i[8]=n*w+o*D+u*b+a*Q,i[12]=n*v+o*A+u*F+a*Fe,i[1]=h*G+m*S+l*E+c*W,i[5]=h*T+m*O+l*U+c*K,i[9]=h*w+m*D+l*b+c*Q,i[13]=h*v+m*A+l*F+c*Fe,i[2]=x*G+P*S+R*E+f*W,i[6]=x*T+P*O+R*U+f*K,i[10]=x*w+P*D+R*b+f*Q,i[14]=x*v+P*A+R*F+f*Fe,i[3]=C*G+y*S+B*E+M*W,i[7]=C*T+y*O+B*U+M*K,i[11]=C*w+y*D+B*b+M*Q,i[15]=C*v+y*A+B*F+M*Fe,this}premultiplyTranslate(e=new p){let n=e.x,o=e.y,u=e.z,a=this.elements,h=this.elements,m=a[0],l=a[4],c=a[8],x=a[12],P=a[1],R=a[5],f=a[9],C=a[13],y=a[2],B=a[6],M=a[10],G=a[14],T=a[3],w=a[7],v=a[11],S=a[15];return h[0]=1*m+n*T,h[4]=1*l+n*w,h[8]=1*c+n*v,h[12]=1*x+n*S,h[1]=1*P+o*T,h[5]=1*R+o*w,h[9]=1*f+o*v,h[13]=1*C+o*S,h[2]=1*y+u*T,h[6]=1*B+u*w,h[10]=1*M+u*v,h[14]=1*G+u*S,h[3]=1*T,h[7]=1*w,h[11]=1*v,h[15]=1*S,this}premultiplyScale(e=new p){let t=this.elements,r=this.elements,s=e.x,i=e.y,n=e.z,o=1,u=t[0],a=t[4],h=t[8],m=t[12],l=t[1],c=t[5],x=t[9],P=t[13],R=t[2],f=t[6],C=t[10],y=t[14],B=t[3],M=t[7],G=t[11],T=t[15];return r[0]=s*u,r[4]=s*a,r[8]=s*h,r[12]=s*m,r[1]=i*l,r[5]=i*c,r[9]=i*x,r[13]=i*P,r[2]=n*R,r[6]=n*f,r[10]=n*C,r[14]=n*y,r[3]=o*B,r[7]=o*M,r[11]=o*G,r[15]=o*T,this}getInverse(){let e=this.elements,t=new d,r=t.elements,s=e[0],i=e[1],n=e[2],o=e[3],u=e[4],a=e[5],h=e[6],m=e[7],l=e[8],c=e[9],x=e[10],P=e[11],R=e[12],f=e[13],C=e[14],y=e[15],B=s*a-i*u,M=s*h-n*u,G=s*m-o*u,T=i*h-n*a,w=i*m-o*a,v=n*m-o*h,S=l*f-c*R,O=l*C-x*R,D=l*y-P*R,A=c*C-x*f,E=c*y-P*f,U=x*y-P*C,b=B*U-M*E+G*A+T*D-w*O+v*S;return b?(b=1/b,r[0]=(a*U-h*E+m*A)*b,r[1]=(n*E-i*U-o*A)*b,r[2]=(f*v-C*w+y*T)*b,r[3]=(x*w-c*v-P*T)*b,r[4]=(h*D-u*U-m*O)*b,r[5]=(s*U-n*D+o*O)*b,r[6]=(C*G-R*v-y*M)*b,r[7]=(l*v-x*G+P*M)*b,r[8]=(u*E-a*D+m*S)*b,r[9]=(i*D-s*E-o*S)*b,r[10]=(R*w-f*G+y*B)*b,r[11]=(c*G-l*w-P*B)*b,r[12]=(a*O-u*A-h*S)*b,r[13]=(s*A-i*O+n*S)*b,r[14]=(f*M-R*T-C*B)*b,r[15]=(l*T-c*M+x*B)*b,t):null}translate(e=new p){let t=this.elements;return t[12]=t[0]*e.x+t[4]*e.y+t[8]*e.z+t[12],t[13]=t[1]*e.x+t[5]*e.y+t[9]*e.z+t[13],t[14]=t[2]*e.x+t[6]*e.y+t[10]*e.z+t[14],t[15]=t[3]*e.x+t[7]*e.y+t[11]*e.z+t[15],this}scale(e=new p){let t=this.elements;return t[0]*=e.x,t[1]*=e.x,t[2]*=e.x,t[3]*=e.x,t[4]*=e.y,t[5]*=e.y,t[6]*=e.y,t[7]*=e.y,t[8]*=e.z,t[9]*=e.z,t[10]*=e.z,t[11]*=e.z,this}rotateFromQuaternion(e=new H){let t=this.elements,r=e.elements[0],s=e.elements[1],i=e.elements[2],n=e.elements[3],o=r+r,u=s+s,a=i+i,h=r*o,m=r*u,l=r*a,c=s*u,x=s*a,P=i*a,R=n*o,f=n*u,C=n*a;return t[0]=1-(c+P),t[4]=m-C,t[8]=l+f,t[1]=m+C,t[5]=1-(h+P),t[9]=x-R,t[2]=l-f,t[6]=x+R,t[10]=1-(h+c),this}compose(e=new p,t=new H,r=new p(1)){let s=this.elements,i=t.elements[0],n=t.elements[1],o=t.elements[2],u=t.elements[3],a=i+i,h=n+n,m=o+o,l=i*a,c=i*h,x=i*m,P=n*h,R=n*m,f=o*m,C=u*a,y=u*h,B=u*m,M=r.x,G=r.y,T=r.z;return s[0]=(1-(P+f))*M,s[1]=(c+B)*M,s[2]=(x-y)*M,s[3]=0,s[4]=(c-B)*G,s[5]=(1-(l+f))*G,s[6]=(R+C)*G,s[7]=0,s[8]=(x+y)*T,s[9]=(R-C)*T,s[10]=(1-(l+P))*T,s[11]=0,s[12]=e.x,s[13]=e.y,s[14]=e.z,s[15]=1,this}composeFromOrigin(e=new p,t=new H,r=new p(1),s=new p){let i=this.elements,n=t.elements[0],o=t.elements[1],u=t.elements[2],a=t.elements[3],h=n+n,m=o+o,l=u+u,c=n*h,x=n*m,P=n*l,R=o*m,f=o*l,C=u*l,y=a*h,B=a*m,M=a*l,G=r.x,T=r.y,w=r.z,v=s.x,S=s.y,O=s.z,D=(1-(R+C))*G,A=(x+M)*G,E=(P-B)*G,U=(x-M)*T,b=(1-(c+C))*T,F=(f+y)*T,W=(P+B)*w,K=(f-y)*w,Q=(1-(c+R))*w;return i[0]=D,i[1]=A,i[2]=E,i[3]=0,i[4]=U,i[5]=b,i[6]=F,i[7]=0,i[8]=W,i[9]=K,i[10]=Q,i[11]=0,i[12]=e.x+v-(D*v+U*S+W*O),i[13]=e.y+S-(A*v+b*S+K*O),i[14]=e.z+O-(E*v+F*S+Q*O),i[15]=1,this}};var p=class d{constructor(e=0,t=e,r=e){this.type="Vec3",this._x=e,this._y=t,this._z=r}get x(){return this._x}set x(e){let t=e!==this._x;this._x=e,t&&this._onChangeCallback&&this._onChangeCallback()}get y(){return this._y}set y(e){let t=e!==this._y;this._y=e,t&&this._onChangeCallback&&this._onChangeCallback()}get z(){return this._z}set z(e){let t=e!==this._z;this._z=e,t&&this._onChangeCallback&&this._onChangeCallback()}onChange(e){return e&&(this._onChangeCallback=e),this}set(e=0,t=0,r=0){return this.x=e,this.y=t,this.z=r,this}add(e=new d){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e=0){return this.x+=e,this.y+=e,this.z+=e,this}sub(e=new d){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e=0){return this.x-=e,this.y-=e,this.z-=e,this}multiply(e=new d(1)){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e=1){return this.x*=e,this.y*=e,this.z*=e,this}copy(e=new d){return this.x=e.x,this.y=e.y,this.z=e.z,this}clone(){return new d(this.x,this.y,this.z)}max(e=new d){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}min(e=new d){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}equals(e=new d){return this.x===e.x&&this.y===e.y&&this.z===e.z}normalize(){let e=this.x*this.x+this.y*this.y+this.z*this.z;return e>0&&(e=1/Math.sqrt(e)),this.x*=e,this.y*=e,this.z*=e,this}dot(e=new d){return this.x*e.x+this.y*e.y+this.z*e.z}lerp(e=new d,t=1){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}applyMat4(e=new z){let t=this._x,r=this._y,s=this._z,i=e.elements,n=i[3]*t+i[7]*r+i[11]*s+i[15];return n=n||1,this.x=(i[0]*t+i[4]*r+i[8]*s+i[12])/n,this.y=(i[1]*t+i[5]*r+i[9]*s+i[13])/n,this.z=(i[2]*t+i[6]*r+i[10]*s+i[14])/n,this}applyQuat(e=new H){let t=this.x,r=this.y,s=this.z,i=e.elements[0],n=e.elements[1],o=e.elements[2],u=e.elements[3],a=u*t+n*s-o*r,h=u*r+o*t-i*s,m=u*s+i*r-n*t,l=-i*t-n*r-o*s;return this.x=a*u+l*-i+h*-o-m*-n,this.y=h*u+l*-n+m*-i-a*-o,this.z=m*u+l*-o+a*-n-h*-i,this}project(e){return this.applyMat4(e.viewMatrix).applyMat4(e.projectionMatrix),this}unproject(e){return this.applyMat4(e.projectionMatrix.getInverse()).applyMat4(e.modelMatrix),this}};var _=class extends Y{constructor({label:t="Uniform",name:r="uniform",bindingType:s,bindIndex:i=0,visibility:n,useStruct:o=!0,access:u="read",bindings:a={}}){s=s??"uniform";super({label:t,name:r,bindIndex:i,bindingType:s,visibility:n});this.options={...this.options,useStruct:o,access:u,bindings:a},this.arrayBufferSize=0,this.shouldUpdate=!1,this.useStruct=o,this.bindingElements=[],this.bindings={},this.buffer=null,this.setBindings(a),this.setBufferAttributes(),this.setWGSLFragment()}get resourceLayout(){return{buffer:{type:nt(this)}}}get resource(){return{buffer:this.buffer}}setBindings(t){Object.keys(t).forEach(r=>{let s={};for(let i in t[r])i!=="value"&&(s[i]=t[r][i]);Object.defineProperty(s,"value",{get(){return s._value},set(i){s._value=i,s.shouldUpdate=!0}}),s.value=t[r].value,(s.value instanceof $||s.value instanceof p)&&s.value.onChange(()=>s.shouldUpdate=!0),this.bindings[r]=s})}setBufferAttributes(){Object.keys(this.bindings).forEach(t=>{let r=this.bindings[t],s=r.type&&r.type.indexOf("array")!==-1&&r.value instanceof Float32Array?{numElements:r.value.length,align:16,size:r.value.byteLength,type:"f32",View:Float32Array}:st(r.type);this.bindingElements.push({name:ze(r.name??t),type:r.type??"array<f32>",key:t,bufferLayout:s,startOffset:0,endOffset:0})}),this.alignmentRows=0,this.bindingElements.forEach((t,r)=>{let{numElements:s,align:i,View:n}=t.bufferLayout,o=n.BYTES_PER_ELEMENT;if(r===0)t.startOffset=0,this.alignmentRows+=Math.max(1,Math.ceil(s/o));else{let u=this.bindingElements[r-1].startOffset+this.bindingElements[r-1].bufferLayout.numElements;i<=o*2?(s===2&&u%2===1&&(u=u+1),u+s<=this.alignmentRows*o?t.startOffset=u:(t.startOffset=this.alignmentRows*o,this.alignmentRows++)):u%i!==0||(u+s)%o!==0?(t.startOffset=this.alignmentRows*o,this.alignmentRows+=Math.ceil(s/o)):(t.startOffset=u,this.alignmentRows+=Math.ceil(s/o))}t.endOffset=t.startOffset+t.bufferLayout.numElements}),this.arrayBufferSize=this.alignmentRows*4*4,this.arrayBuffer=new ArrayBuffer(this.arrayBufferSize),this.arrayView=new DataView(this.arrayBuffer,0,this.arrayBuffer.byteLength),this.bindingElements.forEach(t=>{t.array=new t.bufferLayout.View(this.arrayBuffer,t.startOffset*t.bufferLayout.View.BYTES_PER_ELEMENT,t.endOffset-t.startOffset),t.update=r=>{if(t.type==="f32"||t.type==="u32"||t.type==="i32")t.array[0]=r;else if(t.type==="vec2f")t.array[0]=r.x??r[0]??0,t.array[1]=r.y??r[1]??0;else if(t.type==="vec3f")t.array[0]=r.x??r[0]??0,t.array[1]=r.y??r[1]??0,t.array[2]=r.z??r[2]??0;else if(r.elements)t.array=r.elements;else if(r instanceof t.bufferLayout.View)t.array=r;else if(Array.isArray(r))for(let s=0;s<t.array.length;s++)t.array[s]=r[s]?r[s]:0}}),this.shouldUpdate=this.arrayBufferSize>0}setWGSLFragment(){if(this.useStruct)if(Object.keys(this.bindings).find(r=>this.bindings[r].type.indexOf("array")===-1)){this.wgslStructFragment=`struct ${he(this.label)} {
	${this.bindingElements.map(s=>s.name+": "+s.type).join(`,
	`)}
};`;let r=Le(this);this.wgslGroupFragment=[`${r} ${this.name}: ${he(this.label)};`]}else{let r=he(this.label);this.wgslStructFragment=`struct ${r} {
	${this.bindingElements.map(i=>i.name+": "+i.type.replace("array","").replace("<","").replace(">","")).join(`,
	`)}
};`;let s=Le(this);this.wgslGroupFragment=[`${s} ${this.name}: array<${r}>;`]}else this.wgslStructFragment="",this.wgslGroupFragment=this.bindingElements.map(t=>`${Le(this)} ${t.name}: ${t.type};`)}shouldUpdateBinding(t=""){let r=Object.keys(this.bindings).find(s=>this.bindings[s].name===t);r&&(this.bindings[r].shouldUpdate=!0)}update(){Object.keys(this.bindings).forEach((t,r)=>{let s=this.bindings[t],i=this.bindingElements.find(n=>n.key===t);if(s.shouldUpdate&&i){s.onBeforeUpdate&&s.onBeforeUpdate(),i.update(s.value);let n=Object.keys(this.bindings).find(a=>this.bindings[a].type.indexOf("array")===-1),o=(a=>{switch(i.bufferLayout.View){case Int32Array:return a.setInt32.bind(a);case Uint16Array:return a.setUint16.bind(a);case Uint32Array:return a.setUint32.bind(a);case Float32Array:default:return a.setFloat32.bind(a)}})(this.arrayView),u=Float32Array.BYTES_PER_ELEMENT;if(n)i.array.forEach((a,h)=>{o(i.startOffset*u+h*u,a,!0)});else{let a=ke(i),h=0,m=0;this.bindingElements.forEach((l,c)=>{h+=ke(l),c<r&&(m+=ke(l))});for(let l=0,c=0;c<i.array.length;l++,c+=a){let x=i.array.subarray(c,c+a),P=l*h*u+m*u;x.forEach((R,f)=>{o(P+f*u,R,!0)})}}this.shouldUpdate=!0,s.shouldUpdate=!1}})}};var le=class extends _{constructor({label:t="Work",name:r="work",bindingType:s,bindIndex:i=0,useStruct:n=!0,bindings:o={},visibility:u,access:a="read_write",shouldCopyResult:h=!1}){s="storage",u="compute";super({label:t,name:r,bindIndex:i,bindingType:s,useStruct:n,bindings:o,visibility:u,access:a});this.options={...this.options,shouldCopyResult:h},this.shouldCopyResult=h,this.result=new Float32Array(this.arrayBuffer.slice(0)),this.resultBuffer=null}};var X=class{constructor(e,{label:t="BindGroup",index:r=0,bindings:s=[],inputs:i}={}){this.type="BindGroup",e=e&&e.renderer||e,g(e,this.type),this.renderer=e,this.options={label:t,index:r,bindings:s,...i&&{inputs:i}},this.index=r,this.uuid=k(),this.bindings=[],s.length&&this.addBindings(s),this.options.inputs&&this.setInputBindings(),this.resetEntries(),this.bindGroupLayout=null,this.bindGroup=null,this.needsReset=!1,this.needsPipelineFlush=!1}setIndex(e){this.index=e}addBindings(e=[]){this.bindings=[...this.bindings,...e]}addBinding(e){this.bindings.push(e)}createInputBindings(e="uniform",t={}){return[...Object.keys(t).map(r=>{let s=t[r],i={label:he(s.label||r),name:r,bindingType:e,useStruct:!0,visibility:s.access==="read_write"?"compute":s.visibility,access:s.access??"read",bindings:s.bindings},n=i.access==="read_write"?le:_;return s.useStruct!==!1?new n(i):Object.keys(s.bindings).map(o=>(i.label=he(s.label?s.label+o:r+o),i.name=r+o,i.useStruct=!1,i.bindings={[o]:s.bindings[o]},new n(i)))})].flat()}setInputBindings(){this.addBindings([...this.createInputBindings("uniform",this.options.inputs.uniforms),...this.createInputBindings("storage",this.options.inputs.storages)])}get shouldCreateBindGroup(){return!this.bindGroup&&!!this.bindings.length}resetEntries(){this.entries={bindGroupLayout:[],bindGroup:[]}}createBindGroup(){this.fillEntries(),this.setBindGroupLayout(),this.setBindGroup()}resetBindGroup(){this.resetEntries(),this.createBindGroup()}get bufferBindings(){return this.bindings.filter(e=>e instanceof _||e instanceof le)}createBindingBuffer(e){e.buffer=this.renderer.createBuffer({label:this.options.label+": "+e.bindingType+" buffer from: "+e.label,size:e.arrayBuffer.byteLength,usage:e.bindingType==="uniform"?GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC|GPUBufferUsage.VERTEX:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC|GPUBufferUsage.VERTEX}),"resultBuffer"in e&&(e.resultBuffer=this.renderer.createBuffer({label:this.options.label+": Result buffer from: "+e.label,size:e.arrayBuffer.byteLength,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}))}fillEntries(){this.bindings.forEach(e=>{e.visibility||(e.visibility=GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE),"buffer"in e&&!e.buffer&&this.createBindingBuffer(e),this.entries.bindGroupLayout.push({binding:this.entries.bindGroupLayout.length,...e.resourceLayout,visibility:e.visibility}),this.entries.bindGroup.push({binding:this.entries.bindGroup.length,resource:e.resource})})}getBindingByName(e=""){return this.bindings.find(t=>t.name===e)}setBindGroupLayout(){this.bindGroupLayout=this.renderer.createBindGroupLayout({label:this.options.label+" layout",entries:this.entries.bindGroupLayout})}setBindGroup(){this.bindGroup=this.renderer.createBindGroup({label:this.options.label,layout:this.bindGroupLayout,entries:this.entries.bindGroup})}updateBufferBindings(){this.bufferBindings.forEach((e,t)=>{e.update(),e.shouldUpdate&&(!e.useStruct&&e.bindingElements.length>1?this.renderer.queueWriteBuffer(e.buffer,0,e.bindingElements[t].array):this.renderer.queueWriteBuffer(e.buffer,0,e.arrayBuffer)),e.shouldUpdate=!1})}update(){this.updateBufferBindings(),this.needsReset&&(this.resetBindGroup(),this.needsReset=!1)}clone({bindings:e=[],keepLayout:t=!1}={}){let r={...this.options};r.label+=" (copy)";let s=new this.constructor(this.renderer,{label:r.label});return s.setIndex(this.index),s.options=r,(e.length?e:this.bindings).forEach((n,o)=>{s.addBinding(n),"buffer"in n&&!n.buffer&&s.createBindingBuffer(n),t||s.entries.bindGroupLayout.push({binding:s.entries.bindGroupLayout.length,...n.resourceLayout,visibility:n.visibility}),s.entries.bindGroup.push({binding:s.entries.bindGroup.length,resource:n.resource})}),t&&(s.entries.bindGroupLayout=[...this.entries.bindGroupLayout]),s.setBindGroupLayout(),s.setBindGroup(),s}destroy(){this.bufferBindings.forEach(e=>{"buffer"in e&&e.buffer?.destroy(),"resultBuffer"in e&&e.resultBuffer?.destroy()}),this.bindings=[],this.bindGroupLayout=null,this.bindGroup=null,this.resetEntries()}};var Z=class extends Y{constructor({label:t="Texture",name:r="texture",bindingType:s,bindIndex:i=0,visibility:n,texture:o,format:u="rgba8unorm",access:a="write"}){s=s??"texture",s==="storageTexture"&&(n="compute");super({label:t,name:r,bindingType:s,bindIndex:i,visibility:n});this.options={...this.options,texture:o,format:u,access:a},this.resource=o,this.setWGSLFragment()}get resourceLayout(){return ot(this)}get resource(){return this.texture instanceof GPUExternalTexture?this.texture:this.texture instanceof GPUTexture?this.texture.createView():null}set resource(t){this.texture=t}setBindingType(t){t!==this.bindingType&&(this.bindingType=t,this.setWGSLFragment())}setWGSLFragment(){this.wgslGroupFragment=[`${it(this)}`]}};var ee=class{constructor(){this.setMatrices(),this.setTransforms()}setTransforms(){this.transforms={origin:{model:new p},quaternion:new H,rotation:new p,position:{world:new p},scale:new p(1)},this.rotation.onChange(()=>this.applyRotation()),this.position.onChange(()=>this.applyPosition()),this.scale.onChange(()=>this.applyScale()),this.transformOrigin.onChange(()=>this.applyTransformOrigin())}get rotation(){return this.transforms.rotation}set rotation(e){this.transforms.rotation=e,this.applyRotation()}get quaternion(){return this.transforms.quaternion}set quaternion(e){this.transforms.quaternion=e}get position(){return this.transforms.position.world}set position(e){this.transforms.position.world=e}get scale(){return this.transforms.scale}set scale(e){this.transforms.scale=e,this.applyScale()}get transformOrigin(){return this.transforms.origin.model}set transformOrigin(e){this.transforms.origin.model=e}applyRotation(){this.quaternion.setFromVec3(this.rotation),this.shouldUpdateModelMatrix()}applyPosition(){this.shouldUpdateModelMatrix()}applyScale(){this.shouldUpdateModelMatrix()}applyTransformOrigin(){this.shouldUpdateModelMatrix()}setMatrices(){this.matrices={model:{matrix:new z,shouldUpdate:!1,onUpdate:()=>this.updateModelMatrix()}}}get modelMatrix(){return this.matrices.model.matrix}set modelMatrix(e){this.matrices.model.matrix=e,this.matrices.model.shouldUpdate=!0}shouldUpdateModelMatrix(){this.matrices.model.shouldUpdate=!0}updateModelMatrix(){this.modelMatrix=this.modelMatrix.composeFromOrigin(this.position,this.quaternion,this.scale,this.transformOrigin)}onAfterMatrixStackUpdate(){}updateSizeAndPosition(){this.shouldUpdateModelMatrix()}updateMatrixStack(){let e=!!Object.keys(this.matrices).find(t=>this.matrices[t].shouldUpdate);for(let t in this.matrices)this.matrices[t].shouldUpdate&&(this.matrices[t].onUpdate(),this.matrices[t].shouldUpdate=!1);e&&this.onAfterMatrixStackUpdate()}};var at={name:"texture",generateMips:!1,flipY:!1,format:"rgba8unorm",placeholderColor:[0,0,0,255],useExternalTextures:!0,fromTexture:null},I=class extends ee{constructor(t,r=at){super();this.#e=new p(1);this.#t=new p(1);this.#r=new p(1);this.#s=new z;this._onSourceLoadedCallback=()=>{};this._onSourceUploadedCallback=()=>{};this.type="Texture",t=t&&t.renderer||t,g(t,r.label?r.label+" "+this.type:this.type),this.renderer=t,this.uuid=k();let s={...at,source:r.fromTexture?r.fromTexture.options.source:null,sourceType:r.fromTexture?r.fromTexture.options.sourceType:null};this.options={...s,...r},this.options.label=this.options.label??this.options.name,this.texture=null,this.externalTexture=null,this.source=null,this.size={width:1,height:1},this.textureMatrix=new _({label:this.options.label+": model matrix",name:this.options.name+"Matrix",useStruct:!1,bindings:{matrix:{name:this.options.name+"Matrix",type:"mat4x4f",value:this.modelMatrix}}}),this.setBindings(),this._parent=null,this.sourceLoaded=!1,this.sourceUploaded=!1,this.shouldUpdate=!1,this.shouldUpdateBindGroup=!1,this.renderer.addTexture(this)}#e;#t;#r;#s;setBindings(){this.bindings=[new Z({label:this.options.label+": texture",name:this.options.name,texture:this.options.sourceType==="externalVideo"?this.externalTexture:this.texture,bindingType:this.options.sourceType==="externalVideo"?"externalTexture":"texture"}),this.textureMatrix]}get textureBinding(){return this.bindings[0]}get parent(){return this._parent}set parent(t){this._parent=t,this.resize()}get sourceLoaded(){return this._sourceLoaded}set sourceLoaded(t){t&&!this.sourceLoaded&&this._onSourceLoadedCallback&&this._onSourceLoadedCallback(),this._sourceLoaded=t}get sourceUploaded(){return this._sourceUploaded}set sourceUploaded(t){t&&!this.sourceUploaded&&this._onSourceUploadedCallback&&this._onSourceUploadedCallback(),this._sourceUploaded=t}setTransforms(){super.setTransforms(),this.transforms.quaternion.setAxisOrder("ZXY"),this.transforms.origin.model.set(.5,.5,0)}updateModelMatrix(){if(!this.parent)return;let t=this.parent.scale?this.parent.scale:new p(1,1,1),r=this.parent.boundingRect?this.parent.boundingRect.width*t.x:this.size.width,s=this.parent.boundingRect?this.parent.boundingRect.height*t.y:this.size.height,i=r/s,n=this.size.width,o=this.size.height,u=n/o;r>s?(this.#e.set(i,1,1),this.#t.set(1/u,1,1)):(this.#e.set(1,1/i,1),this.#t.set(1,u,1));let a=i>u!=r>s?1:r>s?this.#e.x*this.#t.x:this.#t.y*this.#e.y;this.#r.set(1/(a*this.scale.x),1/(a*this.scale.y),1),this.#s.rotateFromQuaternion(this.quaternion),this.modelMatrix.identity().premultiplyTranslate(this.transformOrigin.clone().multiplyScalar(-1)).premultiplyScale(this.#r).premultiplyScale(this.#e).premultiply(this.#s).premultiplyScale(this.#t).premultiplyTranslate(this.transformOrigin).translate(this.position)}onAfterMatrixStackUpdate(){this.textureMatrix.shouldUpdateBinding(this.options.name+"Matrix")}resize(){this.source&&this.source instanceof HTMLCanvasElement&&(this.source.width!==this.size.width||this.source.height!==this.size.height)&&(this.setSourceSize(),this.createTexture()),this.shouldUpdateModelMatrix()}getNumMipLevels(...t){let r=Math.max(...t);return 1+Math.log2(r)|0}uploadTexture(){this.renderer.uploadTexture(this),this.shouldUpdate=!1}uploadVideoTexture(){this.externalTexture=this.renderer.importExternalTexture(this.source),this.textureBinding.resource=this.externalTexture,this.textureBinding.setBindingType("externalTexture"),this.shouldUpdateBindGroup=!0,this.shouldUpdate=!1,this.sourceUploaded=!0}copy(t){if(this.options.sourceType==="externalVideo"&&t.options.sourceType!=="externalVideo"){L(`${this.options.label}: cannot copy a GPUTexture to a GPUExternalTexture`);return}else if(this.options.sourceType!=="externalVideo"&&t.options.sourceType==="externalVideo"){L(`${this.options.label}: cannot copy a GPUExternalTexture to a GPUTexture`);return}this.options.fromTexture=t,this.options.sourceType=t.options.sourceType,this.options.generateMips=t.options.generateMips,this.options.flipY=t.options.flipY,this.options.format=t.options.format,this.options.placeholderColor=t.options.placeholderColor,this.options.useExternalTextures=t.options.useExternalTextures,this.sourceLoaded=t.sourceLoaded,this.sourceUploaded=t.sourceUploaded,t.texture&&(t.sourceLoaded&&(this.size=t.size,this.source=t.source,this.resize()),t.sourceUploaded?(this.texture=t.texture,this.textureBinding.resource=this.texture,this.shouldUpdateBindGroup=!0):this.createTexture())}createTexture(){let t={label:this.options.label,format:this.options.format,size:[this.size.width,this.size.height],usage:this.source?GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST};this.options.sourceType!=="externalVideo"&&(t.mipLevelCount=this.options.generateMips?this.getNumMipLevels(this.size.width,this.size.height):1,this.texture?.destroy(),this.texture=this.renderer.createTexture(t),this.textureBinding.resource=this.texture,this.shouldUpdateBindGroup=!!this.source),this.shouldUpdate=!0}setSourceSize(){this.size={width:this.source.naturalWidth||this.source.width||this.source.videoWidth,height:this.source.naturalHeight||this.source.height||this.source.videoHeight}}async loadImageBitmap(t){let s=await(await fetch(t)).blob();return await createImageBitmap(s,{colorSpaceConversion:"none"})}async loadImage(t){let r=typeof t=="string"?t:t.getAttribute("src");this.options.source=r,this.options.sourceType="image",this.sourceLoaded=!1,this.sourceUploaded=!1,this.source=await this.loadImageBitmap(this.options.source),this.setSourceSize(),this.resize(),this.sourceLoaded=!0,this.createTexture()}onVideoFrameCallback(){this.videoFrameCallbackId&&(this.shouldUpdate=!0,this.source.requestVideoFrameCallback(this.onVideoFrameCallback.bind(this)))}onVideoLoaded(t){this.sourceLoaded||(this.source=t,this.setSourceSize(),this.resize(),this.options.useExternalTextures?(this.options.sourceType="externalVideo",this.texture?.destroy()):(this.options.sourceType="video",this.createTexture()),"requestVideoFrameCallback"in HTMLVideoElement.prototype&&(this.videoFrameCallbackId=this.source.requestVideoFrameCallback(this.onVideoFrameCallback.bind(this))),this.sourceLoaded=!0)}get isVideoSource(){return this.source&&(this.options.sourceType==="video"||this.options.sourceType==="externalVideo")}loadVideo(t){let r;typeof t=="string"?(r=document.createElement("video"),r.src=t):r=t,r.preload="auto",r.muted=!0,r.loop=!0,r.crossOrigin="anonymous",r.setAttribute("playsinline",""),this.options.source=r.src,this.sourceLoaded=!1,this.sourceUploaded=!1,r.readyState>=r.HAVE_ENOUGH_DATA?this.onVideoLoaded(r):r.addEventListener("canplaythrough",this.onVideoLoaded.bind(this,r),{once:!0}),isNaN(r.duration)&&r.load()}loadCanvas(t){this.options.source=t,this.options.sourceType="canvas",this.sourceLoaded=!1,this.sourceUploaded=!1,this.source=t,this.setSourceSize(),this.resize(),this.sourceLoaded=!0,this.createTexture()}onSourceLoaded(t){return t&&(this._onSourceLoadedCallback=t),this}onSourceUploaded(t){return t&&(this._onSourceUploadedCallback=t),this}render(){this.updateMatrixStack(),this.textureMatrix.update(),this.options.sourceType==="externalVideo"&&(this.shouldUpdate=!0),this.isVideoSource&&!this.videoFrameCallbackId&&this.source.readyState>=this.source.HAVE_CURRENT_DATA&&!this.source.paused&&(this.shouldUpdate=!0),this.shouldUpdate&&this.options.sourceType&&this.options.sourceType!=="externalVideo"&&this.uploadTexture()}destroy(){this.videoFrameCallbackId&&this.source.cancelVideoFrameCallback(this.videoFrameCallbackId),this.isVideoSource&&this.source.removeEventListener("canplaythrough",this.onVideoLoaded.bind(this,this.source),{once:!0}),this.renderer.removeTexture(this),this.texture?.destroy(),this.texture=null}};var me=class extends X{constructor(t,{label:r,index:s=0,bindings:i=[],inputs:n,textures:o=[],samplers:u=[]}={}){let a="TextureBindGroup";t=t&&t.renderer||t,g(t,a);super(t,{label:r,index:s,bindings:i,inputs:n});this.options={...this.options,textures:[],samplers:[]},o.length&&o.forEach(h=>this.addTexture(h)),u.length&&u.forEach(h=>this.addSampler(h)),this.type=a,this.externalTexturesIDs=[]}addTexture(t){this.textures.push(t),this.addBindings([...t.bindings])}get textures(){return this.options.textures}addSampler(t){this.samplers.push(t),this.addBindings([t.binding])}get samplers(){return this.options.samplers}get shouldCreateBindGroup(){return!this.bindGroup&&!!this.bindings.length&&!this.textures.find(t=>!(t.texture||t.externalTexture))&&!this.samplers.find(t=>!t.sampler)}resetTextureBindGroup(){let t=[...this.bindings].reduce((r,s,i)=>(s instanceof Z&&r.push(i),r),[]);t.length&&(t.forEach(r=>{this.entries.bindGroup[r].resource=this.bindings[r].resource}),this.setBindGroup())}shouldUpdateVideoTextureBindGroupLayout(t){return this.externalTexturesIDs.includes(t)?!1:(this.externalTexturesIDs.push(t),this.needsPipelineFlush=!0,this.needsPipelineFlush)}updateVideoTextureBindGroupLayout(t){let r=this.textures[t],s=[...this.bindings].reduce((i,n,o)=>(n.bindingType==="externalTexture"&&i.push(o),i),[]);s.length&&(s.forEach(i=>{this.entries.bindGroupLayout[i]={binding:this.entries.bindGroupLayout[i].binding,externalTexture:r.externalTexture,visibility:this.entries.bindGroupLayout[i].visibility},this.bindings[i]&&(this.bindings[i].wgslGroupFragment=r.textureBinding.wgslGroupFragment)}),this.setBindGroupLayout())}updateTextures(){this.textures.forEach((t,r)=>{t instanceof I&&(t.options.fromTexture&&t.options.fromTexture.sourceUploaded&&!t.sourceUploaded&&t.copy(t.options.fromTexture),t.shouldUpdate&&t.options.sourceType&&t.options.sourceType==="externalVideo"&&(t.uploadVideoTexture(),this.shouldUpdateVideoTextureBindGroupLayout(r)&&this.updateVideoTextureBindGroupLayout(r))),t.shouldUpdateBindGroup&&(t.texture||t.externalTexture)&&(this.resetTextureBindGroup(),t.shouldUpdateBindGroup=!1)})}update(){this.updateTextures(),super.update()}destroy(){super.destroy(),this.options.textures=[],this.options.samplers=[]}};var xe=class extends Y{constructor({label:t="Sampler",name:r="sampler",bindingType:s,bindIndex:i=0,visibility:n,sampler:o}){s=s??"sampler";super({label:t,name:r,bindIndex:i,bindingType:s,visibility:n});this.options={...this.options,sampler:o},this.resource=o,this.setWGSLFragment()}get resourceLayout(){return{sampler:{type:"filtering"}}}get resource(){return this.sampler}set resource(t){this.sampler=t}setWGSLFragment(){this.wgslGroupFragment=[`var ${this.name}: ${this.bindingType};`]}};var ge=class{constructor({fov:e=50,near:t=.01,far:r=50,width:s=1,height:i=1,pixelRatio:n=1,onPerspectiveChanged:o=()=>{},onPositionChanged:u=()=>{}}={}){this.position=new p(0,0,1).onChange(()=>this.applyPosition()),this.projectionMatrix=new z,this.modelMatrix=new z,this.viewMatrix=new z,this.onPerspectiveChanged=o,this.onPositionChanged=u,this.shouldUpdate=!1,this.setPerspective(e,t,r,s,i,n)}setFov(e=this.fov){e=Math.max(1,Math.min(e,179)),e!==this.fov&&(this.fov=e,this.setPosition(),this.shouldUpdate=!0),this.setScreenRatios(),this.setCSSPerspective()}setNear(e=this.near){e=Math.max(e,.01),e!==this.near&&(this.near=e,this.shouldUpdate=!0)}setFar(e=this.far){e=Math.max(e,50),e!==this.far&&(this.far=e,this.shouldUpdate=!0)}setPixelRatio(e=this.pixelRatio){e!==this.pixelRatio&&(this.shouldUpdate=!0),this.pixelRatio=e}setSize(e,t){(e!==this.width||t!==this.height)&&(this.shouldUpdate=!0),this.width=e,this.height=t,this.setScreenRatios(),this.setCSSPerspective()}setPerspective(e=this.fov,t=this.near,r=this.far,s=this.width,i=this.height,n=this.pixelRatio){this.setPixelRatio(n),this.setSize(s,i),this.setFov(e),this.setNear(t),this.setFar(r),this.shouldUpdate&&(this.updateProjectionMatrix(),this.onPerspectiveChanged())}setPosition(e=this.position){this.position.copy(e),this.applyPosition()}applyPosition(){this.modelMatrix.set(1,0,0,0,0,1,0,0,0,0,1,0,this.position.x,this.position.y,this.position.z,1),this.viewMatrix=this.modelMatrix.clone().getInverse(),this.setScreenRatios(),this.onPositionChanged()}setCSSPerspective(){this.CSSPerspective=Math.pow(Math.pow(this.width/(2*this.pixelRatio),2)+Math.pow(this.height/(2*this.pixelRatio),2),.5)/Math.tan(this.fov*.5*Math.PI/180)}setScreenRatios(e=0){let t=this.position.z;e<t?e-=t:e+=t;let r=this.fov*Math.PI/180,s=2*Math.tan(r/2)*Math.abs(e);this.screenRatio={width:s*this.width/this.height,height:s}}updateProjectionMatrix(){let e=this.width/this.height,t=this.near*Math.tan(Math.PI/180*.5*this.fov),r=2*t,s=e*r,i=-.5*s,n=i+s,o=t-r,u=2*this.near/(n-i),a=2*this.near/(t-o),h=(n+i)/(n-i),m=(t+o)/(t-o),l=-(this.far+this.near)/(this.far-this.near),c=-2*this.far*this.near/(this.far-this.near);this.projectionMatrix.set(u,0,0,0,0,a,0,0,h,m,l,-1,0,0,c,0)}};var ye=class{constructor(e,{label:t="Sampler",name:r,addressModeU:s="repeat",addressModeV:i="repeat",magFilter:n="linear",minFilter:o="linear",mipmapFilter:u="linear",maxAnisotropy:a=1}={}){this.type="Sampler",e=e&&e.renderer||e,g(e,t?t+" "+this.type:this.type),this.renderer=e,this.label=t,!r&&!this.renderer.production&&(r="sampler"+this.renderer.samplers.length,L(`Sampler: you are trying to create a sampler without the mandatory name parameter. A default name will be used instead: ${r}`)),this.name=r,this.options={addressModeU:s,addressModeV:i,magFilter:n,minFilter:o,mipmapFilter:u,maxAnisotropy:a},this.createSampler(),this.createBinding()}createSampler(){this.sampler=this.renderer.createSampler(this)}createBinding(){this.binding=new xe({label:this.label,name:this.name,bindingType:"sampler",sampler:this.sampler})}};var ut={label:"RenderTexture",name:"renderTexture",usage:"texture",access:"write",fromTexture:null},j=class{constructor(e,t=ut){e=e&&e.renderer||e,g(e,t.label?t.label+" RenderTexture":"RenderTexture"),this.type="RenderTexture",this.renderer=e,this.uuid=k(),this.options={...ut,...t},this.options.format||(this.options.format=this.renderer.preferredFormat),this.shouldUpdateBindGroup=!1,this.setSize(this.options.size),this.setBindings(),this.createTexture()}setSize(e=null){e||(e={width:this.renderer.pixelRatioBoundingRect.width,height:this.renderer.pixelRatioBoundingRect.height}),this.size=e}createTexture(){if(this.options.fromTexture){this.texture=this.options.fromTexture.texture,this.size=this.options.fromTexture.size,this.textureBinding.resource=this.texture;return}this.texture?.destroy(),this.texture=this.renderer.createTexture({label:this.options.label,format:this.options.format,size:[this.size.width,this.size.height],usage:this.options.usage==="texture"?GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT:GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST}),this.textureBinding.resource=this.texture}setBindings(){this.bindings=[new Z({label:this.options.label+": "+this.options.name+" render texture",name:this.options.name,texture:this.texture,bindingType:this.options.usage})]}get textureBinding(){return this.bindings[0]}resize(e=null){this.setSize(e),this.createTexture(),this.shouldUpdateBindGroup=!0}destroy(){this.texture?.destroy(),this.texture=null}};var te=class{constructor(e,t){this.type="Material",e=e&&e.renderer||e,g(e,this.type),this.renderer=e;let{shaders:r,label:s,useAsyncPipeline:i,inputs:n,bindGroups:o,samplers:u}=t;this.options={shaders:r,label:s,...i!==void 0&&{useAsyncPipeline:i},...n!==void 0&&{inputs:n},...o!==void 0&&{bindGroups:o},...u!==void 0&&{samplers:u}},this.bindGroups=[],this.texturesBindGroups=[],this.clonedBindGroups=[],this.setBindGroups(),this.setTextures(),this.setSamplers()}setMaterial(){let e=this.texturesBindGroup.bindings.length?1:0;this.bindGroups.length>=this.inputsBindGroups.length+e||this.createBindGroups()}get ready(){return!!(this.renderer.ready&&this.pipelineEntry&&this.pipelineEntry.pipeline&&this.pipelineEntry.ready)}getShaderCode(e="full"){return this.pipelineEntry?(e=(()=>{switch(e){case"vertex":case"fragment":case"compute":case"full":return e;default:return"full"}})(),this.pipelineEntry.shaders[e].code):""}getAddedShaderCode(e="vertex"){return this.pipelineEntry?(e=(()=>{switch(e){case"vertex":case"fragment":case"compute":return e;default:return"vertex"}})(),this.pipelineEntry.shaders[e].head):""}setBindGroups(){if(this.uniforms={},this.storages={},this.inputsBindGroups=[],this.inputsBindings=[],this.options.inputs){let e=new X(this.renderer,{label:this.options.label+": Bindings bind group",inputs:this.options.inputs});this.processBindGroupBindings(e),this.inputsBindGroups.push(e)}this.options.bindGroups?.forEach(e=>{this.processBindGroupBindings(e),this.inputsBindGroups.push(e)})}get texturesBindGroup(){return this.texturesBindGroups[0]}processBindGroupBindings(e){e.bindings.forEach(t=>{t.bindingType==="uniform"&&(this.uniforms={...this.uniforms,[t.name]:t.bindings}),t.bindingType==="storage"&&(this.storages={...this.storages,[t.name]:t.bindings}),this.inputsBindings.push(t)})}createBindGroups(){this.texturesBindGroup.shouldCreateBindGroup&&(this.texturesBindGroup.setIndex(this.bindGroups.length),this.texturesBindGroup.createBindGroup(),this.bindGroups.push(this.texturesBindGroup)),this.inputsBindGroups.forEach(e=>{e.shouldCreateBindGroup&&(e.setIndex(this.bindGroups.length),e.createBindGroup(),this.bindGroups.push(e))}),this.options.bindGroups?.forEach(e=>{!e.shouldCreateBindGroup&&!this.bindGroups.find(t=>t.uuid===e.uuid)&&(e.setIndex(this.bindGroups.length),this.bindGroups.push(e)),e instanceof me&&!this.texturesBindGroups.find(t=>t.uuid===e.uuid)&&(this.texturesBindGroups.push(e),e.textures.forEach(t=>{t instanceof I&&!this.textures.find(r=>r.uuid===t.uuid)?this.textures.push(t):t instanceof j&&!this.renderTextures.find(r=>r.uuid===t.uuid)&&this.renderTextures.push(t)}))})}cloneBindGroup({bindGroup:e,bindings:t=[],keepLayout:r=!0}){if(!e)return null;let s=e.clone({bindings:t,keepLayout:r});return this.clonedBindGroups.push(s),s}getBindGroupByBindingName(e=""){return(this.ready?this.bindGroups:this.inputsBindGroups).find(t=>t.bindings.find(r=>r.name===e))}destroyBindGroups(){this.bindGroups.forEach(e=>e.destroy()),this.clonedBindGroups.forEach(e=>e.destroy()),this.texturesBindGroups=[],this.inputsBindGroups=[],this.bindGroups=[],this.clonedBindGroups=[]}updateBindGroups(){this.bindGroups.forEach(e=>{e.update(),e.needsPipelineFlush&&this.pipelineEntry.ready&&(this.pipelineEntry.flushPipelineEntry(this.bindGroups),e.needsPipelineFlush=!1)})}getBindingByName(e=""){return this.inputsBindings.find(t=>t.name===e)}shouldUpdateInputsBindings(e,t){if(!e)return;let r=this.getBindingByName(e);r&&(t?r.shouldUpdateBinding(t):Object.keys(r.bindings).forEach(s=>r.shouldUpdateBinding(s)))}setTextures(){this.textures=[],this.renderTextures=[],this.texturesBindGroups.push(new me(this.renderer,{label:this.options.label+": Textures bind group"}))}addTexture(e){e instanceof I?this.textures.push(e):e instanceof j&&this.renderTextures.push(e),(this.options.shaders.vertex&&this.options.shaders.vertex.code.indexOf(e.options.name)!==-1||this.options.shaders.fragment&&this.options.shaders.fragment.code.indexOf(e.options.name)!==-1||this.options.shaders.compute&&this.options.shaders.compute.code.indexOf(e.options.name)!==-1)&&this.texturesBindGroup.addTexture(e)}destroyTextures(){this.textures?.forEach(e=>e.destroy()),this.renderTextures?.forEach(e=>e.destroy()),this.textures=[],this.renderTextures=[]}setSamplers(){if(this.samplers=[],this.options.samplers?.forEach(t=>{this.addSampler(t)}),!this.samplers.find(t=>t.name==="defaultSampler")){let t=new ye(this.renderer,{name:"defaultSampler"});this.addSampler(t)}}addSampler(e){this.samplers.push(e),(this.options.shaders.vertex&&this.options.shaders.vertex.code.indexOf(e.name)!==-1||this.options.shaders.fragment&&this.options.shaders.fragment.code.indexOf(e.name)!==-1||this.options.shaders.compute&&this.options.shaders.compute.code.indexOf(e.name)!==-1)&&this.texturesBindGroup.addSampler(e)}onBeforeRender(){this.setMaterial(),this.textures.forEach(e=>{e.render()}),this.updateBindGroups()}setPipeline(e){this.renderer.pipelineManager.setCurrentPipeline(e,this.pipelineEntry)}render(e){this.ready&&(this.setPipeline(e),this.bindGroups.forEach(t=>{e.setBindGroup(t.index,t.bindGroup)}))}destroy(){this.destroyBindGroups(),this.destroyTextures()}};var Pe=class extends te{constructor(t,r){t=t&&t.renderer||t;let s="ComputeMaterial";g(t,s);super(t,r);this.type=s,this.renderer=t;let{shaders:i}=r;(!i||!i.compute)&&(i={compute:{code:"",entryPoint:"main"}}),i.compute.code||(i.compute.code=""),i.compute.entryPoint||(i.compute.entryPoint="main"),this.options={...this.options,shaders:i,...r.dispatchSize!==void 0&&{dispatchSize:r.dispatchSize}},this.workGroups=[],this.addWorkGroup({bindGroups:this.bindGroups,dispatchSize:this.options.dispatchSize}),this.pipelineEntry=this.renderer.pipelineManager.createComputePipeline({label:this.options.label+" compute pipeline",shaders:this.options.shaders,useAsync:this.options.useAsyncPipeline})}setPipelineEntryProperties(){this.pipelineEntry.setPipelineEntryProperties({bindGroups:this.bindGroups})}setMaterial(){super.setMaterial(),this.pipelineEntry&&this.pipelineEntry.canCompile&&this.setPipelineEntryProperties()}get hasMappedBuffer(){return!!this.bindGroups.some(r=>r.bindings.some(s=>s.resultBuffer&&s.resultBuffer.mapState!=="unmapped"))}addWorkGroup({bindGroups:t=[],dispatchSize:r=1}){Array.isArray(r)?(r[0]=Math.ceil(r[0]??1),r[1]=Math.ceil(r[1]??1),r[2]=Math.ceil(r[2]??1)):isNaN(r)||(r=[Math.ceil(r),1,1]),this.workGroups.push({bindGroups:t,dispatchSize:r})}renderWorkGroup(t,r){r.bindGroups.forEach(s=>{t.setBindGroup(s.index,s.bindGroup)}),t.dispatchWorkgroups(r.dispatchSize[0],r.dispatchSize[1],r.dispatchSize[2])}render(t){this.ready&&(this.setPipeline(t),this.workGroups.forEach(r=>{this.renderWorkGroup(t,r)}))}copyBufferToResult(t){this.bindGroups.forEach(r=>{r.bindings.forEach(s=>{"shouldCopyResult"in s&&s.shouldCopyResult&&t.copyBufferToBuffer(s.buffer,0,s.resultBuffer,0,s.resultBuffer.size)})})}setWorkGroupsResult(){this.bindGroups.forEach(t=>{t.bindings.forEach(r=>{r.shouldCopyResult&&this.setBufferResult(r)})})}setBufferResult(t){t.resultBuffer?.mapState==="unmapped"&&t.resultBuffer.mapAsync(GPUMapMode.READ).then(()=>{t.result=new Float32Array(t.resultBuffer.getMappedRange().slice(0)),t.resultBuffer.unmap()})}getWorkGroupResult({workGroupName:t="",bindingName:r=""}){let s;if(this.bindGroups.forEach(i=>{s=i.bindings.find(n=>n.name===t)}),s)if(r){let i=s.bindingElements.find(n=>n.name===r);return i?s.result.slice(i.startOffset,i.endOffset):s.result.slice()}else return s.result.slice();else return null}};var Rt=0,_e=class{constructor(e,t={}){this.#e=!0;this._onReadyCallback=()=>{};this._onBeforeRenderCallback=()=>{};this._onRenderCallback=()=>{};this._onAfterRenderCallback=()=>{};this._onAfterResizeCallback=()=>{};let r="ComputePass";e=e&&e.renderer||e,g(e,t.label?`${t.label} ${r}`:r),this.renderer=e,this.type=r,this.uuid=k(),Object.defineProperty(this,"index",{value:Rt++});let{label:s,shaders:i,renderOrder:n,inputs:o,bindGroups:u,autoAddToScene:a,useAsyncPipeline:h,texturesOptions:m,dispatchSize:l}=t;this.options={label:s,shaders:i,...a!==void 0&&{autoAddToScene:a},...n!==void 0&&{renderOrder:n},...h!==void 0&&{useAsyncPipeline:h},...l!==void 0&&{dispatchSize:l},texturesOptions:m},this.renderOrder=n??0,a!==void 0&&(this.#e=a),this.ready=!1,this.setComputeMaterial({label:this.options.label,shaders:this.options.shaders,inputs:o,bindGroups:u,useAsyncPipeline:h,dispatchSize:l}),this.addToScene()}#e;get ready(){return this._ready}set ready(e){e&&this._onReadyCallback&&this._onReadyCallback(),this._ready=e}addToScene(){this.renderer.computePasses.push(this),this.#e&&this.renderer.scene.addComputePass(this)}removeFromScene(){this.#e&&this.renderer.scene.removeComputePass(this),this.renderer.computePasses=this.renderer.computePasses.filter(e=>e.uuid!==this.uuid)}setComputeMaterial(e){this.material=new Pe(this.renderer,e)}get textures(){return this.material?.textures||[]}get renderTextures(){return this.material?.renderTextures||[]}createTexture(e){e.name||(e.name="texture"+this.textures.length),e.label||(e.label=this.options.label+" "+e.name);let t=new I(this.renderer,{...e,...this.options.texturesOptions});return this.addTexture(t),t}addTexture(e){this.material.addTexture(e)}createRenderTexture(e){e.name||(e.name="renderTexture"+this.renderTextures.length);let t=new j(this.renderer,e);return this.addRenderTexture(t),t}addRenderTexture(e){this.material.addTexture(e)}get uniforms(){return this.material?.uniforms}get storages(){return this.material?.storages}resize(){this._onAfterResizeCallback&&this._onAfterResizeCallback()}onReady(e){return e&&(this._onReadyCallback=e),this}onBeforeRender(e){return e&&(this._onBeforeRenderCallback=e),this}onRender(e){return e&&(this._onRenderCallback=e),this}onAfterRender(e){return e&&(this._onAfterRenderCallback=e),this}onAfterResize(e){return e&&(this._onAfterResizeCallback=e),this}onBeforeRenderPass(){this.renderer.ready&&(this.material&&this.material.ready&&!this.ready&&(this.ready=!0),this._onBeforeRenderCallback&&this._onBeforeRenderCallback(),this.material.onBeforeRender())}onRenderPass(e){this.material.ready&&(this._onRenderCallback&&this._onRenderCallback(),this.material.render(e))}onAfterRenderPass(){this._onAfterRenderCallback&&this._onAfterRenderCallback()}render(e){this.onBeforeRenderPass(),this.renderer.ready&&(this.onRenderPass(e),this.onAfterRenderPass())}get canRender(){return this.material?!this.material.hasMappedBuffer:!1}copyBufferToResult(e){this.material?.copyBufferToResult(e)}setWorkGroupsResult(){this.material?.setWorkGroupsResult()}getWorkGroupResult({workGroupName:e,bindingName:t}){return this.material?.getWorkGroupResult({workGroupName:e,bindingName:t})}remove(){this.removeFromScene(),this.destroy()}destroy(){this.material?.destroy()}};var N=[new p,new p,new p,new p,new p,new p,new p,new p],re=class d{constructor(e=new p(1/0),t=new p(-1/0)){this.min=e,this.max=t}set(e=new p(1/0),t=new p(-1/0)){return this.min.copy(e),this.max.copy(t),this}clone(){return new d().set(this.min,this.max)}getCenter(){return this.max.clone().add(this.min).multiplyScalar(.5)}getSize(){return this.max.clone().sub(this.min)}applyMat4(e=new z){let t=[];this.min.z===this.max.z?(t[0]=N[0].set(this.min.x,this.min.y,this.min.z).applyMat4(e),t[1]=N[2].set(this.min.x,this.max.y,this.min.z).applyMat4(e),t[2]=N[4].set(this.max.x,this.min.y,this.min.z).applyMat4(e),t[3]=N[6].set(this.max.x,this.max.y,this.min.z).applyMat4(e)):(t[0]=N[0].set(this.min.x,this.min.y,this.min.z).applyMat4(e),t[1]=N[1].set(this.min.x,this.min.y,this.max.z).applyMat4(e),t[2]=N[2].set(this.min.x,this.max.y,this.min.z).applyMat4(e),t[3]=N[3].set(this.min.x,this.max.y,this.max.z).applyMat4(e),t[4]=N[4].set(this.max.x,this.min.y,this.min.z).applyMat4(e),t[5]=N[5].set(this.max.x,this.min.y,this.max.z).applyMat4(e),t[6]=N[6].set(this.max.x,this.max.y,this.min.z).applyMat4(e),t[7]=N[7].set(this.max.x,this.max.y,this.max.z).applyMat4(e));let r=new d;for(let s=0,i=t.length;s<i;s++)r.min.min(t[s]),r.max.max(t[s]);return r}};var dt={top:0,right:0,bottom:0,left:0},be=class{constructor({boundingBox:e=new re,modelViewProjectionMatrix:t=new z,containerBoundingRect:r={top:0,right:0,bottom:0,left:0,width:0,height:0,x:0,y:0},DOMFrustumMargins:s=dt,onReEnterView:i=()=>{},onLeaveView:n=()=>{}}){this.boundingBox=e,this.modelViewProjectionMatrix=t,this.containerBoundingRect=r,this.DOMFrustumMargins={...dt,...s},this.projectedBoundingRect={top:0,right:0,bottom:0,left:0,width:0,height:0,x:0,y:0},this.onReEnterView=i,this.onLeaveView=n,this.isIntersecting=!1,this.shouldUpdate=!1}setContainerBoundingRect(e){this.containerBoundingRect=e}get DOMFrustumBoundingRect(){return{top:this.projectedBoundingRect.top-this.DOMFrustumMargins.top,right:this.projectedBoundingRect.right+this.DOMFrustumMargins.right,bottom:this.projectedBoundingRect.bottom+this.DOMFrustumMargins.bottom,left:this.projectedBoundingRect.left-this.DOMFrustumMargins.left}}computeProjectedToDocumentCoords(){let e=this.boundingBox.applyMat4(this.modelViewProjectionMatrix);e.min.x=(e.min.x+1)*.5,e.max.x=(e.max.x+1)*.5,e.min.y=1-(e.min.y+1)*.5,e.max.y=1-(e.max.y+1)*.5;let{width:t,height:r,top:s,left:i}=this.containerBoundingRect;this.projectedBoundingRect={left:e.min.x*t+i,x:e.min.x*t+i,top:e.max.y*r+s,y:e.max.y*r+s,right:e.max.x*t+i,bottom:e.min.y*r+s,width:e.max.x*t+i-(e.min.x*t+i),height:e.min.y*r+s-(e.max.y*r+s)},this.intersectsContainer()}intersectsContainer(){Math.round(this.DOMFrustumBoundingRect.right)<=this.containerBoundingRect.left||Math.round(this.DOMFrustumBoundingRect.left)>=this.containerBoundingRect.left+this.containerBoundingRect.width||Math.round(this.DOMFrustumBoundingRect.bottom)<=this.containerBoundingRect.top||Math.round(this.DOMFrustumBoundingRect.top)>=this.containerBoundingRect.top+this.containerBoundingRect.height?(this.isIntersecting&&this.onLeaveView(),this.isIntersecting=!1):(this.isIntersecting||this.onReEnterView(),this.isIntersecting=!0)}};var se=class{constructor({verticesOrder:e="cw",instancesCount:t=1,vertexBuffers:r=[]}={}){this.verticesCount=0,this.verticesOrder=e,this.instancesCount=t,this.boundingBox=new re,this.type="Geometry",this.vertexBuffers=[],this.addVertexBuffer({name:"attributes"}),this.options={verticesOrder:e,instancesCount:t,vertexBuffers:r},r.forEach(s=>{this.addVertexBuffer({stepMode:s.stepMode??"vertex",name:s.name,attributes:s.attributes})})}get shouldCompute(){return!this.vertexBuffers[0].array}get ready(){return!this.shouldCompute&&!this.vertexBuffers.find(e=>!e.buffer)}addVertexBuffer({stepMode:e="vertex",name:t,attributes:r=[]}={}){let s={name:t??"attributes"+this.vertexBuffers.length,stepMode:e,arrayStride:0,bufferLength:0,attributes:[],buffer:null,indexBuffer:null};return r?.forEach(i=>{this.setAttribute({vertexBuffer:s,...i})}),this.vertexBuffers.push(s),s}getVertexBufferByName(e=""){return this.vertexBuffers.find(t=>t.name===e)}setAttribute({vertexBuffer:e=this.vertexBuffers[0],name:t,type:r="vec3f",bufferFormat:s="float32x3",size:i=3,array:n=new Float32Array(this.verticesCount*i),verticesUsed:o=1}){let u=e.attributes,a=u.length;t||(t="geometryAttribute"+a),t==="position"&&(r!=="vec3f"||s!=="float32x3"||i!==3)&&(L(`Geometry 'position' attribute must have this exact properties set:
	type: 'vec3f',
	bufferFormat: 'float32x3',
	size: 3`),r="vec3f",s="float32x3",i=3);let h=n.length/i;t==="position"&&(this.verticesCount=h),e.stepMode==="vertex"&&this.verticesCount&&this.verticesCount!==h*o?V(`Geometry vertex attribute error. Attribute array of size ${i} must be of length: ${this.verticesCount*i}, current given: ${n.length}. (${this.verticesCount} vertices).`):e.stepMode==="instance"&&h!==this.instancesCount&&V(`Geometry instance attribute error. Attribute array of size ${i} must be of length: ${this.instancesCount*i}, current given: ${n.length}. (${this.instancesCount} instances).`);let m={name:t,type:r,bufferFormat:s,size:i,bufferLength:n.length,offset:a?u.reduce((l,c)=>l+c.bufferLength,0):0,bufferOffset:a?u[a-1].bufferOffset+u[a-1].size*4:0,array:n,verticesUsed:o};e.bufferLength+=m.bufferLength*o,e.arrayStride+=m.size,e.attributes.push(m)}getAttributeByName(e){let t;return this.vertexBuffers.forEach(r=>{t=r.attributes.find(s=>s.name===e)}),t}computeGeometry(){this.shouldCompute&&(this.vertexBuffers.forEach((e,t)=>{if(t===0){let i=e.attributes.find(n=>n.name==="position");i||V("Geometry must have a 'position' attribute"),(i.type!=="vec3f"||i.bufferFormat!=="float32x3"||i.size!==3)&&(L(`Geometry 'position' attribute must have this exact properties set:
	type: 'vec3f',
	bufferFormat: 'float32x3',
	size: 3`),i.type="vec3f",i.bufferFormat="float32x3",i.size=3)}e.array=new Float32Array(e.bufferLength);let r=0,s=0;for(let i=0;i<e.bufferLength;i+=e.arrayStride){for(let n=0;n<e.attributes.length;n++){let{name:o,size:u,array:a,verticesUsed:h}=e.attributes[n];for(let m=0;m<u;m++){let l=a[Math.floor(s/h)*u+m];e.array[r]=l,o==="position"&&(m%3===0?(this.boundingBox.min.x>l&&(this.boundingBox.min.x=l),this.boundingBox.max.x<l&&(this.boundingBox.max.x=l)):m%3===1?(this.boundingBox.min.y>l&&(this.boundingBox.min.y=l),this.boundingBox.max.y<l&&(this.boundingBox.max.y=l)):m%3===2&&(this.boundingBox.min.z>l&&(this.boundingBox.min.z=l),this.boundingBox.max.z<l&&(this.boundingBox.max.z=l))),r++}}s++}}),this.#e())}#e(){let e=-1;this.wgslStructFragment=`struct Attributes {
	@builtin(vertex_index) vertexIndex : u32,
	@builtin(instance_index) instanceIndex : u32,${this.vertexBuffers.map(t=>t.attributes.map(r=>(e++,`
	@location(${e}) ${r.name}: ${r.type}`))).join(",")}
};`}setGeometryBuffers(e){this.vertexBuffers.forEach((t,r)=>{e.setVertexBuffer(r,t.buffer)})}drawGeometry(e){e.draw(this.verticesCount,this.instancesCount)}render(e){this.ready&&(this.setGeometryBuffers(e),this.drawGeometry(e))}destroy(){this.vertexBuffers.forEach(e=>{e.buffer?.destroy()}),this.vertexBuffers=[]}};var J=class extends se{constructor({verticesOrder:t="cw",instancesCount:r=1,vertexBuffers:s=[]}={}){super({verticesOrder:t,instancesCount:r,vertexBuffers:s});this.type="IndexedGeometry"}get ready(){return!this.shouldCompute&&!this.vertexBuffers.find(t=>!t.buffer)&&this.indexBuffer&&!!this.indexBuffer.buffer}setIndexBuffer({bufferFormat:t="uint32",array:r=new Uint32Array(0)}){this.indexBuffer={array:r,bufferFormat:t,bufferLength:r.length,buffer:null}}setGeometryBuffers(t){super.setGeometryBuffers(t),t.setIndexBuffer(this.indexBuffer.buffer,this.indexBuffer.bufferFormat)}drawGeometry(t){t.drawIndexed(this.indexBuffer.bufferLength,this.instancesCount)}destroy(){super.destroy(),this.indexBuffer?.buffer?.destroy(),this.indexBuffer=null}};var ie=class extends J{constructor({widthSegments:t=1,heightSegments:r=1,instancesCount:s=1,vertexBuffers:i=[]}={}){super({verticesOrder:"cw",instancesCount:s,vertexBuffers:i});this.type="PlaneGeometry",t=Math.floor(t),r=Math.floor(r),this.definition={id:t*r+t,width:t,height:r,count:t*r},this.setIndexArray();let n=this.definition.width*2+2+(this.definition.height-1)*(this.definition.width+1),o=this.getIndexedVerticesAndUVs(n);Object.keys(o).forEach(u=>{this.setAttribute(o[u])})}setIndexArray(){let t=new Uint32Array(this.definition.count*6),r=0;for(let s=0;s<this.definition.height;s++)for(let i=0;i<this.definition.width;i++)t[r++]=i+s*(this.definition.width+1),t[r++]=this.definition.width+i+1+s*(this.definition.width+1),t[r++]=i+1+s*(this.definition.width+1),t[r++]=i+1+s*(this.definition.width+1),t[r++]=this.definition.width+i+1+s*(this.definition.width+1),t[r++]=this.definition.width+i+2+s*(this.definition.width+1);this.setIndexBuffer({array:t})}getIndexedVerticesAndUVs(t){let r={name:"uv",type:"vec2f",bufferFormat:"float32x2",size:2,bufferLength:t*2,array:new Float32Array(t*2)},s={name:"position",type:"vec3f",bufferFormat:"float32x3",size:3,bufferLength:t*3,array:new Float32Array(t*3)},i=0,n=0;for(let o=0;o<=this.definition.height;o++){let u=o/this.definition.height;for(let a=0;a<this.definition.width;a++){let h=a/this.definition.width;a===0&&(r.array[n++]=h,r.array[n++]=1-u,s.array[i++]=(h-.5)*2,s.array[i++]=(u-.5)*2,s.array[i++]=0),r.array[n++]=h+1/this.definition.width,r.array[n++]=1-u,s.array[i++]=(h+1/this.definition.width-.5)*2,s.array[i++]=(u-.5)*2,s.array[i++]=0}}return{position:s,uv:r}}};var Be=class extends te{constructor(t,r){t=t&&t.renderer||t;let s="RenderMaterial";g(t,s);super(t,r);this.type=s,this.renderer=t;let{shaders:i,label:n,useAsyncPipeline:o,inputs:u,bindGroups:a,...h}=r;i.vertex.entryPoint||(i.vertex.entryPoint="main"),i.fragment.entryPoint||(i.fragment.entryPoint="main"),this.options={...this.options,shaders:i,label:n,...o!==void 0&&{useAsyncPipeline:o},...u!==void 0&&{inputs:u},...a!==void 0&&{bindGroups:a},rendering:h},this.pipelineEntry=this.renderer.pipelineManager.createRenderPipeline({label:this.options.label+" render pipeline",shaders:this.options.shaders,useAsync:this.options.useAsyncPipeline,...this.options.rendering}),this.attributes=null}setPipelineEntryProperties(){this.pipelineEntry.setPipelineEntryProperties({attributes:this.attributes,bindGroups:this.bindGroups})}setMaterial(){super.setMaterial(),this.attributes&&this.pipelineEntry&&this.pipelineEntry.canCompile&&this.setPipelineEntryProperties()}setAttributesFromGeometry(t){this.attributes={wgslStructFragment:t.wgslStructFragment,vertexBuffers:t.vertexBuffers}}createBindGroups(){let t=this.options.rendering.useProjection?1:0;this.texturesBindGroup.shouldCreateBindGroup&&(this.texturesBindGroup.setIndex(this.bindGroups.length+t),this.texturesBindGroup.createBindGroup(),this.bindGroups.push(this.texturesBindGroup)),this.inputsBindGroups.forEach(r=>{r.shouldCreateBindGroup&&(r.setIndex(this.bindGroups.length+t),r.createBindGroup(),this.bindGroups.push(r))})}};var Mt=0,ht={label:"Mesh",geometry:new se,shaders:{},autoAddToScene:!0,useProjection:!1,cullMode:"back",depthWriteEnabled:!0,depthCompare:"less",transparent:!1,visible:!0,renderOrder:0,texturesOptions:{}};function Tt(d){return class extends d{constructor(...r){super(r[0],r[1],{...ht,...r[2]});this.#e=!0;this._onReadyCallback=()=>{};this._onBeforeRenderCallback=()=>{};this._onRenderCallback=()=>{};this._onAfterRenderCallback=()=>{};this._onAfterResizeCallback=()=>{};let s=r[0],i={...ht,...r[2]};this.type="MeshBase",this.uuid=k(),Object.defineProperty(this,"index",{value:Mt++}),s=s&&s.renderer||s,g(s,i.label?i.label+" "+this.type:this.type),this.renderer=s;let{label:n,shaders:o,geometry:u,visible:a,renderOrder:h,renderTarget:m,texturesOptions:l,autoAddToScene:c,verticesOrder:x,...P}=i;this.options={...this.options??{},label:n,shaders:o,texturesOptions:l,...m!==void 0&&{renderTarget:m},...c!==void 0&&{autoAddToScene:c},...P.useAsyncPipeline!==void 0&&{useAsyncPipeline:P.useAsyncPipeline}},this.renderTarget=m??null,this.geometry=u,c!==void 0&&(this.#e=c),this.visible=a,this.renderOrder=h,this.ready=!1,this.computeGeometry(),this.setMaterial({label:this.options.label,shaders:this.options.shaders,...P,verticesOrder:x??u.verticesOrder}),this.addToScene()}#e;get autoAddToScene(){return this.#e}get ready(){return this._ready}set ready(r){r&&this._onReadyCallback&&this._onReadyCallback(),this._ready=r}addToScene(){this.renderer.meshes.push(this),this.#e&&this.renderer.scene.addMesh(this)}removeFromScene(){this.#e&&this.renderer.scene.removeMesh(this),this.renderer.meshes=this.renderer.meshes.filter(r=>r.uuid!==this.uuid)}computeGeometry(){this.geometry.shouldCompute&&this.geometry.computeGeometry()}createGeometryBuffers(){this.geometry.ready||(this.geometry.vertexBuffers.forEach(r=>{r.buffer||(r.buffer=this.renderer.createBuffer({label:this.options.label+": Vertex buffer vertices",size:r.array.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),this.renderer.queueWriteBuffer(r.buffer,0,r.array))}),"indexBuffer"in this.geometry&&this.geometry.indexBuffer&&!this.geometry.indexBuffer.buffer&&(this.geometry.indexBuffer.buffer=this.renderer.createBuffer({label:this.options.label+": Index buffer vertices",size:this.geometry.indexBuffer.array.byteLength,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST}),this.renderer.queueWriteBuffer(this.geometry.indexBuffer.buffer,0,this.geometry.indexBuffer.array)))}setGeometry(){this.geometry&&this.renderer.ready&&(this.createGeometryBuffers(),this.setMaterialGeometryAttributes())}setMaterial(r){this.transparent=r.transparent,this.material=new Be(this.renderer,r)}setMaterialGeometryAttributes(){this.material&&!this.material.attributes&&this.material.setAttributesFromGeometry(this.geometry)}get textures(){return this.material?.textures||[]}get renderTextures(){return this.material?.renderTextures||[]}createTexture(r){r.name||(r.name="texture"+this.textures.length),r.label||(r.label=this.options.label+" "+r.name);let s=new I(this.renderer,{...r,...this.options.texturesOptions});return this.addTexture(s),s}addTexture(r){this.material.addTexture(r),this.onTextureAdded(r)}onTextureAdded(r){r.parent=this}createRenderTexture(r){r.name||(r.name="renderTexture"+this.renderTextures.length);let s=new j(this.renderer,r);return this.addRenderTexture(s),s}addRenderTexture(r){this.material.addTexture(r)}setRenderTarget(r){if(r&&r.type!=="RenderTarget"){L(`${this.options.label??this.type}: renderTarget is not a RenderTarget: ${r}`);return}this.removeFromScene(),this.renderTarget=r,this.addToScene()}get uniforms(){return this.material?.uniforms}get storages(){return this.material?.storages}resizeRenderTextures(){this.renderTextures?.filter(r=>r.options.usage==="texture").forEach(r=>r.resize())}resize(r=null){this.resizeRenderTextures(),super.resize&&super.resize(r),this.textures?.forEach(s=>{s.resize()}),this._onAfterResizeCallback&&this._onAfterResizeCallback()}onReady(r){return r&&(this._onReadyCallback=r),this}onBeforeRender(r){return r&&(this._onBeforeRenderCallback=r),this}onRender(r){return r&&(this._onRenderCallback=r),this}onAfterRender(r){return r&&(this._onAfterRenderCallback=r),this}onAfterResize(r){return r&&(this._onAfterResizeCallback=r),this}onBeforeRenderPass(){this.renderer.ready&&(this.material&&this.material.ready&&this.geometry&&this.geometry.ready&&!this.ready&&(this.ready=!0),this.setGeometry(),this._onBeforeRenderCallback&&this._onBeforeRenderCallback(),this.material.onBeforeRender())}onRenderPass(r){this.material.ready&&(this._onRenderCallback&&this._onRenderCallback(),this.material.render(r),this.geometry.render(r))}onAfterRenderPass(){this._onAfterRenderCallback&&this._onAfterRenderCallback()}render(r){this.onBeforeRenderPass(),!(!this.renderer.ready||!this.visible)&&(super.render&&super.render(),this.onRenderPass(r),this.onAfterRenderPass())}remove(){this.removeFromScene(),this.destroy()}destroy(){super.destroy&&super.destroy(),this.material?.destroy(),this.geometry?.destroy()}}}var Ie=Tt;var Ke=class{constructor(){this.shouldWatch=!0,this.entries=[],this.resizeObserver=new ResizeObserver(e=>{e.forEach(t=>{let r=this.entries.find(s=>s.element.isSameNode(t.target));r&&r.callback&&r.callback()})})}useObserver(e=!0){this.shouldWatch=e}observe({element:e,callback:t}){if(!e||!this.shouldWatch)return;this.resizeObserver.observe(e);let r={element:e,callback:t};this.entries.push(r)}unobserve(e){this.resizeObserver.unobserve(e),this.entries=this.entries.filter(t=>!t.element.isSameNode(e))}destroy(){this.resizeObserver.disconnect()}},Ve=new Ke;var q=class{constructor({element:e=document.body,onSizeChanged:t=(s=null)=>{},onPositionChanged:r=(s=null)=>{}}={}){this.#e=null;if(typeof e=="string"){if(this.element=document.querySelector(e),!this.element){let s=typeof e=="string"?`'${e}' selector`:`${e} HTMLElement`;V(`DOMElement: corresponding ${s} not found.`)}}else this.element=e;this.isResizing=!1,this.onSizeChanged=t,this.onPositionChanged=r,this.resizeManager=Ve,this.resizeManager.observe({element:this.element,callback:()=>{this.setSize()}}),this.setSize()}#e;compareBoundingRect(e,t){return!["x","y","left","top","right","bottom","width","height"].some(r=>e[r]!==t[r])}get boundingRect(){return this._boundingRect}set boundingRect(e){let t=!!this.boundingRect&&this.compareBoundingRect(e,this.boundingRect);this._boundingRect={top:e.top,right:e.right,bottom:e.bottom,left:e.left,width:e.width,height:e.height,x:e.x,y:e.y},t||this.onSizeChanged(this.boundingRect)}updateScrollPosition(e={x:0,y:0}){this.isResizing||(this._boundingRect.top+=e.y,this._boundingRect.left+=e.x,(e.x||e.y)&&this.onPositionChanged(this.boundingRect))}setSize(e=null){this.element&&(this.isResizing=!!this.boundingRect,this.boundingRect=e??this.element.getBoundingClientRect(),this.#e=setTimeout(()=>{this.isResizing=!1,this.#e=null},50))}destroy(){this.resizeManager.unobserve(this.element),this.#e&&clearTimeout(this.#e)}};var lt=`
struct VertexOutput {
  @builtin(position) position: vec4f,
  @location(0) uv: vec2f,
};

@vertex fn main(
  attributes: Attributes,
) -> VertexOutput {
  var vertexOutput: VertexOutput;

  vertexOutput.position = vec4f(attributes.position, 1.0);
  vertexOutput.uv = attributes.uv;
  
  return vertexOutput;
}`;var et=class{constructor(){this.planeGeometries=[]}getPlaneGeometry(e){return this.planeGeometries.find(t=>t.definition.id===e.definition.id)}getPlaneGeometryByID(e){return this.planeGeometries.find(t=>t.definition.id===e)}addPlaneGeometry(e){this.planeGeometries.push(e)}destroy(){this.planeGeometries=[]}},Re=new et;var ne=class extends Ie(class{}){constructor(t,r={}){t=t&&t.renderer||t,g(t,r.label?r.label+" FullscreenQuadMesh":"FullscreenQuadMesh");let s=Re.getPlaneGeometryByID(2);s||(s=new ie({widthSegments:1,heightSegments:1}),Re.addPlaneGeometry(s)),(!r.shaders.vertex||!r.shaders.vertex.code)&&(r.shaders.vertex={code:lt,entryPoint:"main"});super(t,null,{geometry:s,...r});this.size={document:{width:0,height:0,top:0,left:0}},this.domElement=new q({element:this.renderer.domElement.element,onSizeChanged:i=>this.resize(i)}),this.type="FullscreenQuadMesh"}resize(t=null){!t&&(!this.domElement||this.domElement?.isResizing)||(this.size.document=t??this.domElement.element.getBoundingClientRect(),super.resize(t))}mouseToPlaneCoords(t=new $){return new $((t.x-this.size.document.left)/this.size.document.width*2-1,1-(t.y-this.size.document.top)/this.size.document.height*2)}};var oe=class extends ee{constructor(t){super();t=t&&t.renderer||t,ce(t,"ProjectedObject3D"),this.camera=t.camera}applyPosition(){super.applyPosition(),this.shouldUpdateProjectionMatrixStack()}applyRotation(){super.applyRotation(),this.shouldUpdateProjectionMatrixStack()}applyScale(){super.applyScale(),this.shouldUpdateProjectionMatrixStack()}applyTransformOrigin(){super.applyTransformOrigin(),this.shouldUpdateProjectionMatrixStack()}setMatrices(){super.setMatrices(),this.matrices={...this.matrices,modelView:{matrix:new z,shouldUpdate:!1,onUpdate:()=>{this.modelViewMatrix.multiplyMatrices(this.camera.viewMatrix,this.modelMatrix)}},modelViewProjection:{matrix:new z,shouldUpdate:!1,onUpdate:()=>{this.modelViewProjectionMatrix.multiplyMatrices(this.projectionMatrix,this.modelViewMatrix)}}}}get modelViewMatrix(){return this.matrices.modelView.matrix}set modelViewMatrix(t){this.matrices.modelView.matrix=t,this.matrices.modelView.shouldUpdate=!0}get viewMatrix(){return this.camera.viewMatrix}get projectionMatrix(){return this.camera.projectionMatrix}get modelViewProjectionMatrix(){return this.matrices.modelViewProjection.matrix}set modelViewProjectionMatrix(t){this.matrices.modelViewProjection.matrix=t,this.matrices.modelViewProjection.shouldUpdate=!0}shouldUpdateProjectionMatrixStack(){this.matrices.modelView.shouldUpdate=!0,this.matrices.modelViewProjection.shouldUpdate=!0}updateSizePositionAndProjection(){this.shouldUpdateModelMatrix(),this.shouldUpdateProjectionMatrixStack()}};var mt={frustumCulled:!0,DOMFrustumMargins:{top:0,right:0,bottom:0,left:0}};function Gt(d){return class extends Ie(d){constructor(...r){super(r[0],r[1],{...mt,...r[2],useProjection:!0});this._onReEnterViewCallback=()=>{};this._onLeaveViewCallback=()=>{};let s=r[0],i={...mt,...r[2],useProjection:!0};this.type="MeshTransformed",s=s&&s.renderer||s,ce(s,i.label?i.label+" "+this.type:this.type),this.renderer=s;let{label:n,geometry:o,shaders:u,frustumCulled:a,DOMFrustumMargins:h}=i;this.options={...this.options??{},label:n,shaders:u,frustumCulled:a,DOMFrustumMargins:h},this.geometry=o,this.updateSizePositionAndProjection()}computeGeometry(){this.geometry.shouldCompute&&(this.geometry.computeGeometry(),this.domFrustum=new be({boundingBox:this.geometry.boundingBox,modelViewProjectionMatrix:this.modelViewProjectionMatrix,containerBoundingRect:this.renderer.boundingRect,DOMFrustumMargins:this.options.DOMFrustumMargins,onReEnterView:()=>{this._onReEnterViewCallback&&this._onReEnterViewCallback()},onLeaveView:()=>{this._onLeaveViewCallback&&this._onLeaveViewCallback()}}),this.frustumCulled=this.options.frustumCulled,this.DOMFrustumMargins=this.domFrustum.DOMFrustumMargins,this.domFrustum.shouldUpdate=this.frustumCulled)}setMaterial(r){let s={label:"Matrices",bindings:{model:{name:"model",type:"mat4x4f",value:this.modelMatrix,onBeforeUpdate:()=>{s.bindings.model.value=this.modelMatrix}},modelView:{name:"modelView",type:"mat4x4f",value:this.modelViewMatrix,onBeforeUpdate:()=>{s.bindings.modelView.value=this.modelViewMatrix}},modelViewProjection:{name:"modelViewProjection",type:"mat4x4f",value:this.modelViewProjectionMatrix,onBeforeUpdate:()=>{s.bindings.modelViewProjection.value=this.modelViewProjectionMatrix}}}};r.inputs||(r.inputs={uniforms:{}}),r.inputs.uniforms.matrices=s,super.setMaterial(r)}resize(r=null){this.domFrustum&&this.domFrustum.setContainerBoundingRect(this.renderer.boundingRect),super.resize(r)}applyScale(){super.applyScale(),this.textures.forEach(r=>r.resize())}get projectedBoundingRect(){return this.domFrustum?.projectedBoundingRect}updateSizePositionAndProjection(){super.updateSizePositionAndProjection()}updateMatrixStack(){super.updateMatrixStack()}onAfterMatrixStackUpdate(){this.material&&this.material.shouldUpdateInputsBindings("matrices"),this.domFrustum&&(this.domFrustum.shouldUpdate=!0)}onReEnterView(r){return r&&(this._onReEnterViewCallback=r),this}onLeaveView(r){return r&&(this._onLeaveViewCallback=r),this}onBeforeRenderPass(){this.updateMatrixStack(),this.domFrustum&&this.domFrustum.shouldUpdate&&this.frustumCulled&&(this.domFrustum.computeProjectedToDocumentCoords(),this.domFrustum.shouldUpdate=!1),super.onBeforeRenderPass()}onRenderPass(r){this.material.ready&&(this._onRenderCallback&&this._onRenderCallback(),(this.domFrustum&&this.domFrustum.isIntersecting||!this.frustumCulled)&&(this.material.render(r),this.geometry.render(r)))}}}var je=Gt;var We=class extends je(oe){constructor(e,t={}){e=e&&e.renderer||e,ce(e,t.label?t.label+" Mesh":"Mesh"),super(e,null,t),this.type="Mesh"}};var Ct=0,ae=class{constructor(e){this.type="PipelineEntry";let{renderer:t}=e,{label:r,shaders:s,useAsync:i}=e;t=t&&t.renderer||t,g(t,r?r+" "+this.type:this.type),this.renderer=t,Object.defineProperty(this,"index",{value:Ct++}),this.layout=null,this.pipeline=null,this.status={compiling:!1,compiled:!1,error:null},this.options={label:r,shaders:s,useAsync:i!==void 0?i:!0}}get ready(){return!this.status.compiling&&this.status.compiled&&!this.status.error}get canCompile(){return!this.status.compiling&&!this.status.compiled&&!this.status.error}setPipelineEntryBindGroups(e){this.bindGroups=e}createShaderModule({code:e="",type:t="vertex"}){let r=this.renderer.createShaderModule({label:this.options.label+": "+t+"Shader module",code:e});return r.getCompilationInfo().then(s=>{for(let i of s.messages){let n="";switch(i.lineNum&&(n+=`Line ${i.lineNum}:${i.linePos} - ${e.substring(i.offset,i.offset+i.length)}
`),n+=i.message,i.type){case"error":!this.renderer.production&&console.error(`${this.options.label} compilation error:
${n}`);break;case"warning":!this.renderer.production&&console.warn(`${this.options.label} compilation warning:
${n}`);break;case"info":!this.renderer.production&&console.log(`${this.options.label} compilation information:
${n}`);break}}}),r}createShaders(){}createPipelineLayout(){this.layout=this.renderer.createPipelineLayout({label:this.options.label+" layout",bindGroupLayouts:this.bindGroups.map(e=>e.bindGroupLayout)})}createPipelineDescriptor(){}flushPipelineEntry(e=[]){this.status.compiling=!1,this.status.compiled=!1,this.status.error=null,this.setPipelineEntryBindGroups(e),this.setPipelineEntry()}setPipelineEntry(){this.status.compiling=!0,this.createShaders(),this.createPipelineLayout(),this.createPipelineDescriptor()}};var pt=`
fn getOutputPosition(camera: Camera, matrices: Matrices, position: vec3f) -> vec4f {
  return camera.projection * matrices.modelView * vec4f(position, 1.0);
}`;var tt=`
fn getUVCover(uv: vec2f, textureMatrix: mat4x4f) -> vec2f {
  return (textureMatrix * vec4f(uv, 0, 1)).xy;
}`;var ct=`
fn getVertex2DToUVCoords(vertex: vec2f) -> vec2f {
  return vec2(
    vertex.x * 0.5 + 0.5,
    0.5 - vertex.y * 0.5
  );
}

fn getVertex3DToUVCoords(vertex: vec3f) -> vec2f {
  return vec2(
    vertex.x * 0.5 + 0.5,
    0.5 - vertex.y * 0.5
  );
}
`;var Ae={vertex:{get_uv_cover:tt},fragment:{get_uv_cover:tt,get_vertex_to_uv_coords:ct}},De={vertex:{get_output_position:pt},fragment:{}};var Me=class extends ae{constructor(t){let{renderer:r}=t,{label:s,cullMode:i,depthWriteEnabled:n,depthCompare:o,transparent:u,verticesOrder:a,useProjection:h}=t;r=r&&r.renderer||r;let m="RenderPipelineEntry";g(r,s?s+" "+m:m);super(t);this.type=m,this.shaders={vertex:{head:"",code:"",module:null},fragment:{head:"",code:"",module:null},full:{code:"",module:null}},this.descriptor=null,this.options={...this.options,cullMode:i,depthWriteEnabled:n,depthCompare:o,transparent:u,verticesOrder:a,useProjection:h}}setPipelineEntryBindGroups(t){this.bindGroups="cameraBindGroup"in this.renderer&&this.options.useProjection?[this.renderer.cameraBindGroup,...t]:t}setPipelineEntryProperties(t){let{attributes:r,bindGroups:s}=t;this.attributes=r,this.setPipelineEntryBindGroups(s),this.setPipelineEntry()}patchShaders(){this.shaders.vertex.head="",this.shaders.vertex.code="",this.shaders.fragment.head="",this.shaders.fragment.code="";for(let r in Ae.vertex)this.shaders.vertex.head=`${Ae.vertex[r]}
${this.shaders.vertex.head}`;for(let r in Ae.fragment)this.shaders.fragment.head=`${Ae.fragment[r]}
${this.shaders.fragment.head}`;if(this.options.useProjection){for(let r in De.vertex)this.shaders.vertex.head=`${De.vertex[r]}
${this.shaders.vertex.head}`;for(let r in De.fragment)this.shaders.fragment.head=`${De.fragment[r]}
${this.shaders.fragment.head}`}let t=[];this.bindGroups.forEach(r=>{let s=0;r.bindings.forEach((i,n)=>{i.wgslGroupFragment.forEach((o,u)=>{t.push({groupIndex:r.index,visibility:i.visibility,bindIndex:s,wgslStructFragment:i.wgslStructFragment,wgslGroupFragment:o,newLine:n===r.bindings.length-1&&u===i.wgslGroupFragment.length-1}),s++})})}),t.forEach(r=>{(r.visibility===GPUShaderStage.VERTEX||r.visibility===(GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE))&&(r.wgslStructFragment&&this.shaders.vertex.head.indexOf(r.wgslStructFragment)===-1&&(this.shaders.vertex.head=`
${r.wgslStructFragment}
${this.shaders.vertex.head}`),this.shaders.vertex.head.indexOf(r.wgslGroupFragment)===-1&&(this.shaders.vertex.head=`${this.shaders.vertex.head}
@group(${r.groupIndex}) @binding(${r.bindIndex}) ${r.wgslGroupFragment}`,r.newLine&&(this.shaders.vertex.head+=`
`))),(r.visibility===GPUShaderStage.FRAGMENT||r.visibility===(GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE))&&(r.wgslStructFragment&&this.shaders.fragment.head.indexOf(r.wgslStructFragment)===-1&&(this.shaders.fragment.head=`
${r.wgslStructFragment}
${this.shaders.fragment.head}`),this.shaders.fragment.head.indexOf(r.wgslGroupFragment)===-1&&(this.shaders.fragment.head=`${this.shaders.fragment.head}
@group(${r.groupIndex}) @binding(${r.bindIndex}) ${r.wgslGroupFragment}`,r.newLine&&(this.shaders.fragment.head+=`
`)))}),this.shaders.vertex.head=`${this.attributes.wgslStructFragment}
${this.shaders.vertex.head}`,this.shaders.vertex.code=this.shaders.vertex.head+this.options.shaders.vertex.code,this.shaders.fragment.code=this.shaders.fragment.head+this.options.shaders.fragment.code,this.shaders.full.code=this.shaders.vertex.code+`
`+this.shaders.fragment.code}createShaders(){this.patchShaders(),this.shaders.vertex.module=this.createShaderModule({code:this.shaders.vertex.code,type:"vertex"}),this.shaders.fragment.module=this.createShaderModule({code:this.shaders.fragment.code,type:"fragment"})}createPipelineDescriptor(){if(!this.shaders.vertex.module||!this.shaders.fragment.module)return;let t=-1;this.descriptor={label:this.options.label,layout:this.layout,vertex:{module:this.shaders.vertex.module,entryPoint:this.options.shaders.vertex.entryPoint,buffers:this.attributes.vertexBuffers.map(r=>({stepMode:r.stepMode,arrayStride:r.arrayStride*4,attributes:r.attributes.map(s=>(t++,{shaderLocation:t,offset:s.bufferOffset,format:s.bufferFormat}))}))},fragment:{module:this.shaders.fragment.module,entryPoint:this.options.shaders.fragment.entryPoint,targets:[{format:this.renderer.preferredFormat,...this.options.transparent&&{blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha"}}}}]},primitive:{frontFace:this.options.verticesOrder,cullMode:this.options.cullMode},depthStencil:{depthWriteEnabled:this.options.depthWriteEnabled,depthCompare:this.options.depthCompare,format:"depth24plus"},...this.renderer.sampleCount>1&&{multisample:{count:this.renderer.sampleCount}}}}createRenderPipeline(){if(!(!this.shaders.vertex.module||!this.shaders.fragment.module))try{this.pipeline=this.renderer.createRenderPipeline(this.descriptor)}catch(t){this.status.error=t,V(t)}}async createRenderPipelineAsync(){if(!(!this.shaders.vertex.module||!this.shaders.fragment.module))try{this.pipeline=await this.renderer.createRenderPipelineAsync(this.descriptor),this.status.compiled=!0,this.status.compiling=!1,this.status.error=null}catch(t){this.status.error=t,V(t)}}setPipelineEntry(){super.setPipelineEntry(),this.options.useAsync?this.createRenderPipelineAsync():(this.createRenderPipeline(),this.status.compiled=!0,this.status.compiling=!1,this.status.error=null)}};var Te=class extends ae{constructor(t){let{renderer:r}=t,{label:s}=t;r=r&&r.renderer||r;let i="ComputePipelineEntry";g(r,s?s+" "+i:i);super(t);this.type=i,this.shaders={compute:{head:"",code:"",module:null}},this.descriptor=null}setPipelineEntryProperties(t){let{bindGroups:r}=t;this.setPipelineEntryBindGroups(r),this.setPipelineEntry()}patchShaders(){this.shaders.compute.head="",this.shaders.compute.code="";let t=[];this.bindGroups.forEach(r=>{let s=0;r.bindings.forEach((i,n)=>{i.wgslGroupFragment.forEach((o,u)=>{t.push({groupIndex:r.index,visibility:i.visibility,bindIndex:s,wgslStructFragment:i.wgslStructFragment,wgslGroupFragment:o,newLine:n===r.bindings.length-1&&u===i.wgslGroupFragment.length-1}),s++})})}),t.forEach(r=>{r.wgslStructFragment&&this.shaders.compute.head.indexOf(r.wgslStructFragment)===-1&&(this.shaders.compute.head=`
${r.wgslStructFragment}
${this.shaders.compute.head}`),this.shaders.compute.head.indexOf(r.wgslGroupFragment)===-1&&(this.shaders.compute.head=`${this.shaders.compute.head}
@group(${r.groupIndex}) @binding(${r.bindIndex}) ${r.wgslGroupFragment}`),r.newLine&&(this.shaders.compute.head+=`
`)}),this.shaders.compute.code=this.shaders.compute.head+this.options.shaders.compute.code}createShaders(){this.patchShaders(),this.shaders.compute.module=this.createShaderModule({code:this.shaders.compute.code,type:"compute"})}createPipelineDescriptor(){this.shaders.compute.module&&(this.descriptor={label:this.options.label,layout:this.layout,compute:{module:this.shaders.compute.module,entryPoint:this.options.shaders.compute.entryPoint}})}createComputePipeline(){if(this.shaders.compute.module)try{this.pipeline=this.renderer.createComputePipeline(this.descriptor)}catch(t){this.status.error=t,V(t)}}async createComputePipelineAsync(){if(this.shaders.compute.module)try{this.pipeline=await this.renderer.createComputePipelineAsync(this.descriptor),this.status.compiled=!0,this.status.compiling=!1,this.status.error=null}catch(t){this.status.error=t,V(t)}}setPipelineEntry(){super.setPipelineEntry(),this.options.useAsync?this.createComputePipelineAsync():(this.createComputePipeline(),this.status.compiled=!0,this.status.compiling=!1,this.status.error=null)}};var Ge=class{constructor({renderer:e}){this.type="PipelineManager",e=e&&e.renderer||e,g(e,this.type),this.renderer=e,this.currentPipelineIndex=null,this.pipelineEntries=[]}isSameRenderPipeline(e){let{shaders:t,cullMode:r,depthWriteEnabled:s,depthCompare:i,transparent:n,verticesOrder:o}=e;return this.pipelineEntries.filter(u=>u.type==="RenderPipelineEntry").find(u=>{let{options:a}=u;return t.vertex.code.localeCompare(a.shaders.vertex.code)===0&&t.fragment.code.localeCompare(a.shaders.fragment.code)===0&&r===a.cullMode&&s===a.depthWriteEnabled&&i===a.depthCompare&&n===a.transparent&&o===a.verticesOrder})}createRenderPipeline(e){let t=this.isSameRenderPipeline(e);if(t)return t;{let r=new Me({renderer:this.renderer,...e});return this.pipelineEntries.push(r),r}}createComputePipeline(e){let t=new Te({renderer:this.renderer,...e});return this.pipelineEntries.push(t),t}setCurrentPipeline(e,t){t.index!==this.currentPipelineIndex&&(e.setPipeline(t.pipeline),this.currentPipelineIndex=t.index)}resetCurrentPipeline(){this.currentPipelineIndex=null}};var Ce=class extends oe{constructor(t,r,s){super(t);this.#e=new p;this.#t=new p;t=t&&t.renderer||t,fe(t,"DOM3DObject"),this.renderer=t,this.size={world:{width:0,height:0,top:0,left:0},document:{width:0,height:0,top:0,left:0}},this.watchScroll=s.watchScroll,this.camera=this.renderer.camera,this.setDOMElement(r)}#e;#t;setDOMElement(t){this.domElement=new q({element:t,onSizeChanged:r=>this.resize(r),onPositionChanged:r=>{this.watchScroll&&(this.size.document=r,this.updateSizeAndPosition())}})}resetDOMElement(t){this.domElement&&this.domElement.destroy(),this.setDOMElement(t)}updateSizeAndPosition(){this.setWorldSizes(),this.applyPosition(),super.updateSizeAndPosition()}updateSizePositionAndProjection(){this.updateSizeAndPosition(),super.updateSizePositionAndProjection()}resize(t=null){!t&&(!this.domElement||this.domElement?.isResizing)||(this.size.document=t??this.domElement.element.getBoundingClientRect(),this.updateSizePositionAndProjection())}get boundingRect(){return this.domElement.boundingRect}setTransforms(){super.setTransforms(),this.transforms.origin.model.set(.5,.5,0),this.transforms.origin.world=new p,this.transforms.position.document=new p,this.documentPosition.onChange(()=>this.applyPosition()),this.transformOrigin.onChange(()=>this.setWorldTransformOrigin())}get documentPosition(){return this.transforms.position.document}set documentPosition(t){this.transforms.position.document=t,this.applyPosition()}get worldScale(){return this.#t.clone().multiply(this.scale)}get worldPosition(){return this.#e}get transformOrigin(){return this.transforms.origin.model}set transformOrigin(t){this.transforms.origin.model=t,this.setWorldTransformOrigin()}get worldTransformOrigin(){return this.transforms.origin.world}set worldTransformOrigin(t){this.transforms.origin.world=t}applyPosition(){this.applyDocumentPosition(),super.applyPosition()}applyDocumentPosition(){let t=new p(0,0,0);this.documentPosition.equals(t)||(t=this.documentToWorldSpace(this.documentPosition)),this.#e.set(this.position.x+this.size.world.left+t.x,this.position.y+this.size.world.top+t.y,this.position.z+this.documentPosition.z/this.camera.CSSPerspective)}applyTransformOrigin(){this.size&&(this.setWorldTransformOrigin(),super.applyTransformOrigin())}updateModelMatrix(){this.modelMatrix.composeFromOrigin(this.#e,this.quaternion,this.scale,this.worldTransformOrigin),this.modelMatrix.scale(this.#t)}documentToWorldSpace(t=new p){return new p(t.x*this.renderer.pixelRatio/this.renderer.boundingRect.width*this.camera.screenRatio.width,-(t.y*this.renderer.pixelRatio/this.renderer.boundingRect.height)*this.camera.screenRatio.height,t.z)}setWorldSizes(){let t=this.renderer.boundingRect,r={x:this.size.document.width/2+this.size.document.left,y:this.size.document.height/2+this.size.document.top},s={x:t.width/2+t.left,y:t.height/2+t.top};this.size.world={width:this.size.document.width/t.width*this.camera.screenRatio.width/2,height:this.size.document.height/t.height*this.camera.screenRatio.height/2,top:(s.y-r.y)/t.height*this.camera.screenRatio.height,left:(r.x-s.x)/t.width*this.camera.screenRatio.width},this.#t.set(this.size.world.width,this.size.world.height,1),this.setWorldTransformOrigin()}setWorldTransformOrigin(){this.transforms.origin.world=new p((this.transformOrigin.x*2-1)*this.size.world.width,-(this.transformOrigin.y*2-1)*this.size.world.height,this.transformOrigin.z),this.shouldUpdateModelMatrix(),this.shouldUpdateProjectionMatrixStack()}updateScrollPosition(t={x:0,y:0}){(t.x||t.y)&&this.domElement.updateScrollPosition(t)}destroy(){this.domElement?.destroy()}};var ft={autoloadSources:!0,watchScroll:!0},ue=class extends je(Ce){constructor(t,r,s){super(t,r,{...ft,...s});this._onLoadingCallback=t=>{};s={...ft,...s},t=t&&t.renderer||t,fe(t,s.label?s.label+" DOMMesh":"DOMMesh"),this.type="DOMMesh";let{autoloadSources:i}=s;this.autoloadSources=i,this.sourcesReady=!1,this.setInitSources()}get ready(){return this._ready}set ready(t){this._ready=t,this.DOMMeshReady&&this._onReadyCallback&&this._onReadyCallback()}get sourcesReady(){return this._sourcesReady}set sourcesReady(t){this._sourcesReady=t,this.DOMMeshReady&&this._onReadyCallback&&this._onReadyCallback()}get DOMMeshReady(){return this.ready&&this.sourcesReady}addToScene(){super.addToScene(),this.renderer.domMeshes.push(this)}removeFromScene(){super.removeFromScene(),this.renderer.domMeshes=this.renderer.domMeshes.filter(t=>t.uuid!==this.uuid)}setInitSources(){let t=0,r=0;if(this.autoloadSources){let s=this.domElement.element.querySelectorAll("img"),i=this.domElement.element.querySelectorAll("video"),n=this.domElement.element.querySelectorAll("canvas");t=s.length+i.length+n.length;let o=u=>{r++,this._onLoadingCallback&&this._onLoadingCallback(u),r===t&&(this.sourcesReady=!0)};t||(this.sourcesReady=!0),s.length&&s.forEach(u=>{let a=this.createTexture({name:u.getAttribute("data-texture-name")??"texture"+this.textures.length});a.onSourceUploaded(()=>o(a)).loadImage(u.src)}),i.length&&i.forEach(u=>{let a=this.createTexture({name:u.getAttribute("data-texture-name")??"texture"+this.textures.length});a.onSourceUploaded(()=>o(a)).loadVideo(u)}),n.length&&n.forEach(u=>{let a=this.createTexture({name:u.getAttribute("data-texture-name")??"texture"+this.textures.length});a.onSourceUploaded(()=>o(a)).loadCanvas(u)})}else this.sourcesReady=!0}resetDOMElement(t){t?super.resetDOMElement(t):!t&&!this.renderer.production&&L(`${this.options.label}: You are trying to reset a ${this.type} with a HTML element that does not exist. The old HTML element will be kept instead.`)}get pixelRatioBoundingRect(){let t=window.devicePixelRatio??1,r=this.renderer.pixelRatio/t;return Object.keys(this.domElement.boundingRect).reduce((s,i)=>({...s,[i]:this.domElement.boundingRect[i]*r}),{x:0,y:0,width:0,height:0,top:0,right:0,bottom:0,left:0})}createRenderTexture(t){return t={...t,size:{width:this.pixelRatioBoundingRect.width,height:this.pixelRatioBoundingRect.height}},super.createRenderTexture(t)}resizeRenderTextures(){this.renderTextures?.filter(t=>t.options.usage==="texture").forEach(t=>t.resize({width:this.pixelRatioBoundingRect.width,height:this.pixelRatioBoundingRect.height}))}onLoading(t){return t&&(this._onLoadingCallback=t),this}};var wt={label:"Plane",instancesCount:1,vertexBuffers:[]},we=class extends ue{constructor(e,t,r={}){e=e&&e.renderer||e,fe(e,r.label?r.label+" Plane":"Plane");let s={...wt,...r},{geometry:i,widthSegments:n,heightSegments:o,...u}=s,{instancesCount:a,vertexBuffers:h,...m}=u;if(!i||i.type!=="PlaneGeometry"){n=n??1,o=o??1;let l=n*o+n;h.length||(i=Re.getPlaneGeometryByID(l)),i?i.instancesCount=a:(i=new ie({widthSegments:n,heightSegments:o,instancesCount:a,vertexBuffers:h}),Re.addPlaneGeometry(i))}super(e,t,{geometry:i,...m}),this.type="Plane"}mouseToPlaneCoords(e=new $){let t={x:2*(e.x/this.renderer.boundingRect.width)-1,y:2*(1-e.y/this.renderer.boundingRect.height)-1},r=this.camera.position.clone(),s=new p(t.x,t.y,-.5);s.unproject(this.camera),s.sub(r).normalize();let i=new p(0,0,1);i.applyQuat(this.quaternion).normalize();let n=new p(0,0,0),o=i.dot(s);if(Math.abs(o)>=1e-4){let u=this.modelMatrix.getInverse().multiply(this.camera.viewMatrix),a=this.worldTransformOrigin.clone().add(this.worldPosition),h=new p(this.worldPosition.x-a.x,this.worldPosition.y-a.y,this.worldPosition.z-a.z);h.applyQuat(this.quaternion),a.add(h);let m=i.dot(a.clone().sub(r))/o;n.copy(r.add(s.multiplyScalar(m))),n.applyMat4(u)}else n.set(1/0,1/0,1/0);return new $(n.x,n.y)}};var Ee=class{constructor({renderer:e}){e=e&&e.renderer||e,g(e,"Scene"),this.renderer=e,this.computePassEntries=[],this.renderPassEntries={pingPong:[],renderTarget:[],screen:[{renderPass:this.renderer.renderPass,renderTexture:null,onBeforeRenderPass:null,onAfterRenderPass:null,element:null,stack:{unProjected:{opaque:[],transparent:[]},projected:{opaque:[],transparent:[]}}}]}}addComputePass(e){this.computePassEntries.push(e),this.computePassEntries.sort((t,r)=>t.renderOrder!==r.renderOrder?t.renderOrder-r.renderOrder:t.index-r.index)}removeComputePass(e){this.computePassEntries=this.computePassEntries.filter(t=>t.uuid!==e.uuid)}addRenderTarget(e){this.renderPassEntries.renderTarget.find(t=>t.renderPass.uuid===e.renderPass.uuid)||this.renderPassEntries.renderTarget.push({renderPass:e.renderPass,renderTexture:e.renderTexture,onBeforeRenderPass:null,onAfterRenderPass:null,element:null,stack:{unProjected:{opaque:[],transparent:[]},projected:{opaque:[],transparent:[]}}})}removeRenderTarget(e){this.renderPassEntries.renderTarget=this.renderPassEntries.renderTarget.filter(t=>t.renderPass.uuid!==e.renderPass.uuid)}getMeshProjectionStack(e){let t=e.renderTarget?this.renderPassEntries.renderTarget.find(s=>s.renderPass.uuid===e.renderTarget.renderPass.uuid):this.renderPassEntries.screen[0],{stack:r}=t;return e.material.options.rendering.useProjection?r.projected:r.unProjected}addMesh(e){let t=this.getMeshProjectionStack(e),r=e.transparent?[...t.transparent]:[...t.opaque],s=-1;for(let i=r.length-1;i>=0;i--)if(r[i].material.pipelineEntry.index===e.material.pipelineEntry.index){s=i+1;break}s=Math.max(0,s),r.splice(s,0,e),r.sort((i,n)=>i.index-n.index),(e instanceof ue||e instanceof we)&&e.transparent&&r.sort((i,n)=>n.documentPosition.z-i.documentPosition.z),r.sort((i,n)=>i.renderOrder-n.renderOrder),e.transparent?t.transparent=r:t.opaque=r}removeMesh(e){let t=this.getMeshProjectionStack(e);e.transparent?t.transparent=t.transparent.filter(r=>r.uuid!==e.uuid):t.opaque=t.opaque.filter(r=>r.uuid!==e.uuid)}addShaderPass(e){this.renderPassEntries.screen.push({renderPass:this.renderer.renderPass,renderTexture:null,onBeforeRenderPass:(t,r)=>{e.renderTexture&&t.copyTextureToTexture({texture:e.renderTarget?e.renderTarget.renderTexture.texture:r},{texture:e.renderTexture.texture},[e.renderTexture.size.width,e.renderTexture.size.height]),e.renderTarget||this.renderer.renderPass.setLoadOp("clear")},onAfterRenderPass:(t,r)=>{e.renderTarget&&t.copyTextureToTexture({texture:r},{texture:e.renderTarget.renderTexture.texture},[e.renderTexture.size.width,e.renderTexture.size.height])},element:e,stack:null}),this.renderPassEntries.screen.sort((t,r)=>{let s=t.element&&!t.element.renderTarget,i=t.element?t.element.renderOrder:0,n=t.element?t.element.index:0,o=r.element&&!r.element.renderTarget,u=r.element?r.element.renderOrder:0,a=r.element?r.element.index:0;return s&&!o?1:!s&&o?-1:i!==u?i-u:n-a})}removeShaderPass(e){this.renderPassEntries.screen=this.renderPassEntries.screen.filter(t=>!t.element||t.element.uuid!==e.uuid)}addPingPongPlane(e){this.renderPassEntries.pingPong.push({renderPass:e.renderTarget.renderPass,renderTexture:e.renderTarget.renderTexture,onBeforeRenderPass:null,onAfterRenderPass:(t,r)=>{t.copyTextureToTexture({texture:r},{texture:e.renderTexture.texture},[e.renderTexture.size.width,e.renderTexture.size.height])},element:e,stack:null}),this.renderPassEntries.pingPong.sort((t,r)=>t.element.renderOrder-r.element.renderOrder)}removePingPongPlane(e){this.renderPassEntries.pingPong=this.renderPassEntries.pingPong.filter(t=>t.element.uuid!==e.uuid)}renderSinglePassEntry(e,t){let r=this.renderer.setRenderPassCurrentTexture(t.renderPass,t.renderTexture?.texture);t.onBeforeRenderPass&&t.onBeforeRenderPass(e,r);let s=e.beginRenderPass(t.renderPass.descriptor);t.element?t.element.render(s):t.stack&&(t.stack.unProjected.opaque.forEach(i=>i.render(s)),t.stack.unProjected.transparent.forEach(i=>i.render(s)),(t.stack.projected.opaque.length||t.stack.projected.transparent.length)&&(this.renderer.cameraBindGroup&&s.setBindGroup(this.renderer.cameraBindGroup.index,this.renderer.cameraBindGroup.bindGroup),t.stack.projected.opaque.forEach(i=>i.render(s)),t.stack.projected.transparent.forEach(i=>i.render(s)))),s.end(),t.onAfterRenderPass&&t.onAfterRenderPass(e,r),this.renderer.pipelineManager.resetCurrentPipeline()}render(e){this.computePassEntries.forEach(t=>{if(!t.canRender)return;let r=e.beginComputePass();t.render(r),r.end(),t.copyBufferToResult(e),this.renderer.pipelineManager.resetCurrentPipeline()});for(let t in this.renderPassEntries){let r=0;this.renderPassEntries[t].forEach(s=>{!s.element&&!s.stack.unProjected.opaque.length&&!s.stack.unProjected.transparent.length&&!s.stack.projected.opaque.length&&!s.stack.projected.transparent.length||(s.renderPass.setLoadOp(t==="screen"&&r!==0?"load":"clear"),r++,this.renderSinglePassEntry(e,s))})}}onAfterCommandEncoder(){this.computePassEntries.forEach(e=>{e.setWorkGroupsResult()})}};var de=class{constructor(e,{label:t="Render Pass",depth:r=!0,loadOp:s="clear",clearValue:i=[0,0,0,0]}={}){e=e&&e.renderer||e,g(e,"RenderPass"),this.type="RenderPass",this.uuid=k(),this.renderer=e,this.options={label:t,depth:r,loadOp:s,clearValue:i},this.setSize(this.renderer.pixelRatioBoundingRect),this.sampleCount=this.renderer.sampleCount,this.options.depth&&this.createDepthTexture(),this.createRenderTexture(),this.setRenderPassDescriptor()}createDepthTexture(){this.depthTexture=this.renderer.createTexture({label:this.options.label+" depth attachment texture",size:[this.size.width,this.size.height],format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT,sampleCount:this.sampleCount})}createRenderTexture(){this.renderTexture=this.renderer.createTexture({label:this.options.label+" color attachment texture",size:[this.size.width,this.size.height],sampleCount:this.sampleCount,format:this.renderer.preferredFormat,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST|GPUTextureUsage.TEXTURE_BINDING})}resetRenderPassDepth(){this.depthTexture&&this.depthTexture.destroy(),this.createDepthTexture(),this.descriptor.depthStencilAttachment.view=this.depthTexture.createView()}resetRenderPassView(){this.renderTexture&&this.renderTexture.destroy(),this.createRenderTexture(),this.descriptor.colorAttachments[0].view=this.renderTexture.createView()}setRenderPassDescriptor(){this.descriptor={label:this.options.label+" descriptor",colorAttachments:[{view:this.renderTexture.createView(),clearValue:this.options.clearValue,loadOp:this.options.loadOp,storeOp:"store"}],...this.options.depth&&{depthStencilAttachment:{view:this.depthTexture.createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}}}}setSize(e){this.size={width:Math.floor(e.width),height:Math.floor(e.height)}}resize(e){this.setSize(e),this.options.depth&&this.resetRenderPassDepth(),this.resetRenderPassView()}setLoadOp(e="clear"){this.options.loadOp=e,this.descriptor&&this.descriptor.colorAttachments&&(this.descriptor.colorAttachments[0].loadOp=e)}destroy(){this.renderTexture?.destroy(),this.depthTexture?.destroy()}};var pe=class{constructor(){this.#e=0;this.queue=[]}#e;add(e=s=>{},{order:t=this.queue.length,once:r=!1}={}){let s={callback:e,order:t,once:r,id:this.#e};return this.#e++,this.queue.push(s),this.queue.sort((i,n)=>i.order-n.order),s.id}remove(e=0){this.queue=this.queue.filter(t=>t.id!==e)}execute(e){this.queue.forEach(t=>{t.callback(e),t.once&&this.remove(t.id)})}};var Ue=class{constructor({container:e,pixelRatio:t=1,sampleCount:r=4,production:s=!1,preferredFormat:i,onError:n=()=>{}}){this._onBeforeRenderCallback=e=>{};this._onAfterRenderCallback=e=>{};this.type="GPURenderer",this.ready=!1,this.gpu=navigator.gpu,this.pixelRatio=t??window.devicePixelRatio??1,this.sampleCount=r,this.production=s,this.preferredFormat=i,this.onError=n,this.gpu||setTimeout(()=>{this.onError(),V("GPURenderer: WebGPU is not supported on your browser/OS. No 'gpu' object in 'navigator'.")},0),this.setTasksQueues(),this.setRendererObjects(),this.canvas=document.createElement("canvas"),this.domElement=new q({element:e}),this.documentBody=new q({element:document.body,onSizeChanged:()=>this.resize()}),this.texturesQueue=[]}setSize(e){let t=window.devicePixelRatio??1,r=this.pixelRatio/t;this.canvas.style.width=Math.floor(e.width)+"px",this.canvas.style.height=Math.floor(e.height)+"px";let s={width:Math.floor(e.width*r),height:Math.floor(e.height*r)};this.canvas.width=this.device?Math.min(s.width,this.device.limits.maxTextureDimension2D):s.width,this.canvas.height=this.device?Math.min(s.height,this.device.limits.maxTextureDimension2D):s.height}resize(e=null){this.domElement&&(e||(e=this.domElement.element.getBoundingClientRect()),this.setSize(e),this.onResize())}onResize(){this.renderPass?.resize(this.pixelRatioBoundingRect),this.renderTargets.forEach(e=>e.resize(this.pixelRatioBoundingRect)),this.pingPongPlanes.forEach(e=>e.resize(this.boundingRect)),this.shaderPasses.forEach(e=>e.resize(this.boundingRect)),this.computePasses.forEach(e=>e.resize()),this.meshes.forEach(e=>{"domElement"in e||e.resize(this.boundingRect)})}get boundingRect(){return this.domElement.boundingRect}get pixelRatioBoundingRect(){let e=window.devicePixelRatio??1,t=this.pixelRatio/e;return Object.keys(this.domElement.boundingRect).reduce((r,s)=>({...r,[s]:this.domElement.boundingRect[s]*t}),{x:0,y:0,width:0,height:0,top:0,right:0,bottom:0,left:0})}async setContext(){this.context=this.canvas.getContext("webgpu"),await this.setAdapterAndDevice(),this.device&&(this.preferredFormat=this.preferredFormat??this.gpu?.getPreferredCanvasFormat(),this.context.configure({device:this.device,format:this.preferredFormat,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST,alphaMode:"premultiplied"}),this.setMainRenderPass(),this.setPipelineManager(),this.setScene(),this.ready=!0)}async setAdapterAndDevice(){this.adapter=await this.gpu?.requestAdapter().catch(()=>{setTimeout(()=>{this.onError(),V("GPURenderer: WebGPU is not supported on your browser/OS. 'requestAdapter' failed.")},0)});try{this.device=await this.adapter?.requestDevice()}catch(e){setTimeout(()=>{this.onError(),V(`GPURenderer: WebGPU is not supported on your browser/OS. 'requestDevice' failed: ${e}`)},0)}this.device?.lost.then(e=>{L(`GPURenderer: WebGPU device was lost: ${e.message}`),e.reason})}setMainRenderPass(){this.renderPass=new de(this,{label:"Main Render pass",depth:!0})}setPipelineManager(){this.pipelineManager=new Ge({renderer:this})}setScene(){this.scene=new Ee({renderer:this})}createBuffer(e){return this.device?.createBuffer(e)}queueWriteBuffer(e,t,r){this.device?.queue.writeBuffer(e,t,r)}createBindGroupLayout(e){return this.device?.createBindGroupLayout(e)}createBindGroup(e){return this.device?.createBindGroup(e)}createShaderModule(e){return this.device?.createShaderModule(e)}createPipelineLayout(e){return this.device?.createPipelineLayout(e)}createRenderPipeline(e){return this.device?.createRenderPipeline(e)}async createRenderPipelineAsync(e){return await this.device?.createRenderPipelineAsync(e)}createComputePipeline(e){return this.device?.createComputePipeline(e)}async createComputePipelineAsync(e){return await this.device?.createComputePipelineAsync(e)}addTexture(e){this.textures.push(e),this.setTexture(e)}removeTexture(e){this.textures.filter(t=>t.uuid!==e.uuid)}setTexture(e){e.texture||e.createTexture()}createTexture(e){return this.device?.createTexture(e)}uploadTexture(e){if(e.source)try{this.device?.queue.copyExternalImageToTexture({source:e.source,flipY:e.options.flipY},{texture:e.texture},{width:e.size.width,height:e.size.height}),e.texture.mipLevelCount>1&&rt(this.device,e.texture),this.texturesQueue.push(e)}catch({message:t}){V(`GPURenderer: could not upload texture: ${e.options.name} because: ${t}`)}else this.device?.queue.writeTexture({texture:e.texture},new Uint8Array(e.options.placeholderColor),{bytesPerRow:e.size.width*4},{width:e.size.width,height:e.size.height})}importExternalTexture(e){return this.device?.importExternalTexture({source:e})}createSampler(e){let t=this.samplers.find(r=>JSON.stringify(r.options)===JSON.stringify(e.options)&&r.sampler);if(t)return t.sampler;{let r=this.device?.createSampler({label:e.label,...e.options});return this.samplers.push(e),r}}setTasksQueues(){this.onBeforeCommandEncoderCreation=new pe,this.onBeforeRenderScene=new pe,this.onAfterRenderScene=new pe,this.onAfterCommandEncoderSubmission=new pe}setRendererObjects(){this.computePasses=[],this.pingPongPlanes=[],this.shaderPasses=[],this.renderTargets=[],this.meshes=[],this.samplers=[],this.textures=[]}onBeforeRender(e){return e&&(this._onBeforeRenderCallback=e),this}onAfterRender(e){return e&&(this._onAfterRenderCallback=e),this}setRenderPassCurrentTexture(e,t=null){return t||(t=this.context.getCurrentTexture()),this.sampleCount>1?e.descriptor.colorAttachments[0].resolveTarget=t.createView():e.descriptor.colorAttachments[0].view=t.createView(),t}onBeforeCommandEncoder(){}onAfterCommandEncoder(){this.scene.onAfterCommandEncoder()}render(){if(!this.ready)return;this.onBeforeCommandEncoder(),this.onBeforeCommandEncoderCreation.execute();let e=this.device?.createCommandEncoder({label:"Renderer command encoder"});this._onBeforeRenderCallback&&this._onBeforeRenderCallback(e),this.onBeforeRenderScene.execute(e),this.scene.render(e),this._onAfterRenderCallback&&this._onAfterRenderCallback(e),this.onAfterRenderScene.execute(e);let t=e.finish();this.device?.queue.submit([t]),this.textures.filter(r=>!r.parent&&r.sourceLoaded&&!r.sourceUploaded).forEach(r=>this.uploadTexture(r)),this.texturesQueue.forEach(r=>{r.sourceUploaded=!0}),this.texturesQueue=[],this.onAfterCommandEncoder(),this.onAfterCommandEncoderSubmission.execute()}destroy(){this.domElement?.destroy(),this.documentBody?.destroy(),this.meshes.forEach(e=>e.remove()),this.textures=[],this.texturesQueue=[],this.renderPass?.destroy(),this.renderTargets.forEach(e=>e.destroy()),this.shaderPasses.forEach(e=>e.remove()),this.pingPongPlanes.forEach(e=>e.remove()),this.device?.destroy(),this.context?.unconfigure()}};var ve=class extends Ue{constructor({container:t,pixelRatio:r=1,sampleCount:s=4,preferredFormat:i,production:n=!1,camera:o={},onError:u=()=>{}}){super({container:t,pixelRatio:r,sampleCount:s,preferredFormat:i,production:n,onError:u});this.type="GPUCameraRenderer",o={fov:50,near:.01,far:50,...o},this.setCamera(o)}setCamera(t){let r=this.boundingRect?this.boundingRect.width:1,s=this.boundingRect?this.boundingRect.height:1;this.camera=new ge({fov:t.fov,near:t.near,far:t.far,width:r,height:s,pixelRatio:this.pixelRatio,onPositionChanged:()=>{this.onCameraPositionChanged()}}),this.setCameraBufferBinding()}onCameraPositionChanged(){this.setPerspective()}setCameraBufferBinding(){this.cameraBufferBinding=new _({label:"Camera",name:"camera",visibility:"vertex",bindings:{model:{name:"model",type:"mat4x4f",value:this.camera.modelMatrix,onBeforeUpdate:()=>{this.cameraBufferBinding.bindings.model.value=this.camera.modelMatrix}},view:{name:"view",type:"mat4x4f",value:this.camera.viewMatrix,onBeforeUpdate:()=>{this.cameraBufferBinding.bindings.view.value=this.camera.viewMatrix}},projection:{name:"projection",type:"mat4x4f",value:this.camera.projectionMatrix,onBeforeUpdate:()=>{this.cameraBufferBinding.bindings.projection.value=this.camera.projectionMatrix}}}}),this.cameraBindGroup=new X(this,{label:"Camera Uniform bind group",bindings:[this.cameraBufferBinding]})}setCameraBindGroup(){this.cameraBindGroup.shouldCreateBindGroup&&(this.cameraBindGroup.setIndex(0),this.cameraBindGroup.createBindGroup())}updateCameraMatrixStack(){this.cameraBufferBinding?.shouldUpdateBinding("model"),this.cameraBufferBinding?.shouldUpdateBinding("view"),this.cameraBufferBinding?.shouldUpdateBinding("projection")}setPerspective(t,r,s){this.camera?.setPerspective(t,r,s,this.boundingRect.width,this.boundingRect.height,this.pixelRatio)}setCameraPosition(t=new p(0,0,1)){this.camera.setPosition(t)}onResize(){super.onResize(),this.setPerspective(),this.updateCameraMatrixStack()}render(){this.ready&&(this.setCameraBindGroup(),this.cameraBindGroup?.update(),super.render())}destroy(){this.cameraBindGroup?.destroy(),super.destroy()}};var Se=class{constructor(e,t){this.#e=!0;e=e&&e.renderer||e,g(e,"RenderTarget"),this.type="RenderTarget",this.renderer=e,this.uuid=k();let{label:r,depth:s,loadOp:i,clearValue:n,autoAddToScene:o}=t;this.options={label:r,depth:s,loadOp:i,clearValue:n,autoAddToScene:o},o!==void 0&&(this.#e=o),this.renderPass=new de(this.renderer,{label:this.options.label?`${this.options.label} Render Pass`:"Render Target Render Pass",depth:this.options.depth,loadOp:this.options.loadOp,clearValue:this.options.clearValue}),this.renderTexture=new j(this.renderer,{label:this.options.label?`${this.options.label} Render Texture`:"Render Target Render Texture",name:"renderTexture"}),this.addToScene()}#e;addToScene(){this.renderer.renderTargets.push(this),this.#e&&this.renderer.scene.addRenderTarget(this)}removeFromScene(){this.#e&&this.renderer.scene.removeRenderTarget(this),this.renderer.renderTargets=this.renderer.renderTargets.filter(e=>e.uuid!==this.uuid)}resize(e){this.renderPass?.resize(e),this.renderTexture?.resize()}remove(){this.destroy()}destroy(){this.renderer.meshes.forEach(e=>{e.renderTarget&&e.renderTarget.uuid===this.uuid&&e.setRenderTarget(null)}),this.renderer.shaderPasses.forEach(e=>{e.renderTarget&&e.renderTarget.uuid===this.uuid&&(e.renderTarget=null,e.setRenderTarget(null))}),this.removeFromScene(),this.renderPass?.destroy(),this.renderTexture?.destroy()}};var $e=class extends ne{constructor(t,r){t=t&&t.renderer||t,g(t,r.label?r.label+" ShaderPass":"ShaderPass"),r.transparent=!0;super(t,r);this.type="ShaderPass",this.createRenderTexture({label:r.label?`${r.label} render texture`:"Shader pass render texture",name:"renderTexture"})}get renderTexture(){return this.renderTextures[0]??null}addToScene(){this.renderer.shaderPasses.push(this),this.autoAddToScene&&this.renderer.scene.addShaderPass(this)}removeFromScene(){this.renderTarget&&this.renderTarget.destroy(),this.autoAddToScene&&this.renderer.scene.removeShaderPass(this),this.renderer.shaderPasses=this.renderer.shaderPasses.filter(t=>t.uuid!==this.uuid)}};var He=class extends ne{constructor(t,r={}){t=t&&t.renderer||t,g(t,r.label?r.label+" PingPongPlane":"PingPongPlane"),r.renderTarget=new Se(t,{label:r.label?r.label+" render target":"Ping Pong render target"}),r.transparent=!1;super(t,r);this.type="PingPongPlane",this.createRenderTexture({label:r.label?`${r.label} render texture`:"PingPongPlane render texture",name:"renderTexture"})}get renderTexture(){return this.renderTextures[0]??null}addToScene(){this.renderer.pingPongPlanes.push(this),this.autoAddToScene&&this.renderer.scene.addPingPongPlane(this)}removeFromScene(){this.renderTarget&&this.renderTarget.destroy(),this.autoAddToScene&&this.renderer.scene.removePingPongPlane(this),this.renderer.pingPongPlanes=this.renderer.pingPongPlanes.filter(t=>t.uuid!==this.uuid)}};var Oe=class extends ve{constructor({container:t,pixelRatio:r=1,sampleCount:s=4,preferredFormat:i,production:n=!1,onError:o=()=>{},camera:u}){super({container:t,pixelRatio:r,sampleCount:s,preferredFormat:i,production:n,onError:o,camera:u});this.type="GPUCurtainsRenderer"}onCameraPositionChanged(){super.onCameraPositionChanged(),this.domMeshes?.forEach(t=>t.updateSizePositionAndProjection())}setRendererObjects(){super.setRendererObjects(),this.domMeshes=[]}onResize(){super.onResize(),this.domMeshes?.forEach(t=>{t.domElement&&t.domElement.setSize()})}};var Ne=class{constructor({scroll:e={x:0,y:0},delta:t={x:0,y:0},shouldWatch:r=!0,onScroll:s=(i={x:0,y:0})=>{}}={}){this.scroll=e,this.delta=t,this.shouldWatch=r,this.onScroll=s,this.handler=this.scrollHandler.bind(this,!0),this.shouldWatch&&window.addEventListener("scroll",this.handler,{passive:!0})}scrollHandler(){this.updateScrollValues({x:window.pageXOffset,y:window.pageYOffset})}updateScrollValues({x:e,y:t}){let r=this.scroll;this.scroll={x:e,y:t},this.delta={x:r.x-this.scroll.x,y:r.y-this.scroll.y},this.onScroll&&this.onScroll(this.delta)}destroy(){this.shouldWatch&&window.removeEventListener("scroll",this.handler,{passive:!0})}};var qe=class{constructor({container:e,pixelRatio:t=window.devicePixelRatio??1,sampleCount:r=4,preferredFormat:s,production:i=!1,camera:n,autoRender:o=!0,autoResize:u=!0,watchScroll:a=!0}){this._onRenderCallback=()=>{};this._onScrollCallback=()=>{};this._onAfterResizeCallback=()=>{};this._onErrorCallback=()=>{};this.type="CurtainsGPU",this.options={container:e,pixelRatio:t,sampleCount:r,camera:n,production:i,preferredFormat:s,autoRender:o,autoResize:u,watchScroll:a},e&&this.setContainer(e)}setContainer(e){if(e)if(typeof e=="string")if(e=document.getElementById(e),e)this.options.container=e;else{let t=document.createElement("div");t.setAttribute("id","curtains-gpu-canvas"),document.body.appendChild(t),this.options.container=t}else e instanceof Element&&(this.options.container=e);else{let t=document.createElement("div");t.setAttribute("id","curtains-gpu-canvas"),document.body.appendChild(t),this.options.container=t}this.container=this.options.container,this.setCurtains()}setRenderer(){this.renderer=new Oe({container:this.options.container,pixelRatio:this.options.pixelRatio,sampleCount:this.options.sampleCount,preferredFormat:this.options.preferredFormat,camera:this.options.camera,production:this.options.production,onError:()=>this._onErrorCallback&&this._onErrorCallback()})}async setRendererContext(){await this.renderer.setContext()}setCurtains(){this.initEvents(),this.setRenderer(),this.container.appendChild(this.renderer.canvas),this.options.autoRender&&this.animate()}get pingPongPlanes(){return this.renderer?.pingPongPlanes}get shaderPasses(){return this.renderer?.shaderPasses}get meshes(){return this.renderer?.meshes}get domMeshes(){return this.renderer?.domMeshes}get planes(){return this.renderer?.domMeshes.filter(e=>e.type==="Plane")}get computePasses(){return this.renderer?.computePasses}get camera(){return this.renderer?.camera}setPerspective(e=50,t=.01,r=50){this.renderer?.setPerspective(e,t,r)}setCameraPosition(e=new p(0,0,1)){this.renderer?.setCameraPosition(e)}resize(){this.renderer?.resize(),this._onAfterResizeCallback&&this._onAfterResizeCallback()}get boundingRect(){return this.renderer?.boundingRect}initScroll(){this.scrollManager=new Ne({scroll:{x:window.pageXOffset,y:window.pageYOffset},delta:{x:0,y:0},shouldWatch:this.options.watchScroll,onScroll:e=>this.updateScroll(e)})}updateScroll(e={x:0,y:0}){this.renderer.domMeshes.forEach(t=>{t.domElement&&t.updateScrollPosition(e)}),this._onScrollCallback&&this._onScrollCallback()}updateScrollValues(e={x:0,y:0}){this.scrollManager.updateScrollValues(e)}get scrollDelta(){return this.scrollManager.delta}get scrollValues(){return this.scrollManager.scroll}initEvents(){Ve.useObserver(this.options.autoResize),this.initScroll()}onRender(e){return e&&(this._onRenderCallback=e),this}onScroll(e){return e&&(this._onScrollCallback=e),this}onAfterResize(e){return e&&(this._onAfterResizeCallback=e),this}onError(e){return e&&(this._onErrorCallback=e),this}animate(){this.render(),this.animationFrameID=window.requestAnimationFrame(this.animate.bind(this))}render(){this._onRenderCallback&&this._onRenderCallback(),this.renderer?.render()}destroy(){this.animationFrameID&&window.cancelAnimationFrame(this.animationFrameID),this.renderer?.destroy(),this.scrollManager?.destroy(),Ve.destroy()}};var Qe=class extends J{constructor({widthSegments:e=1,heightSegments:t=1,depthSegments:r=1,instancesCount:s=1,vertexBuffers:i=[]}={}){super({verticesOrder:"ccw",instancesCount:s,vertexBuffers:i}),this.type="BoxGeometry",e=Math.floor(e),t=Math.floor(t),r=Math.floor(r);let n=[],o=[],u=[],a=[],h=0,m=(l,c,x,P,R,f,C,y,B,M)=>{let G=f/B,T=C/M,w=f/2,v=C/2,S=y/2,O=B+1,D=M+1,A=0,E=new p;for(let U=0;U<D;U++){let b=U*T-v;for(let F=0;F<O;F++){let W=F*G-w;E[l]=W*P,E[c]=b*R,E[x]=S,n.push(E.x,E.y,E.z),E[l]=0,E[c]=0,E[x]=y>0?1:-1,u.push(E.x,E.y,E.z),o.push(F/B),o.push(U/M),A+=1}}for(let U=0;U<M;U++)for(let b=0;b<B;b++){let F=h+b+O*U,W=h+b+O*(U+1),K=h+(b+1)+O*(U+1),Q=h+(b+1)+O*U;a.push(F,W,Q),a.push(W,K,Q),h+=A}};m("z","y","x",-1,-1,2,2,2,r,t),m("z","y","x",1,-1,2,2,-2,r,t),m("x","z","y",1,1,2,2,2,e,r),m("x","z","y",1,-1,2,2,-2,e,r),m("x","y","z",1,-1,2,2,2,e,t),m("x","y","z",-1,-1,2,2,-2,e,t),this.setIndexBuffer({array:new Uint32Array(a)}),this.setAttribute({name:"position",type:"vec3f",bufferFormat:"float32x3",size:3,array:new Float32Array(n)}),this.setAttribute({name:"uv",type:"vec2f",bufferFormat:"float32x2",size:2,array:new Float32Array(o)}),this.setAttribute({name:"normal",type:"vec3f",bufferFormat:"float32x3",size:3,array:new Float32Array(u)})}};var Ye=class extends J{constructor({widthSegments:e=32,heightSegments:t=16,phiStart:r=0,phiLength:s=Math.PI*2,thetaStart:i=0,thetaLength:n=Math.PI,instancesCount:o=1,vertexBuffers:u=[]}={}){super({verticesOrder:"ccw",instancesCount:o,vertexBuffers:u}),this.type="SphereGeometry",e=Math.max(3,Math.floor(e)),t=Math.max(2,Math.floor(t));let a=1,h=Math.min(i+n,Math.PI),m=0,l=[],c=new p,x=new p,P=[],R=[],f=[],C=[];for(let y=0;y<=t;y++){let B=[],M=y/t,G=0;y===0&&i===0?G=.5/e:y===t&&h===Math.PI&&(G=-.5/e);for(let T=0;T<=e;T++){let w=T/e;c.x=-a*Math.cos(r+w*s)*Math.sin(i+M*n),c.y=a*Math.cos(i+M*n),c.z=a*Math.sin(r+w*s)*Math.sin(i+M*n),R.push(c.x,c.y,c.z),x.copy(c).normalize(),f.push(x.x,x.y,x.z),C.push(w+G,M),B.push(m++)}l.push(B)}for(let y=0;y<t;y++)for(let B=0;B<e;B++){let M=l[y][B+1],G=l[y][B],T=l[y+1][B],w=l[y+1][B+1];(y!==0||i>0)&&P.push(M,G,w),(y!==t-1||h<Math.PI)&&P.push(G,T,w)}this.setIndexBuffer({array:new Uint32Array(P)}),this.setAttribute({name:"position",type:"vec3f",bufferFormat:"float32x3",size:3,array:new Float32Array(R)}),this.setAttribute({name:"uv",type:"vec2f",bufferFormat:"float32x2",size:2,array:new Float32Array(C)}),this.setAttribute({name:"normal",type:"vec3f",bufferFormat:"float32x3",size:3,array:new Float32Array(f)})}};return Bt(Et);})();
