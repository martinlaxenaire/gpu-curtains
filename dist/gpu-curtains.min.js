var GPUCurtains=(()=>{var qe=Object.defineProperty;var pt=Object.getOwnPropertyDescriptor;var ct=Object.getOwnPropertyNames;var ft=Object.prototype.hasOwnProperty;var xt=(u,e)=>{for(var t in e)qe(u,t,{get:e[t],enumerable:!0})},gt=(u,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of ct(e))!ft.call(u,s)&&s!==t&&qe(u,s,{get:()=>e[s],enumerable:!(r=pt(e,s))||r.enumerable});return u};var yt=u=>gt(qe({},"__esModule",{value:!0}),u);var Ct={};xt(Ct,{BindGroup:()=>X,Bindings:()=>Y,Box3:()=>se,BoxGeometry:()=>Ye,BufferBindings:()=>I,Camera:()=>xe,ComputeMaterial:()=>ye,ComputePass:()=>_e,ComputePipelineEntry:()=>Te,DOMElement:()=>W,DOMFrustum:()=>Pe,DOMMesh:()=>he,DOMObject3D:()=>Ge,FullscreenPlane:()=>ae,GPUCameraRenderer:()=>ve,GPUCurtains:()=>Ne,GPUCurtainsRenderer:()=>Oe,GPURenderer:()=>Ue,Geometry:()=>ie,IndexedGeometry:()=>q,Mat4:()=>z,Material:()=>re,Mesh:()=>Ie,Object3D:()=>ee,PingPongPlane:()=>We,PipelineEntry:()=>ue,PipelineManager:()=>Ce,Plane:()=>we,PlaneGeometry:()=>ne,ProjectedObject3D:()=>de,Quat:()=>j,RenderMaterial:()=>be,RenderPass:()=>le,RenderPipelineEntry:()=>Me,RenderTarget:()=>Se,RenderTexture:()=>oe,Sampler:()=>ge,SamplerBindings:()=>fe,Scene:()=>Ee,ShaderPass:()=>$e,SphereGeometry:()=>Xe,Texture:()=>te,TextureBindGroup:()=>ce,TextureBindings:()=>K,Vec2:()=>_,Vec3:()=>p,WorkBufferBindings:()=>pe});var N=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,u=>{let e=Math.random()*16|0;return(u==="x"?e:e&3|8).toString(16).toUpperCase()}),ze=u=>u.replace(/(?:^\w|[A-Z]|\b\w)/g,(e,t)=>t===0?e.toLowerCase():e.toUpperCase()).replace(/\s+/g,""),Z=u=>{let e=ze(u);return e.charAt(0).toUpperCase()+e.slice(1)},Qe=0,k=u=>{Qe>100||(console.warn(Qe===100?"GPUCurtains: too many warnings thrown, stop logging.":u),Qe++)};var V=u=>{throw new Error(u)};var Ze=(u,e="GPURenderer",t)=>{let r=t?`Unable to create ${t} because the ${e} is not defined: ${u}`:`The ${e} is not defined: ${u}`;V(r)},y=(u,e)=>{let t=u&&(u.type==="GPURenderer"||u.type==="GPUCameraRenderer"||u.type==="GPUCurtainsRenderer");return t||Ze(u,"GPURenderer",e),t},J=(u,e)=>{let t=u&&(u.type==="GPUCameraRenderer"||u.type==="GPUCurtainsRenderer");return t||Ze(u,"GPUCameraRenderer",e),t},me=(u,e)=>{let t=u&&u.type==="GPUCurtainsRenderer";return t||Ze(u,"GPUCurtainsRenderer",e),t},rt=((u,e)=>{let t,r,s={};return function(n,o){r||(r=n.createShaderModule({label:"textured quad shaders for mip level generation",code:`
            struct VSOutput {
              @builtin(position) position: vec4f,
              @location(0) texcoord: vec2f,
            };

            @vertex fn vs(
              @builtin(vertex_index) vertexIndex : u32
            ) -> VSOutput {
              var pos = array<vec2f, 6>(

                vec2f( 0.0,  0.0),  // center
                vec2f( 1.0,  0.0),  // right, center
                vec2f( 0.0,  1.0),  // center, top

                // 2st triangle
                vec2f( 0.0,  1.0),  // center, top
                vec2f( 1.0,  0.0),  // right, center
                vec2f( 1.0,  1.0),  // right, top
              );

              var vsOutput: VSOutput;
              let xy = pos[vertexIndex];
              vsOutput.position = vec4f(xy * 2.0 - 1.0, 0.0, 1.0);
              vsOutput.texcoord = vec2f(xy.x, 1.0 - xy.y);
              return vsOutput;
            }

            @group(0) @binding(0) var ourSampler: sampler;
            @group(0) @binding(1) var ourTexture: texture_2d<f32>;

            @fragment fn fs(fsInput: VSOutput) -> @location(0) vec4f {
              return textureSample(ourTexture, ourSampler, fsInput.texcoord);
            }
          `}),t=n.createSampler({minFilter:"linear"})),s[o.format]||(s[o.format]=n.createRenderPipeline({label:"mip level generator pipeline",layout:"auto",vertex:{module:r,entryPoint:"vs"},fragment:{module:r,entryPoint:"fs",targets:[{format:o.format}]}}));let d=s[o.format],a=n.createCommandEncoder({label:"mip gen encoder"}),h=o.width,l=o.height,m=0;for(;h>1||l>1;){h=Math.max(1,h/2|0),l=Math.max(1,l/2|0);let P=n.createBindGroup({layout:d.getBindGroupLayout(0),entries:[{binding:0,resource:t},{binding:1,resource:o.createView({baseMipLevel:m,mipLevelCount:1})}]});++m;let g={label:"our basic canvas renderPass",colorAttachments:[{view:o.createView({baseMipLevel:m,mipLevelCount:1}),loadOp:"clear",storeOp:"store"}]},b=a.beginRenderPass(g);b.setPipeline(d),b.setBindGroup(0,P),b.draw(6),b.end()}let c=a.finish();n.queue.submit([c])}})();var st=u=>({i32:{numElements:1,align:4,size:4,type:"i32",View:Int32Array},u32:{numElements:1,align:4,size:4,type:"u32",View:Uint32Array},f32:{numElements:1,align:4,size:4,type:"f32",View:Float32Array},f16:{numElements:1,align:2,size:2,type:"u16",View:Uint16Array},vec2f:{numElements:2,align:8,size:8,type:"f32",View:Float32Array},vec2i:{numElements:2,align:8,size:8,type:"i32",View:Int32Array},vec2u:{numElements:2,align:8,size:8,type:"u32",View:Uint32Array},vec2h:{numElements:2,align:4,size:4,type:"u16",View:Uint16Array},vec3i:{numElements:3,align:16,size:12,type:"i32",View:Int32Array},vec3u:{numElements:3,align:16,size:12,type:"u32",View:Uint32Array},vec3f:{numElements:3,align:16,size:12,type:"f32",View:Float32Array},vec3h:{numElements:3,align:8,size:6,type:"u16",View:Uint16Array},vec4i:{numElements:4,align:16,size:16,type:"i32",View:Int32Array},vec4u:{numElements:4,align:16,size:16,type:"u32",View:Uint32Array},vec4f:{numElements:4,align:16,size:16,type:"f32",View:Float32Array},vec4h:{numElements:4,align:8,size:8,type:"u16",View:Uint16Array},mat2x2f:{numElements:4,align:8,size:16,type:"f32",View:Float32Array},mat2x2h:{numElements:4,align:4,size:8,type:"u16",View:Uint16Array},mat3x2f:{numElements:6,align:8,size:24,type:"f32",View:Float32Array},mat3x2h:{numElements:6,align:4,size:12,type:"u16",View:Uint16Array},mat4x2f:{numElements:8,align:8,size:32,type:"f32",View:Float32Array},mat4x2h:{numElements:8,align:4,size:16,type:"u16",View:Uint16Array},mat2x3f:{numElements:8,align:16,size:32,pad:[3,1],type:"f32",View:Float32Array},mat2x3h:{numElements:8,align:8,size:16,pad:[3,1],type:"u16",View:Uint16Array},mat3x3f:{numElements:12,align:16,size:48,pad:[3,1],type:"f32",View:Float32Array},mat3x3h:{numElements:12,align:8,size:24,pad:[3,1],type:"u16",View:Uint16Array},mat4x3f:{numElements:16,align:16,size:64,pad:[3,1],type:"f32",View:Float32Array},mat4x3h:{numElements:16,align:8,size:32,pad:[3,1],type:"u16",View:Uint16Array},mat2x4f:{numElements:8,align:16,size:32,type:"f32",View:Float32Array},mat2x4h:{numElements:8,align:8,size:16,type:"u16",View:Uint16Array},mat3x4f:{numElements:12,align:16,size:48,pad:[3,1],type:"f32",View:Float32Array},mat3x4h:{numElements:12,align:8,size:24,pad:[3,1],type:"u16",View:Uint16Array},mat4x4f:{numElements:16,align:16,size:64,type:"f32",View:Float32Array},mat4x4h:{numElements:16,align:8,size:32,type:"u16",View:Uint16Array}})[u],ke=u=>(()=>{switch(u.type){case"array<vec4f>":return 4;case"array<vec3f>":return 3;case"array<vec2f>":return 2;case"array<f32>":default:return 1}})(),Le=u=>(()=>{switch(u){case"storage":return"var<storage, read>";case"storageWrite":return"var<storage, read_write>";case"uniform":default:return"var<uniform>"}})(),Je=u=>(()=>{switch(u){case"storage":return"read-only-storage";case"storageWrite":return"storage";case"uniform":default:return"uniform"}})();var Y=class{constructor({label:e="Uniform",name:t="uniform",bindingType:r="uniform",bindIndex:s=0,visibility:i}){this.label=e,this.name=ze(t),this.bindingType=r,this.bindIndex=s,this.visibility=i?(()=>{switch(i){case"vertex":return GPUShaderStage.VERTEX;case"fragment":return GPUShaderStage.FRAGMENT;case"compute":return GPUShaderStage.COMPUTE;default:return GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE}})():GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE}onBeforeRender(){}};var _=class u{constructor(e=0,t=e){this.type="Vec2",this._x=e,this._y=t}get x(){return this._x}set x(e){let t=e!==this._x;this._x=e,t&&this._onChangeCallback&&this._onChangeCallback()}get y(){return this._y}set y(e){let t=e!==this._y;this._y=e,t&&this._onChangeCallback&&this._onChangeCallback()}onChange(e){return e&&(this._onChangeCallback=e),this}set(e=0,t=e){return this.x=e,this.y=t,this}add(e=new u){return this.x+=e.x,this.y+=e.y,this}addScalar(e=0){return this.x+=e,this.y+=e,this}sub(e=new u){return this.x-=e.x,this.y-=e.y,this}subScalar(e=0){return this.x-=e,this.y-=e,this}multiply(e=new u(1)){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e=1){return this.x*=e,this.y*=e,this}copy(e=new u){return this.x=e.x,this.y=e.y,this}clone(){return new u(this.x,this.y)}max(e=new u){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}min(e=new u){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}equals(e=new u){return this.x===e.x&&this.y===e.y}normalize(){let e=this.x*this.x+this.y*this.y;return e>0&&(e=1/Math.sqrt(e)),this.x*=e,this.y*=e,this}dot(e=new u){return this.x*e.x+this.y*e.y}lerp(e=new u,t=1){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}};var j=class u{constructor(e=new Float32Array([0,0,0,1]),t="XYZ"){this.type="Quat",this.elements=e,this.axisOrder=t}setFromArray(e=new Float32Array([0,0,0,1])){return this.elements[0]=e[0],this.elements[1]=e[1],this.elements[2]=e[2],this.elements[3]=e[3],this}setAxisOrder(e="XYZ"){switch(e=e.toUpperCase(),e){case"XYZ":case"YXZ":case"ZXY":case"ZYX":case"YZX":case"XZY":this.axisOrder=e;break;default:this.axisOrder="XYZ"}return this}copy(e=new u){return this.elements=e.elements,this.axisOrder=e.axisOrder,this}clone(){return new u().copy(this)}equals(e=new u){return this.elements[0]===e.elements[0]&&this.elements[1]===e.elements[1]&&this.elements[2]===e.elements[2]&&this.elements[3]===e.elements[3]&&this.axisOrder===e.axisOrder}setFromVec3(e=new p){let t=e.x*.5,r=e.y*.5,s=e.z*.5,i=Math.cos(t),n=Math.cos(r),o=Math.cos(s),d=Math.sin(t),a=Math.sin(r),h=Math.sin(s);return this.axisOrder==="XYZ"?(this.elements[0]=d*n*o+i*a*h,this.elements[1]=i*a*o-d*n*h,this.elements[2]=i*n*h+d*a*o,this.elements[3]=i*n*o-d*a*h):this.axisOrder==="YXZ"?(this.elements[0]=d*n*o+i*a*h,this.elements[1]=i*a*o-d*n*h,this.elements[2]=i*n*h-d*a*o,this.elements[3]=i*n*o+d*a*h):this.axisOrder==="ZXY"?(this.elements[0]=d*n*o-i*a*h,this.elements[1]=i*a*o+d*n*h,this.elements[2]=i*n*h+d*a*o,this.elements[3]=i*n*o-d*a*h):this.axisOrder==="ZYX"?(this.elements[0]=d*n*o-i*a*h,this.elements[1]=i*a*o+d*n*h,this.elements[2]=i*n*h-d*a*o,this.elements[3]=i*n*o+d*a*h):this.axisOrder==="YZX"?(this.elements[0]=d*n*o+i*a*h,this.elements[1]=i*a*o+d*n*h,this.elements[2]=i*n*h-d*a*o,this.elements[3]=i*n*o-d*a*h):this.axisOrder==="XZY"&&(this.elements[0]=d*n*o-i*a*h,this.elements[1]=i*a*o-d*n*h,this.elements[2]=i*n*h+d*a*o,this.elements[3]=i*n*o+d*a*h),this}};var z=class u{constructor(e=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])){this.type="Mat4",this.elements=e}set(e,t,r,s,i,n,o,d,a,h,l,m,c,P,g,b){let f=this.elements;return f[0]=e,f[1]=t,f[2]=r,f[3]=s,f[4]=i,f[5]=n,f[6]=o,f[7]=d,f[8]=a,f[9]=h,f[10]=l,f[11]=m,f[12]=c,f[13]=P,f[14]=g,f[15]=b,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}setFromArray(e=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])){for(let t=0;t<this.elements.length;t++)this.elements[t]=e[t];return this}copy(e=new u){let t=e.elements;return this.elements[0]=t[0],this.elements[1]=t[1],this.elements[2]=t[2],this.elements[3]=t[3],this.elements[4]=t[4],this.elements[5]=t[5],this.elements[6]=t[6],this.elements[7]=t[7],this.elements[8]=t[8],this.elements[9]=t[9],this.elements[10]=t[10],this.elements[11]=t[11],this.elements[12]=t[12],this.elements[13]=t[13],this.elements[14]=t[14],this.elements[15]=t[15],this}clone(){return new u().copy(this)}multiply(e=new u){return this.multiplyMatrices(this,e)}premultiply(e=new u){return this.multiplyMatrices(e,this)}multiplyMatrices(e=new u,t=new u){let r=e.elements,s=t.elements,i=this.elements,n=r[0],o=r[4],d=r[8],a=r[12],h=r[1],l=r[5],m=r[9],c=r[13],P=r[2],g=r[6],b=r[10],f=r[14],G=r[3],x=r[7],R=r[11],M=r[15],C=s[0],T=s[4],w=s[8],v=s[12],S=s[1],O=s[5],D=s[9],A=s[13],E=s[2],U=s[6],B=s[10],F=s[14],L=s[3],Q=s[7],H=s[11],Fe=s[15];return i[0]=n*C+o*S+d*E+a*L,i[4]=n*T+o*O+d*U+a*Q,i[8]=n*w+o*D+d*B+a*H,i[12]=n*v+o*A+d*F+a*Fe,i[1]=h*C+l*S+m*E+c*L,i[5]=h*T+l*O+m*U+c*Q,i[9]=h*w+l*D+m*B+c*H,i[13]=h*v+l*A+m*F+c*Fe,i[2]=P*C+g*S+b*E+f*L,i[6]=P*T+g*O+b*U+f*Q,i[10]=P*w+g*D+b*B+f*H,i[14]=P*v+g*A+b*F+f*Fe,i[3]=G*C+x*S+R*E+M*L,i[7]=G*T+x*O+R*U+M*Q,i[11]=G*w+x*D+R*B+M*H,i[15]=G*v+x*A+R*F+M*Fe,this}premultiplyTranslate(e=new p){let n=e.x,o=e.y,d=e.z,a=this.elements,h=this.elements,l=a[0],m=a[4],c=a[8],P=a[12],g=a[1],b=a[5],f=a[9],G=a[13],x=a[2],R=a[6],M=a[10],C=a[14],T=a[3],w=a[7],v=a[11],S=a[15];return h[0]=1*l+n*T,h[4]=1*m+n*w,h[8]=1*c+n*v,h[12]=1*P+n*S,h[1]=1*g+o*T,h[5]=1*b+o*w,h[9]=1*f+o*v,h[13]=1*G+o*S,h[2]=1*x+d*T,h[6]=1*R+d*w,h[10]=1*M+d*v,h[14]=1*C+d*S,h[3]=1*T,h[7]=1*w,h[11]=1*v,h[15]=1*S,this}premultiplyScale(e=new p){let t=this.elements,r=this.elements,s=e.x,i=e.y,n=e.z,o=1,d=t[0],a=t[4],h=t[8],l=t[12],m=t[1],c=t[5],P=t[9],g=t[13],b=t[2],f=t[6],G=t[10],x=t[14],R=t[3],M=t[7],C=t[11],T=t[15];return r[0]=s*d,r[4]=s*a,r[8]=s*h,r[12]=s*l,r[1]=i*m,r[5]=i*c,r[9]=i*P,r[13]=i*g,r[2]=n*b,r[6]=n*f,r[10]=n*G,r[14]=n*x,r[3]=o*R,r[7]=o*M,r[11]=o*C,r[15]=o*T,this}getInverse(){let e=this.elements,t=new u,r=t.elements,s=e[0],i=e[1],n=e[2],o=e[3],d=e[4],a=e[5],h=e[6],l=e[7],m=e[8],c=e[9],P=e[10],g=e[11],b=e[12],f=e[13],G=e[14],x=e[15],R=s*a-i*d,M=s*h-n*d,C=s*l-o*d,T=i*h-n*a,w=i*l-o*a,v=n*l-o*h,S=m*f-c*b,O=m*G-P*b,D=m*x-g*b,A=c*G-P*f,E=c*x-g*f,U=P*x-g*G,B=R*U-M*E+C*A+T*D-w*O+v*S;return B?(B=1/B,r[0]=(a*U-h*E+l*A)*B,r[1]=(n*E-i*U-o*A)*B,r[2]=(f*v-G*w+x*T)*B,r[3]=(P*w-c*v-g*T)*B,r[4]=(h*D-d*U-l*O)*B,r[5]=(s*U-n*D+o*O)*B,r[6]=(G*C-b*v-x*M)*B,r[7]=(m*v-P*C+g*M)*B,r[8]=(d*E-a*D+l*S)*B,r[9]=(i*D-s*E-o*S)*B,r[10]=(b*w-f*C+x*R)*B,r[11]=(c*C-m*w-g*R)*B,r[12]=(a*O-d*A-h*S)*B,r[13]=(s*A-i*O+n*S)*B,r[14]=(f*M-b*T-G*R)*B,r[15]=(m*T-c*M+P*R)*B,t):null}translate(e=new p){let t=this.elements;return t[12]=t[0]*e.x+t[4]*e.y+t[8]*e.z+t[12],t[13]=t[1]*e.x+t[5]*e.y+t[9]*e.z+t[13],t[14]=t[2]*e.x+t[6]*e.y+t[10]*e.z+t[14],t[15]=t[3]*e.x+t[7]*e.y+t[11]*e.z+t[15],this}scale(e=new p){let t=this.elements;return t[0]*=e.x,t[1]*=e.x,t[2]*=e.x,t[3]*=e.x,t[4]*=e.y,t[5]*=e.y,t[6]*=e.y,t[7]*=e.y,t[8]*=e.z,t[9]*=e.z,t[10]*=e.z,t[11]*=e.z,this}rotateFromQuaternion(e=new j){let t=this.elements,r=e.elements[0],s=e.elements[1],i=e.elements[2],n=e.elements[3],o=r+r,d=s+s,a=i+i,h=r*o,l=r*d,m=r*a,c=s*d,P=s*a,g=i*a,b=n*o,f=n*d,G=n*a;return t[0]=1-(c+g),t[4]=l-G,t[8]=m+f,t[1]=l+G,t[5]=1-(h+g),t[9]=P-b,t[2]=m-f,t[6]=P+b,t[10]=1-(h+c),this}compose(e=new p,t=new j,r=new p(1)){let s=this.elements,i=t.elements[0],n=t.elements[1],o=t.elements[2],d=t.elements[3],a=i+i,h=n+n,l=o+o,m=i*a,c=i*h,P=i*l,g=n*h,b=n*l,f=o*l,G=d*a,x=d*h,R=d*l,M=r.x,C=r.y,T=r.z;return s[0]=(1-(g+f))*M,s[1]=(c+R)*M,s[2]=(P-x)*M,s[3]=0,s[4]=(c-R)*C,s[5]=(1-(m+f))*C,s[6]=(b+G)*C,s[7]=0,s[8]=(P+x)*T,s[9]=(b-G)*T,s[10]=(1-(m+g))*T,s[11]=0,s[12]=e.x,s[13]=e.y,s[14]=e.z,s[15]=1,this}composeFromOrigin(e=new p,t=new j,r=new p(1),s=new p){let i=this.elements,n=t.elements[0],o=t.elements[1],d=t.elements[2],a=t.elements[3],h=n+n,l=o+o,m=d+d,c=n*h,P=n*l,g=n*m,b=o*l,f=o*m,G=d*m,x=a*h,R=a*l,M=a*m,C=r.x,T=r.y,w=r.z,v=s.x,S=s.y,O=s.z,D=(1-(b+G))*C,A=(P+M)*C,E=(g-R)*C,U=(P-M)*T,B=(1-(c+G))*T,F=(f+x)*T,L=(g+R)*w,Q=(f-x)*w,H=(1-(c+b))*w;return i[0]=D,i[1]=A,i[2]=E,i[3]=0,i[4]=U,i[5]=B,i[6]=F,i[7]=0,i[8]=L,i[9]=Q,i[10]=H,i[11]=0,i[12]=e.x+v-(D*v+U*S+L*O),i[13]=e.y+S-(A*v+B*S+Q*O),i[14]=e.z+O-(E*v+F*S+H*O),i[15]=1,this}};var p=class u{constructor(e=0,t=e,r=e){this.type="Vec3",this._x=e,this._y=t,this._z=r}get x(){return this._x}set x(e){let t=e!==this._x;this._x=e,t&&this._onChangeCallback&&this._onChangeCallback()}get y(){return this._y}set y(e){let t=e!==this._y;this._y=e,t&&this._onChangeCallback&&this._onChangeCallback()}get z(){return this._z}set z(e){let t=e!==this._z;this._z=e,t&&this._onChangeCallback&&this._onChangeCallback()}onChange(e){return e&&(this._onChangeCallback=e),this}set(e=0,t=0,r=0){return this.x=e,this.y=t,this.z=r,this}add(e=new u){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e=0){return this.x+=e,this.y+=e,this.z+=e,this}sub(e=new u){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e=0){return this.x-=e,this.y-=e,this.z-=e,this}multiply(e=new u(1)){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e=1){return this.x*=e,this.y*=e,this.z*=e,this}copy(e=new u){return this.x=e.x,this.y=e.y,this.z=e.z,this}clone(){return new u(this.x,this.y,this.z)}max(e=new u){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}min(e=new u){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}equals(e=new u){return this.x===e.x&&this.y===e.y&&this.z===e.z}normalize(){let e=this.x*this.x+this.y*this.y+this.z*this.z;return e>0&&(e=1/Math.sqrt(e)),this.x*=e,this.y*=e,this.z*=e,this}dot(e=new u){return this.x*e.x+this.y*e.y+this.z*e.z}lerp(e=new u,t=1){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}applyMat4(e=new z){let t=this._x,r=this._y,s=this._z,i=e.elements,n=i[3]*t+i[7]*r+i[11]*s+i[15];return n=n||1,this.x=(i[0]*t+i[4]*r+i[8]*s+i[12])/n,this.y=(i[1]*t+i[5]*r+i[9]*s+i[13])/n,this.z=(i[2]*t+i[6]*r+i[10]*s+i[14])/n,this}applyQuat(e=new j){let t=this.x,r=this.y,s=this.z,i=e.elements[0],n=e.elements[1],o=e.elements[2],d=e.elements[3],a=d*t+n*s-o*r,h=d*r+o*t-i*s,l=d*s+i*r-n*t,m=-i*t-n*r-o*s;return this.x=a*d+m*-i+h*-o-l*-n,this.y=h*d+m*-n+l*-i-a*-o,this.z=l*d+m*-o+a*-n-h*-i,this}project(e){return this.applyMat4(e.viewMatrix).applyMat4(e.projectionMatrix),this}unproject(e){return this.applyMat4(e.projectionMatrix.getInverse()).applyMat4(e.modelMatrix),this}};var I=class extends Y{constructor({label:t="Uniform",name:r="uniform",bindingType:s,bindIndex:i=0,visibility:n,useStruct:o=!0,bindings:d={}}){s=s??"uniform";super({label:t,name:r,bindIndex:i,bindingType:s,visibility:n});this.size=0,this.shouldUpdate=!1,this.useStruct=o,this.bindingElements=[],this.bindings={},this.setBindings(d),this.setBufferAttributes(),this.setWGSLFragment()}setBindings(t){Object.keys(t).forEach(r=>{let s={};for(let i in t[r])i!=="value"&&(s[i]=t[r][i]);Object.defineProperty(s,"value",{get(){return s._value},set(i){s._value=i,s.shouldUpdate=!0}}),s.value=t[r].value,(s.value instanceof _||s.value instanceof p)&&s.value.onChange(()=>s.shouldUpdate=!0),this.bindings[r]=s})}setBufferAttributes(){Object.keys(this.bindings).forEach(r=>{let s=this.bindings[r],i=s.type&&s.type.indexOf("array")!==-1&&s.value instanceof Float32Array?{numElements:s.value.length,align:16,size:s.value.byteLength,type:"f32",View:Float32Array}:st(s.type);this.bindingElements.push({name:ze(s.name??r),type:s.type??"array<f32>",key:r,bufferLayout:i,startOffset:0,endOffset:0})}),this.alignmentRows=0;let t=Float32Array.BYTES_PER_ELEMENT;this.bindingElements.forEach((r,s)=>{let{numElements:i,align:n}=r.bufferLayout;if(s===0)r.startOffset=0,this.alignmentRows+=Math.max(1,Math.ceil(i/t));else{let o=this.bindingElements[s-1].startOffset+this.bindingElements[s-1].bufferLayout.numElements;n<=t*2?(i===2&&o%2===1&&(o=o+1),o+i<=this.alignmentRows*t?r.startOffset=o:(r.startOffset=this.alignmentRows*t,this.alignmentRows++)):o%n!==0||(o+i)%t!==0?(r.startOffset=this.alignmentRows*t,this.alignmentRows+=Math.ceil(i/t)):(r.startOffset=o,this.alignmentRows+=Math.ceil(i/t))}r.endOffset=r.startOffset+r.bufferLayout.numElements}),this.size=this.alignmentRows*t,this.value=new Float32Array(this.size),this.bindingElements.forEach(r=>{r.array=new r.bufferLayout.View(this.value.subarray(r.startOffset,r.endOffset)),r.update=s=>{if(r.type==="f32")r.array[0]=s;else if(r.type==="vec2f")r.array[0]=s.x??s[0]??0,r.array[1]=s.y??s[1]??0;else if(r.type==="vec3f")r.array[0]=s.x??s[0]??0,r.array[1]=s.y??s[1]??0,r.array[2]=s.z??s[2]??0;else if(s.elements)r.array=s.elements;else if(s instanceof Float32Array)r.array.set(s.slice());else if(Array.isArray(s))for(let i=0;i<r.array.length;i++)r.array[i]=s[i]?s[i]:0}}),this.shouldUpdate=this.size>0}setWGSLFragment(){if(this.useStruct)if(Object.keys(this.bindings).find(r=>this.bindings[r].type.indexOf("array")===-1)){this.wgslStructFragment=`struct ${Z(this.label)} {
	${this.bindingElements.map(s=>s.name+": "+s.type).join(`,
	`)}
};`;let r=Le(this.bindingType);this.wgslGroupFragment=[`${r} ${this.name}: ${Z(this.label)};`]}else{let r=Z(this.label);this.wgslStructFragment=`struct ${r} {
	${this.bindingElements.map(i=>i.name+": "+i.type.replace("array","").replace("<","").replace(">","")).join(`,
	`)}
};`;let s=Le(this.bindingType);this.wgslGroupFragment=[`${s} ${this.name}: array<${r}>;`]}else this.wgslStructFragment="",this.wgslGroupFragment=this.bindingElements.map(t=>`${Le(this.bindingType)} ${t.name}: ${t.type};`)}shouldUpdateBinding(t=""){let r=Object.keys(this.bindings).find(s=>this.bindings[s].name===t);r&&(this.bindings[r].shouldUpdate=!0)}onBeforeRender(){Object.keys(this.bindings).forEach((t,r)=>{let s=this.bindings[t],i=this.bindingElements.find(n=>n.key===t);if(s.shouldUpdate&&i){if(s.onBeforeUpdate&&s.onBeforeUpdate(),i.update(s.value),Object.keys(this.bindings).find(o=>this.bindings[o].type.indexOf("array")===-1))this.value.set(i.array,i.startOffset);else{let o=ke(i),d=0,a=0;this.bindingElements.forEach((h,l)=>{d+=ke(h),l<r&&(a+=ke(h))});for(let h=0,l=0;l<i.array.length;h++,l+=o)this.value.set(i.array.subarray(l,l+o),h*d+a)}this.shouldUpdate=!0,s.shouldUpdate=!1}})}};var pe=class extends I{constructor({label:t="Work",name:r="work",bindingType:s,bindIndex:i=0,useStruct:n=!0,bindings:o={},visibility:d,dispatchSize:a,shouldCopyResult:h=!1}){s="storageWrite",d="compute";super({label:t,name:r,bindIndex:i,bindingType:s,useStruct:n,bindings:o,visibility:d});a?Array.isArray(a)?(a[0]=Math.ceil(a[0]??1),a[1]=Math.ceil(a[1]??1),a[2]=Math.ceil(a[2]??1)):isNaN(a)||(a=[Math.ceil(a),1,1]):a=[1,1,1],this.dispatchSize=a,this.shouldCopyResult=h,this.result=new Float32Array(this.value.slice())}};var X=class{constructor(e,{label:t="BindGroup",index:r=0,bindings:s=[],inputs:i}={}){this.type="BindGroup",e=e&&e.renderer||e,y(e,this.type),this.renderer=e,this.options={label:t,index:r,bindings:s,...i&&{inputs:i}},this.index=r,this.uuid=N(),this.bindings=[],s.length&&this.addBindings(s),this.options.inputs&&this.setInputBindings(),this.resetEntries(),this.bindingsBuffers=[],this.bindGroupLayout=null,this.bindGroup=null,this.needsReset=!1,this.needsPipelineFlush=!1}setIndex(e){this.index=e}addBindings(e=[]){this.bindings=[...this.bindings,...e]}addBinding(e){this.bindings.push(e)}createInputBindings(e="uniform",t={}){return[...Object.keys(t).map(r=>{let s=t[r],i={label:Z(s.label||r),name:r,bindingType:e,useStruct:!0,bindings:s.bindings,dispatchSize:s.dispatchSize,visibility:e==="storageWrite"?"compute":s.visibility},n=e==="storageWrite"?pe:I;return s.useStruct!==!1?new n(i):Object.keys(s.bindings).map(o=>(i.label=Z(s.label?s.label+o:r+o),i.name=r+o,i.useStruct=!1,i.bindings={[o]:s.bindings[o]},new n(i)))})].flat()}setInputBindings(){this.addBindings([...this.createInputBindings("uniform",this.options.inputs.uniforms),...this.createInputBindings("storage",this.options.inputs.storages),...this.createInputBindings("storageWrite",this.options.inputs.works)])}get shouldCreateBindGroup(){return!this.bindGroup&&!!this.bindings.length}resetEntries(){this.entries={bindGroupLayout:[],bindGroup:[]}}createBindGroup(){this.createBindingsBuffers(),this.setBindGroupLayout(),this.setBindGroup()}resetBindGroup(){this.resetEntries(),this.createBindGroup()}createBindingBufferElement(e,t,r){let s=this.renderer.createBuffer({label:this.options.label+": "+e.bindingType+" buffer from:"+e.label,size:r.byteLength,usage:e.bindingType==="uniform"?GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC|GPUBufferUsage.VERTEX:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC|GPUBufferUsage.VERTEX});this.bindingsBuffers.push({inputBinding:e,buffer:s,array:r,...e.bindingType==="storageWrite"&&{resultBuffer:this.renderer.createBuffer({label:this.options.label+": Result buffer from: "+e.label,size:e.value.byteLength,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST})}}),this.entries.bindGroupLayout.push({binding:t,buffer:{type:Je(e.bindingType)},visibility:e.visibility}),this.entries.bindGroup.push({binding:t,resource:{buffer:s}})}createBindingBuffer(e){e.useStruct?(e.bindIndex=this.entries.bindGroupLayout.length,this.createBindingBufferElement(e,e.bindIndex,e.value)):e.bindingElements.forEach(t=>{let r=this.entries.bindGroupLayout.length;this.createBindingBufferElement(e,r,t.array)})}createBindingsBuffers(){this.bindings.forEach(e=>{e.visibility||(e.visibility=GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT),e.value&&this.createBindingBuffer(e)})}getBindingsByName(e=""){return this.bindings.find(t=>t.name===e)}setBindGroupLayout(){this.bindGroupLayout=this.renderer.createBindGroupLayout({label:this.options.label+" layout",entries:this.entries.bindGroupLayout})}setBindGroup(){this.bindGroup=this.renderer.createBindGroup({label:this.options.label,layout:this.bindGroupLayout,entries:this.entries.bindGroup})}updateBindings(){this.bindingsBuffers.forEach(e=>{e.inputBinding&&e.inputBinding.shouldUpdate&&(!e.inputBinding.useStruct&&e.inputBinding.bindingElements.length>1?this.renderer.queueWriteBuffer(e.buffer,0,e.array):this.renderer.queueWriteBuffer(e.buffer,0,e.inputBinding.value)),e.inputBinding.shouldUpdate=!1})}cloneFromBindingsBuffers({bindingsBuffers:e=[],keepLayout:t=!1}={}){let r={...this.options};r.label+=" (copy)";let s=new this.constructor(this.renderer,{label:r.label});return s.setIndex(this.index),(e.length?e:this.bindingsBuffers).forEach((n,o)=>{s.addBinding(n.inputBinding),s.bindingsBuffers.push({...n}),t||s.entries.bindGroupLayout.push({binding:s.entries.bindGroupLayout.length,buffer:{type:Je(n.inputBinding.bindingType)},visibility:n.inputBinding.visibility}),s.entries.bindGroup.push({binding:s.entries.bindGroup.length,resource:{buffer:n.buffer}})}),t&&(s.entries.bindGroupLayout=[...this.entries.bindGroupLayout]),s.setBindGroupLayout(),s.setBindGroup(),s}clone(){return this.cloneFromBindingsBuffers()}destroy(){this.bindingsBuffers.forEach(e=>{e.buffer?.destroy(),e.resultBuffer?.destroy()}),this.bindingsBuffers=[],this.bindGroupLayout=null,this.bindGroup=null,this.resetEntries()}};var ce=class extends X{constructor(t,{label:r,index:s=0,bindings:i=[],inputs:n,textures:o=[],samplers:d=[]}={}){let a="TextureBindGroup";t=t&&t.renderer||t,y(t,a);super(t,{label:r,index:s,bindings:i,inputs:n});this.options={...this.options,textures:o,samplers:d},this.type=a,this.externalTexturesIDs=[]}addTexture(t){this.textures.push(t),this.addBindings([...t.bindings])}get textures(){return this.options.textures}addSampler(t){this.samplers.push(t),this.addBindings([t.binding])}get samplers(){return this.options.samplers}get shouldCreateBindGroup(){return!this.bindGroup&&!!this.bindings.length&&!this.textures.find(t=>!(t.texture||t.externalTexture))&&!this.samplers.find(t=>!t.sampler)}createBindingsBuffers(){this.bindings.forEach(t=>{if(t.visibility||(t.visibility=GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT),t.value)this.createBindingBuffer(t);else if("resource"in t&&t.resource&&t.bindingType){t.bindIndex=this.entries.bindGroupLayout.length;let r=(()=>{switch(t.bindingType){case"texture":return t.resource.createView();case"externalTexture":return t.resource;case"sampler":return t.resource;default:return t.resource}})();this.entries.bindGroupLayout.push({binding:t.bindIndex,[t.bindingType]:r,visibility:t.visibility}),this.entries.bindGroup.push({binding:t.bindIndex,resource:r})}})}resetTextureBindGroup(){let t=this.entries.bindGroup.filter(r=>r.resource instanceof GPUTextureView||r.resource instanceof GPUExternalTexture);t.length&&(t.forEach((r,s)=>{let i=this.textures[s];i&&(r.resource=i.options?.sourceType==="externalVideo"?i.externalTexture:i.texture.createView())}),this.setBindGroup())}shouldUpdateVideoTextureBindGroupLayout(t){return this.externalTexturesIDs.includes(t)?!1:(this.externalTexturesIDs.push(t),this.needsPipelineFlush=!0,this.needsPipelineFlush)}updateVideoTextureBindGroupLayout(t){let r=this.textures[t],s=[...this.bindings].reduce((i,n,o)=>(n.bindingType==="externalTexture"&&i.push(o),i),[]);s.length&&(s.forEach(i=>{this.entries.bindGroupLayout[i]={binding:this.entries.bindGroupLayout[i].binding,externalTexture:r.externalTexture,visibility:this.entries.bindGroupLayout[i].visibility},this.bindings[i]&&(this.bindings[i].wgslGroupFragment=r.textureBinding.wgslGroupFragment)}),this.setBindGroupLayout())}destroy(){super.destroy(),this.options.textures=[],this.options.samplers=[]}};var fe=class extends Y{constructor({label:t="Sampler",name:r="sampler",bindingType:s,bindIndex:i=0,visibility:n,resource:o}){s=s??"sampler";super({label:t,name:r,bindIndex:i,bindingType:s,visibility:n});this.resource=o,this.setWGSLFragment()}setWGSLFragment(){this.wgslGroupFragment=[`var ${this.name}: ${this.bindingType};`]}};var K=class extends Y{constructor({label:t="Texture",name:r="texture",resource:s,bindingType:i,bindIndex:n=0,visibility:o}){i=i??"texture";super({label:t,name:r,bindingType:i,bindIndex:n,visibility:o});this.resource=s,this.setWGSLFragment()}setBindingType(t){t!==this.bindingType&&(this.bindingType=t,this.setWGSLFragment())}setWGSLFragment(){this.wgslGroupFragment=[this.bindingType==="externalTexture"?`var ${this.name}: texture_external;`:`var ${this.name}: texture_2d<f32>;`]}};var xe=class{constructor({fov:e=50,near:t=.01,far:r=50,width:s=1,height:i=1,pixelRatio:n=1,onPerspectiveChanged:o=()=>{},onPositionChanged:d=()=>{}}={}){this.position=new p(0,0,1).onChange(()=>this.applyPosition()),this.projectionMatrix=new z,this.modelMatrix=new z,this.viewMatrix=new z,this.onPerspectiveChanged=o,this.onPositionChanged=d,this.shouldUpdate=!1,this.setPerspective(e,t,r,s,i,n)}setFov(e=this.fov){e=Math.max(1,Math.min(e,179)),e!==this.fov&&(this.fov=e,this.setPosition(),this.shouldUpdate=!0),this.setScreenRatios(),this.setCSSPerspective()}setNear(e=this.near){e=Math.max(e,.01),e!==this.near&&(this.near=e,this.shouldUpdate=!0)}setFar(e=this.far){e=Math.max(e,50),e!==this.far&&(this.far=e,this.shouldUpdate=!0)}setPixelRatio(e=this.pixelRatio){e!==this.pixelRatio&&(this.shouldUpdate=!0),this.pixelRatio=e}setSize(e,t){(e!==this.width||t!==this.height)&&(this.shouldUpdate=!0),this.width=e,this.height=t,this.setScreenRatios(),this.setCSSPerspective()}setPerspective(e=this.fov,t=this.near,r=this.far,s=this.width,i=this.height,n=this.pixelRatio){this.setPixelRatio(n),this.setSize(s,i),this.setFov(e),this.setNear(t),this.setFar(r),this.shouldUpdate&&(this.updateProjectionMatrix(),this.onPerspectiveChanged())}setPosition(e=this.position){this.position.copy(e),this.applyPosition()}applyPosition(){this.modelMatrix.set(1,0,0,0,0,1,0,0,0,0,1,0,this.position.x,this.position.y,this.position.z,1),this.viewMatrix=this.modelMatrix.clone().getInverse(),this.setScreenRatios(),this.onPositionChanged()}setCSSPerspective(){this.CSSPerspective=Math.pow(Math.pow(this.width/(2*this.pixelRatio),2)+Math.pow(this.height/(2*this.pixelRatio),2),.5)/Math.tan(this.fov*.5*Math.PI/180)}setScreenRatios(e=0){let t=this.position.z;e<t?e-=t:e+=t;let r=this.fov*Math.PI/180,s=2*Math.tan(r/2)*Math.abs(e);this.screenRatio={width:s*this.width/this.height,height:s}}updateProjectionMatrix(){let e=this.width/this.height,t=this.near*Math.tan(Math.PI/180*.5*this.fov),r=2*t,s=e*r,i=-.5*s,n=i+s,o=t-r,d=2*this.near/(n-i),a=2*this.near/(t-o),h=(n+i)/(n-i),l=(t+o)/(t-o),m=-(this.far+this.near)/(this.far-this.near),c=-2*this.far*this.near/(this.far-this.near);this.projectionMatrix.set(d,0,0,0,0,a,0,0,h,l,m,-1,0,0,c,0)}};var ge=class{constructor(e,{label:t="Sampler",name:r,addressModeU:s="repeat",addressModeV:i="repeat",magFilter:n="linear",minFilter:o="linear",mipmapFilter:d="linear",maxAnisotropy:a=1}={}){this.type="Sampler",e=e&&e.renderer||e,y(e,t?t+" "+this.type:this.type),this.renderer=e,this.label=t,!r&&!this.renderer.production&&(r="sampler"+this.renderer.samplers.length,k(`Sampler: you are trying to create a sampler without the mandatory name parameter. A default name will be used instead: ${r}`)),this.name=r,this.options={addressModeU:s,addressModeV:i,magFilter:n,minFilter:o,mipmapFilter:d,maxAnisotropy:a},this.createSampler(),this.createBinding()}createSampler(){this.sampler=this.renderer.createSampler(this)}createBinding(){this.binding=new fe({label:this.label,name:this.name,bindingType:"sampler",resource:this.sampler})}};var ee=class{constructor(){this.setMatrices(),this.setTransforms()}setTransforms(){this.transforms={origin:{model:new p},quaternion:new j,rotation:new p,position:{world:new p},scale:new p(1)},this.rotation.onChange(()=>this.applyRotation()),this.position.onChange(()=>this.applyPosition()),this.scale.onChange(()=>this.applyScale()),this.transformOrigin.onChange(()=>this.applyTransformOrigin())}get rotation(){return this.transforms.rotation}set rotation(e){this.transforms.rotation=e,this.applyRotation()}get quaternion(){return this.transforms.quaternion}set quaternion(e){this.transforms.quaternion=e}get position(){return this.transforms.position.world}set position(e){this.transforms.position.world=e}get scale(){return this.transforms.scale}set scale(e){this.transforms.scale=e,this.applyScale()}get transformOrigin(){return this.transforms.origin.model}set transformOrigin(e){this.transforms.origin.model=e}applyRotation(){this.quaternion.setFromVec3(this.rotation),this.shouldUpdateModelMatrix()}applyPosition(){this.shouldUpdateModelMatrix()}applyScale(){this.shouldUpdateModelMatrix()}applyTransformOrigin(){this.shouldUpdateModelMatrix()}setMatrices(){this.matrices={model:{matrix:new z,shouldUpdate:!1,onUpdate:()=>this.updateModelMatrix()}}}get modelMatrix(){return this.matrices.model.matrix}set modelMatrix(e){this.matrices.model.matrix=e,this.matrices.model.shouldUpdate=!0}shouldUpdateModelMatrix(){this.matrices.model.shouldUpdate=!0}updateModelMatrix(){this.modelMatrix=this.modelMatrix.composeFromOrigin(this.position,this.quaternion,this.scale,this.transformOrigin)}onAfterMatrixStackUpdate(){}updateSizeAndPosition(){this.shouldUpdateModelMatrix()}updateMatrixStack(){let e=!!Object.keys(this.matrices).find(t=>this.matrices[t].shouldUpdate);for(let t in this.matrices)this.matrices[t].shouldUpdate&&(this.matrices[t].onUpdate(),this.matrices[t].shouldUpdate=!1);e&&this.onAfterMatrixStackUpdate()}};var it={name:"texture",texture:{generateMips:!1,flipY:!1,format:"rgba8unorm",placeholderColor:[0,0,0,255],useExternalTextures:!0},fromTexture:null},te=class extends ee{constructor(t,r=it){super();this.#e=new p(1);this.#t=new p(1);this.#r=new p(1);this.#s=new z;this._onSourceLoadedCallback=()=>{};this._onSourceUploadedCallback=()=>{};this.type="Texture",t=t&&t.renderer||t,y(t,r.label?r.label+" "+this.type:this.type),this.renderer=t;let s={...it,source:r.fromTexture?r.fromTexture.options.source:null,sourceType:r.fromTexture?r.fromTexture.options.sourceType:null};this.options={...s,...r},this.options.texture={...s.texture,...r.texture},this.options.label=this.options.label??this.options.name,this.texture=null,this.externalTexture=null,this.source=null,this.size={width:1,height:1},this.textureMatrix=new I({label:this.options.label+": model matrix",name:this.options.name+"Matrix",useStruct:!1,bindings:{matrix:{name:this.options.name+"Matrix",type:"mat4x4f",value:this.modelMatrix,onBeforeUpdate:()=>this.updateTextureMatrix()}}}),this.setBindings(),this._parent=null,this.sourceLoaded=!1,this.sourceUploaded=!1,this.shouldUpdate=!1,this.shouldUpdateBindGroup=!1,this.renderer.addTexture(this)}#e;#t;#r;#s;setBindings(){this.bindings=[new K({label:this.options.label+": texture",name:this.options.name,resource:this.options.sourceType==="externalVideo"?this.externalTexture:this.texture,bindingType:this.options.sourceType==="externalVideo"?"externalTexture":"texture"}),this.textureMatrix]}get textureBinding(){return this.bindings[0]}get parent(){return this._parent}set parent(t){this._parent=t,this.resize()}get sourceLoaded(){return this._sourceLoaded}set sourceLoaded(t){t&&!this.sourceLoaded&&this._onSourceLoadedCallback&&this._onSourceLoadedCallback(),this._sourceLoaded=t}get sourceUploaded(){return this._sourceUploaded}set sourceUploaded(t){t&&!this.sourceUploaded&&this._onSourceUploadedCallback&&this._onSourceUploadedCallback(),this._sourceUploaded=t}setTransforms(){super.setTransforms(),this.transforms.quaternion.setAxisOrder("ZXY"),this.transforms.origin.model.set(.5,.5,0)}applyPosition(){super.applyPosition(),this.resize()}applyRotation(){super.applyRotation(),this.resize()}applyScale(){super.applyScale(),this.resize()}applyTransformOrigin(){super.applyTransformOrigin(),this.resize()}updateTextureMatrix(){if(!this.parent)return;let t=this.parent.scale?this.parent.scale:new p(1,1,1),r=this.parent.boundingRect?this.parent.boundingRect.width*t.x:this.size.width,s=this.parent.boundingRect?this.parent.boundingRect.height*t.y:this.size.height,i=r/s,n=this.size.width,o=this.size.height,d=n/o;r>s?(this.#e.set(i,1,1),this.#t.set(1/d,1,1)):(this.#e.set(1,1/i,1),this.#t.set(1,d,1));let a=i>d!=r>s?1:r>s?this.#e.x*this.#t.x:this.#t.y*this.#e.y;this.#r.set(1/(a*this.scale.x),1/(a*this.scale.y),1),this.#s.rotateFromQuaternion(this.quaternion),this.modelMatrix.identity().premultiplyTranslate(this.transformOrigin.clone().multiplyScalar(-1)).premultiplyScale(this.#r).premultiplyScale(this.#e).premultiply(this.#s).premultiplyScale(this.#t).premultiplyTranslate(this.transformOrigin).translate(this.position)}resize(){this.textureMatrix&&(this.source&&this.source instanceof HTMLCanvasElement&&(this.source.width!==this.size.width||this.source.height!==this.size.height)&&(this.setSourceSize(),this.createTexture()),this.textureMatrix.shouldUpdateBinding(this.options.name+"Matrix"))}getNumMipLevels(...t){let r=Math.max(...t);return 1+Math.log2(r)|0}uploadTexture(){this.renderer.uploadTexture(this),this.shouldUpdate=!1}uploadVideoTexture(){this.externalTexture=this.renderer.importExternalTexture(this.source),this.textureBinding.resource=this.externalTexture,this.textureBinding.setBindingType("externalTexture"),this.shouldUpdateBindGroup=!0,this.shouldUpdate=!1,this.sourceUploaded=!0}copy(t){if(this.options.sourceType==="externalVideo"&&t.options.sourceType!=="externalVideo"){k(`${this.options.label}: cannot copy a GPUTexture to a GPUExternalTexture`);return}else if(this.options.sourceType!=="externalVideo"&&t.options.sourceType==="externalVideo"){k(`${this.options.label}: cannot copy a GPUExternalTexture to a GPUTexture`);return}this.options.fromTexture=t,this.options.sourceType=t.options.sourceType,this.options.texture=t.options.texture,this.sourceLoaded=t.sourceLoaded,this.sourceUploaded=t.sourceUploaded,t.texture&&(t.sourceLoaded&&(this.size=t.size,this.source=t.source,this.resize()),t.sourceUploaded?(this.texture=t.texture,this.shouldUpdateBindGroup=!0):this.createTexture())}createTexture(){let t={label:this.options.label,format:this.options.texture.format,size:[this.size.width,this.size.height],usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT};this.options.sourceType!=="externalVideo"&&(t.mipLevelCount=this.options.texture.generateMips?this.getNumMipLevels(this.size.width,this.size.height):1,this.texture?.destroy(),this.texture=this.renderer.createTexture(t),this.textureBinding.resource=this.texture,this.shouldUpdateBindGroup=!!this.source),this.shouldUpdate=!0}setSourceSize(){this.size={width:this.source.naturalWidth||this.source.width||this.source.videoWidth,height:this.source.naturalHeight||this.source.height||this.source.videoHeight}}async loadImageBitmap(t){let s=await(await fetch(t)).blob();return await createImageBitmap(s,{colorSpaceConversion:"none"})}async loadImage(t){let r=typeof t=="string"?t:t.getAttribute("src");this.options.source=r,this.options.sourceType="image",this.sourceLoaded=!1,this.sourceUploaded=!1,this.source=await this.loadImageBitmap(this.options.source),this.setSourceSize(),this.resize(),this.sourceLoaded=!0,this.createTexture()}onVideoFrameCallback(){this.videoFrameCallbackId&&(this.shouldUpdate=!0,this.source.requestVideoFrameCallback(this.onVideoFrameCallback.bind(this)))}onVideoLoaded(t){this.sourceLoaded||(this.source=t,this.setSourceSize(),this.resize(),this.options.texture.useExternalTextures?(this.options.sourceType="externalVideo",this.texture?.destroy()):(this.options.sourceType="video",this.createTexture()),"requestVideoFrameCallback"in HTMLVideoElement.prototype&&(this.videoFrameCallbackId=this.source.requestVideoFrameCallback(this.onVideoFrameCallback.bind(this))),this.sourceLoaded=!0)}get isVideoSource(){return this.source&&(this.options.sourceType==="video"||this.options.sourceType==="externalVideo")}loadVideo(t){let r;typeof t=="string"?(r=document.createElement("video"),r.src=t):r=t,r.preload="auto",r.muted=!0,r.loop=!0,r.crossOrigin="anonymous",r.setAttribute("playsinline",""),this.options.source=r.src,this.sourceLoaded=!1,this.sourceUploaded=!1,r.readyState>=r.HAVE_ENOUGH_DATA?this.onVideoLoaded(r):r.addEventListener("canplaythrough",this.onVideoLoaded.bind(this,r),{once:!0}),isNaN(r.duration)&&r.load()}loadCanvas(t){this.options.source=t,this.options.sourceType="canvas",this.sourceLoaded=!1,this.sourceUploaded=!1,this.source=t,this.setSourceSize(),this.resize(),this.sourceLoaded=!0,this.createTexture()}onSourceLoaded(t){return t&&(this._onSourceLoadedCallback=t),this}onSourceUploaded(t){return t&&(this._onSourceUploadedCallback=t),this}render(){this.textureMatrix.onBeforeRender(),this.options.sourceType==="externalVideo"&&(this.shouldUpdate=!0),this.isVideoSource&&!this.videoFrameCallbackId&&this.source.readyState>=this.source.HAVE_CURRENT_DATA&&!this.source.paused&&(this.shouldUpdate=!0),this.shouldUpdate&&this.options.sourceType&&this.options.sourceType!=="externalVideo"&&this.uploadTexture()}destroy(){this.videoFrameCallbackId&&this.source.cancelVideoFrameCallback(this.videoFrameCallbackId),this.isVideoSource&&this.source.removeEventListener("canplaythrough",this.onVideoLoaded.bind(this,this.source),{once:!0}),this.texture?.destroy(),this.texture=null}};var re=class{constructor(e,t){this.type="Material",e=e&&e.renderer||e,y(e,this.type),this.renderer=e;let{shaders:r,label:s,useAsyncPipeline:i,inputs:n,bindGroups:o,samplers:d}=t;this.options={shaders:r,label:s,...i!==void 0&&{useAsyncPipeline:i},...n!==void 0&&{inputs:n},...o!==void 0&&{bindGroups:o},...d!==void 0&&{samplers:d}},this.bindGroups=[],this.clonedBindGroups=[],this.setBindGroups(),this.setTextures(),this.setSamplers()}setMaterial(){let e=this.texturesBindGroup.bindings.length?1:0;this.bindGroups.length>=this.inputsBindGroups.length+e||this.createBindGroups()}get ready(){return!!(this.pipelineEntry&&this.pipelineEntry.pipeline&&this.pipelineEntry.ready)}getShaderCode(e="full"){return this.pipelineEntry?(e=(()=>{switch(e){case"vertex":case"fragment":case"compute":case"full":return e;default:return"full"}})(),this.pipelineEntry.shaders[e].code):""}getAddedShaderCode(e="vertex"){return this.pipelineEntry?(e=(()=>{switch(e){case"vertex":case"fragment":case"compute":return e;default:return"vertex"}})(),this.pipelineEntry.shaders[e].head):""}setBindGroups(){if(this.uniforms={},this.storages={},this.works={},this.inputsBindGroups=[],this.inputsBindings=[],this.options.inputs){let e=new X(this.renderer,{label:this.options.label+": Bindings bind group",inputs:this.options.inputs});this.processBindGroupBindings(e),this.inputsBindGroups.push(e)}this.options.bindGroups?.forEach(e=>{this.processBindGroupBindings(e),this.inputsBindGroups.push(e)})}processBindGroupBindings(e){e.bindings.forEach(t=>{t.bindingType==="uniform"&&(this.uniforms={...this.uniforms,[t.name]:t.bindings}),t.bindingType==="storage"&&(this.storages={...this.storages,[t.name]:t.bindings}),t.bindingType==="storageWrite"&&(this.works={...this.works,[t.name]:t.bindings}),this.inputsBindings.push(t)})}createBindGroups(){this.texturesBindGroup.shouldCreateBindGroup&&(this.texturesBindGroup.setIndex(this.bindGroups.length),this.texturesBindGroup.createBindGroup(),this.bindGroups.push(this.texturesBindGroup)),this.options.bindGroups?.forEach(e=>{!e.shouldCreateBindGroup&&!this.bindGroups.find(t=>t.uuid===e.uuid)&&this.bindGroups.push(e)}),this.inputsBindGroups.forEach(e=>{e.shouldCreateBindGroup&&(e.setIndex(this.bindGroups.length),e.createBindGroup(),this.bindGroups.push(e))})}cloneBindGroup({bindGroup:e,bindingsBuffers:t=[],keepLayout:r=!0}){if(!e)return null;let s=e.cloneFromBindingsBuffers({bindingsBuffers:t,keepLayout:r});return this.clonedBindGroups.push(s),s}getBindGroupByBindingName(e=""){return(this.ready?this.bindGroups:this.inputsBindGroups).find(t=>t.bindings.find(r=>r.name===e))}destroyBindGroups(){this.bindGroups.forEach(e=>e.destroy()),this.clonedBindGroups.forEach(e=>e.destroy()),this.texturesBindGroup=null,this.inputsBindGroups=[],this.bindGroups=[],this.clonedBindGroups=[]}updateBindGroups(){this.bindGroups.forEach(e=>{e.needsReset&&(e.resetBindGroup(),e.needsReset=!1),e.needsPipelineFlush&&this.pipelineEntry.ready&&(this.pipelineEntry.flushPipelineEntry(this.bindGroups),e.needsPipelineFlush=!1),e.updateBindings()})}shouldUpdateInputsBindings(e,t){if(!e)return;let r=this.inputsBindings.find(s=>s.name===e);r&&(t?r.shouldUpdateBinding(t):Object.keys(r.bindings).forEach(s=>r.shouldUpdateBinding(s)))}getBindingsByName(e=""){let t;return(this.ready?this.bindGroups:this.inputsBindGroups).forEach(r=>{t=r.getBindingsByName(e)}),t}getBindingsBuffersByBindingName(e=""){let t=[];return(this.ready?this.bindGroups:this.inputsBindGroups).forEach(r=>{let s=r.bindingsBuffers.filter(i=>i.inputBinding.useStruct?i.inputBinding.name===e:i.inputBinding.name===e+Z(i.inputBinding.bindingElements.length?i.inputBinding.bindingElements[0].name:""));s.length&&(t=[...t,...s])}),t}setTextures(){this.textures=[],this.texturesBindGroup=new ce(this.renderer,{label:this.options.label+": Textures bind group"})}addTexture(e){this.textures.push(e),(this.options.shaders.vertex&&this.options.shaders.vertex.code.indexOf(e.options.name)!==-1||this.options.shaders.fragment&&this.options.shaders.fragment.code.indexOf(e.options.name)!==-1||this.options.shaders.compute&&this.options.shaders.compute.code.indexOf(e.options.name)!==-1)&&this.texturesBindGroup.addTexture(e)}destroyTextures(){this.textures?.forEach(e=>e.destroy()),this.textures=[]}setSamplers(){if(this.samplers=[],this.options.samplers?.forEach(t=>{this.addSampler(t)}),!this.samplers.find(t=>t.name==="defaultSampler")){let t=new ge(this.renderer,{name:"defaultSampler"});this.addSampler(t)}}addSampler(e){this.samplers.push(e),(this.options.shaders.vertex&&this.options.shaders.vertex.code.indexOf(e.name)!==-1||this.options.shaders.fragment&&this.options.shaders.fragment.code.indexOf(e.name)!==-1||this.options.shaders.compute&&this.options.shaders.compute.code.indexOf(e.name)!==-1)&&this.texturesBindGroup.addSampler(e)}onBeforeRender(){this.setMaterial(),this.textures.forEach(e=>{"render"in e&&e.render()}),this.texturesBindGroup?.textures.forEach((e,t)=>{e instanceof te&&(e.options.fromTexture&&e.options.fromTexture.sourceUploaded&&!e.sourceUploaded&&e.copy(e.options.fromTexture),e.shouldUpdate&&e.options.sourceType&&e.options.sourceType==="externalVideo"&&(e.uploadVideoTexture(),this.texturesBindGroup.shouldUpdateVideoTextureBindGroupLayout(t)&&this.texturesBindGroup.updateVideoTextureBindGroupLayout(t))),e.shouldUpdateBindGroup&&(e.texture||e.externalTexture)&&(this.texturesBindGroup.resetTextureBindGroup(),e.shouldUpdateBindGroup=!1)}),this.inputsBindings.forEach(e=>{e.onBeforeRender()}),this.updateBindGroups()}render(e){this.renderer.ready&&this.ready&&(this.renderer.pipelineManager.setCurrentPipeline(e,this.pipelineEntry),this.bindGroups.forEach(t=>{e.setBindGroup(t.index,t.bindGroup)}))}destroy(){this.destroyBindGroups(),this.destroyTextures()}};var ye=class extends re{constructor(t,r){t=t&&t.renderer||t;let s="ComputeMaterial";y(t,s);super(t,r);this.type=s,this.renderer=t;let{shaders:i}=r;(!i||!i.compute)&&(i={compute:{code:"",entryPoint:"main"}}),i.compute.code||(i.compute.code=""),i.compute.entryPoint||(i.compute.entryPoint="main"),this.options={...this.options,shaders:i},this.pipelineEntry=this.renderer.pipelineManager.createComputePipeline({label:this.options.label+" compute pipeline",shaders:this.options.shaders,useAsync:this.options.useAsyncPipeline})}setPipelineEntryBuffers(){this.pipelineEntry.setPipelineEntryBuffers({bindGroups:this.bindGroups})}setMaterial(){super.setMaterial(),this.pipelineEntry&&this.pipelineEntry.canCompile&&this.setPipelineEntryBuffers()}get hasMappedBuffer(){return!!this.bindGroups.some(r=>r.bindingsBuffers.some(s=>s.resultBuffer&&s.resultBuffer.mapState!=="unmapped"))}render(t){this.renderer.ready&&this.ready&&(this.renderer.pipelineManager.setCurrentPipeline(t,this.pipelineEntry),this.bindGroups.forEach(r=>{t.setBindGroup(r.index,r.bindGroup),r.bindings.forEach(s=>{"dispatchSize"in s&&t.dispatchWorkgroups(s.dispatchSize[0],s.dispatchSize[1],s.dispatchSize[2])})}))}copyBufferToResult(t){this.bindGroups.forEach(r=>{r.bindingsBuffers.forEach(s=>{"shouldCopyResult"in s.inputBinding&&s.inputBinding.shouldCopyResult&&t.copyBufferToBuffer(s.buffer,0,s.resultBuffer,0,s.resultBuffer.size)})})}setWorkGroupsResult(){this.bindGroups.forEach(t=>{t.bindingsBuffers.forEach(r=>{r.inputBinding.shouldCopyResult&&this.setBufferResult(r)})})}setBufferResult(t){t.resultBuffer?.mapState==="unmapped"&&t.resultBuffer.mapAsync(GPUMapMode.READ).then(()=>{t.inputBinding.result=new Float32Array(t.resultBuffer.getMappedRange().slice(0)),t.resultBuffer.unmap()})}getWorkGroupResult({workGroupName:t="",bindingName:r=""}){let s;if(this.bindGroups.forEach(i=>{s=i.bindingsBuffers.find(n=>n.inputBinding.name===t)}),s)if(r){let i=s.inputBinding.bindingElements.find(n=>n.name===r);return i?s.inputBinding.result.slice(i.startOffset,i.endOffset):s.inputBinding.result.slice()}else return s.inputBinding.result.slice();else return null}};var Pt=0,_e=class{constructor(e,t={}){this.#e=!0;this._onReadyCallback=()=>{};this._onBeforeRenderCallback=()=>{};this._onRenderCallback=()=>{};this._onAfterRenderCallback=()=>{};this._onAfterResizeCallback=()=>{};let r="ComputePass";e=e&&e.renderer||e,y(e,t.label?`${t.label} ${r}`:r),this.renderer=e,this.type=r,this.uuid=N(),Object.defineProperty(this,"index",{value:Pt++});let{label:s,shaders:i,renderOrder:n,inputs:o,bindGroups:d,autoAddToScene:a,useAsyncPipeline:h}=t;this.options={label:s,shaders:i,...a!==void 0&&{autoAddToScene:a},...n!==void 0&&{renderOrder:n},...h!==void 0&&{useAsyncPipeline:h}},this.renderOrder=n??0,a!==void 0&&(this.#e=a),this.ready=!1,this.setComputeMaterial({label:this.options.label,shaders:this.options.shaders,inputs:o,bindGroups:d,useAsyncPipeline:h}),this.addToScene()}#e;get ready(){return this._ready}set ready(e){e&&this._onReadyCallback&&this._onReadyCallback(),this._ready=e}setComputeMaterial(e){this.material=new ye(this.renderer,e)}addToScene(){this.renderer.computePasses.push(this),this.#e&&this.renderer.scene.addComputePass(this)}removeFromScene(){this.#e&&this.renderer.scene.removeComputePass(this),this.renderer.computePasses=this.renderer.computePasses.filter(e=>e.uuid!==this.uuid)}get uniforms(){return this.material?.uniforms}get storages(){return this.material?.storages}get works(){return this.material?.works}resize(){this._onAfterResizeCallback&&this._onAfterResizeCallback()}onReady(e){return e&&(this._onReadyCallback=e),this}onBeforeRender(e){return e&&(this._onBeforeRenderCallback=e),this}onRender(e){return e&&(this._onRenderCallback=e),this}onAfterRender(e){return e&&(this._onAfterRenderCallback=e),this}onAfterResize(e){return e&&(this._onAfterResizeCallback=e),this}onBeforeRenderPass(){this.renderer.ready&&(this.material&&this.material.ready&&!this.ready&&(this.ready=!0),this._onBeforeRenderCallback&&this._onBeforeRenderCallback(),this.material.onBeforeRender())}onRenderPass(e){this._onRenderCallback&&this._onRenderCallback(),this.material.render(e)}onAfterRenderPass(){this._onAfterRenderCallback&&this._onAfterRenderCallback()}render(e){this.onBeforeRenderPass(),this.renderer.ready&&(this.onRenderPass(e),this.onAfterRenderPass())}get canRender(){return this.material?!this.material.hasMappedBuffer:!1}copyBufferToResult(e){this.material?.copyBufferToResult(e)}setWorkGroupsResult(){this.material?.setWorkGroupsResult()}getWorkGroupResult({workGroupName:e,bindingName:t}){return this.material?.getWorkGroupResult({workGroupName:e,bindingName:t})}remove(){this.removeFromScene(),this.destroy()}destroy(){this.material?.destroy()}};var $=[new p,new p,new p,new p,new p,new p,new p,new p],se=class u{constructor(e=new p(1/0),t=new p(-1/0)){this.min=e,this.max=t}set(e=new p(1/0),t=new p(-1/0)){return this.min.copy(e),this.max.copy(t),this}clone(){return new u().set(this.min,this.max)}getCenter(){return this.max.clone().add(this.min).multiplyScalar(.5)}getSize(){return this.max.clone().sub(this.min)}applyMat4(e=new z){let t=[];this.min.z===this.max.z?(t[0]=$[0].set(this.min.x,this.min.y,this.min.z).applyMat4(e),t[1]=$[2].set(this.min.x,this.max.y,this.min.z).applyMat4(e),t[2]=$[4].set(this.max.x,this.min.y,this.min.z).applyMat4(e),t[3]=$[6].set(this.max.x,this.max.y,this.min.z).applyMat4(e)):(t[0]=$[0].set(this.min.x,this.min.y,this.min.z).applyMat4(e),t[1]=$[1].set(this.min.x,this.min.y,this.max.z).applyMat4(e),t[2]=$[2].set(this.min.x,this.max.y,this.min.z).applyMat4(e),t[3]=$[3].set(this.min.x,this.max.y,this.max.z).applyMat4(e),t[4]=$[4].set(this.max.x,this.min.y,this.min.z).applyMat4(e),t[5]=$[5].set(this.max.x,this.min.y,this.max.z).applyMat4(e),t[6]=$[6].set(this.max.x,this.max.y,this.min.z).applyMat4(e),t[7]=$[7].set(this.max.x,this.max.y,this.max.z).applyMat4(e));let r=new u;for(let s=0,i=t.length;s<i;s++)r.min.min(t[s]),r.max.max(t[s]);return r}};var nt={top:0,right:0,bottom:0,left:0},Pe=class{constructor({boundingBox:e=new se,modelViewProjectionMatrix:t=new z,containerBoundingRect:r={top:0,right:0,bottom:0,left:0,width:0,height:0,x:0,y:0},DOMFrustumMargins:s=nt,onReEnterView:i=()=>{},onLeaveView:n=()=>{}}){this.boundingBox=e,this.modelViewProjectionMatrix=t,this.containerBoundingRect=r,this.DOMFrustumMargins={...nt,...s},this.projectedBoundingRect={top:0,right:0,bottom:0,left:0,width:0,height:0,x:0,y:0},this.onReEnterView=i,this.onLeaveView=n,this.isIntersecting=!1,this.shouldUpdate=!1}setContainerBoundingRect(e){this.containerBoundingRect=e}get DOMFrustumBoundingRect(){return{top:this.projectedBoundingRect.top-this.DOMFrustumMargins.top,right:this.projectedBoundingRect.right+this.DOMFrustumMargins.right,bottom:this.projectedBoundingRect.bottom+this.DOMFrustumMargins.bottom,left:this.projectedBoundingRect.left-this.DOMFrustumMargins.left}}computeProjectedToDocumentCoords(){let e=this.boundingBox.applyMat4(this.modelViewProjectionMatrix);e.min.x=(e.min.x+1)*.5,e.max.x=(e.max.x+1)*.5,e.min.y=1-(e.min.y+1)*.5,e.max.y=1-(e.max.y+1)*.5;let{width:t,height:r,top:s,left:i}=this.containerBoundingRect;this.projectedBoundingRect={left:e.min.x*t+i,x:e.min.x*t+i,top:e.max.y*r+s,y:e.max.y*r+s,right:e.max.x*t+i,bottom:e.min.y*r+s,width:e.max.x*t+i-(e.min.x*t+i),height:e.min.y*r+s-(e.max.y*r+s)},this.intersectsContainer()}intersectsContainer(){Math.round(this.DOMFrustumBoundingRect.right)<=this.containerBoundingRect.left||Math.round(this.DOMFrustumBoundingRect.left)>=this.containerBoundingRect.left+this.containerBoundingRect.width||Math.round(this.DOMFrustumBoundingRect.bottom)<=this.containerBoundingRect.top||Math.round(this.DOMFrustumBoundingRect.top)>=this.containerBoundingRect.top+this.containerBoundingRect.height?(this.isIntersecting&&this.onLeaveView(),this.isIntersecting=!1):(this.isIntersecting||this.onReEnterView(),this.isIntersecting=!0)}};var ie=class{constructor({verticesOrder:e="cw",instancesCount:t=1,vertexBuffers:r=[]}={}){this.verticesCount=0,this.verticesOrder=e,this.instancesCount=t,this.boundingBox=new se,this.type="Geometry",this.vertexBuffers=[],this.addVertexBuffer({name:"attributes"}),this.options={verticesOrder:e,instancesCount:t,vertexBuffers:r},r.forEach(s=>{this.addVertexBuffer({stepMode:s.stepMode??"vertex",name:s.name,attributes:s.attributes})})}addVertexBuffer({stepMode:e="vertex",name:t,attributes:r=[]}={}){let s={name:t??"attributes"+this.vertexBuffers.length,stepMode:e,arrayStride:0,bufferLength:0,attributes:[],buffer:null,indexBuffer:null};return r?.forEach(i=>{this.setAttribute({vertexBuffer:s,...i})}),this.vertexBuffers.push(s),s}getVertexBufferByName(e=""){return this.vertexBuffers.find(t=>t.name===e)}setAttribute({vertexBuffer:e=this.vertexBuffers[0],name:t,type:r="vec3f",bufferFormat:s="float32x3",size:i=3,array:n=new Float32Array(this.verticesCount*i),verticesUsed:o=1}){let d=e.attributes,a=d.length;t||(t="geometryAttribute"+a),t==="position"&&(r!=="vec3f"||s!=="float32x3"||i!==3)&&(k(`Geometry 'position' attribute must have this exact properties set:
	type: 'vec3f',
	bufferFormat: 'float32x3',
	size: 3`),r="vec3f",s="float32x3",i=3);let h=n.length/i;t==="position"&&(this.verticesCount=h),e.stepMode==="vertex"&&this.verticesCount&&this.verticesCount!==h*o?V(`Geometry vertex attribute error. Attribute array of size ${i} must be of length: ${this.verticesCount*i}, current given: ${n.length}. (${this.verticesCount} vertices).`):e.stepMode==="instance"&&h!==this.instancesCount&&V(`Geometry instance attribute error. Attribute array of size ${i} must be of length: ${this.instancesCount*i}, current given: ${n.length}. (${this.instancesCount} instances).`);let l={name:t,type:r,bufferFormat:s,size:i,bufferLength:n.length,offset:a?d.reduce((m,c)=>m+c.bufferLength,0):0,bufferOffset:a?d[a-1].bufferOffset+d[a-1].size*4:0,array:n,verticesUsed:o};e.bufferLength+=l.bufferLength*o,e.arrayStride+=l.size,e.attributes.push(l)}getAttributeByName(e){let t;return this.vertexBuffers.forEach(r=>{t=r.attributes.find(s=>s.name===e)}),t}get shouldCompute(){return!this.vertexBuffers[0].array}computeGeometry(){this.shouldCompute&&(this.vertexBuffers.forEach((e,t)=>{if(t===0){let i=e.attributes.find(n=>n.name==="position");i||V("Geometry must have a 'position' attribute"),(i.type!=="vec3f"||i.bufferFormat!=="float32x3"||i.size!==3)&&(k(`Geometry 'position' attribute must have this exact properties set:
	type: 'vec3f',
	bufferFormat: 'float32x3',
	size: 3`),i.type="vec3f",i.bufferFormat="float32x3",i.size=3)}e.array=new Float32Array(e.bufferLength);let r=0,s=0;for(let i=0;i<e.bufferLength;i+=e.arrayStride){for(let n=0;n<e.attributes.length;n++){let{name:o,size:d,array:a,verticesUsed:h}=e.attributes[n];for(let l=0;l<d;l++){let m=a[Math.floor(s/h)*d+l];e.array[r]=m,o==="position"&&(l%3===0?(this.boundingBox.min.x>m&&(this.boundingBox.min.x=m),this.boundingBox.max.x<m&&(this.boundingBox.max.x=m)):l%3===1?(this.boundingBox.min.y>m&&(this.boundingBox.min.y=m),this.boundingBox.max.y<m&&(this.boundingBox.max.y=m)):l%3===2&&(this.boundingBox.min.z>m&&(this.boundingBox.min.z=m),this.boundingBox.max.z<m&&(this.boundingBox.max.z=m))),r++}}s++}}),this.#e())}#e(){let e=-1;this.wgslStructFragment=`struct Attributes {
	@builtin(vertex_index) vertexIndex : u32,
	@builtin(instance_index) instanceIndex : u32,${this.vertexBuffers.map(t=>t.attributes.map(r=>(e++,`
	@location(${e}) ${r.name}: ${r.type}`))).join(",")}
};`}};var q=class extends ie{constructor({verticesOrder:t="cw",instancesCount:r=1,vertexBuffers:s=[]}={}){super({verticesOrder:t,instancesCount:r,vertexBuffers:s});this.type="IndexedGeometry",this.isIndexed=!0}setIndexBuffer({vertexBuffer:t=this.vertexBuffers[0],bufferFormat:r="uint32",array:s=new Uint32Array(0)}){t.indexBuffer={array:s,bufferFormat:r,bufferLength:s.length,buffer:null}}};var ne=class extends q{constructor({widthSegments:t=1,heightSegments:r=1,instancesCount:s=1,vertexBuffers:i=[]}={}){super({verticesOrder:"cw",instancesCount:s,vertexBuffers:i});this.type="PlaneGeometry",t=Math.floor(t),r=Math.floor(r),this.definition={id:t*r+t,width:t,height:r,count:t*r},this.setIndexArray();let n=this.definition.width*2+2+(this.definition.height-1)*(this.definition.width+1),o=this.getIndexedVerticesAndUVs(n);Object.keys(o).forEach(d=>{this.setAttribute(o[d])})}setIndexArray(){let t=new Uint32Array(this.definition.count*6),r=0;for(let s=0;s<this.definition.height;s++)for(let i=0;i<this.definition.width;i++)t[r++]=i+s*(this.definition.width+1),t[r++]=this.definition.width+i+1+s*(this.definition.width+1),t[r++]=i+1+s*(this.definition.width+1),t[r++]=i+1+s*(this.definition.width+1),t[r++]=this.definition.width+i+1+s*(this.definition.width+1),t[r++]=this.definition.width+i+2+s*(this.definition.width+1);this.setIndexBuffer({array:t})}getIndexedVerticesAndUVs(t){let r={name:"uv",type:"vec2f",bufferFormat:"float32x2",size:2,bufferLength:t*2,array:new Float32Array(t*2)},s={name:"position",type:"vec3f",bufferFormat:"float32x3",size:3,bufferLength:t*3,array:new Float32Array(t*3)},i=0,n=0;for(let o=0;o<=this.definition.height;o++){let d=o/this.definition.height;for(let a=0;a<this.definition.width;a++){let h=a/this.definition.width;a===0&&(r.array[n++]=h,r.array[n++]=1-d,s.array[i++]=(h-.5)*2,s.array[i++]=(d-.5)*2,s.array[i++]=0),r.array[n++]=h+1/this.definition.width,r.array[n++]=1-d,s.array[i++]=(h+1/this.definition.width-.5)*2,s.array[i++]=(d-.5)*2,s.array[i++]=0}}return{position:s,uv:r}}};var be=class extends re{constructor(t,r){t=t&&t.renderer||t;let s="RenderMaterial";y(t,s);super(t,r);this.type=s,this.renderer=t;let{shaders:i,label:n,useAsyncPipeline:o,inputs:d,bindGroups:a,geometry:h,...l}=r;i.vertex.entryPoint||(i.vertex.entryPoint="main"),i.fragment.entryPoint||(i.fragment.entryPoint="main"),this.options={...this.options,shaders:i,label:n,...o!==void 0&&{useAsyncPipeline:o},...d!==void 0&&{inputs:d},...a!==void 0&&{bindGroups:a},rendering:{...l,verticesOrder:h.verticesOrder}},this.pipelineEntry=this.renderer.pipelineManager.createRenderPipeline({label:this.options.label+" render pipeline",shaders:this.options.shaders,useAsync:this.options.useAsyncPipeline,...this.options.rendering}),this.attributes=null,this.setAttributesFromGeometry(h)}setPipelineEntryBuffers(){this.pipelineEntry.setPipelineEntryBuffers({attributes:this.attributes,bindGroups:this.bindGroups})}setMaterial(){this.attributes?.vertexBuffers[0].buffer||this.createAttributesBuffers(),super.setMaterial(),this.pipelineEntry&&this.pipelineEntry.canCompile&&this.setPipelineEntryBuffers()}setAttributesFromGeometry(t){t.shouldCompute&&t.computeGeometry(),this.attributes={wgslStructFragment:t.wgslStructFragment,verticesCount:t.verticesCount,instancesCount:t.instancesCount,verticesOrder:t.verticesOrder,vertexBuffers:t.vertexBuffers}}createAttributesBuffers(){this.attributes.vertexBuffers.forEach(t=>{t.buffer=this.renderer.createBuffer({label:this.options.label+": Vertex buffer vertices",size:t.array.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),this.renderer.queueWriteBuffer(t.buffer,0,t.array),t.indexBuffer&&(t.indexBuffer.buffer=this.renderer.createBuffer({label:this.options.label+": Index buffer vertices",size:t.indexBuffer.array.byteLength,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST}),this.renderer.queueWriteBuffer(t.indexBuffer.buffer,0,t.indexBuffer.array))})}destroyAttributeBuffers(){this.attributes.vertexBuffers.forEach(t=>{t.buffer?.destroy(),t.indexBuffer?.buffer?.destroy()}),this.attributes.vertexBuffers=[]}createBindGroups(){this.renderer.cameraBindGroup&&this.options.rendering.useProjection&&this.bindGroups.push(this.renderer.cameraBindGroup),super.createBindGroups()}render(t){this.renderer.ready&&this.ready&&(super.render(t),this.attributes.vertexBuffers.forEach((r,s)=>{t.setVertexBuffer(s,r.buffer),r.indexBuffer&&t.setIndexBuffer(r.indexBuffer.buffer,r.indexBuffer.bufferFormat)}),this.attributes.vertexBuffers[0].indexBuffer?t.drawIndexed(this.attributes.vertexBuffers[0].indexBuffer.bufferLength,this.attributes.instancesCount):t.draw(this.attributes.verticesCount,this.attributes.instancesCount))}destroy(){super.destroy(),this.destroyAttributeBuffers()}};var ot={label:"Texture",name:"texture",fromTexture:null},oe=class{constructor(e,t=ot){e=e&&e.renderer||e,y(e,t.label?t.label+" RenderTexture":"RenderTexture"),this.type="RenderTexture",this.renderer=e,this.options={...ot,...t},this.shouldUpdateBindGroup=!1,this.setSourceSize(),this.setBindings(),this.createTexture()}setSourceSize(){let e=this.renderer.pixelRatioBoundingRect;this.size={width:e.width,height:e.height}}createTexture(){if(this.options.fromTexture){this.texture=this.options.fromTexture.texture,this.textureBinding.resource=this.texture;return}this.texture?.destroy(),this.texture=this.renderer.createTexture({label:this.options.label,format:this.renderer.preferredFormat,size:[this.size.width,this.size.height],usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT}),this.textureBinding.resource=this.texture}setBindings(){this.bindings=[new K({label:this.options.label+": "+this.options.name+" texture",name:this.options.name,resource:this.texture,bindingType:"texture"})]}get textureBinding(){return this.bindings[0]}resize(){this.setSourceSize(),this.createTexture(),this.shouldUpdateBindGroup=!0}destroy(){this.texture?.destroy(),this.texture=null}};var bt=0,at={label:"Mesh",geometry:new ie,shaders:{},autoAddToScene:!0,useProjection:!1,cullMode:"back",depthWriteEnabled:!0,depthCompare:"less",transparent:!1,visible:!0,renderOrder:0,texturesOptions:{}};function Bt(u){return class extends u{constructor(...r){super(r[0],r[1],{...at,...r[2]});this.#e=!0;this._onReadyCallback=()=>{};this._onBeforeRenderCallback=()=>{};this._onRenderCallback=()=>{};this._onAfterRenderCallback=()=>{};this._onAfterResizeCallback=()=>{};let s=r[0],i={...at,...r[2]};this.type="MeshBase",this.uuid=N(),Object.defineProperty(this,"index",{value:bt++}),s=s&&s.renderer||s,J(s,i.label?i.label+" "+this.type:this.type),this.renderer=s,this.textures=[],this.renderTextures=[];let{label:n,shaders:o,geometry:d,visible:a,renderOrder:h,renderTarget:l,texturesOptions:m,autoAddToScene:c,verticesOrder:P,...g}=i;this.options={...this.options??{},label:n,shaders:o,texturesOptions:m,...l!==void 0&&{renderTarget:l},...c!==void 0&&{autoAddToScene:c},...g.useAsyncPipeline!==void 0&&{useAsyncPipeline:g.useAsyncPipeline}},this.renderTarget=l??null,this.geometry=d,c!==void 0&&(this.#e=c),this.visible=a,this.renderOrder=h,this.ready=!1,this.setMeshMaterial({label:this.options.label,shaders:this.options.shaders,...g,geometry:this.geometry}),this.addToScene()}#e;get autoAddToScene(){return this.#e}get ready(){return this._ready}set ready(r){r&&this._onReadyCallback&&this._onReadyCallback(),this._ready=r}setMeshMaterial(r){this.transparent=r.transparent,this.setMaterial(r)}setMaterial(r){this.material=new be(this.renderer,r)}addToScene(){this.renderer.meshes.push(this),this.#e&&this.renderer.scene.addMesh(this)}removeFromScene(){this.#e&&this.renderer.scene.removeMesh(this),this.renderer.meshes=this.renderer.meshes.filter(r=>r.uuid!==this.uuid)}createTexture(r){r.name||(r.name="texture"+this.textures.length),r.label||(r.label=this.options.label+" "+r.name);let s=new te(this.renderer,{...r,texture:this.options.texturesOptions});return this.material.addTexture(s),this.textures.push(s),this.onTextureCreated(s),s}onTextureCreated(r){r.parent=this}createRenderTexture(r){r.name||(r.name="renderTexture"+this.renderTextures.length);let s=new oe(this.renderer,r);return this.material.addTexture(s),this.renderTextures.push(s),s}setRenderTarget(r){if(r&&r.type!=="RenderTarget"){k(`${this.options.label??this.type}: renderTarget is not a RenderTarget: ${r}`);return}this.removeFromScene(),this.renderTarget=r,this.addToScene()}get uniforms(){return this.material?.uniforms}get storages(){return this.material?.storages}resize(r=null){this.renderTextures?.forEach(s=>s.resize()),super.resize&&super.resize(r),this.textures?.forEach(s=>{s.resize()}),this._onAfterResizeCallback&&this._onAfterResizeCallback()}onReady(r){return r&&(this._onReadyCallback=r),this}onBeforeRender(r){return r&&(this._onBeforeRenderCallback=r),this}onRender(r){return r&&(this._onRenderCallback=r),this}onAfterRender(r){return r&&(this._onAfterRenderCallback=r),this}onAfterResize(r){return r&&(this._onAfterResizeCallback=r),this}onBeforeRenderPass(){this.renderer.ready&&(this.material&&this.material.ready&&!this.ready&&(this.ready=!0),this._onBeforeRenderCallback&&this._onBeforeRenderCallback(),this.material.onBeforeRender())}onRenderPass(r){this._onRenderCallback&&this._onRenderCallback(),this.material.render(r)}onAfterRenderPass(){this._onAfterRenderCallback&&this._onAfterRenderCallback()}render(r){this.onBeforeRenderPass(),!(!this.renderer.ready||!this.visible)&&(super.render&&super.render(),this.onRenderPass(r),this.onAfterRenderPass())}remove(){this.removeFromScene(),this.destroy()}destroy(){super.destroy&&super.destroy(),this.material?.destroy(),this.geometry=null,this.renderTextures=[],this.textures=[]}}}var Be=Bt;var Ke=class{constructor(){this.shouldWatch=!0,this.entries=[],this.resizeObserver=new ResizeObserver(e=>{e.forEach(t=>{let r=this.entries.find(s=>s.element.isSameNode(t.target));r&&r.callback&&r.callback()})})}useObserver(e=!0){this.shouldWatch=e}observe({element:e,callback:t}){if(!e||!this.shouldWatch)return;this.resizeObserver.observe(e);let r={element:e,callback:t};this.entries.push(r)}unobserve(e){this.resizeObserver.unobserve(e),this.entries=this.entries.filter(t=>!t.element.isSameNode(e))}destroy(){this.resizeObserver.disconnect()}},Ve=new Ke;var W=class{constructor({element:e=document.body,onSizeChanged:t=(s=null)=>{},onPositionChanged:r=(s=null)=>{}}={}){this.#e=null;if(typeof e=="string"){if(this.element=document.querySelector(e),!this.element){let s=typeof e=="string"?`'${e}' selector`:`${e} HTMLElement`;V(`DOMElement: corresponding ${s} not found.`)}}else this.element=e;this.isResizing=!1,this.onSizeChanged=t,this.onPositionChanged=r,this.resizeManager=Ve,this.resizeManager.observe({element:this.element,callback:()=>{this.setSize()}}),this.setSize()}#e;compareBoundingRect(e,t){return!["x","y","left","top","right","bottom","width","height"].some(r=>e[r]!==t[r])}get boundingRect(){return this._boundingRect}set boundingRect(e){let t=!!this.boundingRect&&this.compareBoundingRect(e,this.boundingRect);this._boundingRect={top:e.top,right:e.right,bottom:e.bottom,left:e.left,width:e.width,height:e.height,x:e.x,y:e.y},t||this.onSizeChanged(this.boundingRect)}updateScrollPosition(e,t){this.isResizing||(this._boundingRect.top+=t,this._boundingRect.left+=e,(e||t)&&this.onPositionChanged(this.boundingRect))}setSize(e=null){this.element&&(this.isResizing=!!this.boundingRect,this.boundingRect=e??this.element.getBoundingClientRect(),this.#e=setTimeout(()=>{this.isResizing=!1,this.#e=null},50))}destroy(){this.resizeManager.unobserve(this.element),this.#e&&clearTimeout(this.#e)}};var dt=`
struct VertexOutput {
  @builtin(position) position: vec4f,
  @location(0) uv: vec2f,
};

@vertex fn main(
  attributes: Attributes,
) -> VertexOutput {
  var vertexOutput: VertexOutput;

  vertexOutput.position = vec4f(attributes.position, 1.0);
  vertexOutput.uv = attributes.uv;
  
  return vertexOutput;
}`;var et=class{constructor(){this.planeGeometries=[]}getPlaneGeometry(e){return this.planeGeometries.find(t=>t.definition.id===e.definition.id)}getPlaneGeometryByID(e){return this.planeGeometries.find(t=>t.definition.id===e)}addPlaneGeometry(e){this.planeGeometries.push(e)}destroy(){this.planeGeometries=[]}},Re=new et;var ae=class extends Be(class{}){constructor(t,r={}){t=t&&t.renderer||t,y(t,r.label?r.label+" FullscreenQuadMesh":"FullscreenQuadMesh");let s=Re.getPlaneGeometryByID(2);s||(s=new ne({widthSegments:1,heightSegments:1}),Re.addPlaneGeometry(s)),(!r.shaders.vertex||!r.shaders.vertex.code)&&(r.shaders.vertex={code:dt,entryPoint:"main"});super(t,null,{geometry:s,...r});this.size={document:{width:0,height:0,top:0,left:0}},this.domElement=new W({element:this.renderer.domElement.element,onSizeChanged:i=>this.resize(i)}),this.type="FullscreenQuadMesh"}resize(t=null){!t&&(!this.domElement||this.domElement?.isResizing)||(this.size.document=t??this.domElement.element.getBoundingClientRect(),super.resize(t))}mouseToPlaneCoords(t=new _){return new _((t.x-this.size.document.left)/this.size.document.width*2-1,1-(t.y-this.size.document.top)/this.size.document.height*2)}};var de=class extends ee{constructor(t){super();t=t&&t.renderer||t,J(t,"ProjectedObject3D"),this.renderer=t,this.camera=this.renderer.camera}applyPosition(){super.applyPosition(),this.shouldUpdateProjectionMatrixStack()}applyRotation(){super.applyRotation(),this.shouldUpdateProjectionMatrixStack()}applyScale(){super.applyScale(),this.shouldUpdateProjectionMatrixStack()}applyTransformOrigin(){super.applyTransformOrigin(),this.shouldUpdateProjectionMatrixStack()}setMatrices(){super.setMatrices(),this.matrices={...this.matrices,modelView:{matrix:new z,shouldUpdate:!1,onUpdate:()=>{this.modelViewMatrix.multiplyMatrices(this.camera.viewMatrix,this.modelMatrix)}},modelViewProjection:{matrix:new z,shouldUpdate:!1,onUpdate:()=>{this.modelViewProjectionMatrix.multiplyMatrices(this.projectionMatrix,this.modelViewMatrix)}}}}get modelViewMatrix(){return this.matrices.modelView.matrix}set modelViewMatrix(t){this.matrices.modelView.matrix=t,this.matrices.modelView.shouldUpdate=!0}get viewMatrix(){return this.camera.viewMatrix}get projectionMatrix(){return this.camera.projectionMatrix}get modelViewProjectionMatrix(){return this.matrices.modelViewProjection.matrix}set modelViewProjectionMatrix(t){this.matrices.modelViewProjection.matrix=t,this.matrices.modelViewProjection.shouldUpdate=!0}shouldUpdateProjectionMatrixStack(){this.matrices.modelView.shouldUpdate=!0,this.matrices.modelViewProjection.shouldUpdate=!0}updateSizePositionAndProjection(){this.shouldUpdateModelMatrix(),this.shouldUpdateProjectionMatrixStack()}};var ut={useProjection:!0,frustumCulled:!0,DOMFrustumMargins:{top:0,right:0,bottom:0,left:0}};function Rt(u){return class extends u{constructor(...r){super(r[0],r[1],{...ut,...r[2]});this._onReEnterViewCallback=()=>{};this._onLeaveViewCallback=()=>{};let s=r[0],i={...ut,...r[2]};this.type="MeshTransformed",s=s&&s.renderer||s,J(s,i.label?i.label+" "+this.type:this.type),this.renderer=s;let{label:n,geometry:o,shaders:d}=i;this.options={...this.options??{},label:n,shaders:d},this.geometry=o,this.updateSizePositionAndProjection()}setMeshMaterial(r){let{frustumCulled:s,DOMFrustumMargins:i,...n}=r,o={label:"Matrices",bindings:{model:{name:"model",type:"mat4x4f",value:this.modelMatrix,onBeforeUpdate:()=>{o.bindings.model.value=this.modelMatrix}},modelView:{name:"modelView",type:"mat4x4f",value:this.modelViewMatrix,onBeforeUpdate:()=>{o.bindings.modelView.value=this.modelViewMatrix}},modelViewProjection:{name:"modelViewProjection",type:"mat4x4f",value:this.modelViewProjectionMatrix,onBeforeUpdate:()=>{o.bindings.modelViewProjection.value=this.modelViewProjectionMatrix}}}};n.inputs||(n.inputs={uniforms:{}}),n.inputs.uniforms.matrices=o,super.setMeshMaterial(n),this.domFrustum=new Pe({boundingBox:this.geometry.boundingBox,modelViewProjectionMatrix:this.modelViewProjectionMatrix,containerBoundingRect:this.renderer.boundingRect,DOMFrustumMargins:i,onReEnterView:()=>{this._onReEnterViewCallback&&this._onReEnterViewCallback()},onLeaveView:()=>{this._onLeaveViewCallback&&this._onLeaveViewCallback()}}),this.frustumCulled=s,this.DOMFrustumMargins=this.domFrustum.DOMFrustumMargins}resize(r=null){this.domFrustum&&this.domFrustum.setContainerBoundingRect(this.renderer.boundingRect),super.resize(r)}applyScale(){super.applyScale(),this.textures.forEach(r=>r.resize())}get projectedBoundingRect(){return this.domFrustum?.projectedBoundingRect}updateSizePositionAndProjection(){super.updateSizePositionAndProjection()}updateMatrixStack(){super.updateMatrixStack()}onAfterMatrixStackUpdate(){this.material&&this.material.shouldUpdateInputsBindings("matrices"),this.domFrustum&&(this.domFrustum.shouldUpdate=!0)}onReEnterView(r){return r&&(this._onReEnterViewCallback=r),this}onLeaveView(r){return r&&(this._onLeaveViewCallback=r),this}onBeforeRenderPass(){this.updateMatrixStack(),this.domFrustum.shouldUpdate&&this.frustumCulled&&(this.domFrustum.computeProjectedToDocumentCoords(),this.domFrustum.shouldUpdate=!1),super.onBeforeRenderPass()}onRenderPass(r){this._onRenderCallback&&this._onRenderCallback(),(this.domFrustum.isIntersecting||!this.frustumCulled)&&this.material.render(r)}}}var je=Rt;var Ie=class extends je(Be(de)){constructor(e,t={}){e=e&&e.renderer||e,J(e,t.label?t.label+" Mesh":"Mesh"),super(e,null,t),this.type="Mesh"}};var Mt=0,ue=class{constructor(e){this.type="PipelineEntry";let{renderer:t}=e,{label:r,shaders:s,useAsync:i}=e;t=t&&t.renderer||t,y(t,r?r+" "+this.type:this.type),this.renderer=t,Object.defineProperty(this,"index",{value:Mt++}),this.layout=null,this.pipeline=null,this.status={compiling:!1,compiled:!1,error:null},this.options={label:r,shaders:s,useAsync:i!==void 0?i:!0}}get ready(){return!this.status.compiling&&this.status.compiled&&!this.status.error}get canCompile(){return!this.status.compiling&&!this.status.compiled&&!this.status.error}setPipelineEntryBindGroups(e){this.bindGroups=e}createShaderModule({code:e="",type:t="vertex"}){let r=this.renderer.createShaderModule({label:this.options.label+": "+t+"Shader module",code:e});return r.getCompilationInfo().then(s=>{for(let i of s.messages){let n="";switch(i.lineNum&&(n+=`Line ${i.lineNum}:${i.linePos} - ${e.substring(i.offset,i.offset+i.length)}
`),n+=i.message,i.type){case"error":!this.renderer.production&&console.error(`${this.options.label} compilation error:
${n}`);break;case"warning":!this.renderer.production&&console.warn(`${this.options.label} compilation warning:
${n}`);break;case"info":!this.renderer.production&&console.log(`${this.options.label} compilation information:
${n}`);break}}}),r}createShaders(){}createPipelineLayout(){this.layout=this.renderer.createPipelineLayout({label:this.options.label+" layout",bindGroupLayouts:this.bindGroups.map(e=>e.bindGroupLayout)})}createPipelineDescriptor(){}flushPipelineEntry(e=[]){this.status.compiling=!1,this.status.compiled=!1,this.status.error=null,this.setPipelineEntryBindGroups(e),this.setPipelineEntry()}setPipelineEntry(){this.status.compiling=!0,this.createShaders(),this.createPipelineLayout(),this.createPipelineDescriptor()}};var ht=`
fn getOutputPosition(camera: Camera, matrices: Matrices, position: vec3f) -> vec4f {
  return camera.projection * matrices.modelView * vec4f(position, 1.0);
}`;var tt=`
fn getUVCover(uv: vec2f, textureMatrix: mat4x4f) -> vec2f {
  return (textureMatrix * vec4f(uv, 0, 1)).xy;
}`;var lt=`
fn getVertex2DToUVCoords(vertex: vec2f) -> vec2f {
  return vec2(
    vertex.x * 0.5 + 0.5,
    0.5 - vertex.y * 0.5
  );
}

fn getVertex3DToUVCoords(vertex: vec3f) -> vec2f {
  return vec2(
    vertex.x * 0.5 + 0.5,
    0.5 - vertex.y * 0.5
  );
}
`;var Ae={vertex:{get_scaled_uv:tt},fragment:{get_scaled_uv:tt,get_vertex_to_uv_coords:lt}},De={vertex:{get_output_position:ht},fragment:{}};var Me=class extends ue{constructor(t){let{renderer:r}=t,{label:s,cullMode:i,depthWriteEnabled:n,depthCompare:o,transparent:d,verticesOrder:a,useProjection:h}=t;r=r&&r.renderer||r;let l="RenderPipelineEntry";y(r,s?s+" "+l:l);super(t);this.type=l,this.shaders={vertex:{head:"",code:"",module:null},fragment:{head:"",code:"",module:null},full:{code:"",module:null}},this.descriptor=null,this.options={...this.options,cullMode:i,depthWriteEnabled:n,depthCompare:o,transparent:d,verticesOrder:a,useProjection:h}}setPipelineEntryBuffers(t){let{attributes:r,bindGroups:s}=t;this.attributes=r,this.setPipelineEntryBindGroups(s),this.setPipelineEntry()}patchShaders(){this.shaders.vertex.head="",this.shaders.vertex.code="",this.shaders.fragment.head="",this.shaders.fragment.code="";for(let r in Ae.vertex)this.shaders.vertex.head=`${Ae.vertex[r]}
${this.shaders.vertex.head}`;for(let r in Ae.fragment)this.shaders.fragment.head=`${Ae.fragment[r]}
${this.shaders.fragment.head}`;if(this.options.useProjection){for(let r in De.vertex)this.shaders.vertex.head=`${De.vertex[r]}
${this.shaders.vertex.head}`;for(let r in De.fragment)this.shaders.fragment.head=`${De.fragment[r]}
${this.shaders.fragment.head}`}let t=[];this.bindGroups.forEach(r=>{let s=0;r.bindings.forEach((i,n)=>{i.wgslGroupFragment.forEach((o,d)=>{t.push({groupIndex:r.index,visibility:i.visibility,bindIndex:s,wgslStructFragment:i.wgslStructFragment,wgslGroupFragment:o,newLine:n===r.bindings.length-1&&d===i.wgslGroupFragment.length-1}),s++})})}),t.forEach(r=>{(r.visibility===GPUShaderStage.VERTEX||r.visibility===(GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE))&&(r.wgslStructFragment&&(this.shaders.vertex.head=`
${r.wgslStructFragment}
${this.shaders.vertex.head}`),this.shaders.vertex.head=`${this.shaders.vertex.head}
@group(${r.groupIndex}) @binding(${r.bindIndex}) ${r.wgslGroupFragment}`,r.newLine&&(this.shaders.vertex.head+=`
`)),(r.visibility===GPUShaderStage.FRAGMENT||r.visibility===(GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE))&&(r.wgslStructFragment&&(this.shaders.fragment.head=`
${r.wgslStructFragment}
${this.shaders.fragment.head}`),this.shaders.fragment.head=`${this.shaders.fragment.head}
@group(${r.groupIndex}) @binding(${r.bindIndex}) ${r.wgslGroupFragment}`,r.newLine&&(this.shaders.fragment.head+=`
`))}),this.shaders.vertex.head=`${this.attributes.wgslStructFragment}
${this.shaders.vertex.head}`,this.shaders.vertex.code=this.shaders.vertex.head+this.options.shaders.vertex.code,this.shaders.fragment.code=this.shaders.fragment.head+this.options.shaders.fragment.code,this.shaders.full.code=this.shaders.vertex.code+`
`+this.shaders.fragment.code}createShaders(){this.patchShaders(),this.shaders.vertex.module=this.createShaderModule({code:this.shaders.vertex.code,type:"vertex"}),this.shaders.fragment.module=this.createShaderModule({code:this.shaders.fragment.code,type:"fragment"})}createPipelineDescriptor(){if(!this.shaders.vertex.module||!this.shaders.fragment.module)return;let t=-1;this.descriptor={label:this.options.label,layout:this.layout,vertex:{module:this.shaders.vertex.module,entryPoint:this.options.shaders.vertex.entryPoint,buffers:this.attributes.vertexBuffers.map(r=>({stepMode:r.stepMode,arrayStride:r.arrayStride*4,attributes:r.attributes.map(s=>(t++,{shaderLocation:t,offset:s.bufferOffset,format:s.bufferFormat}))}))},fragment:{module:this.shaders.fragment.module,entryPoint:this.options.shaders.fragment.entryPoint,targets:[{format:this.renderer.preferredFormat,...this.options.transparent&&{blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha"}}}}]},primitive:{frontFace:this.options.verticesOrder,cullMode:this.options.cullMode},depthStencil:{depthWriteEnabled:this.options.depthWriteEnabled,depthCompare:this.options.depthCompare,format:"depth24plus"},...this.renderer.sampleCount>1&&{multisample:{count:this.renderer.sampleCount}}}}createRenderPipeline(){if(!(!this.shaders.vertex.module||!this.shaders.fragment.module))try{this.pipeline=this.renderer.createRenderPipeline(this.descriptor)}catch(t){this.status.error=t,V(t)}}async createRenderPipelineAsync(){if(!(!this.shaders.vertex.module||!this.shaders.fragment.module))try{this.pipeline=await this.renderer.createRenderPipelineAsync(this.descriptor),this.status.compiled=!0,this.status.compiling=!1,this.status.error=null}catch(t){this.status.error=t,V(t)}}setPipelineEntry(){super.setPipelineEntry(),this.options.useAsync?this.createRenderPipelineAsync():(this.createRenderPipeline(),this.status.compiled=!0,this.status.compiling=!1,this.status.error=null)}};var Te=class extends ue{constructor(t){let{renderer:r}=t,{label:s}=t;r=r&&r.renderer||r;let i="ComputePipelineEntry";y(r,s?s+" "+i:i);super(t);this.type=i,this.shaders={compute:{head:"",code:"",module:null}},this.descriptor=null}setPipelineEntryBuffers(t){let{bindGroups:r}=t;this.setPipelineEntryBindGroups(r),this.setPipelineEntry()}patchShaders(){this.shaders.compute.head="",this.shaders.compute.code="";let t=[];this.bindGroups.forEach(r=>{let s=0;r.bindings.forEach((i,n)=>{i.wgslGroupFragment.forEach((o,d)=>{t.push({groupIndex:r.index,visibility:i.visibility,bindIndex:s,wgslStructFragment:i.wgslStructFragment,wgslGroupFragment:o,newLine:n===r.bindings.length-1&&d===i.wgslGroupFragment.length-1}),s++})})}),t.forEach(r=>{r.wgslStructFragment&&this.shaders.compute.head.indexOf(r.wgslStructFragment)===-1&&(this.shaders.compute.head=`
${r.wgslStructFragment}
${this.shaders.compute.head}`),this.shaders.compute.head=`${this.shaders.compute.head}
@group(${r.groupIndex}) @binding(${r.bindIndex}) ${r.wgslGroupFragment}`,r.newLine&&(this.shaders.compute.head+=`
`)}),this.shaders.compute.code=this.shaders.compute.head+this.options.shaders.compute.code}createShaders(){this.patchShaders(),this.shaders.compute.module=this.createShaderModule({code:this.shaders.compute.code,type:"compute"})}createPipelineDescriptor(){this.shaders.compute.module&&(this.descriptor={label:this.options.label,layout:this.layout,compute:{module:this.shaders.compute.module,entryPoint:this.options.shaders.compute.entryPoint}})}createComputePipeline(){if(this.shaders.compute.module)try{this.pipeline=this.renderer.createComputePipeline(this.descriptor)}catch(t){this.status.error=t,V(t)}}async createComputePipelineAsync(){if(this.shaders.compute.module)try{this.pipeline=await this.renderer.createComputePipelineAsync(this.descriptor),this.status.compiled=!0,this.status.compiling=!1,this.status.error=null}catch(t){this.status.error=t,V(t)}}setPipelineEntry(){super.setPipelineEntry(),this.options.useAsync?this.createComputePipelineAsync():(this.createComputePipeline(),this.status.compiled=!0,this.status.compiling=!1,this.status.error=null)}};var Ce=class{constructor({renderer:e}){this.type="PipelineManager",e=e&&e.renderer||e,y(e,this.type),this.renderer=e,this.currentPipelineIndex=null,this.pipelineEntries=[]}isSameRenderPipeline(e){let{shaders:t,cullMode:r,depthWriteEnabled:s,depthCompare:i,transparent:n,verticesOrder:o}=e;return this.pipelineEntries.filter(d=>d.type==="RenderPipelineEntry").find(d=>{let{options:a}=d;return t.vertex.code.localeCompare(a.shaders.vertex.code)===0&&t.fragment.code.localeCompare(a.shaders.fragment.code)===0&&r===a.cullMode&&s===a.depthWriteEnabled&&i===a.depthCompare&&n===a.transparent&&o===a.verticesOrder})}createRenderPipeline(e){let t=this.isSameRenderPipeline(e);if(t)return t;{let r=new Me({renderer:this.renderer,...e});return this.pipelineEntries.push(r),r}}createComputePipeline(e){let t=new Te({renderer:this.renderer,...e});return this.pipelineEntries.push(t),t}setCurrentPipeline(e,t){t.index!==this.currentPipelineIndex&&(e.setPipeline(t.pipeline),this.currentPipelineIndex=t.index)}resetCurrentPipeline(){this.currentPipelineIndex=null}};var Ge=class extends de{constructor(t,r,s){super(t);this.#e=new p;this.#t=new p;t=t&&t.renderer||t,me(t,"DOM3DObject"),this.renderer=t,this.size={world:{width:0,height:0,top:0,left:0},document:{width:0,height:0,top:0,left:0}},this.watchScroll=s.watchScroll,this.camera=this.renderer.camera,this.setDOMElement(r)}#e;#t;setDOMElement(t){this.domElement=new W({element:t,onSizeChanged:r=>this.resize(r),onPositionChanged:r=>{this.watchScroll&&(this.size.document=r,this.updateSizeAndPosition())}})}resetDOMElement(t){this.domElement&&this.domElement.destroy(),this.setDOMElement(t)}updateSizeAndPosition(){this.setWorldSizes(),this.applyPosition(),super.updateSizeAndPosition()}updateSizePositionAndProjection(){this.updateSizeAndPosition(),super.updateSizePositionAndProjection()}resize(t=null){!t&&(!this.domElement||this.domElement?.isResizing)||(this.size.document=t??this.domElement.element.getBoundingClientRect(),this.updateSizePositionAndProjection())}get boundingRect(){return this.domElement.boundingRect}setTransforms(){super.setTransforms(),this.transforms.origin.model.set(.5,.5,0),this.transforms.origin.world=new p,this.transforms.position.document=new p,this.documentPosition.onChange(()=>this.applyPosition()),this.transformOrigin.onChange(()=>this.setWorldTransformOrigin())}get documentPosition(){return this.transforms.position.document}set documentPosition(t){this.transforms.position.document=t,this.applyPosition()}get worldScale(){return this.#t.clone().multiply(this.scale)}get worldPosition(){return this.#e}get transformOrigin(){return this.transforms.origin.model}set transformOrigin(t){this.transforms.origin.model=t,this.setWorldTransformOrigin()}get worldTransformOrigin(){return this.transforms.origin.world}set worldTransformOrigin(t){this.transforms.origin.world=t}applyPosition(){this.applyDocumentPosition(),super.applyPosition()}applyDocumentPosition(){let t=new p(0,0,0);this.documentPosition.equals(t)||(t=this.documentToWorldSpace(this.documentPosition)),this.#e.set(this.position.x+this.size.world.left+t.x,this.position.y+this.size.world.top+t.y,this.position.z+this.documentPosition.z/this.camera.CSSPerspective)}applyTransformOrigin(){this.size&&(this.setWorldTransformOrigin(),super.applyTransformOrigin())}updateModelMatrix(){this.modelMatrix.composeFromOrigin(this.#e,this.quaternion,this.scale,this.worldTransformOrigin),this.modelMatrix.scale(this.#t)}documentToWorldSpace(t=new p){return new p(t.x*this.renderer.pixelRatio/this.renderer.boundingRect.width*this.camera.screenRatio.width,-(t.y*this.renderer.pixelRatio/this.renderer.boundingRect.height)*this.camera.screenRatio.height,t.z)}setWorldSizes(){let t=this.renderer.boundingRect,r={x:this.size.document.width/2+this.size.document.left,y:this.size.document.height/2+this.size.document.top},s={x:t.width/2+t.left,y:t.height/2+t.top};this.size.world={width:this.size.document.width/t.width*this.camera.screenRatio.width/2,height:this.size.document.height/t.height*this.camera.screenRatio.height/2,top:(s.y-r.y)/t.height*this.camera.screenRatio.height,left:(r.x-s.x)/t.width*this.camera.screenRatio.width},this.#t.set(this.size.world.width,this.size.world.height,1),this.setWorldTransformOrigin()}setWorldTransformOrigin(){this.transforms.origin.world=new p((this.transformOrigin.x*2-1)*this.size.world.width,-(this.transformOrigin.y*2-1)*this.size.world.height,this.transformOrigin.z),this.shouldUpdateModelMatrix(),this.shouldUpdateProjectionMatrixStack()}updateScrollPosition(t=0,r=0){(t||r)&&this.domElement.updateScrollPosition(t,r)}destroy(){this.domElement?.destroy()}};var mt={autoloadSources:!0,watchScroll:!0},he=class extends je(Be(Ge)){constructor(t,r,s){super(t,r,{...mt,...s});this._onLoadingCallback=t=>{};s={...mt,...s},t=t&&t.renderer||t,me(t,s.label?s.label+" DOMMesh":"DOMMesh"),this.type="DOMMesh";let{autoloadSources:i}=s;this.autoloadSources=i,this.sourcesReady=!1,this.setInitSources()}get ready(){return this._ready}set ready(t){this._ready=t,this.DOMMeshReady&&this._onReadyCallback&&this._onReadyCallback()}get sourcesReady(){return this._sourcesReady}set sourcesReady(t){this._sourcesReady=t,this.DOMMeshReady&&this._onReadyCallback&&this._onReadyCallback()}get DOMMeshReady(){return this.ready&&this.sourcesReady}addToScene(){super.addToScene(),this.renderer.domMeshes.push(this)}removeFromScene(){super.removeFromScene(),this.renderer.domMeshes=this.renderer.domMeshes.filter(t=>t.uuid!==this.uuid)}setInitSources(){let t=0,r=0;if(this.autoloadSources){let s=this.domElement.element.querySelectorAll("img"),i=this.domElement.element.querySelectorAll("video"),n=this.domElement.element.querySelectorAll("canvas");t=s.length+i.length+n.length;let o=d=>{r++,this._onLoadingCallback&&this._onLoadingCallback(d),r===t&&(this.sourcesReady=!0)};t||(this.sourcesReady=!0),s.length&&s.forEach(d=>{let a=this.createTexture({name:d.getAttribute("data-texture-name")??"texture"+this.textures.length});a.onSourceUploaded(()=>o(a)).loadImage(d.src)}),i.length&&i.forEach(d=>{let a=this.createTexture({name:d.getAttribute("data-texture-name")??"texture"+this.textures.length});a.onSourceUploaded(()=>o(a)).loadVideo(d)}),n.length&&n.forEach(d=>{let a=this.createTexture({name:d.getAttribute("data-texture-name")??"texture"+this.textures.length});a.onSourceUploaded(()=>o(a)).loadCanvas(d)})}else this.sourcesReady=!0}resetDOMElement(t){t?super.resetDOMElement(t):!t&&!this.renderer.production&&k(`${this.options.label}: You are trying to reset a ${this.type} with a HTML element that does not exist. The old HTML element will be kept instead.`)}onLoading(t){return t&&(this._onLoadingCallback=t),this}};var Tt={label:"Plane",instancesCount:1,vertexBuffers:[]},we=class extends he{constructor(e,t,r={}){e=e&&e.renderer||e,me(e,r.label?r.label+" Plane":"Plane");let s={...Tt,...r},{geometry:i,widthSegments:n,heightSegments:o,...d}=s,{instancesCount:a,vertexBuffers:h,...l}=d;if(!i||i.type!=="PlaneGeometry"){n=n??1,o=o??1;let m=n*o+n;h.length||(i=Re.getPlaneGeometryByID(m)),i?i.instancesCount=a:(i=new ne({widthSegments:n,heightSegments:o,instancesCount:a,vertexBuffers:h}),Re.addPlaneGeometry(i))}super(e,t,{geometry:i,...l}),this.type="Plane"}mouseToPlaneCoords(e=new _){let t={x:2*(e.x/this.renderer.boundingRect.width)-1,y:2*(1-e.y/this.renderer.boundingRect.height)-1},r=this.camera.position.clone(),s=new p(t.x,t.y,-.5);s.unproject(this.camera),s.sub(r).normalize();let i=new p(0,0,1);i.applyQuat(this.quaternion).normalize();let n=new p(0,0,0),o=i.dot(s);if(Math.abs(o)>=1e-4){let d=this.modelMatrix.getInverse().multiply(this.camera.viewMatrix),a=this.worldTransformOrigin.clone().add(this.worldPosition),h=new p(this.worldPosition.x-a.x,this.worldPosition.y-a.y,this.worldPosition.z-a.z);h.applyQuat(this.quaternion),a.add(h);let l=i.dot(a.clone().sub(r))/o;n.copy(r.add(s.multiplyScalar(l))),n.applyMat4(d)}else n.set(1/0,1/0,1/0);return new _(n.x,n.y)}};var Ee=class{constructor({renderer:e}){e=e&&e.renderer||e,y(e,"Scene"),this.renderer=e,this.computePassEntries=[],this.renderPassEntries={pingPong:[],renderTarget:[],screen:[{renderPass:this.renderer.renderPass,renderTexture:null,onBeforeRenderPass:null,onAfterRenderPass:null,element:null,stack:{unProjected:{opaque:[],transparent:[]},projected:{opaque:[],transparent:[]}}}]}}addComputePass(e){this.computePassEntries.push(e),this.computePassEntries.sort((t,r)=>t.renderOrder!==r.renderOrder?t.renderOrder-r.renderOrder:t.index-r.index)}removeComputePass(e){this.computePassEntries=this.computePassEntries.filter(t=>t.uuid!==e.uuid)}addRenderTarget(e){this.renderPassEntries.renderTarget.find(t=>t.renderPass.uuid===e.renderPass.uuid)||this.renderPassEntries.renderTarget.push({renderPass:e.renderPass,renderTexture:e.renderTexture,onBeforeRenderPass:null,onAfterRenderPass:null,element:null,stack:{unProjected:{opaque:[],transparent:[]},projected:{opaque:[],transparent:[]}}})}removeRenderTarget(e){this.renderPassEntries.renderTarget=this.renderPassEntries.renderTarget.filter(t=>t.renderPass.uuid!==e.renderPass.uuid)}getMeshProjectionStack(e){let t=e.renderTarget?this.renderPassEntries.renderTarget.find(s=>s.renderPass.uuid===e.renderTarget.renderPass.uuid):this.renderPassEntries.screen[0],{stack:r}=t;return e.material.options.rendering.useProjection?r.projected:r.unProjected}addMesh(e){let t=this.getMeshProjectionStack(e),r=e.transparent?[...t.transparent]:[...t.opaque],s=-1;for(let i=r.length-1;i>=0;i--)if(r[i].material.pipelineEntry.index===e.material.pipelineEntry.index){s=i+1;break}s=Math.max(0,s),r.splice(s,0,e),r.sort((i,n)=>i.index-n.index),(e instanceof he||e instanceof we)&&e.transparent&&r.sort((i,n)=>n.documentPosition.z-i.documentPosition.z),r.sort((i,n)=>i.renderOrder-n.renderOrder),e.transparent?t.transparent=r:t.opaque=r}removeMesh(e){let t=this.getMeshProjectionStack(e);e.transparent?t.transparent=t.transparent.filter(r=>r.uuid!==e.uuid):t.opaque=t.opaque.filter(r=>r.uuid!==e.uuid)}addShaderPass(e){this.renderPassEntries.screen.push({renderPass:this.renderer.renderPass,renderTexture:null,onBeforeRenderPass:(t,r)=>{e.renderTexture&&t.copyTextureToTexture({texture:e.renderTarget?e.renderTarget.renderTexture.texture:r},{texture:e.renderTexture.texture},[e.renderTexture.size.width,e.renderTexture.size.height]),e.renderTarget||this.renderer.renderPass.setLoadOp("clear")},onAfterRenderPass:(t,r)=>{e.renderTarget&&t.copyTextureToTexture({texture:r},{texture:e.renderTarget.renderTexture.texture},[e.renderTexture.size.width,e.renderTexture.size.height])},element:e,stack:null}),this.renderPassEntries.screen.sort((t,r)=>{let s=t.element&&!t.element.renderTarget,i=t.element?t.element.renderOrder:0,n=t.element?t.element.index:0,o=r.element&&!r.element.renderTarget,d=r.element?r.element.renderOrder:0,a=r.element?r.element.index:0;return s&&!o?1:!s&&o?-1:i!==d?i-d:n-a})}removeShaderPass(e){this.renderPassEntries.screen=this.renderPassEntries.screen.filter(t=>!t.element||t.element.uuid!==e.uuid)}addPingPongPlane(e){this.renderPassEntries.pingPong.push({renderPass:e.renderTarget.renderPass,renderTexture:e.renderTarget.renderTexture,onBeforeRenderPass:null,onAfterRenderPass:(t,r)=>{t.copyTextureToTexture({texture:r},{texture:e.renderTexture.texture},[e.renderTexture.size.width,e.renderTexture.size.height])},element:e,stack:null}),this.renderPassEntries.pingPong.sort((t,r)=>t.element.renderOrder-r.element.renderOrder)}removePingPongPlane(e){this.renderPassEntries.pingPong=this.renderPassEntries.pingPong.filter(t=>t.element.uuid!==e.uuid)}renderSinglePassEntry(e,t){let r=this.renderer.setRenderPassCurrentTexture(t.renderPass,t.renderTexture?.texture);t.onBeforeRenderPass&&t.onBeforeRenderPass(e,r);let s=e.beginRenderPass(t.renderPass.descriptor);t.element?t.element.render(s):t.stack&&(t.stack.unProjected.opaque.forEach(i=>i.render(s)),t.stack.unProjected.transparent.forEach(i=>i.render(s)),(t.stack.projected.opaque.length||t.stack.projected.transparent.length)&&(this.renderer.cameraBindGroup&&s.setBindGroup(this.renderer.cameraBindGroup.index,this.renderer.cameraBindGroup.bindGroup),t.stack.projected.opaque.forEach(i=>i.render(s)),t.stack.projected.transparent.forEach(i=>i.render(s)))),s.end(),t.onAfterRenderPass&&t.onAfterRenderPass(e,r),this.renderer.pipelineManager.resetCurrentPipeline()}render(e){this.computePassEntries.forEach(t=>{if(!t.canRender)return;let r=e.beginComputePass();t.render(r),r.end(),t.copyBufferToResult(e),this.renderer.pipelineManager.resetCurrentPipeline()});for(let t in this.renderPassEntries){let r=0;this.renderPassEntries[t].forEach(s=>{!s.element&&!s.stack.unProjected.opaque.length&&!s.stack.unProjected.transparent.length&&!s.stack.projected.opaque.length&&!s.stack.projected.transparent.length||(s.renderPass.setLoadOp(t==="screen"&&r!==0?"load":"clear"),r++,this.renderSinglePassEntry(e,s))})}}onAfterCommandEncoder(){this.computePassEntries.forEach(e=>{e.setWorkGroupsResult()})}};var le=class{constructor(e,{label:t="Render Pass",depth:r=!0,loadOp:s="clear",clearValue:i=[0,0,0,0]}={}){e=e&&e.renderer||e,y(e,"RenderPass"),this.type="RenderPass",this.uuid=N(),this.renderer=e,this.options={label:t,depth:r,loadOp:s,clearValue:i},this.setSize(this.renderer.pixelRatioBoundingRect),this.sampleCount=this.renderer.sampleCount,this.options.depth&&this.createDepthTexture(),this.createRenderTexture(),this.setRenderPassDescriptor()}createDepthTexture(){this.depthTexture=this.renderer.createTexture({label:this.options.label+" depth attachment texture",size:[this.size.width,this.size.height],format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT,sampleCount:this.sampleCount})}createRenderTexture(){this.renderTexture=this.renderer.createTexture({label:this.options.label+" color attachment texture",size:[this.size.width,this.size.height],sampleCount:this.sampleCount,format:this.renderer.preferredFormat,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST|GPUTextureUsage.TEXTURE_BINDING})}resetRenderPassDepth(){this.depthTexture&&this.depthTexture.destroy(),this.createDepthTexture(),this.descriptor.depthStencilAttachment.view=this.depthTexture.createView()}resetRenderPassView(){this.renderTexture&&this.renderTexture.destroy(),this.createRenderTexture(),this.descriptor.colorAttachments[0].view=this.renderTexture.createView()}setRenderPassDescriptor(){this.descriptor={label:this.options.label+" descriptor",colorAttachments:[{view:this.renderTexture.createView(),clearValue:this.options.clearValue,loadOp:this.options.loadOp,storeOp:"store"}],...this.options.depth&&{depthStencilAttachment:{view:this.depthTexture.createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}}}}setSize(e){this.size={width:Math.floor(e.width),height:Math.floor(e.height)}}resize(e){this.setSize(e),this.options.depth&&this.resetRenderPassDepth(),this.resetRenderPassView()}setLoadOp(e="clear"){this.options.loadOp=e,this.descriptor&&this.descriptor.colorAttachments&&(this.descriptor.colorAttachments[0].loadOp=e)}destroy(){this.renderTexture?.destroy(),this.depthTexture?.destroy()}};var Ue=class{constructor({container:e,pixelRatio:t=1,sampleCount:r=4,production:s=!1,preferredFormat:i,onError:n=()=>{}}){this._onBeforeRenderCallback=e=>{};this._onAfterRenderCallback=e=>{};this.type="GPURenderer",this.ready=!1,this.gpu=navigator.gpu,this.pixelRatio=t??window.devicePixelRatio??1,this.sampleCount=r,this.production=s,this.preferredFormat=i,this.onError=n,this.gpu||setTimeout(()=>{this.onError(),V("GPURenderer: WebGPU is not supported on your browser/OS. No 'gpu' object in 'navigator'.")},0),this.setRendererObjects(),this.canvas=document.createElement("canvas"),this.domElement=new W({element:e}),this.documentBody=new W({element:document.body,onSizeChanged:()=>this.resize()}),this.texturesQueue=[]}setSize(e){let t=window.devicePixelRatio??1,r=this.pixelRatio/t;this.canvas.style.width=Math.floor(e.width)+"px",this.canvas.style.height=Math.floor(e.height)+"px";let s={width:Math.floor(e.width*r),height:Math.floor(e.height*r)};this.canvas.width=this.device?Math.min(s.width,this.device.limits.maxTextureDimension2D):s.width,this.canvas.height=this.device?Math.min(s.height,this.device.limits.maxTextureDimension2D):s.height}resize(e=null){this.domElement&&(e||(e=this.domElement.element.getBoundingClientRect()),this.setSize(e),this.onResize())}onResize(){this.renderPass?.resize(this.pixelRatioBoundingRect),this.renderTargets.forEach(e=>e.resize(this.pixelRatioBoundingRect)),this.pingPongPlanes.forEach(e=>e.resize(this.boundingRect)),this.shaderPasses.forEach(e=>e.resize(this.boundingRect)),this.computePasses.forEach(e=>e.resize()),this.meshes.forEach(e=>{"domElement"in e||e.resize(this.boundingRect)})}get boundingRect(){return this.domElement.boundingRect}get pixelRatioBoundingRect(){let e=window.devicePixelRatio??1,t=this.pixelRatio/e;return Object.keys(this.domElement.boundingRect).reduce((r,s)=>({...r,[s]:this.domElement.boundingRect[s]*t}),{x:0,y:0,width:0,height:0,top:0,right:0,bottom:0,left:0})}async setContext(){this.context=this.canvas.getContext("webgpu"),await this.setAdapterAndDevice(),this.device&&(this.preferredFormat=this.preferredFormat??this.gpu?.getPreferredCanvasFormat(),this.context.configure({device:this.device,format:this.preferredFormat,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST,alphaMode:"premultiplied"}),this.setMainRenderPass(),this.setPipelineManager(),this.setScene(),this.ready=!0)}async setAdapterAndDevice(){this.adapter=await this.gpu?.requestAdapter().catch(()=>{setTimeout(()=>{this.onError(),V("GPURenderer: WebGPU is not supported on your browser/OS. 'requestAdapter' failed.")},0)});try{this.device=await this.adapter?.requestDevice()}catch(e){setTimeout(()=>{this.onError(),V(`GPURenderer: WebGPU is not supported on your browser/OS. 'requestDevice' failed: ${e}`)},0)}this.device?.lost.then(e=>{k(`GPURenderer: WebGPU device was lost: ${e.message}`),e.reason})}setMainRenderPass(){this.renderPass=new le(this,{label:"Main Render pass",depth:!0})}setPipelineManager(){this.pipelineManager=new Ce({renderer:this})}setScene(){this.scene=new Ee({renderer:this})}createBuffer(e){return this.device?.createBuffer(e)}queueWriteBuffer(e,t,r){this.device?.queue.writeBuffer(e,t,r)}createBindGroupLayout(e){return this.device?.createBindGroupLayout(e)}createBindGroup(e){return this.device?.createBindGroup(e)}createShaderModule(e){return this.device?.createShaderModule(e)}createPipelineLayout(e){return this.device?.createPipelineLayout(e)}createRenderPipeline(e){return this.device?.createRenderPipeline(e)}async createRenderPipelineAsync(e){return await this.device?.createRenderPipelineAsync(e)}createComputePipeline(e){return this.device?.createComputePipeline(e)}async createComputePipelineAsync(e){return await this.device?.createComputePipelineAsync(e)}addTexture(e){this.textures.push(e),this.setTexture(e)}setTexture(e){e.texture||e.createTexture()}createSampler(e){let t=this.samplers.find(r=>JSON.stringify(r.options)===JSON.stringify(e.options)&&r.sampler);if(t)return t.sampler;{let r=this.device?.createSampler({label:e.label,...e.options});return this.samplers.push(e),r}}createTexture(e){return this.device?.createTexture(e)}uploadTexture(e){if(e.source)try{this.device?.queue.copyExternalImageToTexture({source:e.source,flipY:e.options.texture.flipY},{texture:e.texture},{width:e.size.width,height:e.size.height}),e.texture.mipLevelCount>1&&rt(this.device,e.texture),this.texturesQueue.push(e)}catch({message:t}){V(`GPURenderer: could not upload texture: ${e.options.name} because: ${t}`)}else this.device?.queue.writeTexture({texture:e.texture},new Uint8Array(e.options.texture.placeholderColor),{bytesPerRow:e.size.width*4},{width:e.size.width,height:e.size.height})}importExternalTexture(e){return this.device?.importExternalTexture({source:e})}setRendererObjects(){this.computePasses=[],this.pingPongPlanes=[],this.shaderPasses=[],this.renderTargets=[],this.meshes=[],this.samplers=[],this.textures=[]}onBeforeRender(e){return e&&(this._onBeforeRenderCallback=e),this}onAfterRender(e){return e&&(this._onAfterRenderCallback=e),this}setRenderPassCurrentTexture(e,t=null){return t||(t=this.context.getCurrentTexture()),this.sampleCount>1?e.descriptor.colorAttachments[0].resolveTarget=t.createView():e.descriptor.colorAttachments[0].view=t.createView(),t}onBeforeCommandEncoder(){}onAfterCommandEncoder(){this.scene.onAfterCommandEncoder()}render(){if(!this.ready)return;this.onBeforeCommandEncoder();let e=this.device?.createCommandEncoder({label:"Renderer command encoder"});this._onBeforeRenderCallback&&this._onBeforeRenderCallback(e),this.scene.render(e),this._onAfterRenderCallback&&this._onAfterRenderCallback(e);let t=e.finish();this.device?.queue.submit([t]),this.texturesQueue.forEach(r=>{r.sourceUploaded=!0}),this.texturesQueue=[],this.onAfterCommandEncoder()}destroy(){this.domElement?.destroy(),this.documentBody?.destroy(),this.meshes.forEach(e=>e.remove()),this.textures=[],this.texturesQueue=[],this.renderPass?.destroy(),this.renderTargets.forEach(e=>e.destroy()),this.shaderPasses.forEach(e=>e.remove()),this.pingPongPlanes.forEach(e=>e.remove()),this.device?.destroy(),this.context?.unconfigure()}};var ve=class extends Ue{constructor({container:t,pixelRatio:r=1,sampleCount:s=4,preferredFormat:i,production:n=!1,camera:o={},onError:d=()=>{}}){super({container:t,pixelRatio:r,sampleCount:s,preferredFormat:i,production:n,onError:d});this.type="GPUCameraRenderer",o={fov:50,near:.01,far:50,...o},this.setCamera(o)}setCamera(t){let r=this.boundingRect?this.boundingRect.width:1,s=this.boundingRect?this.boundingRect.height:1;this.camera=new xe({fov:t.fov,near:t.near,far:t.far,width:r,height:s,pixelRatio:this.pixelRatio,onPositionChanged:()=>{this.onCameraPositionChanged()}}),this.setCameraUniformBinding()}onCameraPositionChanged(){this.setPerspective()}setCameraUniformBinding(){this.cameraUniformBinding=new I({label:"Camera",name:"camera",visibility:"vertex",bindings:{model:{name:"model",type:"mat4x4f",value:this.camera.modelMatrix,onBeforeUpdate:()=>{this.cameraUniformBinding.bindings.model.value=this.camera.modelMatrix}},view:{name:"view",type:"mat4x4f",value:this.camera.viewMatrix,onBeforeUpdate:()=>{this.cameraUniformBinding.bindings.view.value=this.camera.viewMatrix}},projection:{name:"projection",type:"mat4x4f",value:this.camera.projectionMatrix,onBeforeUpdate:()=>{this.cameraUniformBinding.bindings.projection.value=this.camera.projectionMatrix}}}}),this.cameraBindGroup=new X(this,{label:"Camera Uniform bind group",bindings:[this.cameraUniformBinding]})}setCameraBindGroup(){this.cameraBindGroup.shouldCreateBindGroup&&(this.cameraBindGroup.setIndex(0),this.cameraBindGroup.createBindingsBuffers(),this.cameraBindGroup.setBindGroupLayout(),this.cameraBindGroup.setBindGroup())}updateCameraMatrixStack(){this.cameraUniformBinding?.shouldUpdateBinding("model"),this.cameraUniformBinding?.shouldUpdateBinding("view"),this.cameraUniformBinding?.shouldUpdateBinding("projection")}setPerspective(t,r,s){this.camera?.setPerspective(t,r,s,this.boundingRect.width,this.boundingRect.height,this.pixelRatio)}setCameraPosition(t=new p(0,0,1)){this.camera.setPosition(t)}onResize(){super.onResize(),this.setPerspective(),this.updateCameraMatrixStack()}render(){this.ready&&(this.cameraUniformBinding?.onBeforeRender(),this.setCameraBindGroup(),this.cameraBindGroup?.updateBindings(),super.render())}destroy(){this.cameraBindGroup?.destroy(),super.destroy()}};var Se=class{constructor(e,t){this.#e=!0;e=e&&e.renderer||e,y(e,"RenderTarget"),this.type="RenderTarget",this.renderer=e,this.uuid=N();let{label:r,depth:s,loadOp:i,clearValue:n,autoAddToScene:o}=t;this.options={label:r,depth:s,loadOp:i,clearValue:n,autoAddToScene:o},o!==void 0&&(this.#e=o),this.renderPass=new le(this.renderer,{label:this.options.label?`${this.options.label} Render Pass`:"Render Target Render Pass",depth:this.options.depth,loadOp:this.options.loadOp,clearValue:this.options.clearValue}),this.renderTexture=new oe(this.renderer,{label:this.options.label?`${this.options.label} Render Texture`:"Render Target Render Texture",name:"renderTexture"}),this.addToScene()}#e;addToScene(){this.renderer.renderTargets.push(this),this.#e&&this.renderer.scene.addRenderTarget(this)}removeFromScene(){this.#e&&this.renderer.scene.removeRenderTarget(this),this.renderer.renderTargets=this.renderer.renderTargets.filter(e=>e.uuid!==this.uuid)}resize(e){this.renderPass?.resize(e),this.renderTexture?.resize()}remove(){this.destroy()}destroy(){this.renderer.meshes.forEach(e=>{e.renderTarget&&e.renderTarget.uuid===this.uuid&&e.setRenderTarget(null)}),this.renderer.shaderPasses.forEach(e=>{e.renderTarget&&e.renderTarget.uuid===this.uuid&&(e.renderTarget=null,e.setRenderTarget(null))}),this.removeFromScene(),this.renderPass?.destroy(),this.renderTexture?.destroy()}};var $e=class extends ae{constructor(t,r){t=t&&t.renderer||t,y(t,r.label?r.label+" ShaderPass":"ShaderPass"),r.transparent=!0;super(t,r);this.type="ShaderPass",this.createRenderTexture({label:r.label?`${r.label} render texture`:"Shader pass render texture",name:"renderTexture"})}get renderTexture(){return this.renderTextures[0]??null}addToScene(){this.renderer.shaderPasses.push(this),this.autoAddToScene&&this.renderer.scene.addShaderPass(this)}removeFromScene(){this.renderTarget&&this.renderTarget.destroy(),this.autoAddToScene&&this.renderer.scene.removeShaderPass(this),this.renderer.shaderPasses=this.renderer.shaderPasses.filter(t=>t.uuid!==this.uuid)}};var We=class extends ae{constructor(t,r={}){t=t&&t.renderer||t,y(t,r.label?r.label+" PingPongPlane":"PingPongPlane"),r.renderTarget=new Se(t,{label:r.label?r.label+" render target":"Ping Pong render target"}),r.transparent=!1;super(t,r);this.type="PingPongPlane",this.createRenderTexture({label:r.label?`${r.label} render texture`:"PingPongPlane render texture",name:"renderTexture"})}get renderTexture(){return this.renderTextures[0]??null}addToScene(){this.renderer.pingPongPlanes.push(this),this.autoAddToScene&&this.renderer.scene.addPingPongPlane(this)}removeFromScene(){this.renderTarget&&this.renderTarget.destroy(),this.autoAddToScene&&this.renderer.scene.removePingPongPlane(this),this.renderer.pingPongPlanes=this.renderer.pingPongPlanes.filter(t=>t.uuid!==this.uuid)}};var Oe=class extends ve{constructor({container:t,pixelRatio:r=1,sampleCount:s=4,preferredFormat:i,production:n=!1,onError:o=()=>{},camera:d}){super({container:t,pixelRatio:r,sampleCount:s,preferredFormat:i,production:n,onError:o,camera:d});this.type="GPUCurtainsRenderer"}onCameraPositionChanged(){super.onCameraPositionChanged(),this.domMeshes?.forEach(t=>t.updateSizePositionAndProjection())}setRendererObjects(){super.setRendererObjects(),this.domMeshes=[]}onResize(){super.onResize(),this.domMeshes?.forEach(t=>{t.domElement&&t.domElement.setSize()})}};var He=class{constructor({xOffset:e=0,yOffset:t=0,lastXDelta:r=0,lastYDelta:s=0,shouldWatch:i=!0,onScroll:n=(o=0,d=0)=>{}}={}){this.xOffset=e,this.yOffset=t,this.lastXDelta=r,this.lastYDelta=s,this.shouldWatch=i,this.onScroll=n,this.handler=this.scroll.bind(this,!0),this.shouldWatch&&window.addEventListener("scroll",this.handler,{passive:!0})}scroll(){this.updateScrollValues(window.pageXOffset,window.pageYOffset)}updateScrollValues(e,t){let r=this.xOffset;this.xOffset=e,this.lastXDelta=r-this.xOffset;let s=this.yOffset;this.yOffset=t,this.lastYDelta=s-this.yOffset,this.onScroll&&this.onScroll(this.lastXDelta,this.lastYDelta)}destroy(){this.shouldWatch&&window.removeEventListener("scroll",this.handler,{passive:!0})}};var Ne=class{constructor({container:e,pixelRatio:t=window.devicePixelRatio??1,sampleCount:r=4,preferredFormat:s,production:i=!1,camera:n,autoRender:o=!0,autoResize:d=!0,watchScroll:a=!0}){this._onRenderCallback=()=>{};this._onScrollCallback=()=>{};this._onAfterResizeCallback=()=>{};this._onErrorCallback=()=>{};this.type="CurtainsGPU",this.options={container:e,pixelRatio:t,sampleCount:r,camera:n,production:i,preferredFormat:s,autoRender:o,autoResize:d,watchScroll:a},e&&this.setContainer(e)}setContainer(e){if(e)if(typeof e=="string")if(e=document.getElementById(e),e)this.options.container=e;else{let t=document.createElement("div");t.setAttribute("id","curtains-gpu-canvas"),document.body.appendChild(t),this.options.container=t}else e instanceof Element&&(this.options.container=e);else{let t=document.createElement("div");t.setAttribute("id","curtains-gpu-canvas"),document.body.appendChild(t),this.options.container=t}this.container=this.options.container,this.setCurtains()}setRenderer(){this.renderer=new Oe({container:this.options.container,pixelRatio:this.options.pixelRatio,sampleCount:this.options.sampleCount,preferredFormat:this.options.preferredFormat,camera:this.options.camera,production:this.options.production,onError:()=>this._onErrorCallback&&this._onErrorCallback()}),this.canvas=this.renderer.canvas}async setRendererContext(){await this.renderer.setContext()}setCurtains(){this.initEvents(),this.setRenderer(),this.container.appendChild(this.canvas),this.options.autoRender&&this.animate()}get pingPongPlanes(){return this.renderer?.pingPongPlanes}get shaderPasses(){return this.renderer?.shaderPasses}get meshes(){return this.renderer?.meshes}get domMeshes(){return this.renderer?.domMeshes}get planes(){return this.renderer?.domMeshes.filter(e=>e.type==="Plane")}get computePass(){return this.renderer?.computePasses}get camera(){return this.renderer?.camera}setPerspective(e=50,t=.01,r=50){this.renderer?.setPerspective(e,t,r)}setCameraPosition(e=new p(0,0,1)){this.renderer?.setCameraPosition(e)}initEvents(){Ve.useObserver(this.options.autoResize),this.options.watchScroll&&this.initScroll()}resize(){this.renderer?.resize(),this._onAfterResizeCallback&&this._onAfterResizeCallback()}get boundingRect(){return this.renderer?.boundingRect}initScroll(){this.scrollManager=new He({xOffset:window.pageXOffset,yOffset:window.pageYOffset,lastXDelta:0,lastYDelta:0,shouldWatch:!0,onScroll:(e,t)=>this.updateScroll(e,t)})}updateScroll(e=0,t=0){this.renderer.domMeshes.forEach(r=>{r.domElement&&r.updateScrollPosition(e,t)}),this._onScrollCallback&&this._onScrollCallback()}getScrollDeltas(){return{x:this.scrollManager.lastXDelta,y:this.scrollManager.lastYDelta}}getScrollValues(){return{x:this.scrollManager.xOffset,y:this.scrollManager.yOffset}}onRender(e){return e&&(this._onRenderCallback=e),this}onScroll(e){return e&&(this._onScrollCallback=e),this}onAfterResize(e){return e&&(this._onAfterResizeCallback=e),this}onError(e){return e&&(this._onErrorCallback=e),this}animate(){this.render(),this.animationFrameID=window.requestAnimationFrame(this.animate.bind(this))}render(){this._onRenderCallback&&this._onRenderCallback(),this.renderer?.render()}destroy(){this.animationFrameID&&window.cancelAnimationFrame(this.animationFrameID),this.renderer?.destroy(),this.scrollManager?.destroy(),Ve.destroy()}};var Ye=class extends q{constructor({widthSegments:e=1,heightSegments:t=1,depthSegments:r=1,instancesCount:s=1,vertexBuffers:i=[]}={}){super({verticesOrder:"ccw",instancesCount:s,vertexBuffers:i}),this.type="BoxGeometry",e=Math.floor(e),t=Math.floor(t),r=Math.floor(r);let n=[],o=[],d=[],a=[],h=0,l=(m,c,P,g,b,f,G,x,R,M)=>{let C=f/R,T=G/M,w=f/2,v=G/2,S=x/2,O=R+1,D=M+1,A=0,E=new p;for(let U=0;U<D;U++){let B=U*T-v;for(let F=0;F<O;F++){let L=F*C-w;E[m]=L*g,E[c]=B*b,E[P]=S,n.push(E.x,E.y,E.z),E[m]=0,E[c]=0,E[P]=x>0?1:-1,d.push(E.x,E.y,E.z),o.push(F/R),o.push(U/M),A+=1}}for(let U=0;U<M;U++)for(let B=0;B<R;B++){let F=h+B+O*U,L=h+B+O*(U+1),Q=h+(B+1)+O*(U+1),H=h+(B+1)+O*U;a.push(F,L,H),a.push(L,Q,H),h+=A}};l("z","y","x",-1,-1,2,2,2,r,t),l("z","y","x",1,-1,2,2,-2,r,t),l("x","z","y",1,1,2,2,2,e,r),l("x","z","y",1,-1,2,2,-2,e,r),l("x","y","z",1,-1,2,2,2,e,t),l("x","y","z",-1,-1,2,2,-2,e,t),this.setIndexBuffer({array:new Uint32Array(a)}),this.setAttribute({name:"position",type:"vec3f",bufferFormat:"float32x3",size:3,array:new Float32Array(n)}),this.setAttribute({name:"uv",type:"vec2f",bufferFormat:"float32x2",size:2,array:new Float32Array(o)}),this.setAttribute({name:"normal",type:"vec3f",bufferFormat:"float32x3",size:3,array:new Float32Array(d)})}};var Xe=class extends q{constructor({widthSegments:e=32,heightSegments:t=16,phiStart:r=0,phiLength:s=Math.PI*2,thetaStart:i=0,thetaLength:n=Math.PI,instancesCount:o=1,vertexBuffers:d=[]}={}){super({verticesOrder:"ccw",instancesCount:o,vertexBuffers:d}),this.type="SphereGeometry",e=Math.max(3,Math.floor(e)),t=Math.max(2,Math.floor(t));let a=1,h=Math.min(i+n,Math.PI),l=0,m=[],c=new p,P=new p,g=[],b=[],f=[],G=[];for(let x=0;x<=t;x++){let R=[],M=x/t,C=0;x===0&&i===0?C=.5/e:x===t&&h===Math.PI&&(C=-.5/e);for(let T=0;T<=e;T++){let w=T/e;c.x=-a*Math.cos(r+w*s)*Math.sin(i+M*n),c.y=a*Math.cos(i+M*n),c.z=a*Math.sin(r+w*s)*Math.sin(i+M*n),b.push(c.x,c.y,c.z),P.copy(c).normalize(),f.push(P.x,P.y,P.z),G.push(w+C,M),R.push(l++)}m.push(R)}for(let x=0;x<t;x++)for(let R=0;R<e;R++){let M=m[x][R+1],C=m[x][R],T=m[x+1][R],w=m[x+1][R+1];(x!==0||i>0)&&g.push(M,C,w),(x!==t-1||h<Math.PI)&&g.push(C,T,w)}this.setIndexBuffer({array:new Uint32Array(g)}),this.setAttribute({name:"position",type:"vec3f",bufferFormat:"float32x3",size:3,array:new Float32Array(b)}),this.setAttribute({name:"uv",type:"vec2f",bufferFormat:"float32x2",size:2,array:new Float32Array(G)}),this.setAttribute({name:"normal",type:"vec3f",bufferFormat:"float32x3",size:3,array:new Float32Array(f)})}};return yt(Ct);})();
